# å®¢æœç³»ç»Ÿç¡®è®¤åŠŸèƒ½å®Œæ•´è®¾è®¡æ–¹æ¡ˆ

**ç‰ˆæœ¬**: v2.0  
**è®¾è®¡æ–¹æ¡ˆ**: çŠ¶æ€æœº + è§„åˆ™å¢å¼º  
**æœ€åæ›´æ–°**: 2025-01-XX

---

## ç›®å½•

- [ä¸€ã€é—®é¢˜åˆ†æ](#ä¸€é—®é¢˜åˆ†æ)
- [äºŒã€æ–¹æ¡ˆå¯¹æ¯”](#äºŒæ–¹æ¡ˆå¯¹æ¯”)
- [ä¸‰ã€æ–¹æ¡ˆé€‰æ‹©](#ä¸‰æ–¹æ¡ˆé€‰æ‹©)
- [å››ã€è¯¦ç»†è®¾è®¡](#å››è¯¦ç»†è®¾è®¡)
- [äº”ã€æ ¸å¿ƒå®ç°](#äº”æ ¸å¿ƒå®ç°)
- [å…­ã€é›†æˆæ–¹æ¡ˆ](#å…­é›†æˆæ–¹æ¡ˆ)
- [ä¸ƒã€æµ‹è¯•æ–¹æ¡ˆ](#ä¸ƒæµ‹è¯•æ–¹æ¡ˆ)
- [å…«ã€ä¸Šçº¿è®¡åˆ’](#å…«ä¸Šçº¿è®¡åˆ’)

---

## ä¸€ã€é—®é¢˜åˆ†æ

### 1.1 æ ¸å¿ƒæŒ‘æˆ˜

åœ¨å¯¹è¯å¼å®¢æœç³»ç»Ÿä¸­ï¼Œéœ€è¦å¤„ç†**ç¡®è®¤æµç¨‹ä¸­çš„å¤æ‚å¯¹è¯**ï¼Œç‰¹åˆ«æ˜¯ä»¥ä¸‹åœºæ™¯ï¼š

#### åœºæ™¯ä¸€ï¼šç®€å•ç¡®è®¤æµç¨‹ âœ…
```
ç”¨æˆ·: æœ‰å“ªäº›å¥—é¤
ç³»ç»Ÿ: [è¿”å›å¥—é¤åˆ—è¡¨]
ç”¨æˆ·: åŠç†ç»æµå¥—é¤ï¼Œæ‰‹æœºå·13800000000
ç³»ç»Ÿ: è¯·ç¡®è®¤ä¸º138...åŠç†ã€ç»æµå¥—é¤ã€‘å—ï¼Ÿ
ç”¨æˆ·: ç¡®è®¤åŠç†
ç³»ç»Ÿ: å·²æˆåŠŸåŠç†ã€ç»æµå¥—é¤ã€‘ï¼Œæ¬¡æœˆç”Ÿæ•ˆ
```
**çŠ¶æ€**: å½“å‰ç³»ç»Ÿå·²åŸºæœ¬æ”¯æŒ

#### åœºæ™¯äºŒï¼šç¡®è®¤ä¸­æ’å…¥å’¨è¯¢ ğŸ”¥ï¼ˆæ ¸å¿ƒæŒ‘æˆ˜ï¼‰
```
ç”¨æˆ·: åŠç†æ— é™å¥—é¤ï¼Œæ‰‹æœºå·13800000000
ç³»ç»Ÿ: æ­¤ä¸ºé«˜ä»·å¥—é¤ï¼Œè¯·ç¡®è®¤ä¸º138...åŠç†ã€æ— é™å¥—é¤ã€‘å—ï¼Ÿ
ç”¨æˆ·: é‚£å…ˆä»‹ç»ä¸‹æ— é™å¥—é¤ä¿¡æ¯  â† ğŸ”¥ æ’å…¥å’¨è¯¢
ç³»ç»Ÿ: ã€æ— é™å¥—é¤ã€‘ä»·æ ¼150å…ƒ/æœˆï¼Œæµé‡150G
      ğŸ’¡ æé†’ï¼šå¾…ç¡®è®¤ä¸º138...åŠç†ã€æ— é™å¥—é¤ã€‘ï¼Œç¡®è®¤è¯·å›å¤"ç¡®è®¤"
ç”¨æˆ·: ç¡®è®¤åŠç†
ç³»ç»Ÿ: å·²æˆåŠŸåŠç†ã€æ— é™å¥—é¤ã€‘ï¼Œæ¬¡æœˆç”Ÿæ•ˆ
```
**çŠ¶æ€**: âŒ å½“å‰ç³»ç»Ÿå­˜åœ¨é—®é¢˜

#### åœºæ™¯ä¸‰ï¼šç¡®è®¤ä¸­æ¢è¯é¢˜
```
ç”¨æˆ·: åŠç†æ— é™å¥—é¤ï¼Œæ‰‹æœºå·13800000000
ç³»ç»Ÿ: è¯·ç¡®è®¤ä¸º138...åŠç†ã€æ— é™å¥—é¤ã€‘å—ï¼Ÿ
ç”¨æˆ·: æŸ¥è¯¢æˆ‘çš„æµé‡ä½¿ç”¨æƒ…å†µ  â† ğŸ”¥ å®Œå…¨æ–°è¯é¢˜
ç³»ç»Ÿ: [æ¸…é™¤ç¡®è®¤æ€ï¼Œå¤„ç†æ–°è¯·æ±‚]
      ğŸ“± 138...çš„ä½¿ç”¨æƒ…å†µï¼šæœ¬æœˆå·²ç”¨æµé‡5GB...
```
**çŠ¶æ€**: âŒ å½“å‰ç³»ç»Ÿå¯èƒ½è¯¯åˆ¤

### 1.2 æŠ€æœ¯é—®é¢˜

#### é—®é¢˜1ï¼šæ„å›¾è¯†åˆ«ä¸å‡†ç¡®
- **ç°è±¡**: "åŠç†æµç¨‹" è¢«è¯¯åˆ¤ä¸º "ç¡®è®¤"
- **åŸå› **: è§„åˆ™è¿‡äºå®½æ¾ï¼ˆ`len(text) <= 5` ä¸”åŒ…å«"åŠç†"ï¼‰
- **å½±å“**: ç”¨æˆ·å’¨è¯¢æµç¨‹å´è§¦å‘äº†ä¸šåŠ¡æ‰§è¡Œ

#### é—®é¢˜2ï¼šçŠ¶æ€ç®¡ç†æ··ä¹±
- **ç°è±¡**: å’¨è¯¢åç¡®è®¤æ€è¢«é”™è¯¯æ¸…é™¤
- **åŸå› **: æ— æ³•åŒºåˆ†"ç›¸å…³å’¨è¯¢"å’Œ"æ–°è¯é¢˜"
- **å½±å“**: ç”¨æˆ·å’¨è¯¢åéœ€è¦é‡æ–°å‘èµ·åŠç†

#### é—®é¢˜3ï¼šç”¨æˆ·ä½“éªŒä¸ä½³
- **ç°è±¡**: å’¨è¯¢åæ²¡æœ‰æé†’ç”¨æˆ·ä»éœ€ç¡®è®¤
- **åŸå› **: ç¼ºå°‘ç¡®è®¤æé†’æœºåˆ¶
- **å½±å“**: ç”¨æˆ·ä»¥ä¸ºå’¨è¯¢å°±æ˜¯å–æ¶ˆäº†æ“ä½œ

### 1.3 è®¾è®¡ç›®æ ‡

| ç›®æ ‡ | æŒ‡æ ‡ | è¯´æ˜ |
|------|------|------|
| **å‡†ç¡®ç‡** | â‰¥ 90% | æ­£ç¡®è¯†åˆ«ç¡®è®¤/å–æ¶ˆ/å’¨è¯¢/æ–°è¯é¢˜ |
| **ç”¨æˆ·ä½“éªŒ** | è‡ªç„¶æµç•… | æ”¯æŒæ’å…¥å¼å’¨è¯¢ï¼Œä¸æ‰“æ–­æµç¨‹ |
| **å“åº”é€Ÿåº¦** | < 50ms | çŠ¶æ€åˆ¤æ–­å’Œè½¬ç§»çš„è€—æ—¶ |
| **å¯ç»´æŠ¤æ€§** | é«˜ | ä»£ç ç»“æ„æ¸…æ™°ï¼Œæ˜“äºæ‰©å±• |
| **è¯¯åˆ¤ç‡** | < 3% | "åŠç†æµç¨‹"ç­‰caseä¸è¯¯åˆ¤ |

---

## äºŒã€æ–¹æ¡ˆå¯¹æ¯”

### æ–¹æ¡ˆAï¼šçº¯è§„åˆ™å¢å¼º

#### æ ¸å¿ƒæ€è·¯
åœ¨å½“å‰è§„åˆ™åŸºç¡€ä¸Šï¼Œå¢åŠ "è¯é¢˜ç›¸å…³æ€§æ£€æµ‹"å’Œ"æ„å›¾ç»†åˆ†"ï¼Œé€šè¿‡ if-else å¤„ç†å„ç§æƒ…å†µã€‚

#### æ¶æ„
```
ç”¨æˆ·è¾“å…¥ â†’ ç¡®è®¤æ€æ£€æŸ¥ â†’ è¯é¢˜ç›¸å…³æ€§ â†’ æ„å›¾åˆ¤æ–­ â†’ if-elseåˆ†æ”¯å¤„ç†
```

#### ä¼˜ç‚¹
- âœ… å¼€å‘å¿«é€Ÿï¼š2å‘¨å®Œæˆ
- âœ… ç®€å•ç›´è§‚ï¼šé€»è¾‘æ¸…æ™°
- âœ… æ— éœ€æ•°æ®ï¼šä¸éœ€è¦æ ‡æ³¨
- âœ… å¯ç‹¬ç«‹å·¥ä½œï¼šä¸ä¾èµ–å…¶ä»–æ¶æ„

#### ç¼ºç‚¹
- âŒ ç»“æ„æ€§å·®ï¼šif-elseåµŒå¥—æ·±ï¼Œéš¾ä»¥ç»´æŠ¤
- âŒ æ‰©å±•å›°éš¾ï¼šæ·»åŠ æ–°çŠ¶æ€éœ€æ”¹å¤šå¤„
- âŒ çŠ¶æ€éšå¼ï¼špending æ ‡å¿—åˆ†æ•£åœ¨ä»£ç ä¸­
- âŒ æµ‹è¯•å›°éš¾ï¼šçŠ¶æ€è½¬ç§»é€»è¾‘è€¦åˆ

#### é€‚ç”¨åœºæ™¯
- å¿«é€ŸéªŒè¯ MVP
- å›¢é˜Ÿäººæ•° < 2 äºº
- åœºæ™¯ç®€å•ï¼ˆ< 5 ç§çŠ¶æ€ï¼‰

---

### æ–¹æ¡ˆBï¼šçŠ¶æ€æœº + è§„åˆ™å¢å¼º â­â­â­â­â­ï¼ˆæ¨èï¼‰

#### æ ¸å¿ƒæ€è·¯
**åˆ†å±‚è®¾è®¡**ï¼šç”¨çŠ¶æ€æœºç®¡ç†æ¶æ„ï¼Œç”¨è§„åˆ™å®ç°ç®—æ³•ã€‚

```
æ¶æ„å±‚ï¼ˆçŠ¶æ€æœºï¼‰ï¼šå®šä¹‰æœ‰å“ªäº›çŠ¶æ€ã€å¦‚ä½•è½¬ç§»
    â†“
ç®—æ³•å±‚ï¼ˆè§„åˆ™ï¼‰ï¼šåˆ¤æ–­åº”è¯¥è½¬ç§»åˆ°å“ªä¸ªçŠ¶æ€
    â†“
ä¸šåŠ¡å±‚ï¼šæ‰§è¡Œå…·ä½“æ“ä½œ
```

#### æ¶æ„
```
ç”¨æˆ·è¾“å…¥ â†’ çŠ¶æ€æœºæ£€æŸ¥å½“å‰çŠ¶æ€ â†’ è§„åˆ™æ£€æµ‹äº‹ä»¶ç±»å‹ 
         â†’ çŠ¶æ€æœºæ‰§è¡Œè½¬ç§» â†’ ä¸šåŠ¡å¤„ç†
```

#### ä¼˜ç‚¹
- âœ… **ç»“æ„æ¸…æ™°**ï¼šçŠ¶æ€å’Œè½¬ç§»æ˜¾å¼å®šä¹‰
- âœ… **æ˜“äºæ‰©å±•**ï¼šæ·»åŠ æ–°çŠ¶æ€ç‹¬ç«‹ä¿®æ”¹
- âœ… **ä¾¿äºæµ‹è¯•**ï¼šçŠ¶æ€è½¬ç§»å¯å•ç‹¬æµ‹è¯•
- âœ… **å¯ç»´æŠ¤æ€§é«˜**ï¼šèŒè´£åˆ†ç¦»ï¼Œä»£ç ç»„ç»‡å¥½
- âœ… **è§„åˆ™çµæ´»**ï¼šç®—æ³•å±‚å¯ç‹¬ç«‹ä¼˜åŒ–

#### ç¼ºç‚¹
- âŒ å¼€å‘å‘¨æœŸç¨é•¿ï¼š2.5-3å‘¨
- âŒ å­¦ä¹ æˆæœ¬ï¼šéœ€è¦ç†è§£çŠ¶æ€æœºæ¦‚å¿µ
- âŒ ä»£ç é‡ç¨å¤šï¼š~600è¡Œï¼ˆvs 400è¡Œï¼‰

#### é€‚ç”¨åœºæ™¯
- âœ… é•¿æœŸç»´æŠ¤çš„äº§å“ï¼ˆæ¨èï¼‰
- âœ… çŠ¶æ€è¾ƒå¤šï¼ˆ> 3 ç§ï¼‰
- âœ… éœ€è¦é«˜å¯ç»´æŠ¤æ€§
- âœ… å›¢é˜Ÿ â‰¥ 2 äºº

---

### æ–¹æ¡ˆCï¼šå°æ¨¡å‹åˆ†ç±»

#### æ ¸å¿ƒæ€è·¯
è®­ç»ƒ BERT-tiny æ¨¡å‹ï¼Œåœ¨ç¡®è®¤æ€ä¸‹åˆ†ç±»ç”¨æˆ·æ„å›¾ã€‚

#### æ¶æ„
```
ç”¨æˆ·è¾“å…¥ â†’ ç¡®è®¤æ€æ£€æŸ¥ â†’ è§„åˆ™å¿«é€Ÿè·¯å¾„(70%) 
         â†’ BERTæ¨¡å‹åˆ†ç±»(25%) â†’ çŠ¶æ€å¤„ç†
```

#### ä¼˜ç‚¹
- âœ… å‡†ç¡®ç‡é«˜ï¼š92-95%
- âœ… æ³›åŒ–èƒ½åŠ›å¼ºï¼šç†è§£å£è¯­åŒ–è¡¨è¾¾

#### ç¼ºç‚¹
- âŒ éœ€è¦æ•°æ®ï¼š2000-5000 æ¡æ ‡æ³¨
- âŒ å¼€å‘å‘¨æœŸé•¿ï¼š1-2 ä¸ªæœˆ
- âŒ ç»´æŠ¤æˆæœ¬é«˜ï¼šéœ€è¦ ML å·¥ç¨‹å¸ˆ
- âŒ éƒ¨ç½²å¤æ‚ï¼šæ¨¡å‹æœåŠ¡

#### é€‚ç”¨åœºæ™¯
- æˆç†ŸæœŸäº§å“
- æœ‰ ML å›¢é˜Ÿ
- å¯¹å‡†ç¡®ç‡è¦æ±‚æé«˜

---

### æ–¹æ¡ˆDï¼šLLM ç›´æ¥åˆ¤æ–­

#### æ ¸å¿ƒæ€è·¯
æ¯æ¬¡ç¡®è®¤æ€è¾“å…¥ï¼Œè°ƒç”¨ LLMï¼ˆDeepSeek/GPT-4o-miniï¼‰åˆ†ç±»ã€‚

#### æ¶æ„
```
ç”¨æˆ·è¾“å…¥ â†’ ç¡®è®¤æ€æ£€æŸ¥ â†’ æ„å»º prompt â†’ LLM åˆ†ç±» â†’ JSON è¾“å‡º
```

#### ä¼˜ç‚¹
- âœ… å‡†ç¡®ç‡æœ€é«˜ï¼š96-98%
- âœ… å¼€å‘æœ€å¿«ï¼š1-2 å¤©
- âœ… ç†è§£èƒ½åŠ›å¼ºï¼šå¤„ç†å¤æ‚å¯¹è¯

#### ç¼ºç‚¹
- âŒ æˆæœ¬é«˜ï¼š0.001-0.01 å…ƒ/æ¬¡
- âŒ å“åº”æ…¢ï¼š200-500ms
- âŒ ä¸ç¨³å®šï¼šè¾“å‡ºå¯èƒ½å˜åŒ–

#### é€‚ç”¨åœºæ™¯
- é¢„ç®—å……è¶³
- è¿½æ±‚æè‡´ä½“éªŒ
- ä½å¹¶å‘åœºæ™¯

---

### æ–¹æ¡ˆEï¼šæ··åˆæ¶æ„ï¼ˆç»ˆææ–¹æ¡ˆï¼‰

#### æ ¸å¿ƒæ€è·¯
è§„åˆ™(70%) + æ¨¡å‹(25%) + LLM(5%) åˆ†å±‚å†³ç­–ã€‚

#### ä¼˜ç‚¹
- âœ… å‡†ç¡®ç‡æœ€ä¼˜ï¼š94-97%
- âœ… æ€§èƒ½å‡è¡¡ï¼šå¹³å‡ 10-50ms
- âœ… æˆæœ¬å¯æ§ï¼šåªæœ‰ 5% èµ° LLM

#### ç¼ºç‚¹
- âŒ æ¶æ„å¤æ‚
- âŒ å¼€å‘å‘¨æœŸé•¿ï¼š2-3 ä¸ªæœˆ

#### é€‚ç”¨åœºæ™¯
- æˆç†Ÿäº§å“
- æœ‰å®Œæ•´æŠ€æœ¯å›¢é˜Ÿ
- é•¿æœŸè¿è¥ 1 å¹´+

---

### æ–¹æ¡ˆå¯¹æ¯”æ€»ç»“

| æ–¹æ¡ˆ | å¼€å‘å‘¨æœŸ | å‡†ç¡®ç‡ | å“åº”æ—¶é—´ | ç»´æŠ¤æˆæœ¬ | æ¨èæŒ‡æ•° | é€‚ç”¨é˜¶æ®µ |
|------|---------|--------|---------|---------|---------|---------|
| A. çº¯è§„åˆ™ | 2å‘¨ | 85-90% | <5ms | ä½ | â­â­â­ | å¿«é€ŸéªŒè¯ |
| **B. çŠ¶æ€æœº+è§„åˆ™** | 2.5-3å‘¨ | 88-92% | <10ms | ä¸­ | â­â­â­â­â­ | **æ¨è** |
| C. å°æ¨¡å‹ | 1-2æœˆ | 92-95% | 5-10ms | é«˜ | â­â­â­ | æˆç†ŸæœŸ |
| D. LLM | 1-2å¤© | 96-98% | 200-500ms | ä¸­ | â­â­ | ç‰¹æ®Šåœºæ™¯ |
| E. æ··åˆ | 2-3æœˆ | 94-97% | 10-50ms | é«˜ | â­â­â­â­â­ | ç»ˆææ–¹æ¡ˆ |

---

## ä¸‰ã€æ–¹æ¡ˆé€‰æ‹©

### 3.1 æ¨èæ–¹æ¡ˆï¼šæ–¹æ¡ˆBï¼ˆçŠ¶æ€æœº + è§„åˆ™å¢å¼ºï¼‰

#### é€‰æ‹©ç†ç”±

**1. ç¬¦åˆå½“å‰é˜¶æ®µ**
- ä½ çš„ç³»ç»Ÿå¤„äºå¼€å‘æœŸï¼Œéœ€è¦æ¸…æ™°çš„æ¶æ„
- å›¢é˜Ÿè§„æ¨¡ 1-2 äººï¼Œéœ€è¦é«˜å¯ç»´æŠ¤æ€§
- éœ€è¦æ”¯æŒé•¿æœŸè¿­ä»£ä¼˜åŒ–

**2. æŠ€æœ¯ä¼˜åŠ¿æ˜æ˜¾**
- **çŠ¶æ€æœºæä¾›æ¶æ„**ï¼šçŠ¶æ€æ¸…æ™°ï¼Œè½¬ç§»è§„èŒƒ
- **è§„åˆ™æä¾›ç®—æ³•**ï¼šå¿«é€Ÿå®ç°ï¼Œæ˜“äºè°ƒè¯•
- **èŒè´£åˆ†ç¦»**ï¼šçŠ¶æ€ç®¡ç†å’Œäº‹ä»¶æ£€æµ‹ç‹¬ç«‹

**3. æŠ•å…¥äº§å‡ºæ¯”ä¼˜**
- å¼€å‘æˆæœ¬ï¼š2.5-3å‘¨ï¼ˆå¯æ¥å—ï¼‰
- å‡†ç¡®ç‡é¢„æœŸï¼š88-92%ï¼ˆè¦†ç›–ç»å¤§å¤šæ•°åœºæ™¯ï¼‰
- ç»´æŠ¤æˆæœ¬ï¼šä¸­ç­‰ï¼ˆåˆ†å±‚æ¸…æ™°ï¼Œæ˜“äºä¿®æ”¹ï¼‰

**4. å¯æŒç»­æ¼”è¿›**
```
å½“å‰ï¼šéšå¼çŠ¶æ€ç®¡ç†
  â†“
æ–¹æ¡ˆBï¼šçŠ¶æ€æœº + è§„åˆ™
  â†“ (ç”¨æˆ·é‡å¢é•¿)
æ–¹æ¡ˆEï¼šçŠ¶æ€æœº + æ··åˆç®—æ³•ï¼ˆè§„åˆ™+æ¨¡å‹+LLMï¼‰
```

### 3.2 çŠ¶æ€æœºå’Œè§„åˆ™çš„å…³ç³»

#### æ ¸å¿ƒè®¤çŸ¥ ğŸ¯

**çŠ¶æ€æœºå’Œè§„åˆ™ä¸æ˜¯å¯¹ç«‹çš„ï¼Œè€Œæ˜¯äº’è¡¥çš„ï¼**

```
å®Œæ•´æ–¹æ¡ˆ = çŠ¶æ€æœºï¼ˆæ¶æ„å±‚ï¼‰ + è§„åˆ™ï¼ˆç®—æ³•å±‚ï¼‰
```

| å±‚é¢ | çŠ¶æ€æœº | è§„åˆ™ |
|------|--------|------|
| **èŒè´£** | ç®¡ç†çŠ¶æ€å’Œè½¬ç§» | æ£€æµ‹äº‹ä»¶ç±»å‹ |
| **é—®é¢˜** | "æœ‰å“ªäº›çŠ¶æ€ï¼Ÿå¦‚ä½•è½¬ç§»ï¼Ÿ" | "å½“å‰æ˜¯ä»€ä¹ˆäº‹ä»¶ï¼Ÿ" |
| **ç±»æ¯”** | åœ°å›¾ï¼ˆæœ‰å“ªäº›åœ°ç‚¹ï¼‰ | å¯¼èˆªï¼ˆå¦‚ä½•ä»Aåˆ°Bï¼‰ |
| **ä»£ç ** | `state_machine.transition(event)` | `event = detect_event(input)` |

#### ä¸ºä»€ä¹ˆå¿…é¡»ç»“åˆï¼Ÿ

**å•ç‹¬ç”¨çŠ¶æ€æœº**ï¼š
```python
# åªèƒ½è¿™æ ·è°ƒç”¨
state_machine.transition("user_confirm", context)

# ğŸ¤” é—®é¢˜ï¼šå¦‚ä½•çŸ¥é“ç”¨æˆ·è¾“å…¥æ˜¯"user_confirm"äº‹ä»¶ï¼Ÿ
# ç­”ï¼šéœ€è¦è§„åˆ™/æ¨¡å‹æ¥åˆ¤æ–­ï¼
```

**å•ç‹¬ç”¨è§„åˆ™**ï¼š
```python
# åªèƒ½è¿™æ ·åˆ¤æ–­
if is_confirmation_word(user_input):
    state.pending_confirmation = False  # æ‰‹åŠ¨ç®¡ç†
    execute_action()

# ğŸ¤” é—®é¢˜ï¼šçŠ¶æ€åˆ†æ•£ç®¡ç†ï¼Œå¦‚ä½•ä¿è¯è½¬ç§»åˆæ³•ï¼Ÿ
# ç­”ï¼šéœ€è¦çŠ¶æ€æœºç»Ÿä¸€ç®¡ç†ï¼
```

**ç»“åˆä½¿ç”¨**ï¼š
```python
# 1. è§„åˆ™æ£€æµ‹äº‹ä»¶
event = event_detector.detect(user_input)  # "user_confirm"

# 2. çŠ¶æ€æœºæ‰§è¡Œè½¬ç§»
state_machine.transition(event)  # PENDING â†’ EXECUTING

# 3. æ ¹æ®æ–°çŠ¶æ€å¤„ç†
handle_by_state(state_machine.current_state)
```

### 3.3 å®æ–½è·¯çº¿å›¾

```
Week 1: çŠ¶æ€æœºæ¡†æ¶ + åŸºç¡€è§„åˆ™
  - å®šä¹‰çŠ¶æ€æšä¸¾
  - å®ç°çŠ¶æ€æœºç±»
  - ç§»æ¤ç°æœ‰è§„åˆ™ä¸ºäº‹ä»¶æ£€æµ‹å™¨

Week 2: å®Œå–„è§„åˆ™ + é›†æˆ
  - ä¼˜åŒ–äº‹ä»¶æ£€æµ‹é€»è¾‘ï¼ˆè¯é¢˜ç›¸å…³æ€§ç­‰ï¼‰
  - é›†æˆåˆ° chatbot_policy.py
  - å®Œå–„å„çŠ¶æ€çš„å¤„ç†é€»è¾‘

Week 2.5: æµ‹è¯•
  - å•å…ƒæµ‹è¯•ï¼ˆçŠ¶æ€è½¬ç§»ï¼‰
  - é›†æˆæµ‹è¯•ï¼ˆå®Œæ•´å¯¹è¯æµç¨‹ï¼‰
  - æ‰‹åŠ¨æµ‹è¯•ï¼ˆè¾¹ç•Œcaseï¼‰

Week 3: ä¸Šçº¿
  - ç°åº¦å‘å¸ƒ
  - ç›‘æ§æŒ‡æ ‡
  - Badcase æ”¶é›†
```

---

## å››ã€è¯¦ç»†è®¾è®¡

### 4.1 æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç”¨æˆ·è¾“å…¥                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Layer 1: çŠ¶æ€æœºå±‚     â”‚  â† Whatï¼ˆæ¶æ„ï¼‰
         â”‚ æ£€æŸ¥å½“å‰çŠ¶æ€          â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Layer 2: ç®—æ³•å±‚       â”‚  â† Howï¼ˆå®ç°ï¼‰
         â”‚ è§„åˆ™æ£€æµ‹äº‹ä»¶ç±»å‹      â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Layer 1: çŠ¶æ€æœºå±‚     â”‚  â† Whatï¼ˆæ¶æ„ï¼‰
         â”‚ æ‰§è¡ŒçŠ¶æ€è½¬ç§»          â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Layer 3: ä¸šåŠ¡å±‚       â”‚  â† Doï¼ˆæ‰§è¡Œï¼‰
         â”‚ æ ¹æ®çŠ¶æ€æ‰§è¡Œå¤„ç†      â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 çŠ¶æ€æœºè®¾è®¡

#### 4.2.1 çŠ¶æ€å®šä¹‰

```python
class ConfirmationState(Enum):
    """ç¡®è®¤çŠ¶æ€æšä¸¾"""
    IDLE = "idle"                           # ç©ºé—²ï¼ˆæ— ç¡®è®¤ï¼‰
    PENDING = "pending_confirmation"        # å¾…ç¡®è®¤
    INQUIRING = "confirming_with_inquiry"   # ç¡®è®¤ä¸­å’¨è¯¢
    EXECUTING = "executing"                 # æ‰§è¡Œä¸­
    COMPLETED = "completed"                 # å·²å®Œæˆ
    CANCELLED = "cancelled"                 # å·²å–æ¶ˆ
    TIMEOUT = "timeout"                     # å·²è¶…æ—¶
```

#### 4.2.2 çŠ¶æ€è½¬ç§»å›¾

```
                    trigger_confirmation
        IDLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ PENDING
         â†‘                                      â”‚
         â”‚                                      â”‚ user_confirm
         â”‚                                      â†“
         â”‚                                  EXECUTING
         â”‚                                      â”‚
         â”‚                                      â”‚ success
         â”‚                                      â†“
         â”‚                                  COMPLETED
         â”‚
         â”‚ user_new_topic                      
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ PENDING
         â”‚                                  â”‚  â”‚
         â”‚                     user_inquiry â”‚  â”‚ user_deny
         â”‚                                  â†“  â†“
         â”‚                              INQUIRING  CANCELLED
         â”‚                                  â”‚
         â”‚                  inquiry_answeredâ”‚
         â”‚                                  â†“
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€PENDING
                                             â”‚
                                     timeout â”‚
                                             â†“
                                          TIMEOUT
```

#### 4.2.3 çŠ¶æ€è½¬ç§»è¡¨

```python
STATE_TRANSITIONS = {
    "IDLE": {
        "trigger_confirmation": "PENDING",  # è§¦å‘ç¡®è®¤æµç¨‹
    },
    
    "PENDING": {
        "user_confirm": "EXECUTING",        # ç”¨æˆ·ç¡®è®¤ â†’ æ‰§è¡Œ
        "user_deny": "CANCELLED",           # ç”¨æˆ·å–æ¶ˆ â†’ å–æ¶ˆ
        "user_inquiry": "INQUIRING",        # ç”¨æˆ·å’¨è¯¢ â†’ å’¨è¯¢æ€
        "user_new_topic": "IDLE",           # æ–°è¯é¢˜ â†’ ç©ºé—²
        "timeout": "TIMEOUT",               # è¶…æ—¶ â†’ è¶…æ—¶æ€
    },
    
    "INQUIRING": {
        "inquiry_answered": "PENDING",      # å’¨è¯¢å®Œæˆ â†’ å›åˆ°å¾…ç¡®è®¤
        "user_confirm": "EXECUTING",        # å’¨è¯¢ä¸­ç¡®è®¤ â†’ æ‰§è¡Œ
        "user_deny": "CANCELLED",           # å’¨è¯¢ä¸­å–æ¶ˆ â†’ å–æ¶ˆ
        "user_new_topic": "IDLE",           # å’¨è¯¢ä¸­æ–°è¯é¢˜ â†’ ç©ºé—²
    },
    
    "EXECUTING": {
        "success": "COMPLETED",             # æ‰§è¡ŒæˆåŠŸ â†’ å®Œæˆ
        "failure": "IDLE",                  # æ‰§è¡Œå¤±è´¥ â†’ ç©ºé—²
    },
    
    "COMPLETED": {
        # ç»ˆæ€ï¼Œè‡ªåŠ¨è¿”å› IDLE
    },
    
    "CANCELLED": {
        # ç»ˆæ€ï¼Œè‡ªåŠ¨è¿”å› IDLE
    },
    
    "TIMEOUT": {
        # ç»ˆæ€ï¼Œè‡ªåŠ¨è¿”å› IDLE
    }
}
```

### 4.3 äº‹ä»¶æ£€æµ‹ï¼ˆè§„åˆ™å±‚ï¼‰

#### 4.3.1 äº‹ä»¶ç±»å‹

```python
class ConfirmationEvent(Enum):
    """ç¡®è®¤äº‹ä»¶ç±»å‹"""
    USER_CONFIRM = "user_confirm"          # ç”¨æˆ·ç¡®è®¤
    USER_DENY = "user_deny"                # ç”¨æˆ·å–æ¶ˆ
    USER_INQUIRY = "user_inquiry"          # ç”¨æˆ·å’¨è¯¢ï¼ˆç›¸å…³è¯é¢˜ï¼‰
    USER_NEW_TOPIC = "user_new_topic"      # ç”¨æˆ·æ–°è¯é¢˜ï¼ˆæ— å…³ï¼‰
    TIMEOUT = "timeout"                    # è¶…æ—¶
    INQUIRY_ANSWERED = "inquiry_answered"  # å’¨è¯¢å·²å›ç­”
    SUCCESS = "success"                    # æ‰§è¡ŒæˆåŠŸ
    FAILURE = "failure"                    # æ‰§è¡Œå¤±è´¥
```

#### 4.3.2 äº‹ä»¶æ£€æµ‹æµç¨‹

```
ç”¨æˆ·è¾“å…¥
  â†“
ã€ä¼˜å…ˆçº§1ã€‘çº¯ç¡®è®¤/å–æ¶ˆè¯æ£€æµ‹ï¼ˆå¿«é€Ÿè·¯å¾„ï¼‰
  â†“ (æœªåŒ¹é…)
ã€ä¼˜å…ˆçº§2ã€‘è¯é¢˜ç›¸å…³æ€§åˆ†æ
  â†“
  â”œâ”€â†’ ç›¸å…³ â†’ ã€ä¼˜å…ˆçº§3ã€‘æ„å›¾ç»†åˆ†ï¼ˆç¡®è®¤/å–æ¶ˆ/å’¨è¯¢ç»„åˆè¯ï¼‰
  â”‚              â†“
  â”‚            ç¡®å®šäº‹ä»¶ç±»å‹
  â”‚
  â””â”€â†’ ä¸ç›¸å…³ â†’ USER_NEW_TOPIC
```

#### 4.3.3 è¯é¢˜ç›¸å…³æ€§ç®—æ³•

**ç›®æ ‡**ï¼šåˆ¤æ–­ç”¨æˆ·è¾“å…¥æ˜¯å¦ä¸å¾…ç¡®è®¤æ“ä½œç›¸å…³

**è¯„åˆ†è§„åˆ™**ï¼š

| è§„åˆ™ | æƒé‡ | ç¤ºä¾‹ |
|------|------|------|
| åŒ…å«å¾…ç¡®è®¤å®ä½“ï¼ˆå¥—é¤åç­‰ï¼‰ | +0.4 | "æ— é™å¥—é¤" |
| åŒ…å«å’¨è¯¢å…³é”®è¯ | +0.3 | "ä»‹ç»"ã€"ä»·æ ¼"ã€"è¯¦æƒ…" |
| åŒ…å«å¥—é¤ç›¸å…³è¯ | +0.2 | "å¥—é¤"ã€"èµ„è´¹"ã€"æµé‡" |
| ç–‘é—®å¥ | +0.1 | "ï¼Ÿ"ã€"å—"ã€"å‘¢" |
| åŒ…å«æ–°è¯é¢˜å…³é”®è¯ | -0.3 | "æŸ¥è¯¢ä½™é¢"ã€"æµé‡ä½¿ç”¨" |

**é˜ˆå€¼**ï¼š`score >= 0.5` è§†ä¸ºç›¸å…³

**ç¤ºä¾‹**ï¼š

| è¾“å…¥ | å¾…ç¡®è®¤æ“ä½œ | å®ä½“ | å’¨è¯¢ | å¥—é¤ | ç–‘é—® | æ–°è¯é¢˜ | æ€»åˆ† | ç›¸å…³? |
|------|-----------|------|------|------|------|--------|------|-------|
| "ä»‹ç»ä¸‹æ— é™å¥—é¤" | åŠç†æ— é™å¥—é¤ | 0.4 | 0.3 | 0.2 | 0 | 0 | **0.9** | âœ… |
| "å¥—é¤ä»·æ ¼å¤šå°‘" | åŠç†æ— é™å¥—é¤ | 0 | 0.3 | 0.2 | 0.1 | 0 | **0.6** | âœ… |
| "æŸ¥è¯¢æˆ‘çš„æµé‡" | åŠç†æ— é™å¥—é¤ | 0 | 0 | 0 | 0 | -0.3 | **-0.3** | âŒ |

### 4.4 æ¨¡å—åˆ’åˆ†

```
core/policy/confirmation/
â”œâ”€â”€ __init__.py
â”‚
â”œâ”€â”€ state_machine.py              # çŠ¶æ€æœºï¼ˆLayer 1ï¼‰
â”‚   â”œâ”€â”€ ConfirmationState         # çŠ¶æ€æšä¸¾
â”‚   â”œâ”€â”€ ConfirmationStateMachine  # çŠ¶æ€æœºç±»
â”‚   â””â”€â”€ STATE_TRANSITIONS         # è½¬ç§»è¡¨
â”‚
â”œâ”€â”€ event_detector.py             # äº‹ä»¶æ£€æµ‹å™¨ï¼ˆLayer 2ï¼‰
â”‚   â”œâ”€â”€ ConfirmationEvent         # äº‹ä»¶æšä¸¾
â”‚   â”œâ”€â”€ EventDetector             # æ£€æµ‹å™¨ä¸»ç±»
â”‚   â”œâ”€â”€ IntentClassifier          # æ„å›¾åˆ†ç±»
â”‚   â””â”€â”€ TopicAnalyzer             # è¯é¢˜ç›¸å…³æ€§
â”‚
â”œâ”€â”€ handler.py                    # ç¡®è®¤å¤„ç†å™¨ï¼ˆLayer 3ï¼‰
â”‚   â””â”€â”€ ConfirmationHandler       # ç»Ÿä¸€å¤„ç†å…¥å£
â”‚
â””â”€â”€ context.py                    # æ•°æ®ç»“æ„
    â”œâ”€â”€ ConfirmationContext       # ç¡®è®¤ä¸Šä¸‹æ–‡
    â””â”€â”€ ConfirmationResult        # å¤„ç†ç»“æœ
```

---

## äº”ã€æ ¸å¿ƒå®ç°

### 5.1 çŠ¶æ€æœºå®ç°

```python
# core/policy/confirmation/state_machine.py

from enum import Enum
from typing import Optional, Dict, Any
from datetime import datetime
from utils.logger import logger


class ConfirmationState(Enum):
    """ç¡®è®¤çŠ¶æ€"""
    IDLE = "idle"
    PENDING = "pending_confirmation"
    INQUIRING = "confirming_with_inquiry"
    EXECUTING = "executing"
    COMPLETED = "completed"
    CANCELLED = "cancelled"
    TIMEOUT = "timeout"


# çŠ¶æ€è½¬ç§»è¡¨
STATE_TRANSITIONS = {
    "IDLE": {
        "trigger_confirmation": "PENDING"
    },
    "PENDING": {
        "user_confirm": "EXECUTING",
        "user_deny": "CANCELLED",
        "user_inquiry": "INQUIRING",
        "user_new_topic": "IDLE",
        "timeout": "TIMEOUT"
    },
    "INQUIRING": {
        "inquiry_answered": "PENDING",
        "user_confirm": "EXECUTING",
        "user_deny": "CANCELLED",
        "user_new_topic": "IDLE"
    },
    "EXECUTING": {
        "success": "COMPLETED",
        "failure": "IDLE"
    },
    "COMPLETED": {},  # ç»ˆæ€
    "CANCELLED": {},  # ç»ˆæ€
    "TIMEOUT": {}     # ç»ˆæ€
}


class InvalidTransitionError(Exception):
    """éæ³•çŠ¶æ€è½¬ç§»å¼‚å¸¸"""
    pass


class ConfirmationStateMachine:
    """ç¡®è®¤çŠ¶æ€æœº"""
    
    def __init__(self):
        """åˆå§‹åŒ–"""
        self.current_state = ConfirmationState.IDLE
        self.previous_state: Optional[ConfirmationState] = None
        self.transition_history = []  # è½¬ç§»å†å²
        
        logger.info("çŠ¶æ€æœºåˆå§‹åŒ–å®Œæˆ")
    
    def transition(self, event: str, context: Optional[Dict] = None):
        """
        æ‰§è¡ŒçŠ¶æ€è½¬ç§»
        
        Args:
            event: äº‹ä»¶åç§°
            context: ä¸Šä¸‹æ–‡ä¿¡æ¯
            
        Raises:
            InvalidTransitionError: éæ³•è½¬ç§»
        """
        context = context or {}
        
        # æ£€æŸ¥è½¬ç§»æ˜¯å¦åˆæ³•
        transitions = STATE_TRANSITIONS.get(self.current_state.name, {})
        
        if event not in transitions:
            error_msg = (f"éæ³•è½¬ç§»: {self.current_state.name} "
                        f"æ— æ³•é€šè¿‡äº‹ä»¶ '{event}' è½¬ç§»")
            logger.error(error_msg)
            raise InvalidTransitionError(error_msg)
        
        # è·å–ç›®æ ‡çŠ¶æ€
        target_state_name = transitions[event]
        target_state = ConfirmationState[target_state_name]
        
        # æ‰§è¡Œè½¬ç§»å‰é’©å­
        self._before_transition(self.current_state, target_state, event, context)
        
        # æ›´æ–°çŠ¶æ€
        self.previous_state = self.current_state
        self.current_state = target_state
        
        # è®°å½•å†å²
        self.transition_history.append({
            "from": self.previous_state.name,
            "to": self.current_state.name,
            "event": event,
            "timestamp": datetime.now()
        })
        
        # æ‰§è¡Œè½¬ç§»åé’©å­
        self._after_transition(self.current_state, event, context)
        
        logger.info(f"çŠ¶æ€è½¬ç§»: {self.previous_state.name} "
                   f"--[{event}]--> {self.current_state.name}")
    
    def _before_transition(self, from_state: ConfirmationState,
                          to_state: ConfirmationState,
                          event: str,
                          context: Dict):
        """è½¬ç§»å‰é’©å­"""
        # å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æ—¥å¿—ã€éªŒè¯ç­‰
        pass
    
    def _after_transition(self, new_state: ConfirmationState,
                         event: str,
                         context: Dict):
        """è½¬ç§»åé’©å­"""
        # å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ çŠ¶æ€è¿›å…¥åçš„å¤„ç†
        # ä¾‹å¦‚ï¼šè®°å½•å’¨è¯¢æ¬¡æ•°
        if new_state == ConfirmationState.INQUIRING:
            context["inquiry_count"] = context.get("inquiry_count", 0) + 1
    
    def can_transition(self, event: str) -> bool:
        """
        æ£€æŸ¥æ˜¯å¦å¯ä»¥æ‰§è¡Œè½¬ç§»
        
        Args:
            event: äº‹ä»¶åç§°
            
        Returns:
            bool: æ˜¯å¦å¯ä»¥è½¬ç§»
        """
        transitions = STATE_TRANSITIONS.get(self.current_state.name, {})
        return event in transitions
    
    def reset(self):
        """é‡ç½®çŠ¶æ€æœº"""
        self.current_state = ConfirmationState.IDLE
        self.previous_state = None
        self.transition_history = []
        logger.info("çŠ¶æ€æœºå·²é‡ç½®")
    
    def is_terminal_state(self) -> bool:
        """æ˜¯å¦å¤„äºç»ˆæ€"""
        return self.current_state in [
            ConfirmationState.COMPLETED,
            ConfirmationState.CANCELLED,
            ConfirmationState.TIMEOUT
        ]
    
    def get_state_info(self) -> Dict[str, Any]:
        """è·å–çŠ¶æ€ä¿¡æ¯"""
        return {
            "current_state": self.current_state.name,
            "previous_state": self.previous_state.name if self.previous_state else None,
            "is_terminal": self.is_terminal_state(),
            "history_count": len(self.transition_history)
        }
```

### 5.2 äº‹ä»¶æ£€æµ‹å™¨å®ç°

```python
# core/policy/confirmation/event_detector.py

from enum import Enum
from typing import Optional
from dataclasses import dataclass
import re
from utils.logger import logger


class ConfirmationEvent(Enum):
    """ç¡®è®¤äº‹ä»¶"""
    USER_CONFIRM = "user_confirm"
    USER_DENY = "user_deny"
    USER_INQUIRY = "user_inquiry"
    USER_NEW_TOPIC = "user_new_topic"
    TIMEOUT = "timeout"
    INQUIRY_ANSWERED = "inquiry_answered"
    SUCCESS = "success"
    FAILURE = "failure"


@dataclass
class TopicRelevance:
    """è¯é¢˜ç›¸å…³æ€§"""
    is_related: bool
    score: float
    reason: str


class EventDetector:
    """äº‹ä»¶æ£€æµ‹å™¨ï¼ˆè§„åˆ™å®ç°ï¼‰"""
    
    def __init__(self):
        """åˆå§‹åŒ–"""
        logger.info("äº‹ä»¶æ£€æµ‹å™¨åˆå§‹åŒ–å®Œæˆ")
    
    def detect(self, user_input: str, confirmation_ctx: Dict) -> str:
        """
        æ£€æµ‹äº‹ä»¶ç±»å‹
        
        Args:
            user_input: ç”¨æˆ·è¾“å…¥
            confirmation_ctx: ç¡®è®¤ä¸Šä¸‹æ–‡
            
        Returns:
            str: äº‹ä»¶åç§°
        """
        logger.info(f"[äº‹ä»¶æ£€æµ‹] è¾“å…¥: {user_input}")
        
        # ä¼˜å…ˆçº§1: çº¯ç¡®è®¤/å–æ¶ˆè¯ï¼ˆå¿«é€Ÿè·¯å¾„ï¼‰
        if self._is_pure_confirmation(user_input):
            logger.info("æ£€æµ‹åˆ°çº¯ç¡®è®¤è¯")
            return ConfirmationEvent.USER_CONFIRM.value
        
        if self._is_pure_cancellation(user_input):
            logger.info("æ£€æµ‹åˆ°çº¯å–æ¶ˆè¯")
            return ConfirmationEvent.USER_DENY.value
        
        # ä¼˜å…ˆçº§2: è¯é¢˜ç›¸å…³æ€§åˆ†æ
        relevance = self._analyze_topic_relevance(user_input, confirmation_ctx)
        logger.info(f"è¯é¢˜ç›¸å…³æ€§: {relevance.is_related}, "
                   f"åˆ†æ•°: {relevance.score:.2f}")
        
        if not relevance.is_related:
            # ä¸ç›¸å…³ â†’ æ–°è¯é¢˜
            logger.info("æ£€æµ‹åˆ°æ–°è¯é¢˜")
            return ConfirmationEvent.USER_NEW_TOPIC.value
        
        # ä¼˜å…ˆçº§3: ç›¸å…³è¯é¢˜ä¸‹çš„æ„å›¾ç»†åˆ†
        return self._classify_related_intent(user_input)
    
    def _is_pure_confirmation(self, text: str) -> bool:
        """çº¯ç¡®è®¤è¯æ£€æµ‹"""
        clean = re.sub(r'[,ã€‚!?ã€\s]+', '', text.lower())
        pure_words = [
            "ç¡®è®¤", "ç¡®å®š", "æ˜¯çš„", "æ˜¯", "å¯¹", "å¥½çš„",
            "å¯ä»¥", "ok", "yes", "å—¯", "è¡Œ", "åŒæ„", "æ²¡é—®é¢˜"
        ]
        return clean in pure_words
    
    def _is_pure_cancellation(self, text: str) -> bool:
        """çº¯å–æ¶ˆè¯æ£€æµ‹"""
        clean = re.sub(r'[,ã€‚!?ã€\s]+', '', text.lower())
        pure_words = [
            "å–æ¶ˆ", "ä¸", "ä¸è¦", "ç®—äº†", "ä¸åŠ",
            "no", "cancel", "ä¸è¡Œ", "ä¸ç”¨"
        ]
        return clean in pure_words
    
    def _analyze_topic_relevance(self, text: str, 
                                 confirmation_ctx: Dict) -> TopicRelevance:
        """
        è¯é¢˜ç›¸å…³æ€§åˆ†æï¼ˆæ ¸å¿ƒç®—æ³•ï¼‰
        """
        score = 0.0
        reasons = []
        
        # è§„åˆ™1: åŒ…å«å¾…ç¡®è®¤å®ä½“ï¼ˆå¥—é¤åï¼‰
        pending_package = confirmation_ctx.get("parameters", {}).get("new_package_name")
        if pending_package and pending_package in text:
            score += 0.4
            reasons.append(f"åŒ…å«å¥—é¤å'{pending_package}'")
        
        # è§„åˆ™2: åŒ…å«å’¨è¯¢å…³é”®è¯
        inquiry_keywords = [
            "ä»‹ç»", "è¯¦æƒ…", "è¯´æ˜", "äº†è§£", "æŸ¥è¯¢",
            "ä»·æ ¼", "å¤šå°‘é’±", "åŒ…å«", "ä»€ä¹ˆ", "æœ‰ä»€ä¹ˆ"
        ]
        matched_inquiry = [kw for kw in inquiry_keywords if kw in text]
        if matched_inquiry:
            score += 0.3
            reasons.append(f"åŒ…å«å’¨è¯¢è¯: {matched_inquiry}")
        
        # è§„åˆ™3: åŒ…å«å¥—é¤ç›¸å…³è¯
        package_keywords = ["å¥—é¤", "èµ„è´¹", "åŠç†", "æœˆè´¹", "æµé‡"]
        matched_package = [kw for kw in package_keywords if kw in text]
        if matched_package:
            score += 0.2
            reasons.append(f"åŒ…å«å¥—é¤è¯: {matched_package}")
        
        # è§„åˆ™4: ç–‘é—®å¥
        if any(w in text for w in ["ï¼Ÿ", "?", "å—", "å‘¢"]):
            score += 0.1
            reasons.append("ç–‘é—®å¥")
        
        # è§„åˆ™5: æ–°è¯é¢˜å…³é”®è¯ï¼ˆè´Ÿåˆ†ï¼‰
        new_topic_keywords = [
            "æˆ‘è¦", "å¸®æˆ‘", "æŸ¥è¯¢ä½™é¢", "æµé‡ä½¿ç”¨",
            "å½“å‰å¥—é¤", "æˆ‘çš„å¥—é¤"
        ]
        matched_new = [kw for kw in new_topic_keywords if kw in text]
        if matched_new:
            score -= 0.3
            reasons.append(f"åŒ…å«æ–°è¯é¢˜è¯: {matched_new}")
        
        # è§„åˆ™6: å’¨è¯¢è¯æ’é™¤ï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰
        consultation_keywords = [
            "æ€ä¹ˆ", "å¦‚ä½•", "æ€æ ·",
            "æµç¨‹", "æ­¥éª¤", "æ‰‹ç»­",
            "æ¡ä»¶", "è¦æ±‚"
        ]
        matched_consult = [kw for kw in consultation_keywords if kw in text]
        if matched_consult:
            # å’¨è¯¢æµç¨‹ç±»é—®é¢˜ï¼Œè™½ç„¶å¯èƒ½ç›¸å…³ï¼Œä½†ä¸æ˜¯ç¡®è®¤/å–æ¶ˆ
            # å•ç‹¬æ ‡è®°ä¸ºå’¨è¯¢
            reasons.append(f"åŒ…å«å’¨è¯¢æµç¨‹è¯: {matched_consult}")
        
        is_related = score >= 0.5
        reason_text = "; ".join(reasons) if reasons else "æ— åŒ¹é…"
        
        return TopicRelevance(
            is_related=is_related,
            score=score,
            reason=reason_text
        )
    
    def _classify_related_intent(self, text: str) -> str:
        """
        ç›¸å…³è¯é¢˜çš„æ„å›¾ç»†åˆ†
        
        Returns:
            str: äº‹ä»¶åç§°
        """
        # 1. ç¡®è®¤ç»„åˆè¯
        confirm_patterns = [
            "ç¡®è®¤åŠç†", "å¥½çš„åŠç†", "å¯ä»¥åŠç†",
            "å°±è¿™ä¸ª", "å°±åŠè¿™ä¸ª", "åŠå§", "åŠç†å§"
        ]
        if any(p in text for p in confirm_patterns):
            logger.info("æ£€æµ‹åˆ°ç¡®è®¤ç»„åˆè¯")
            return ConfirmationEvent.USER_CONFIRM.value
        
        # 2. å–æ¶ˆç»„åˆè¯
        deny_patterns = [
            "ä¸åŠäº†", "ç®—äº†ä¸åŠ", "å–æ¶ˆåŠç†",
            "ä¸æƒ³åŠ", "å†æƒ³æƒ³", "è€ƒè™‘ä¸€ä¸‹"
        ]
        if any(p in text for p in deny_patterns):
            logger.info("æ£€æµ‹åˆ°å–æ¶ˆç»„åˆè¯")
            return ConfirmationEvent.USER_DENY.value
        
        # 3. å’¨è¯¢æ¨¡å¼
        inquiry_patterns = [
            "ä»‹ç»", "è¯´æ˜", "è¯¦æƒ…", "äº†è§£",
            "ä»·æ ¼", "å¤šå°‘é’±", "åŒ…å«ä»€ä¹ˆ", "æœ‰ä»€ä¹ˆ"
        ]
        if any(p in text for p in inquiry_patterns):
            logger.info("æ£€æµ‹åˆ°å’¨è¯¢æ¨¡å¼")
            return ConfirmationEvent.USER_INQUIRY.value
        
        # 4. çŸ­å¥"åŠç†"ï¼ˆä¸¥æ ¼é™åˆ¶ï¼‰
        if "åŠç†" in text and len(text) <= 3:
            logger.info("æ£€æµ‹åˆ°çŸ­å¥åŠç†")
            return ConfirmationEvent.USER_CONFIRM.value
        
        # 5. é»˜è®¤ï¼šå€¾å‘ç¡®è®¤ï¼ˆä½ç½®ä¿¡åº¦ï¼‰
        logger.warning(f"æœªæ˜ç¡®åŒ¹é…ï¼Œé»˜è®¤ç¡®è®¤: {text}")
        return ConfirmationEvent.USER_CONFIRM.value
```

### 5.3 ç¡®è®¤å¤„ç†å™¨å®ç°

```python
# core/policy/confirmation/handler.py

from typing import Dict, Any, Optional
from datetime import datetime

from .state_machine import (
    ConfirmationStateMachine, 
    ConfirmationState,
    InvalidTransitionError
)
from .event_detector import EventDetector, ConfirmationEvent
from .context import ConfirmationContext, ConfirmationResult
from utils.logger import logger


class ConfirmationHandler:
    """ç¡®è®¤å¤„ç†å™¨ï¼ˆæ•´åˆçŠ¶æ€æœº + äº‹ä»¶æ£€æµ‹ï¼‰"""
    
    def __init__(self, nlu_engine, executor):
        """
        åˆå§‹åŒ–
        
        Args:
            nlu_engine: NLUå¼•æ“
            executor: ä¸šåŠ¡æ‰§è¡Œå™¨
        """
        # Layer 1: çŠ¶æ€æœº
        self.state_machine = ConfirmationStateMachine()
        
        # Layer 2: äº‹ä»¶æ£€æµ‹å™¨
        self.event_detector = EventDetector()
        
        # ä¾èµ–
        self.nlu = nlu_engine
        self.executor = executor
        
        logger.info("ç¡®è®¤å¤„ç†å™¨åˆå§‹åŒ–å®Œæˆ")
    
    def handle(self, user_input: str, 
               dialog_state: 'DialogState') -> ConfirmationResult:
        """
        å¤„ç†ç”¨æˆ·è¾“å…¥ï¼ˆä¸»å…¥å£ï¼‰
        
        Args:
            user_input: ç”¨æˆ·è¾“å…¥
            dialog_state: å¯¹è¯çŠ¶æ€
            
        Returns:
            ConfirmationResult: å¤„ç†ç»“æœ
        """
        logger.info(f"[ç¡®è®¤å¤„ç†] å¼€å§‹å¤„ç†: {user_input}")
        
        # æ„å»ºç¡®è®¤ä¸Šä¸‹æ–‡
        confirmation_ctx = self._build_context(dialog_state)
        
        # Step 1: æ£€æµ‹äº‹ä»¶ç±»å‹ï¼ˆLayer 2: ç®—æ³•ï¼‰
        try:
            event = self.event_detector.detect(user_input, confirmation_ctx)
            logger.info(f"æ£€æµ‹åˆ°äº‹ä»¶: {event}")
        except Exception as e:
            logger.error(f"äº‹ä»¶æ£€æµ‹å¤±è´¥: {e}")
            return ConfirmationResult(
                action="clarify",
                message="æ²¡å¬æ˜ç™½ï¼Œè¯·å›å¤"ç¡®è®¤"æˆ–"å–æ¶ˆ""
            )
        
        # Step 2: æ‰§è¡ŒçŠ¶æ€è½¬ç§»ï¼ˆLayer 1: çŠ¶æ€æœºï¼‰
        try:
            self.state_machine.transition(event, confirmation_ctx)
        except InvalidTransitionError as e:
            logger.error(f"çŠ¶æ€è½¬ç§»å¤±è´¥: {e}")
            return ConfirmationResult(
                action="clarify",
                message="æ“ä½œä¸åˆæ³•ï¼Œè¯·é‡æ–°æ“ä½œ"
            )
        
        # Step 3: æ ¹æ®æ–°çŠ¶æ€æ‰§è¡Œå¤„ç†ï¼ˆLayer 3: ä¸šåŠ¡ï¼‰
        new_state = self.state_machine.current_state
        return self._handle_by_state(new_state, user_input, dialog_state)
    
    def _build_context(self, dialog_state: 'DialogState') -> Dict:
        """æ„å»ºç¡®è®¤ä¸Šä¸‹æ–‡"""
        return {
            "intent": dialog_state.confirmation_intent,
            "parameters": dialog_state.confirmation_slots,
            "created_at": dialog_state.confirmation_timestamp,
            "inquiry_count": 0
        }
    
    def _handle_by_state(self, state: ConfirmationState,
                        user_input: str,
                        dialog_state: 'DialogState') -> ConfirmationResult:
        """
        æ ¹æ®çŠ¶æ€æ‰§è¡Œå¤„ç†
        
        Args:
            state: å½“å‰çŠ¶æ€
            user_input: ç”¨æˆ·è¾“å…¥
            dialog_state: å¯¹è¯çŠ¶æ€
            
        Returns:
            ConfirmationResult: å¤„ç†ç»“æœ
        """
        handlers = {
            ConfirmationState.EXECUTING: self._handle_executing,
            ConfirmationState.INQUIRING: self._handle_inquiring,
            ConfirmationState.CANCELLED: self._handle_cancelled,
            ConfirmationState.TIMEOUT: self._handle_timeout,
            ConfirmationState.IDLE: self._handle_idle,
        }
        
        handler = handlers.get(state)
        if handler:
            return handler(user_input, dialog_state)
        
        # é»˜è®¤
        return ConfirmationResult(
            action="inform",
            message="å¤„ç†å®Œæˆ"
        )
    
    def _handle_executing(self, user_input: str,
                         dialog_state: 'DialogState') -> ConfirmationResult:
        """å¤„ç†æ‰§è¡ŒçŠ¶æ€"""
        logger.info("[çŠ¶æ€å¤„ç†] EXECUTING")
        
        # æ‰§è¡Œä¸šåŠ¡
        result = self.executor.execute_function(
            dialog_state.confirmation_intent,
            dialog_state.confirmation_slots
        )
        
        # æ ¹æ®ç»“æœè½¬ç§»çŠ¶æ€
        if result.get("success"):
            self.state_machine.transition("success")
            return ConfirmationResult(
                action="confirm_executed",
                result=result,
                clear_confirmation=True
            )
        else:
            self.state_machine.transition("failure")
            return ConfirmationResult(
                action="execute_failed",
                message=f"æŠ±æ­‰ï¼Œ{result.get('error', 'æ‰§è¡Œå¤±è´¥')}",
                clear_confirmation=True
            )
    
    def _handle_inquiring(self, user_input: str,
                         dialog_state: 'DialogState') -> ConfirmationResult:
        """å¤„ç†å’¨è¯¢çŠ¶æ€ï¼ˆå…³é”®ï¼‰"""
        logger.info("[çŠ¶æ€å¤„ç†] INQUIRING")
        
        # 1. æå–å’¨è¯¢æ„å›¾
        inquiry_intent = self._extract_inquiry_intent(user_input)
        
        # 2. æå–å’¨è¯¢å‚æ•°ï¼ˆåˆ©ç”¨ç¡®è®¤ä¸Šä¸‹æ–‡ï¼‰
        inquiry_params = self._extract_inquiry_params(
            user_input,
            dialog_state
        )
        
        # 3. æ‰§è¡Œå’¨è¯¢
        inquiry_result = self.executor.execute_function(
            inquiry_intent,
            inquiry_params
        )
        
        # 4. ç”Ÿæˆæé†’
        reminder = self._generate_reminder(dialog_state)
        
        # 5. è½¬ç§»å›å¾…ç¡®è®¤çŠ¶æ€
        self.state_machine.transition("inquiry_answered")
        
        return ConfirmationResult(
            action="inquiry_answered",
            result=inquiry_result,
            reminder=reminder,
            clear_confirmation=False  # ğŸ”¥ ä¸æ¸…é™¤ç¡®è®¤æ€
        )
    
    def _handle_cancelled(self, user_input: str,
                         dialog_state: 'DialogState') -> ConfirmationResult:
        """å¤„ç†å–æ¶ˆçŠ¶æ€"""
        logger.info("[çŠ¶æ€å¤„ç†] CANCELLED")
        
        # è‡ªåŠ¨è¿”å›IDLE
        self.state_machine.reset()
        
        return ConfirmationResult(
            action="cancelled",
            message="å·²å–æ¶ˆæ“ä½œã€‚è¿˜æœ‰ä»€ä¹ˆå¯ä»¥å¸®æ‚¨çš„å—ï¼Ÿ",
            clear_confirmation=True
        )
    
    def _handle_timeout(self, user_input: str,
                       dialog_state: 'DialogState') -> ConfirmationResult:
        """å¤„ç†è¶…æ—¶çŠ¶æ€"""
        logger.info("[çŠ¶æ€å¤„ç†] TIMEOUT")
        
        # è‡ªåŠ¨è¿”å›IDLE
        self.state_machine.reset()
        
        return ConfirmationResult(
            action="timeout",
            message="ç¡®è®¤å·²è¶…æ—¶ï¼Œè¯·é‡æ–°æ“ä½œã€‚è¿˜æœ‰ä»€ä¹ˆå¯ä»¥å¸®æ‚¨çš„å—ï¼Ÿ",
            clear_confirmation=True
        )
    
    def _handle_idle(self, user_input: str,
                    dialog_state: 'DialogState') -> ConfirmationResult:
        """å¤„ç†ç©ºé—²çŠ¶æ€ï¼ˆæ–°è¯é¢˜ï¼‰"""
        logger.info("[çŠ¶æ€å¤„ç†] IDLE")
        
        return ConfirmationResult(
            action="new_topic",
            message="æ”¶åˆ°ï¼Œä¸ºæ‚¨å¤„ç†æ–°çš„è¯·æ±‚",
            clear_confirmation=True
        )
    
    def _extract_inquiry_intent(self, user_input: str) -> str:
        """æå–å’¨è¯¢æ„å›¾"""
        # å¥—é¤è¯¦æƒ…
        if any(kw in user_input for kw in ["ä»‹ç»", "è¯¦æƒ…", "è¯´æ˜"]):
            return "query_package_detail"
        
        # ä»·æ ¼å’¨è¯¢
        if "ä»·æ ¼" in user_input or "å¤šå°‘é’±" in user_input:
            return "query_package_detail"
        
        # æµç¨‹å’¨è¯¢
        if "æµç¨‹" in user_input or "æ€ä¹ˆåŠ" in user_input:
            return "business_consultation"
        
        # é»˜è®¤
        return "query_package_detail"
    
    def _extract_inquiry_params(self, user_input: str,
                                dialog_state: 'DialogState') -> Dict:
        """æå–å’¨è¯¢å‚æ•°ï¼ˆä»ä¸Šä¸‹æ–‡è¡¥å……ï¼‰"""
        params = {}
        
        # å°è¯•ä»ç”¨æˆ·è¾“å…¥æå–
        nlu_result = self.nlu.understand(user_input, "temp_inquiry")
        if nlu_result.parameters:
            params.update(nlu_result.parameters)
        
        # ğŸ”¥ ä»ç¡®è®¤ä¸Šä¸‹æ–‡è¡¥å……ï¼ˆå…³é”®ï¼‰
        if "package_name" not in params:
            pending_package = dialog_state.confirmation_slots.get("new_package_name")
            if pending_package:
                params["package_name"] = pending_package
                logger.info(f"ä»ç¡®è®¤ä¸Šä¸‹æ–‡è¡¥å……: package_name={pending_package}")
        
        return params
    
    def _generate_reminder(self, dialog_state: 'DialogState') -> str:
        """ç”Ÿæˆç¡®è®¤æé†’"""
        intent = dialog_state.confirmation_intent
        params = dialog_state.confirmation_slots
        
        if intent == "change_package":
            package = params.get("new_package_name")
            phone = params.get("phone", "æ‚¨")
            return (f"ğŸ’¡ æé†’ï¼šå¾…ç¡®è®¤ä¸º {phone} åŠç†ã€{package}ã€‘ï¼Œ"
                   f"ç¡®è®¤è¯·å›å¤\"ç¡®è®¤\"ï¼Œå–æ¶ˆè¯·å›å¤\"å–æ¶ˆ\"")
        
        return "ğŸ’¡ æé†’ï¼šä»æœ‰å¾…ç¡®è®¤çš„æ“ä½œï¼Œç¡®è®¤è¯·å›å¤\"ç¡®è®¤\""
```

### 5.4 æ•°æ®ç»“æ„

```python
# core/policy/confirmation/context.py

from dataclasses import dataclass, field
from datetime import datetime
from typing import Dict, Any, Optional, List


@dataclass
class ConfirmationContext:
    """ç¡®è®¤ä¸Šä¸‹æ–‡"""
    intent: str                            # å¾…ç¡®è®¤æ„å›¾
    parameters: Dict[str, Any]             # å¾…ç¡®è®¤å‚æ•°
    created_at: datetime                   # åˆ›å»ºæ—¶é—´
    inquiry_count: int = 0                 # å’¨è¯¢æ¬¡æ•°
    inquiry_history: List[Dict] = field(default_factory=list)  # å’¨è¯¢å†å²


@dataclass
class ConfirmationResult:
    """ç¡®è®¤å¤„ç†ç»“æœ"""
    action: str                            # åŠ¨ä½œç±»å‹
    message: str = ""                      # å“åº”æ¶ˆæ¯
    result: Optional[Dict] = None          # æ‰§è¡Œç»“æœ
    reminder: str = ""                     # æé†’ä¿¡æ¯
    clear_confirmation: bool = False       # æ˜¯å¦æ¸…é™¤ç¡®è®¤æ€
```

---

## å…­ã€é›†æˆæ–¹æ¡ˆ

### 6.1 æ–‡ä»¶ç»“æ„

```
telecom_chatbot/
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ policy/
â”‚   â”‚   â”œâ”€â”€ confirmation/              â† ğŸ†• æ–°å¢ç›®å½•
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”œâ”€â”€ state_machine.py       â† çŠ¶æ€æœº
â”‚   â”‚   â”‚   â”œâ”€â”€ event_detector.py      â† äº‹ä»¶æ£€æµ‹
â”‚   â”‚   â”‚   â”œâ”€â”€ handler.py             â† å¤„ç†å™¨
â”‚   â”‚   â”‚   â””â”€â”€ context.py             â† æ•°æ®ç»“æ„
â”‚   â”‚   â”œâ”€â”€ policy_engine.py
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ chatbot_policy.py              â† ğŸ“ ä¿®æ”¹
â”‚   â””â”€â”€ ...
â””â”€â”€ tests/
    â”œâ”€â”€ test_confirmation_state_machine.py  â† ğŸ†• æ–°å¢
    â”œâ”€â”€ test_confirmation_flow.py           â† ğŸ†• æ–°å¢
    â””â”€â”€ ...
```

### 6.2 é›†æˆæ­¥éª¤

#### æ­¥éª¤1ï¼šåˆ›å»ºç¡®è®¤æ¨¡å—

**1.1 åˆ›å»ºç›®å½•ç»“æ„**

```bash
mkdir -p core/policy/confirmation
touch core/policy/confirmation/__init__.py
touch core/policy/confirmation/state_machine.py
touch core/policy/confirmation/event_detector.py
touch core/policy/confirmation/handler.py
touch core/policy/confirmation/context.py
```

**1.2 å¤åˆ¶ä»£ç **

å°†ç¬¬äº”ç« çš„ä»£ç åˆ†åˆ«å¤åˆ¶åˆ°å¯¹åº”æ–‡ä»¶ï¼š
- `state_machine.py` - çŠ¶æ€æœºå®ç°
- `event_detector.py` - äº‹ä»¶æ£€æµ‹å™¨å®ç°
- `handler.py` - ç¡®è®¤å¤„ç†å™¨å®ç°
- `context.py` - æ•°æ®ç»“æ„

**1.3 å®Œå–„ `__init__.py`**

```python
# core/policy/confirmation/__init__.py

from .state_machine import (
    ConfirmationState,
    ConfirmationStateMachine,
    InvalidTransitionError
)

from .event_detector import (
    ConfirmationEvent,
    EventDetector
)

from .handler import ConfirmationHandler

from .context import (
    ConfirmationContext,
    ConfirmationResult
)

__all__ = [
    # çŠ¶æ€æœº
    'ConfirmationState',
    'ConfirmationStateMachine',
    'InvalidTransitionError',
    
    # äº‹ä»¶æ£€æµ‹
    'ConfirmationEvent',
    'EventDetector',
    
    # å¤„ç†å™¨
    'ConfirmationHandler',
    
    # æ•°æ®ç»“æ„
    'ConfirmationContext',
    'ConfirmationResult',
]
```

#### æ­¥éª¤2ï¼šä¿®æ”¹ chatbot_policy.py

**2.1 å¯¼å…¥æ–°æ¨¡å—**

```python
# åœ¨æ–‡ä»¶é¡¶éƒ¨æ·»åŠ 
from core.policy.confirmation import (
    ConfirmationHandler,
    ConfirmationState
)
```

**2.2 åˆå§‹åŒ–å¤„ç†å™¨**

```python
class TelecomChatbotPolicy:
    def __init__(self):
        # ç¬¬ä¸€é˜¶æ®µï¼šNLU
        self.nlu = NLUEngine()
        
        # ç¬¬äºŒé˜¶æ®µï¼šDST
        self.dst = DialogStateTracker()
        
        # ç¬¬ä¸‰é˜¶æ®µï¼šPolicy + NLG
        self.policy = PolicyEngine()
        self.nlg = NLGGenerator()
        
        # ğŸ†• æ–°å¢ï¼šç¡®è®¤å¤„ç†å™¨ï¼ˆçŠ¶æ€æœº + è§„åˆ™ï¼‰
        self.confirmation_handler = ConfirmationHandler(
            nlu_engine=self.nlu,
            executor=self.db_executor
        )
        
        # é«˜çº§ç‰¹æ€§
        self.recommendation = RecommendationEngine()
        
        # æ‰§è¡Œå™¨
        self.db_executor = DatabaseExecutor()
        
        # ç¼“å­˜
        self.cache = ResponseCache(ttl=300, max_size=1000)
        
        logger.info("=" * 60)
        logger.info("ç¬¬ä¸‰é˜¶æ®µå¯¹è¯ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼ˆçŠ¶æ€æœº + è§„åˆ™ï¼‰")
        logger.info("=" * 60)
```

**2.3 ä¿®æ”¹ chat() æ–¹æ³•**

```python
def chat(self, user_input: str, session_id: Optional[str] = None,
         user_phone: Optional[str] = None) -> Dict[str, Any]:
    """å¤„ç†ç”¨æˆ·è¾“å…¥"""
    
    start_time = datetime.now()
    
    if not session_id:
        session_id = str(uuid.uuid4())
    
    logger.info(f"\n{'=' * 60}")
    logger.info(f"[{session_id}] æ”¶åˆ°ç”¨æˆ·è¾“å…¥: {user_input}")
    logger.info(f"{'=' * 60}")
    
    try:
        # åŠ è½½çŠ¶æ€
        current_state = self.dst.get_state(session_id)
        
        # ========== ğŸ”¥ å…³é”®ï¼šç¡®è®¤æ€å¤„ç† ==========
        if current_state.pending_confirmation:
            logger.info("ã€æ£€æµ‹åˆ°ç¡®è®¤æ€ã€‘å¯ç”¨çŠ¶æ€æœºå¤„ç†å™¨")
            
            # è¶…æ—¶æ£€æŸ¥
            if current_state.is_confirmation_expired():
                logger.warning("ç¡®è®¤å·²è¶…æ—¶")
                current_state.clear_pending_confirmation()
                self.dst.state_store.save(session_id, current_state)
                
                return {
                    "session_id": session_id,
                    "response": "ç¡®è®¤å·²è¶…æ—¶ï¼Œè¯·é‡æ–°æ“ä½œã€‚è¿˜æœ‰ä»€ä¹ˆå¯ä»¥å¸®æ‚¨çš„å—ï¼Ÿ",
                    "action": "INFORM",
                    "requires_confirmation": False,
                    "timestamp": datetime.now().isoformat()
                }
            
            # ğŸ†• ä½¿ç”¨çŠ¶æ€æœºå¤„ç†å™¨
            confirmation_result = self.confirmation_handler.handle(
                user_input,
                current_state
            )
            
            # æ„å»ºå“åº”
            return self._build_confirmation_response(
                confirmation_result,
                session_id,
                current_state,
                user_input
            )
        
        # ========== æ­£å¸¸æµç¨‹ï¼ˆä¿æŒä¸å˜ï¼‰==========
        logger.info("ã€é˜¶æ®µ1ã€‘NLUç†è§£...")
        nlu_result = self.nlu.understand(user_input, session_id, user_phone)
        nlu_result.raw_input = user_input
        logger.info(f"âœ“ NLUå®Œæˆ: intent={nlu_result.intent}")
        
        # ... åç»­æµç¨‹ä¿æŒä¸å˜
        
    except Exception as e:
        logger.error(f"[{session_id}] å¤„ç†å¼‚å¸¸: {e}", exc_info=True)
        return {
            "session_id": session_id,
            "response": "æŠ±æ­‰ï¼Œç³»ç»Ÿé‡åˆ°äº†é—®é¢˜ï¼Œè¯·ç¨åå†è¯•",
            "action": "APOLOGIZE",
            "timestamp": datetime.now().isoformat()
        }
```

**2.4 æ·»åŠ å“åº”æ„å»ºæ–¹æ³•**

```python
def _build_confirmation_response(
    self,
    result: ConfirmationResult,
    session_id: str,
    state: DialogState,
    user_input: str
) -> Dict[str, Any]:
    """
    æ„å»ºç¡®è®¤å“åº”
    
    Args:
        result: ç¡®è®¤å¤„ç†ç»“æœ
        session_id: ä¼šè¯ID
        state: å¯¹è¯çŠ¶æ€
        user_input: ç”¨æˆ·è¾“å…¥
        
    Returns:
        Dict: å“åº”å­—å…¸
    """
    action = result.action
    
    # ========== åœºæ™¯1: å’¨è¯¢å·²å›ç­” ==========
    if action == "inquiry_answered":
        logger.info("ã€åœºæ™¯ã€‘å’¨è¯¢å·²å›ç­”ï¼Œä¿æŒç¡®è®¤æ€")
        
        # æ ¼å¼åŒ–å’¨è¯¢ç»“æœ
        inquiry_result = result.result
        if inquiry_result and inquiry_result.get("success"):
            response_text = self._format_inquiry_response(inquiry_result)
        else:
            response_text = f"æŠ±æ­‰ï¼Œ{inquiry_result.get('error', 'æŸ¥è¯¢å¤±è´¥') if inquiry_result else 'æŸ¥è¯¢å¤±è´¥'}"
        
        # æ·»åŠ æé†’
        response_text += "\n\n" + result.reminder
        
        # æ›´æ–°çŠ¶æ€ï¼ˆä¿æŒç¡®è®¤æ€ï¼‰
        state.add_turn('assistant', response_text)
        self.dst.state_store.save(session_id, state)
        
        return {
            "session_id": session_id,
            "response": response_text,
            "action": "INFORM_WITH_REMINDER",
            "requires_confirmation": True,  # ğŸ”¥ ä»éœ€ç¡®è®¤
            "data": inquiry_result,
            "state": {
                "turn_count": state.turn_count,
                "pending_confirmation": True
            },
            "metadata": {
                "timestamp": datetime.now().isoformat()
            }
        }
    
    # ========== åœºæ™¯2: ç¡®è®¤æ‰§è¡Œ ==========
    elif action == "confirm_executed":
        logger.info("ã€åœºæ™¯ã€‘ç¡®è®¤æ‰§è¡Œ")
        
        exec_result = result.result
        
        # ç”Ÿæˆå›å¤
        if exec_result and exec_result.get("success"):
            action_obj = Action(
                action_type=ActionType.INFORM,
                intent=state.confirmation_intent,
                parameters=exec_result
            )
            response_text = self.nlg.generate(action_obj, state)
        else:
            response_text = f"æŠ±æ­‰ï¼Œ{exec_result.get('error', 'å¤„ç†å¤±è´¥') if exec_result else 'å¤„ç†å¤±è´¥'}"
        
        # æ¸…é™¤ç¡®è®¤æ€
        if result.clear_confirmation:
            state.clear_pending_confirmation()
        
        state.add_turn('assistant', response_text)
        self.dst.state_store.save(session_id, state)
        
        return {
            "session_id": session_id,
            "response": response_text,
            "action": "INFORM",
            "requires_confirmation": False,
            "data": exec_result,
            "state": {
                "turn_count": state.turn_count,
                "pending_confirmation": False
            },
            "metadata": {
                "timestamp": datetime.now().isoformat()
            }
        }
    
    # ========== åœºæ™¯3: å–æ¶ˆ ==========
    elif action == "cancelled":
        logger.info("ã€åœºæ™¯ã€‘ç”¨æˆ·å–æ¶ˆ")
        
        response_text = result.message
        
        # æ¸…é™¤ç¡®è®¤æ€
        if result.clear_confirmation:
            state.clear_pending_confirmation()
        
        state.add_turn('assistant', response_text)
        self.dst.state_store.save(session_id, state)
        
        return {
            "session_id": session_id,
            "response": response_text,
            "action": "INFORM",
            "requires_confirmation": False,
            "state": {
                "turn_count": state.turn_count,
                "pending_confirmation": False
            },
            "metadata": {
                "timestamp": datetime.now().isoformat()
            }
        }
    
    # ========== åœºæ™¯4: æ–°è¯é¢˜ ==========
    elif action == "new_topic":
        logger.info("ã€åœºæ™¯ã€‘æ–°è¯é¢˜ï¼Œæ¸…é™¤ç¡®è®¤æ€")
        
        # æ¸…é™¤ç¡®è®¤æ€
        state.clear_pending_confirmation()
        self.dst.state_store.save(session_id, state)
        
        # é‡æ–°å¤„ç†
        return self.chat(user_input, session_id)
    
    # ========== åœºæ™¯5: æ¾„æ¸… ==========
    elif action == "clarify":
        logger.warning("ã€åœºæ™¯ã€‘éœ€è¦æ¾„æ¸…")
        
        return {
            "session_id": session_id,
            "response": result.message,
            "action": "CLARIFY",
            "requires_confirmation": True,
            "state": {
                "turn_count": state.turn_count,
                "pending_confirmation": True
            },
            "metadata": {
                "timestamp": datetime.now().isoformat()
            }
        }
    
    # ========== é»˜è®¤ ==========
    else:
        logger.error(f"æœªçŸ¥çš„ç¡®è®¤åŠ¨ä½œ: {action}")
        return {
            "session_id": session_id,
            "response": "æŠ±æ­‰ï¼Œå¤„ç†å‡ºç°é—®é¢˜",
            "action": "ERROR",
            "requires_confirmation": False,
            "timestamp": datetime.now().isoformat()
        }

def _format_inquiry_response(self, result: Dict) -> str:
    """æ ¼å¼åŒ–å’¨è¯¢å“åº”ï¼ˆå¤ç”¨ç°æœ‰é€»è¾‘ï¼‰"""
    if not result.get("success"):
        return f"æŠ±æ­‰ï¼Œ{result.get('error', 'æŸ¥è¯¢å¤±è´¥')}"
    
    data = result.get("data", {})
    
    # å¥—é¤è¯¦æƒ…
    if isinstance(data, dict) and "name" in data:
        return self._format_package_detail_response({"data": data})
    
    # å¥—é¤åˆ—è¡¨
    if isinstance(data, list):
        return self._format_packages_response(result)
    
    return "æŸ¥è¯¢å®Œæˆ"
```

### 6.3 ç§»é™¤æ—§ä»£ç ï¼ˆå¯é€‰ï¼‰

å¯ä»¥ç§»é™¤æˆ–æ³¨é‡Š `chatbot_policy.py` ä¸­çš„ï¼š
- `_is_confirmation_word()`
- `_is_cancellation_word()`
- `_handle_confirmation_response()`

**å»ºè®®**ï¼šå…ˆæ³¨é‡Šï¼ŒéªŒè¯æ— é—®é¢˜åå†åˆ é™¤ã€‚

---

## ä¸ƒã€æµ‹è¯•æ–¹æ¡ˆ

### 7.1 å•å…ƒæµ‹è¯•

#### æµ‹è¯•çŠ¶æ€æœº

```python
# tests/test_confirmation_state_machine.py

import pytest
from core.policy.confirmation import (
    ConfirmationStateMachine,
    ConfirmationState,
    InvalidTransitionError
)


class TestStateMachine:
    """æµ‹è¯•çŠ¶æ€æœº"""
    
    def test_initial_state(self):
        """æµ‹è¯•åˆå§‹çŠ¶æ€"""
        sm = ConfirmationStateMachine()
        assert sm.current_state == ConfirmationState.IDLE
    
    def test_trigger_confirmation(self):
        """æµ‹è¯•è§¦å‘ç¡®è®¤"""
        sm = ConfirmationStateMachine()
        sm.transition("trigger_confirmation")
        assert sm.current_state == ConfirmationState.PENDING
    
    def test_user_confirm(self):
        """æµ‹è¯•ç”¨æˆ·ç¡®è®¤"""
        sm = ConfirmationStateMachine()
        sm.transition("trigger_confirmation")
        sm.transition("user_confirm")
        assert sm.current_state == ConfirmationState.EXECUTING
    
    def test_user_inquiry(self):
        """æµ‹è¯•ç”¨æˆ·å’¨è¯¢"""
        sm = ConfirmationStateMachine()
        sm.transition("trigger_confirmation")
        sm.transition("user_inquiry")
        assert sm.current_state == ConfirmationState.INQUIRING
    
    def test_inquiry_back_to_pending(self):
        """æµ‹è¯•å’¨è¯¢åè¿”å›å¾…ç¡®è®¤"""
        sm = ConfirmationStateMachine()
        sm.transition("trigger_confirmation")
        sm.transition("user_inquiry")
        sm.transition("inquiry_answered")
        assert sm.current_state == ConfirmationState.PENDING
    
    def test_invalid_transition(self):
        """æµ‹è¯•éæ³•è½¬ç§»"""
        sm = ConfirmationStateMachine()
        # IDLE ä¸èƒ½ç›´æ¥ user_confirm
        with pytest.raises(InvalidTransitionError):
            sm.transition("user_confirm")
    
    def test_can_transition(self):
        """æµ‹è¯•è½¬ç§»æ£€æŸ¥"""
        sm = ConfirmationStateMachine()
        assert sm.can_transition("trigger_confirmation")
        assert not sm.can_transition("user_confirm")
```

#### æµ‹è¯•äº‹ä»¶æ£€æµ‹

```python
# tests/test_confirmation_event_detector.py

import pytest
from core.policy.confirmation import EventDetector


@pytest.fixture
def detector():
    return EventDetector()


@pytest.fixture
def confirmation_ctx():
    return {
        "intent": "change_package",
        "parameters": {
            "new_package_name": "æ— é™å¥—é¤",
            "phone": "13800000000"
        }
    }


class TestEventDetector:
    """æµ‹è¯•äº‹ä»¶æ£€æµ‹"""
    
    def test_pure_confirmation(self, detector, confirmation_ctx):
        """æµ‹è¯•çº¯ç¡®è®¤è¯"""
        cases = ["ç¡®è®¤", "ç¡®å®š", "æ˜¯çš„", "å¥½çš„", "å¯ä»¥"]
        for text in cases:
            event = detector.detect(text, confirmation_ctx)
            assert event == "user_confirm"
    
    def test_pure_cancellation(self, detector, confirmation_ctx):
        """æµ‹è¯•çº¯å–æ¶ˆè¯"""
        cases = ["å–æ¶ˆ", "ä¸è¦", "ç®—äº†", "ä¸åŠ"]
        for text in cases:
            event = detector.detect(text, confirmation_ctx)
            assert event == "user_deny"
    
    def test_related_inquiry(self, detector, confirmation_ctx):
        """æµ‹è¯•ç›¸å…³å’¨è¯¢"""
        cases = [
            "å…ˆä»‹ç»ä¸‹æ— é™å¥—é¤",
            "æ— é™å¥—é¤ä»·æ ¼å¤šå°‘",
            "å¥—é¤åŒ…å«ä»€ä¹ˆ"
        ]
        for text in cases:
            event = detector.detect(text, confirmation_ctx)
            assert event == "user_inquiry"
    
    def test_new_topic(self, detector, confirmation_ctx):
        """æµ‹è¯•æ–°è¯é¢˜"""
        cases = [
            "æŸ¥è¯¢æˆ‘çš„ä½™é¢",
            "æˆ‘è¦æŸ¥æµé‡ä½¿ç”¨",
            "å¸®æˆ‘çœ‹çœ‹å½“å‰å¥—é¤"
        ]
        for text in cases:
            event = detector.detect(text, confirmation_ctx)
            assert event == "user_new_topic"
    
    def test_consultation_not_confirmation(self, detector, confirmation_ctx):
        """æµ‹è¯•å’¨è¯¢ä¸è¢«è¯¯åˆ¤ï¼ˆé‡è¦ï¼‰"""
        cases = [
            "åŠç†æµç¨‹",
            "æ€ä¹ˆåŠç†",
            "éœ€è¦ä»€ä¹ˆæ¡ä»¶"
        ]
        for text in cases:
            event = detector.detect(text, confirmation_ctx)
            # åº”è¯¥è¢«è¯†åˆ«ä¸ºå’¨è¯¢æˆ–æ–°è¯é¢˜ï¼Œè€Œä¸æ˜¯ç¡®è®¤
            assert event != "user_confirm"
```

### 7.2 é›†æˆæµ‹è¯•

```python
# tests/test_confirmation_flow.py

import pytest
from core.chatbot_policy import TelecomChatbotPolicy


@pytest.fixture
def chatbot():
    return TelecomChatbotPolicy()


class TestConfirmationFlow:
    """æµ‹è¯•å®Œæ•´ç¡®è®¤æµç¨‹"""
    
    def test_simple_confirmation(self, chatbot):
        """æµ‹è¯•ç®€å•ç¡®è®¤"""
        sid = "test_simple"
        
        # è½®1: æŸ¥è¯¢å¥—é¤
        r1 = chatbot.chat("æœ‰å“ªäº›å¥—é¤", sid)
        assert "å¥—é¤" in r1["response"]
        
        # è½®2: åŠç†å¥—é¤
        r2 = chatbot.chat("åŠç†ç»æµå¥—é¤ï¼Œæ‰‹æœºå·13800000000", sid)
        assert r2.get("requires_confirmation") == True
        
        # è½®3: ç¡®è®¤
        r3 = chatbot.chat("ç¡®è®¤åŠç†", sid)
        assert r3.get("requires_confirmation") == False
        assert ("æˆåŠŸ" in r3["response"] or "ç”Ÿæ•ˆ" in r3["response"])
    
    def test_confirmation_with_inquiry(self, chatbot):
        """æµ‹è¯•ç¡®è®¤ä¸­å’¨è¯¢ï¼ˆæ ¸å¿ƒï¼‰"""
        sid = "test_inquiry"
        
        # è½®1: åŠç†å¥—é¤
        r1 = chatbot.chat("åŠç†æ— é™å¥—é¤ï¼Œæ‰‹æœºå·13800000000", sid)
        assert r1.get("requires_confirmation") == True
        
        # è½®2: å’¨è¯¢ï¼ˆå…³é”®ï¼‰
        r2 = chatbot.chat("é‚£å…ˆä»‹ç»ä¸‹æ— é™å¥—é¤ä¿¡æ¯", sid)
        assert r2.get("requires_confirmation") == True  # ğŸ”¥ ä»éœ€ç¡®è®¤
        assert "æ— é™å¥—é¤" in r2["response"]
        assert ("æé†’" in r2["response"] or "ğŸ’¡" in r2["response"])
        
        # è½®3: ç¡®è®¤
        r3 = chatbot.chat("ç¡®è®¤åŠç†", sid)
        assert r3.get("requires_confirmation") == False
        assert ("æˆåŠŸ" in r3["response"] or "ç”Ÿæ•ˆ" in r3["response"])
    
    def test_confirmation_cancelled(self, chatbot):
        """æµ‹è¯•å–æ¶ˆ"""
        sid = "test_cancel"
        
        # è½®1: åŠç†
        r1 = chatbot.chat("åŠç†æ— é™å¥—é¤ï¼Œæ‰‹æœºå·13800000000", sid)
        assert r1.get("requires_confirmation") == True
        
        # è½®2: å–æ¶ˆ
        r2 = chatbot.chat("ç®—äº†ä¸åŠäº†", sid)
        assert r2.get("requires_confirmation") == False
        assert "å–æ¶ˆ" in r2["response"]
    
    def test_new_topic_clears_confirmation(self, chatbot):
        """æµ‹è¯•æ–°è¯é¢˜æ¸…é™¤ç¡®è®¤æ€"""
        sid = "test_new"
        
        # è½®1: åŠç†
        r1 = chatbot.chat("åŠç†æ— é™å¥—é¤ï¼Œæ‰‹æœºå·13800000000", sid)
        assert r1.get("requires_confirmation") == True
        
        # è½®2: æ–°è¯é¢˜
        r2 = chatbot.chat("æŸ¥è¯¢æˆ‘çš„æµé‡ä½¿ç”¨æƒ…å†µ", sid)
        assert r2.get("requires_confirmation") == False
        assert ("æµé‡" in r2["response"] or "æŸ¥è¯¢" in r2["response"])
```

### 7.3 æ‰‹åŠ¨æµ‹è¯•æ¸…å•

| åœºæ™¯ | è¾“å…¥åºåˆ— | æœŸæœ›è¾“å‡º | é€šè¿‡? |
|------|---------|---------|-------|
| ç®€å•ç¡®è®¤ | 1. åŠç†ç»æµå¥—é¤<br>2. ç¡®è®¤ | åŠç†æˆåŠŸ | â˜ |
| ç®€å•å–æ¶ˆ | 1. åŠç†ç»æµå¥—é¤<br>2. å–æ¶ˆ | å·²å–æ¶ˆ | â˜ |
| ç¡®è®¤ä¸­å’¨è¯¢ | 1. åŠç†æ— é™å¥—é¤<br>2. ä»‹ç»ä¸‹<br>3. ç¡®è®¤ | å›ç­”+æé†’â†’æˆåŠŸ | â˜ |
| æ–°è¯é¢˜ | 1. åŠç†ç»æµå¥—é¤<br>2. æŸ¥è¯¢ä½™é¢ | æ¸…é™¤ç¡®è®¤æ€ | â˜ |
| å’¨è¯¢ä¸è¯¯åˆ¤ | 1. åŠç†ç»æµå¥—é¤<br>2. åŠç†æµç¨‹ | å›ç­”æµç¨‹+ä¿æŒç¡®è®¤ | â˜ |
| è¶…æ—¶ | 1. åŠç†ç»æµå¥—é¤<br>2. (ç­‰6åˆ†é’Ÿ)<br>3. ç¡®è®¤ | æç¤ºè¶…æ—¶ | â˜ |
| å¤šæ¬¡å’¨è¯¢ | 1. åŠç†æ— é™å¥—é¤<br>2. ä»·æ ¼å¤šå°‘<br>3. åŒ…å«ä»€ä¹ˆ<br>4. ç¡®è®¤ | å…¨éƒ¨å›ç­”+æˆåŠŸ | â˜ |

---

## å…«ã€ä¸Šçº¿è®¡åˆ’

### 8.1 å¼€å‘é˜¶æ®µï¼ˆWeek 1-2.5ï¼‰

#### Week 1: çŠ¶æ€æœºæ¡†æ¶

**Day 1-2**
- [ ] åˆ›å»ºç›®å½•ç»“æ„
- [ ] å®ç°çŠ¶æ€æœºæ ¸å¿ƒä»£ç 
- [ ] ç¼–å†™çŠ¶æ€æœºå•å…ƒæµ‹è¯•

**Day 3-4**
- [ ] å®ç°äº‹ä»¶æ£€æµ‹å™¨
- [ ] ç¼–å†™äº‹ä»¶æ£€æµ‹å•å…ƒæµ‹è¯•

**Day 5**
- [ ] å®ç°ç¡®è®¤å¤„ç†å™¨
- [ ] æ•´åˆçŠ¶æ€æœº + äº‹ä»¶æ£€æµ‹

#### Week 2: é›†æˆä¸å®Œå–„

**Day 1-2**
- [ ] ä¿®æ”¹ chatbot_policy.py
- [ ] æ·»åŠ å“åº”æ„å»ºæ–¹æ³•
- [ ] é›†æˆæµ‹è¯•

**Day 3-4**
- [ ] å®Œå–„è¾¹ç•Œcaseå¤„ç†
- [ ] ä¼˜åŒ–æ—¥å¿—å’Œå¼‚å¸¸å¤„ç†
- [ ] æ‰‹åŠ¨æµ‹è¯•

**Day 5**
- [ ] Bugä¿®å¤
- [ ] ä»£ç Review

#### Week 2.5: æµ‹è¯•ä¼˜åŒ–

**Day 1-2**
- [ ] å®Œæ•´æµ‹è¯•å¥—ä»¶
- [ ] è¾¹ç•Œcaseæµ‹è¯•
- [ ] å‹åŠ›æµ‹è¯•

**Day 3**
- [ ] æ–‡æ¡£å®Œå–„
- [ ] éƒ¨ç½²å‡†å¤‡

### 8.2 ä¸Šçº¿é˜¶æ®µï¼ˆWeek 3ï¼‰

#### ç°åº¦å‘å¸ƒ

**Day 1**
- [ ] 10%æµé‡ç°åº¦
- [ ] ç›‘æ§å…³é”®æŒ‡æ ‡
- [ ] æ”¶é›†Badcase

**Day 2**
- [ ] åˆ†æç°åº¦æ•°æ®
- [ ] 30%æµé‡

**Day 3**
- [ ] 50%æµé‡

**Day 4**
- [ ] 100%å…¨é‡å‘å¸ƒ

**Day 5**
- [ ] ç›‘æ§ç¨³å®šæ€§
- [ ] æ€»ç»“ä¼˜åŒ–

### 8.3 ç›‘æ§æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | è¯´æ˜ |
|------|-------|------|
| ç¡®è®¤æˆåŠŸç‡ | â‰¥ 85% | ç”¨æˆ·ç¡®è®¤ / æ€»ç¡®è®¤è¯·æ±‚ |
| å–æ¶ˆç‡ | < 10% | ç”¨æˆ·å–æ¶ˆ / æ€»ç¡®è®¤è¯·æ±‚ |
| è¶…æ—¶ç‡ | < 5% | è¶…æ—¶ / æ€»ç¡®è®¤è¯·æ±‚ |
| å’¨è¯¢è¯†åˆ«å‡†ç¡®ç‡ | â‰¥ 85% | æ­£ç¡®è¯†åˆ«å’¨è¯¢ / æ€»å’¨è¯¢ |
| è¯¯åˆ¤ç‡ | < 3% | "åŠç†æµç¨‹"ç­‰è¯¯åˆ¤ |
| å¹³å‡ç¡®è®¤æ—¶é•¿ | < 15s | ä»ç¡®è®¤è¯·æ±‚åˆ°ç”¨æˆ·ç¡®è®¤ |

### 8.4 å›æ»šæœºåˆ¶

```python
# config/settings.py
CONFIRMATION_STATE_MACHINE_ENABLED = True  # çŠ¶æ€æœºå¼€å…³

# chatbot_policy.py
if settings.CONFIRMATION_STATE_MACHINE_ENABLED:
    # æ–°é€»è¾‘ï¼ˆçŠ¶æ€æœºï¼‰
    result = self.confirmation_handler.handle(...)
else:
    # æ—§é€»è¾‘ï¼ˆå…œåº•ï¼‰
    result = self._handle_confirmation_old(...)
```

---

## ä¹ã€å¸¸è§é—®é¢˜

### Q1: çŠ¶æ€æœºå’Œè§„åˆ™çš„å…³ç³»æ˜¯ä»€ä¹ˆï¼Ÿ

**A**: äº’è¡¥å…³ç³»ï¼Œä¸æ˜¯å¯¹ç«‹å…³ç³»ã€‚
- **çŠ¶æ€æœº**ï¼šæ¶æ„å±‚ï¼Œå®šä¹‰æœ‰å“ªäº›çŠ¶æ€ã€å¦‚ä½•è½¬ç§»
- **è§„åˆ™**ï¼šç®—æ³•å±‚ï¼Œåˆ¤æ–­åº”è¯¥è½¬ç§»åˆ°å“ªä¸ªçŠ¶æ€

### Q2: å¦‚ä½•è°ƒæ•´è¯é¢˜ç›¸å…³æ€§é˜ˆå€¼ï¼Ÿ

**A**: ä¿®æ”¹ `event_detector.py` ä¸­çš„è¯„åˆ†è§„åˆ™ï¼š
```python
# å½“å‰é˜ˆå€¼
is_related = score >= 0.5

# è°ƒæ•´å»ºè®®ï¼š
# - æé«˜åˆ° 0.6ï¼šå‡å°‘è¯¯åˆ¤
# - é™ä½åˆ° 0.4ï¼šæé«˜å¬å›
```

### Q3: å¦‚ä½•æ·»åŠ æ–°çŠ¶æ€ï¼Ÿ

**A**: ä¸‰æ­¥å®Œæˆï¼š
1. åœ¨ `ConfirmationState` æ·»åŠ æšä¸¾å€¼
2. åœ¨ `STATE_TRANSITIONS` æ·»åŠ è½¬ç§»è§„åˆ™
3. åœ¨ `ConfirmationHandler` æ·»åŠ å¤„ç†æ–¹æ³•

### Q4: å¦‚ä½•å¤„ç†å¤šæ¬¡å’¨è¯¢ï¼Ÿ

**A**: å·²å†…ç½®æ”¯æŒï¼ŒçŠ¶æ€æœºä¼šè®°å½•å’¨è¯¢å†å²ã€‚
å¯ä»¥è®¾ç½®ä¸Šé™ï¼š
```python
if context["inquiry_count"] >= 3:
    return "æ‚¨å·²å’¨è¯¢å¤šæ¬¡ï¼Œè¯·æ˜ç¡®æ˜¯å¦ç¡®è®¤"
```

### Q5: å¦‚ä½•å‡çº§åˆ°æ··åˆç®—æ³•ï¼Ÿ

**A**: åªéœ€ä¿®æ”¹äº‹ä»¶æ£€æµ‹å™¨ï¼š
```python
class EventDetector:
    def detect(self, user_input, context):
        # ä¼˜å…ˆçº§1: è§„åˆ™å¿«é€Ÿè·¯å¾„
        if rule_result.confidence > 0.9:
            return rule_result
        
        # ä¼˜å…ˆçº§2: æ¨¡å‹åˆ†ç±»ï¼ˆæ–°å¢ï¼‰
        if model_result.confidence > 0.8:
            return model_result
        
        # ä¼˜å…ˆçº§3: LLMå…œåº•ï¼ˆæ–°å¢ï¼‰
        return llm_classify(...)
```

---

## åã€æ€»ç»“

### 10.1 æ–¹æ¡ˆä¼˜åŠ¿

âœ… **æ¶æ„æ¸…æ™°**ï¼šçŠ¶æ€æœºæä¾›ç»“æ„ï¼Œè§„åˆ™æä¾›å®ç°  
âœ… **èŒè´£åˆ†ç¦»**ï¼šçŠ¶æ€ç®¡ç†å’Œäº‹ä»¶æ£€æµ‹ç‹¬ç«‹  
âœ… **æ˜“äºæ‰©å±•**ï¼šæ·»åŠ æ–°çŠ¶æ€ç‹¬ç«‹ä¿®æ”¹  
âœ… **ä¾¿äºæµ‹è¯•**ï¼šçŠ¶æ€è½¬ç§»å¯å•ç‹¬æµ‹è¯•  
âœ… **å¯ç»´æŠ¤æ€§é«˜**ï¼šä»£ç ç»„ç»‡æ¸…æ™°  
âœ… **å¯æ¼”è¿›**ï¼šç®—æ³•å±‚å¯ç‹¬ç«‹å‡çº§  

### 10.2 æŠ€æœ¯äº®ç‚¹

1. **çŠ¶æ€æœº + è§„åˆ™ç»“åˆ**ï¼šå‘æŒ¥å„è‡ªä¼˜åŠ¿
2. **åˆ†å±‚è®¾è®¡**ï¼šæ¶æ„å±‚ã€ç®—æ³•å±‚ã€ä¸šåŠ¡å±‚åˆ†ç¦»
3. **è¯é¢˜ç›¸å…³æ€§ç®—æ³•**ï¼šå¤šç»´åº¦è¯„åˆ†åˆ¤æ–­
4. **æ’å…¥å¼å¯¹è¯æ”¯æŒ**ï¼šå’¨è¯¢ä¸å½±å“ç¡®è®¤æµç¨‹

### 10.3 é¢„æœŸæ•ˆæœ

| æŒ‡æ ‡ | å½“å‰ | ç›®æ ‡ | è¯´æ˜ |
|------|------|------|------|
| å‡†ç¡®ç‡ | ~80% | 88-92% | æå‡ 8-12% |
| è¯¯åˆ¤ç‡ | ~5% | < 3% | é™ä½ 2% |
| å¯ç»´æŠ¤æ€§ | ä¸­ | é«˜ | ä»£ç ç»“æ„ä¼˜åŒ– |
| æ‰©å±•æ€§ | ä¸­ | é«˜ | çŠ¶æ€æœºæ¶æ„ |

### 10.4 åç»­ä¼˜åŒ–

**çŸ­æœŸï¼ˆ1-3ä¸ªæœˆï¼‰**
- æ”¶é›†Badcaseï¼Œä¼˜åŒ–è§„åˆ™
- A/Bæµ‹è¯•é˜ˆå€¼å‚æ•°

**ä¸­æœŸï¼ˆ3-6ä¸ªæœˆï¼‰**
- å¼•å…¥å°æ¨¡å‹å¤„ç†è¾¹ç•Œcase
- æ„å»ºæ··åˆç®—æ³•

**é•¿æœŸï¼ˆ6ä¸ªæœˆ+ï¼‰**
- LLMå…œåº•
- å¤šè½®åµŒå¥—ç¡®è®¤
- æƒ…æ„Ÿç†è§£

---

**æ–‡æ¡£ç‰ˆæœ¬**: v2.0  
**æœ€åæ›´æ–°**: 2025-01-XX  
**è®¾è®¡æ–¹æ¡ˆ**: çŠ¶æ€æœº + è§„åˆ™å¢å¼º  
**ç»´æŠ¤è€…**: [æ‚¨çš„åå­—]
