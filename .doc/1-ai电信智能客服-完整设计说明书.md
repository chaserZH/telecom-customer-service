# ç”µä¿¡å¥—é¤AIæ™ºèƒ½å®¢æœç³»ç»Ÿ - å®Œæ•´è®¾è®¡è¯´æ˜ä¹¦

## 1. ç³»ç»Ÿæ¦‚è¿°

### 1.1 é¡¹ç›®èƒŒæ™¯

æœ¬ç³»ç»Ÿæ˜¯ä¸€ä¸ªåŸºäºå¤§è¯­è¨€æ¨¡å‹çš„ç”µä¿¡å¥—é¤æ™ºèƒ½å®¢æœç³»ç»Ÿï¼Œæ”¯æŒå¥—é¤æŸ¥è¯¢ã€æ¨èã€åŠç†ç­‰æ ¸å¿ƒä¸šåŠ¡åœºæ™¯ã€‚

**æ ¸å¿ƒç‰¹æ€§**ï¼š

- ğŸ¤– åŸºäºDeepSeekçš„è‡ªç„¶è¯­è¨€ç†è§£
- ğŸ’¬ æ”¯æŒå¤æ‚å¤šè½®å¯¹è¯
- ğŸ¯ æ™ºèƒ½æ„å›¾è¯†åˆ«ä¸æ§½ä½å¡«å……
- ğŸ”„ å®Œæ•´çš„å¯¹è¯çŠ¶æ€ç®¡ç†
- âœ… é«˜é£é™©æ“ä½œç¡®è®¤æœºåˆ¶
- ğŸŒ WebSocketå®æ—¶é€šä¿¡

### 1.2 ä¸šåŠ¡åœºæ™¯

| åœºæ™¯     | æè¿°             | ç¤ºä¾‹                  |
| -------- | ---------------- | --------------------- |
| å¥—é¤æŸ¥è¯¢ | æ ¹æ®æ¡ä»¶ç­›é€‰å¥—é¤ | "æœ‰100å…ƒä»¥å†…çš„å¥—é¤å—" |
| å¥—é¤æ¨è | æ™ºèƒ½æ¨èåˆé€‚å¥—é¤ | "æ¨èæ€§ä»·æ¯”é«˜çš„å¥—é¤"  |
| å¥—é¤åŠç† | åŠç†å¥—é¤å˜æ›´     | "æˆ‘è¦åŠç†ç»æµå¥—é¤"    |
| ä½¿ç”¨æŸ¥è¯¢ | æŸ¥è¯¢æµé‡/ä½™é¢    | "æˆ‘ç”¨äº†å¤šå°‘æµé‡"      |
| ä¸šåŠ¡å’¨è¯¢ | æ”¿ç­–è§„åˆ™è¯´æ˜     | "æ€ä¹ˆåŠç†å¥—é¤"        |

### 1.3 å¯ç”¨å¥—é¤

| åç§°     | æµé‡(G/æœˆ) | ä»·æ ¼(å…ƒ/æœˆ) | é€‚ç”¨äººç¾¤ |
| -------- | ---------- | ----------- | -------- |
| ç»æµå¥—é¤ | 10         | 50          | æ— é™åˆ¶   |
| ç•…æ¸¸å¥—é¤ | 100        | 180         | æ— é™åˆ¶   |
| æ— é™å¥—é¤ | 1000       | 300         | æ— é™åˆ¶   |
| æ ¡å›­å¥—é¤ | 200        | 150         | åœ¨æ ¡ç”Ÿ   |

## 2. ç³»ç»Ÿæ¶æ„

### 2.1 æ•´ä½“æ¶æ„å›¾

```tex
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 Webå‰ç«¯å±‚                            â”‚
â”‚         HTML5 + JavaScript + WebSocket              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†• WebSocket
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              FastAPI WebæœåŠ¡å±‚                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ HTTP API   â”‚  â”‚ WebSocket  â”‚  â”‚ è·¯ç”±ç®¡ç†   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              å¯¹è¯å¼•æ“å±‚ï¼ˆæ ¸å¿ƒï¼‰                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚   TelecomChatbotPolicy   â”‚    â”‚
â”‚  â”‚   - æ•´åˆNLU + DST + Policy + NLG          â”‚    â”‚
â”‚  â”‚   - å¯¹è¯æµç¨‹æ§åˆ¶                           â”‚    â”‚
â”‚  â”‚   - å¼‚å¸¸å¤„ç†                               â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   NLUæ¨¡å—                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚       NLUEngine (æ„å›¾è¯†åˆ«)                  â”‚    â”‚
â”‚  â”‚  - å¤§æ¨¡å‹Function Calling                  â”‚    â”‚
â”‚  â”‚  - å®ä½“æŠ½å–                                 â”‚    â”‚
â”‚  â”‚  - æ§½ä½éªŒè¯                                 â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   DSTæ¨¡å—                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚    DialogStateTracker (çŠ¶æ€è·Ÿè¸ª)           â”‚    â”‚
â”‚  â”‚  - SlotManager (æ§½ä½ç®¡ç†)                  â”‚    â”‚
â”‚  â”‚  - ContextManager (ä¸Šä¸‹æ–‡ç®¡ç†)             â”‚    â”‚
â”‚  â”‚  - StateStore (RedisæŒä¹…åŒ–)                â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 Policyæ¨¡å—                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚      PolicyEngine (ç­–ç•¥å†³ç­–)               â”‚    â”‚
â”‚  â”‚  - åŠ¨ä½œå†³ç­–                                 â”‚    â”‚
â”‚  â”‚  - ConfirmationManager (ç¡®è®¤ç®¡ç†)          â”‚    â”‚
â”‚  â”‚  - RecommendationEngine (æ¨èå¼•æ“)         â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  NLGæ¨¡å—                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚       NLGGenerator (å›å¤ç”Ÿæˆ)              â”‚    â”‚
â”‚  â”‚  - æ¨¡æ¿åŒ–ç”Ÿæˆ                               â”‚    â”‚
â”‚  â”‚  - LLMç”Ÿæˆ                                  â”‚    â”‚
â”‚  â”‚  - æ··åˆç­–ç•¥                                 â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 æ‰§è¡Œå±‚                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ MySQL    â”‚  â”‚ Redis    â”‚  â”‚ å¤–éƒ¨API  â”‚         â”‚
â”‚  â”‚ ä¸šåŠ¡æ•°æ® â”‚  â”‚ ä¼šè¯çŠ¶æ€ â”‚  â”‚ (é¢„ç•™)   â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 ä»£ç åˆ†å±‚ç»“æ„

```tex
telecom-ai-customer-service/
â”‚
â”œâ”€â”€ api/                    # ğŸ“¡ WebæœåŠ¡å±‚
â”‚   â”œâ”€â”€ main.py            # FastAPIåº”ç”¨å…¥å£
â”‚   â”œâ”€â”€ routers/           # è·¯ç”±æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ chat.py       # HTTPèŠå¤©æ¥å£
â”‚   â”‚   â””â”€â”€ websocket.py  # WebSocketæ¥å£
â”‚   â””â”€â”€ static/
â”‚       â””â”€â”€ index.html     # å‰ç«¯é¡µé¢
â”‚
â”œâ”€â”€ core/                   # ğŸ§  æ ¸å¿ƒå¯¹è¯å¼•æ“å±‚
â”‚   â”œâ”€â”€ nlu/               # æ„å›¾è¯†åˆ«æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ nlu_engine.py
â”‚   â”‚   â””â”€â”€ function_definitions.py
â”‚   â”œâ”€â”€ dst/               # çŠ¶æ€è·Ÿè¸ªæ¨¡å—
â”‚   â”‚   â”œâ”€â”€ dialog_state_tracker.py
â”‚   â”‚   â”œâ”€â”€ slot_manager.py
â”‚   â”‚   â”œâ”€â”€ context_manager.py
â”‚   â”‚   â””â”€â”€ state_store.py
â”‚   â”œâ”€â”€ policy/            # ç­–ç•¥å†³ç­–æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ policy_engine.py
â”‚   â”‚   â”œâ”€â”€ policy_rules.py
â”‚   â”‚   â””â”€â”€ confirmation_manager.py
â”‚   â”œâ”€â”€ nlg/               # è¯­è¨€ç”Ÿæˆæ¨¡å—
â”‚   â”‚   â”œâ”€â”€ nlg_generator.py
â”‚   â”‚   â””â”€â”€ templates.py
â”‚   â”œâ”€â”€ recommendation/    # æ¨èå¼•æ“
â”‚   â””â”€â”€ chatbot_policy.py  # ğŸ¯ ä¸»å¯¹è¯ç³»ç»Ÿ
â”‚
â”œâ”€â”€ executor/               # âš™ï¸ æ‰§è¡Œå±‚
â”‚   â””â”€â”€ db_executor.py     # æ•°æ®åº“æ‰§è¡Œå™¨
â”‚
â”œâ”€â”€ database/               # ğŸ’¾ æ•°æ®å±‚
â”‚   â”œâ”€â”€ db_manager.py      # MySQLç®¡ç†
â”‚   â”œâ”€â”€ redis_manager.py   # Redisç®¡ç†
â”‚   â””â”€â”€ schema.sql         # æ•°æ®åº“è¡¨ç»“æ„
â”‚
â”œâ”€â”€ config/                 # âš™ï¸ é…ç½®å±‚
â”‚   â”œâ”€â”€ settings.py        # ç³»ç»Ÿé…ç½®
â”‚   â””â”€â”€ prompts.py         # Promptæ¨¡æ¿
â”‚
â””â”€â”€ utils/                  # ğŸ”§ å·¥å…·å±‚
    â”œâ”€â”€ logger.py
    â”œâ”€â”€ validators.py
    â””â”€â”€ cache.py
```

**å„å±‚èŒè´£**ï¼š

| å±‚çº§       | èŒè´£                         | å…³é”®æ¨¡å—             |
| ---------- | ---------------------------- | -------------------- |
| WebæœåŠ¡å±‚  | HTTP/WebSocketæ¥å£ã€è·¯ç”±ç®¡ç† | FastAPI, WebSocket   |
| å¯¹è¯å¼•æ“å±‚ | å¯¹è¯æµç¨‹æ§åˆ¶ã€æ¨¡å—åè°ƒ       | TelecomChatbotPolicy |
| NLUå±‚      | æ„å›¾è¯†åˆ«ã€å®ä½“æŠ½å–           | NLUEngine            |
| DSTå±‚      | çŠ¶æ€è·Ÿè¸ªã€ä¸Šä¸‹æ–‡ç®¡ç†         | DialogStateTracker   |
| Policyå±‚   | ç­–ç•¥å†³ç­–ã€ç¡®è®¤ç®¡ç†           | PolicyEngine         |
| NLGå±‚      | å›å¤ç”Ÿæˆ                     | NLGGenerator         |
| æ‰§è¡Œå±‚     | ä¸šåŠ¡é€»è¾‘æ‰§è¡Œ                 | DatabaseExecutor     |
| æ•°æ®å±‚     | æ•°æ®æŒä¹…åŒ–                   | MySQL, Redis         |

### 2.3 æ¨¡å—ä¾èµ–å…³ç³»å›¾

```mermaid
graph TB
    A[WebæœåŠ¡å±‚] --> B[å¯¹è¯å¼•æ“]
    B --> C[NLUæ¨¡å—]
    B --> D[DSTæ¨¡å—]
    B --> E[Policyæ¨¡å—]
    B --> F[NLGæ¨¡å—]
    
    D --> G[StateStore/Redis]
    E --> H[ConfirmationManager]
    E --> I[RecommendationEngine]
    
    B --> J[DatabaseExecutor]
    J --> K[MySQLæ•°æ®åº“]
    
    C --> L[DeepSeek/GPT-4]
    F --> L
```

## 3. æ ¸å¿ƒæ¨¡å—è®¾è®¡

### 3.1 NLUæ¨¡å— (Natural Language Understanding)

**æ ¸å¿ƒèŒè´£**ï¼šå°†ç”¨æˆ·è‡ªç„¶è¯­è¨€è½¬æ¢ä¸ºç»“æ„åŒ–æ„å›¾å’Œå‚æ•°

#### 3.1.1 åŠŸèƒ½ç»„ä»¶

```
NLUEngine
â”œâ”€â”€ æ„å›¾è¯†åˆ« (Intent Classification)
â”‚   â””â”€â”€ ä½¿ç”¨å¤§æ¨¡å‹Function Calling
â”œâ”€â”€ å®ä½“æŠ½å– (Entity Extraction)
â”‚   â””â”€â”€ ä»·æ ¼ã€æµé‡ã€æ‰‹æœºå·ç­‰
â”œâ”€â”€ æ§½ä½éªŒè¯ (Slot Validation)
â”‚   â””â”€â”€ æ£€æŸ¥å¿…å¡«å‚æ•°å®Œæ•´æ€§
â””â”€â”€ ä¸Šä¸‹æ–‡ç†è§£ (Context Understanding)
    â””â”€â”€ ç»“åˆå†å²å¯¹è¯ç†è§£æ„å›¾
```

#### 3.1.2 æ ¸å¿ƒæµç¨‹å›¾

```mermaid
graph TB
    Start([ç”¨æˆ·è¾“å…¥]) --> Preprocess[æ–‡æœ¬é¢„å¤„ç†]
    Preprocess --> CheckSession{æ£€æŸ¥ä¼šè¯çŠ¶æ€}
    
    CheckSession -->|æ–°ä¼šè¯| BuildMsg1[æ„å»ºåŸºç¡€æ¶ˆæ¯]
    CheckSession -->|æœ‰å†å²| GetContext[è·å–ä¸Šä¸‹æ–‡]
    
    GetContext --> IsSlotFilling{æ§½ä½å¡«å……ä¸­?}
    IsSlotFilling -->|æ˜¯| BuildTaskContext[æ„å»ºä»»åŠ¡ä¸Šä¸‹æ–‡]
    IsSlotFilling -->|å¦| BuildRecentContext[æ„å»ºç®€æ´ä¸Šä¸‹æ–‡]
    
    BuildTaskContext --> BuildMsg2[æ„å»ºå®Œæ•´æ¶ˆæ¯]
    BuildRecentContext --> BuildMsg2
    BuildMsg1 --> LLMCall[è°ƒç”¨å¤§æ¨¡å‹API]
    BuildMsg2 --> LLMCall
    
    LLMCall --> ResponseType{å“åº”ç±»å‹}
    
    ResponseType -->|Function Call| ParseFunction[è§£æFunction]
    ResponseType -->|æ–‡æœ¬å›å¤| ReturnChat[è¿”å›é—²èŠ]
    
    ParseFunction --> FilterParams[è¿‡æ»¤æ— æ•ˆå‚æ•°]
    FilterParams --> ValidateParams{å‚æ•°å®Œæ•´?}
    
    ValidateParams -->|æ˜¯| ReturnComplete[è¿”å›å®Œæ•´NLUç»“æœ]
    ValidateParams -->|å¦| CheckContext{ä¸Šä¸‹æ–‡æœ‰å‚æ•°?}
    
    CheckContext -->|æœ‰| FillFromContext[ä»ä¸Šä¸‹æ–‡è¡¥å…¨]
    CheckContext -->|æ— | ReturnClarify[è¿”å›éœ€æ¾„æ¸…]
    
    FillFromContext --> ReturnComplete
    
    ReturnComplete --> UpdateSession[æ›´æ–°ä¼šè¯]
    ReturnClarify --> UpdateSession
    ReturnChat --> UpdateSession
    
    UpdateSession --> End([è¿”å›NLUResult])
```

#### 3.1.3 æ ¸å¿ƒä»£ç 

```python
class NLUEngine:
    """NLUå¼•æ“"""
    
    def understand(self, user_input: str, session_id: str) -> NLUResult:
        """ç†è§£ç”¨æˆ·è¾“å…¥"""
        # 1. é¢„å¤„ç†
        processed = self._preprocess(user_input)
        
        # 2. è·å–ä¸Šä¸‹æ–‡
        context = self._get_session_context(session_id)
        
        # 3. æ„å»ºæ¶ˆæ¯ï¼ˆæ™ºèƒ½ä¸Šä¸‹æ–‡ï¼‰
        messages = self._build_messages(processed, context)
        
        # 4. è°ƒç”¨å¤§æ¨¡å‹
        response = self.client.chat.completions.create(
            model=self.model,
            messages=messages,
            tools=FUNCTION_DEFINITIONS,
            tool_choice="required"
        )
        
        # 5. è§£æå“åº”
        nlu_result = self._parse_response(response, context)
        
        # 6. æ›´æ–°ä¼šè¯
        self._update_session(session_id, user_input, nlu_result, context)
        
        return nlu_result
```

#### 3.1.4 å…³é”®ç‰¹æ€§

âœ… **æ™ºèƒ½ä¸Šä¸‹æ–‡ç®¡ç†**

- æ§½ä½å¡«å……åœºæ™¯ï¼šè¯¦ç»†ä»»åŠ¡ä¸Šä¸‹æ–‡
- éæ§½ä½åœºæ™¯ï¼šç®€æ´ä¸Šä¸‹æ–‡æç¤º

âœ… **å‚æ•°è¿‡æ»¤ä¸éªŒè¯**

- è¿‡æ»¤å¤§æ¨¡å‹å¹»è§‰å‚æ•°
- ä»…ä¿ç•™ç”¨æˆ·æ˜ç¡®æåˆ°çš„ä¿¡æ¯

âœ… **å¤šè½®å¯¹è¯æ”¯æŒ**

- ä¼šè¯çŠ¶æ€è·Ÿè¸ª
- æ„å›¾åˆ‡æ¢æ£€æµ‹



### 3.2 DSTæ¨¡å— (Dialog State Tracking)

**æ ¸å¿ƒèŒè´£**ï¼šè·Ÿè¸ªå¯¹è¯çŠ¶æ€ï¼Œç®¡ç†æ§½ä½å’Œä¸Šä¸‹æ–‡

**å…­å¤§æ ¸å¿ƒæ¦‚å¿µ:**

1. **DialogState (å¯¹è¯çŠ¶æ€)** - å¯¹è¯çš„å®Œæ•´å¿«ç…§
2. **Slot (æ§½ä½)** - ä¿¡æ¯æ”¶é›†çš„åŸºæœ¬å•å…ƒ
3. **Context (ä¸Šä¸‹æ–‡)** - å¯¹è¯çš„å†å²å’Œç¯å¢ƒ
4. **StateStore (çŠ¶æ€å­˜å‚¨)** - RedisæŒä¹…åŒ–å±‚
5. **SlotManager (æ§½ä½ç®¡ç†å™¨)** - æ§½ä½æ™ºèƒ½ç®¡ç†
6. **ContextManager (ä¸Šä¸‹æ–‡ç®¡ç†å™¨)** - ä¸Šä¸‹æ–‡ç”Ÿå‘½å‘¨æœŸ

#### 3.2.1 åŠŸèƒ½ç»„ä»¶

```tex
DialogStateTracker
â”œâ”€â”€ SlotManager (æ§½ä½ç®¡ç†å™¨)
â”‚   â”œâ”€â”€ æ§½ä½å¡«å……ç­–ç•¥
â”‚   â”œâ”€â”€ æ§½ä½ç»§æ‰¿è§„åˆ™
â”‚   â””â”€â”€ æ§½ä½éªŒè¯
â”œâ”€â”€ ContextManager (ä¸Šä¸‹æ–‡ç®¡ç†å™¨)
â”‚   â”œâ”€â”€ ä¸Šä¸‹æ–‡æå–
â”‚   â”œâ”€â”€ ä¸Šä¸‹æ–‡æ¸…ç†
â”‚   â””â”€â”€ ä¸Šä¸‹æ–‡ä¼˜å…ˆçº§
â””â”€â”€ StateStore (çŠ¶æ€å­˜å‚¨)
    â”œâ”€â”€ RedisæŒä¹…åŒ–
    â”œâ”€â”€ å†…å­˜é™çº§
    â””â”€â”€ ä¼šè¯è¿‡æœŸç®¡ç†
```

#### 3.2.2 æ ¸å¿ƒæµç¨‹å›¾

```mermaid
graph TB
    Start([æ¥æ”¶NLUç»“æœ]) --> LoadState[åŠ è½½æ—§çŠ¶æ€]
    LoadState --> CheckExpired{çŠ¶æ€è¿‡æœŸ?}
    
    CheckExpired -->|æ˜¯| InitNew[åˆå§‹åŒ–æ–°çŠ¶æ€]
    CheckExpired -->|å¦| CheckConfirm{å¾…ç¡®è®¤è¶…æ—¶?}
    
    CheckConfirm -->|æ˜¯| ClearConfirm[æ¸…é™¤ç¡®è®¤çŠ¶æ€]
    CheckConfirm -->|å¦| Continue[ç»§ç»­å¤„ç†]
    
    InitNew --> AddTurn[æ·»åŠ ç”¨æˆ·è¾“å…¥åˆ°å†å²]
    ClearConfirm --> AddTurn
    Continue --> AddTurn
    
    AddTurn --> IntentChanged{æ„å›¾æ”¹å˜?}
    
    IntentChanged -->|æ˜¯| CheckPending{æœ‰å¾…ç¡®è®¤?}
    IntentChanged -->|å¦| KeepSlots[ä¿ç•™æ‰€æœ‰æ§½ä½]
    
    CheckPending -->|æ˜¯| ShouldClear{åº”æ¸…é™¤?}
    CheckPending -->|å¦| FillSlots[å¡«å……æ§½ä½]
    
    ShouldClear -->|æ˜¯| ClearPending[æ¸…é™¤å¾…ç¡®è®¤]
    ShouldClear -->|å¦| KeepPending[ä¿ç•™å¾…ç¡®è®¤]
    
    ClearPending --> FillSlots
    KeepPending --> FillSlots
    KeepSlots --> FillSlots
    
    FillSlots --> UpdateContext[æ›´æ–°ä¸Šä¸‹æ–‡æ ˆ]
    UpdateContext --> BuildNewState[æ„å»ºæ–°çŠ¶æ€]
    
    BuildNewState --> ValidateSlots[éªŒè¯æ§½ä½å®Œæ•´æ€§]
    ValidateSlots --> SaveState[ä¿å­˜çŠ¶æ€åˆ°Redis]
    
    SaveState --> End([è¿”å›DialogState])
```

#### 3.2.3 æ§½ä½ç»§æ‰¿ç­–ç•¥

```python
class SlotManager:
    """æ§½ä½ç®¡ç†å™¨"""
    
    def fill_slots(self, current_slots, new_slots, 
                    current_intent, new_intent):
        """æ§½ä½å¡«å……ç­–ç•¥"""
        intent_changed = (current_intent != new_intent)
        
        if not intent_changed:
            # æ„å›¾ä¸å˜ï¼šå®Œå…¨åˆå¹¶
            return {**current_slots, **new_slots}
        
        elif self._is_same_domain(current_intent, new_intent):
            # ç›¸åŒé¢†åŸŸï¼šä¿ç•™ç”¨æˆ·ä¿¡æ¯ + éƒ¨åˆ†ä¸šåŠ¡æ§½ä½
            preserved = {
                k: v for k, v in current_slots.items()
                if k in self.USER_INFO_SLOTS or self._should_preserve(k)
            }
            return {**preserved, **new_slots}
        
        else:
            # ä¸åŒé¢†åŸŸï¼šä»…ä¿ç•™ç”¨æˆ·ä¿¡æ¯
            user_slots = {
                k: v for k, v in current_slots.items()
                if k in self.USER_INFO_SLOTS
            }
            return {**user_slots, **new_slots}
```

#### 3.2.4 å…³é”®ç‰¹æ€§

âœ… **RedisæŒä¹…åŒ–**

- æ”¯æŒåº”ç”¨é‡å¯åæ¢å¤
- è‡ªåŠ¨è¿‡æœŸç®¡ç†ï¼ˆ30åˆ†é’Ÿï¼‰
- é™çº§åˆ°å†…å­˜å­˜å‚¨

âœ… **æ™ºèƒ½æ§½ä½ç®¡ç†**

- ç”¨æˆ·ä¿¡æ¯è·¨æ„å›¾ç»§æ‰¿
- ä¸šåŠ¡æ§½ä½æŒ‰é¢†åŸŸç»§æ‰¿
- æ„å›¾åˆ‡æ¢è‡ªåŠ¨æ¸…ç†

âœ… **ç¡®è®¤çŠ¶æ€ç®¡ç†**

- æ”¯æŒå¾…ç¡®è®¤æ“ä½œä¿å­˜
- è¶…æ—¶è‡ªåŠ¨æ¸…é™¤ï¼ˆ5åˆ†é’Ÿï¼‰
- æ„å›¾åˆ‡æ¢æ™ºèƒ½åˆ¤æ–­

### 3.3 Policyæ¨¡å— (å¯¹è¯ç­–ç•¥)

**æ ¸å¿ƒèŒè´£**ï¼šæ ¹æ®å¯¹è¯çŠ¶æ€å†³ç­–ç³»ç»ŸåŠ¨ä½œ

**ç³»ç»ŸåŠ¨ä½œåˆ†ç±»:** 

| åŠ¨ä½œç±»å‹      | è¯´æ˜             | ç¤ºä¾‹                     |
| ------------- | ---------------- | ------------------------ |
| **REQUEST**   | è¯·æ±‚ç”¨æˆ·æä¾›ä¿¡æ¯ | "è¯·é—®æ‚¨çš„æ‰‹æœºå·æ˜¯å¤šå°‘ï¼Ÿ" |
| **INFORM**    | å‘ŠçŸ¥ç”¨æˆ·ä¿¡æ¯     | "ä¸ºæ‚¨æ‰¾åˆ°3ä¸ªå¥—é¤..."     |
| **CONFIRM**   | ç¡®è®¤ç”¨æˆ·æ„å›¾     | "æ‚¨æ˜¯è¦åŠç†ç»æµå¥—é¤å—ï¼Ÿ" |
| **APOLOGIZE** | è‡´æ­‰             | "æŠ±æ­‰ï¼Œæš‚æ—¶æ— æ³•å¤„ç†..."  |
| **EXECUTE**   | æ‰§è¡Œä¸šåŠ¡æ“ä½œ     | è°ƒç”¨æ•°æ®åº“/API           |

**

#### 3.3.1 åŠŸèƒ½ç»„ä»¶

```python
PolicyEngine
â”œâ”€â”€ åŠ¨ä½œå†³ç­– (Action Decision)
â”‚   â”œâ”€â”€ REQUEST (è¯·æ±‚ç”¨æˆ·ä¿¡æ¯)
â”‚   â”œâ”€â”€ CONFIRM (ç¡®è®¤æ“ä½œ)
â”‚   â”œâ”€â”€ INFORM (å‘ŠçŸ¥ç»“æœ)
â”‚   â””â”€â”€ APOLOGIZE (é”™è¯¯å¤„ç†)
â”œâ”€â”€ ConfirmationManager (ç¡®è®¤ç®¡ç†)
â”‚   â”œâ”€â”€ é«˜é£é™©æ“ä½œè¯†åˆ«
â”‚   â”œâ”€â”€ ç¡®è®¤è¯·æ±‚ç”Ÿæˆ
â”‚   â””â”€â”€ ç¡®è®¤å“åº”å¤„ç†
â””â”€â”€ PolicyRules (ç­–ç•¥è§„åˆ™)
    â”œâ”€â”€ ç¡®è®¤è§„åˆ™
    â”œâ”€â”€ æ¨èè§„åˆ™
    â””â”€â”€ å¼•å¯¼è§„åˆ™
```

#### 3.3.2 æ ¸å¿ƒå†³ç­–æµç¨‹

```mermaid
graph TB
    Start([æ¥æ”¶DialogState]) --> CheckError{æœ‰æ‰§è¡Œé”™è¯¯?}
    
    CheckError -->|æ˜¯| ActionApologize[APOLOGIZEåŠ¨ä½œ]
    CheckError -->|å¦| CheckClarify{éœ€è¦æ¾„æ¸…?}
    
    CheckClarify -->|æ˜¯| ActionRequest[REQUESTåŠ¨ä½œ]
    CheckClarify -->|å¦| CheckConfirm{éœ€è¦ç¡®è®¤?}
    
    CheckConfirm -->|æ˜¯| CreateConfirm[åˆ›å»ºç¡®è®¤è®°å½•]
    CheckConfirm -->|å¦| CheckSuccess{æ‰§è¡ŒæˆåŠŸ?}
    
    CreateConfirm --> ActionConfirm[CONFIRMåŠ¨ä½œ]
    
    CheckSuccess -->|æ˜¯| HandleSuccess[å¤„ç†æˆåŠŸç»“æœ]
    CheckSuccess -->|å¦| DefaultAction[EXECUTEåŠ¨ä½œ]
    
    HandleSuccess --> CheckRecommend{éœ€è¦æ¨è?}
    
    CheckRecommend -->|æ˜¯| AddRecommend[æ·»åŠ æ¨èæ ‡è®°]
    CheckRecommend -->|å¦| ActionInform[INFORMåŠ¨ä½œ]
    
    AddRecommend --> ActionInform
    
    ActionApologize --> End([è¿”å›Action])
    ActionRequest --> End
    ActionConfirm --> End
    ActionInform --> End
    DefaultAction --> End
```

#### 3.3.3 ç¡®è®¤ç­–ç•¥

```python
class PolicyEngine:
    """ç­–ç•¥å¼•æ“"""
    
    def _needs_confirmation(self, state: DialogState) -> bool:
        """åˆ¤æ–­æ˜¯å¦éœ€è¦ç¡®è®¤"""
        # è§„åˆ™1: å·²åœ¨å¾…ç¡®è®¤çŠ¶æ€ï¼Œä¸é‡å¤ç¡®è®¤
        if state.pending_confirmation:
            return False
        
        # è§„åˆ™2: é«˜é£é™©æ“ä½œéœ€è¦ç¡®è®¤
        if state.current_intent in ["change_package", "cancel_service"]:
            return True
        
        # è§„åˆ™3: é«˜ä»·å¥—é¤éœ€è¦ç¡®è®¤
        price = state.slots.get("price")
        if price and float(price) > 200:
            return True
        
        return False
```

#### 3.3.4 å…³é”®ç‰¹æ€§

âœ… **æ™ºèƒ½å†³ç­–**

- å¼‚å¸¸ä¼˜å…ˆå¤„ç†
- æ§½ä½å¡«å……ä¼˜å…ˆ
- ç¡®è®¤æµç¨‹ä¿æŠ¤

âœ… **ç¡®è®¤æœºåˆ¶**

- é«˜é£é™©æ“ä½œå¼ºåˆ¶ç¡®è®¤
- é«˜ä»·å¥—é¤æç¤ºç¡®è®¤
- ç¡®è®¤çŠ¶æ€æŒä¹…åŒ–

âœ… **æ¨èè§¦å‘**

- å¤šç»“æœæ—¶ä¸»åŠ¨æ¨è
- ä»·æ ¼æ•æ„Ÿç”¨æˆ·å¼•å¯¼
- å­¦ç”Ÿèº«ä»½æ¨èæ ¡å›­å¥—é¤

### 3.4 NLGæ¨¡å— (Natural Language Generation)

**æ ¸å¿ƒèŒè´£**ï¼šç”Ÿæˆè‡ªç„¶æµç•…çš„å›å¤æ–‡æœ¬

#### 3.4.1 åŠŸèƒ½ç»„ä»¶

```tex
NLGGenerator
â”œâ”€â”€ ç­–ç•¥é€‰æ‹©
â”‚   â”œâ”€â”€ æ¨¡æ¿åŒ–ç”Ÿæˆ (å¿«é€Ÿ)
â”‚   â”œâ”€â”€ LLMç”Ÿæˆ (çµæ´»)
â”‚   â””â”€â”€ æ··åˆç­–ç•¥ (å¹³è¡¡)
â”œâ”€â”€ æ¨¡æ¿ç³»ç»Ÿ
â”‚   â”œâ”€â”€ REQUESTæ¨¡æ¿
â”‚   â”œâ”€â”€ CONFIRMæ¨¡æ¿
â”‚   â”œâ”€â”€ INFORMæ¨¡æ¿
â”‚   â””â”€â”€ APOLOGIZEæ¨¡æ¿
â””â”€â”€ åå¤„ç†
    â”œâ”€â”€ é•¿åº¦æ§åˆ¶
    â”œâ”€â”€ æ ¼å¼åŒ–
    â””â”€â”€ å¼•å¯¼è¯­æ·»åŠ 
```

#### 3.4.2 ç”Ÿæˆç­–ç•¥é€‰æ‹©

```mermaid
graph TB
    Start([æ¥æ”¶Action + State]) --> CheckStrategy{é€‰æ‹©ç­–ç•¥}
    
    CheckStrategy -->|å¼ºåˆ¶LLM| UseLLM[LLMç”Ÿæˆ]
    CheckStrategy -->|REQUEST/CONFIRM| UseTemplate[æ¨¡æ¿ç”Ÿæˆ]
    CheckStrategy -->|æ¨èåœºæ™¯| UseLLM
    CheckStrategy -->|å¤šç»“æœ>3| UseLLM
    CheckStrategy -->|å…¶ä»–| UseTemplate
    
    UseTemplate --> SelectTemplate[é€‰æ‹©æ¨¡æ¿]
    SelectTemplate --> ValidateParams{å‚æ•°å®Œæ•´?}
    
    ValidateParams -->|æ˜¯| FillTemplate[å¡«å……æ¨¡æ¿]
    ValidateParams -->|å¦| GetFallback[é™çº§æ¨¡æ¿]
    
    GetFallback --> FillTemplate
    FillTemplate --> PostProcess[åå¤„ç†]
    
    UseLLM --> BuildPrompt[æ„å»ºPrompt]
    BuildPrompt --> CallLLM[è°ƒç”¨LLM]
    CallLLM --> CheckLLMSuccess{LLMæˆåŠŸ?}
    
    CheckLLMSuccess -->|æ˜¯| PostProcess
    CheckLLMSuccess -->|å¦| Fallback[é™çº§åˆ°æ¨¡æ¿]
    
    Fallback --> PostProcess
    PostProcess --> End([è¿”å›å›å¤æ–‡æœ¬])
```

#### 3.4.3 æ··åˆç­–ç•¥ç¤ºä¾‹

```python
class NLGGenerator:
    """NLGç”Ÿæˆå™¨"""
    
    def generate(self, action: Action, state: DialogState) -> str:
        """ç”Ÿæˆå›å¤"""
        # é€‰æ‹©ç­–ç•¥
        strategy = self._choose_strategy(action, state)
        
        if strategy == "template":
            response = self._generate_from_template(action, state)
        elif strategy == "llm":
            response = self._generate_from_llm(action, state)
        else:
            response = self._generate_hybrid(action, state)
        
        # åå¤„ç†
        return self.formatter.post_process(response, state)
    
    def _choose_strategy(self, action, state):
        """é€‰æ‹©ç”Ÿæˆç­–ç•¥"""
        # REQUESTå’ŒCONFIRMæ€»æ˜¯ç”¨æ¨¡æ¿
        if action.action_type in ["REQUEST", "CONFIRM"]:
            return "template"
        
        # æ¨èåœºæ™¯ç”¨LLM
        if action.parameters.get("should_recommend"):
            return "llm"
        
        # å¤šç»“æœå¯¹æ¯”ç”¨LLM
        if action.parameters.get("count", 0) > 3:
            return "llm"
        
        return "template"
```

#### 3.4.4 å…³é”®ç‰¹æ€§

âœ… **ä¸‰ç§ç”Ÿæˆç­–ç•¥**

- æ¨¡æ¿ï¼šå¿«é€Ÿã€ç¨³å®šã€å¯æ§
- LLMï¼šçµæ´»ã€è‡ªç„¶ã€ä¸ªæ€§åŒ–
- æ··åˆï¼šå¹³è¡¡æ•ˆæœå’Œæˆæœ¬

âœ… **é™çº§æœºåˆ¶**

- æ¨¡æ¿å‚æ•°ç¼ºå¤±æ—¶ä½¿ç”¨ç®€åŒ–æ¨¡æ¿
- LLMå¤±è´¥æ—¶é™çº§åˆ°æ¨¡æ¿
- ä¿è¯ç³»ç»Ÿç¨³å®šæ€§

âœ… **åå¤„ç†ä¼˜åŒ–**

- é•¿åº¦æ§åˆ¶ï¼ˆæœ€å¤š500å­—ï¼‰
- æ ¼å¼åŒ–ï¼ˆemojié—´éš”ï¼‰
- å¼•å¯¼è¯­æ·»åŠ 



## 4. æ•°æ®æµè½¬ä¸æ—¶åº

### 4.1 å®Œæ•´å¯¹è¯æµç¨‹å›¾

```mermaid
graph TB
    Start([ç”¨æˆ·è¾“å…¥]) --> WebSocket[WebSocketæ¥æ”¶]
    WebSocket --> ChatAPI[è°ƒç”¨ChatAPI]
    
    ChatAPI --> CheckConfirm{æ˜¯ç¡®è®¤å“åº”?}
    
    CheckConfirm -->|æ˜¯| LoadState1[åŠ è½½çŠ¶æ€]
    CheckConfirm -->|å¦| NLU[NLUç†è§£]
    
    LoadState1 --> HasPending{æœ‰å¾…ç¡®è®¤?}
    HasPending -->|æ˜¯| HandleConfirm[å¤„ç†ç¡®è®¤å“åº”]
    HasPending -->|å¦| NLU
    
    HandleConfirm --> IsPositive{ç”¨æˆ·ç¡®è®¤?}
    IsPositive -->|æ˜¯| ExecuteBusiness[æ‰§è¡Œä¸šåŠ¡]
    IsPositive -->|å¦| CancelAction[å–æ¶ˆæ“ä½œ]
    
    NLU --> DST[DSTçŠ¶æ€è·Ÿè¸ª]
    
    DST --> CheckClarify{éœ€è¦æ¾„æ¸…?}
    
    CheckClarify -->|æ˜¯| PolicyPreDecide[Policyé¢„å†³ç­–]
    CheckClarify -->|å¦| PolicyPreDecide
    
    PolicyPreDecide --> NeedConfirm{éœ€è¦ç¡®è®¤?}
    
    NeedConfirm -->|æ˜¯| SavePending[ä¿å­˜å¾…ç¡®è®¤çŠ¶æ€]
    NeedConfirm -->|å¦| ExecuteBusiness2[æ‰§è¡Œä¸šåŠ¡]
    
    SavePending --> NLG1[NLGç”Ÿæˆç¡®è®¤è¯æœ¯]
    ExecuteBusiness2 --> CheckResult{æ‰§è¡ŒæˆåŠŸ?}
    ExecuteBusiness --> CheckResult
    
    CheckResult -->|æ˜¯| PolicyFinalDecide[Policyæœ€ç»ˆå†³ç­–]
    CheckResult -->|å¦| PolicyErrorDecide[Policyé”™è¯¯å†³ç­–]
    
    PolicyFinalDecide --> NLG2[NLGç”ŸæˆæˆåŠŸå›å¤]
    PolicyErrorDecide --> NLG3[NLGç”Ÿæˆé”™è¯¯å›å¤]
    CancelAction --> NLG4[NLGç”Ÿæˆå–æ¶ˆå›å¤]
    
    NLG1 --> UpdateState[æ›´æ–°çŠ¶æ€]
    NLG2 --> UpdateState
    NLG3 --> UpdateState
    NLG4 --> UpdateState
    
    UpdateState --> SaveRedis[ä¿å­˜åˆ°Redis]
    SaveRedis --> ReturnResponse[è¿”å›å“åº”]
    
    ReturnResponse --> WebSocketSend[WebSocketå‘é€]
    WebSocketSend --> End([å‰ç«¯å±•ç¤º])
```

#### 4.2 æ•´ä½“å¯¹è¯æ—¶åºå›¾

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant W as WebSocket
    participant API as ChatAPI
    participant Bot as TelecomChatbot
    participant NLU as NLUå¼•æ“
    participant DST as DSTè·Ÿè¸ªå™¨
    participant Policy as Policyå¼•æ“
    participant NLG as NLGç”Ÿæˆå™¨
    participant Exec as Executor
    participant DB as MySQL
    participant Redis as Redis
    
    U->>W: å‘é€æ¶ˆæ¯
    W->>API: WebSocketæ¶ˆæ¯
    
    Note over API,Bot: ã€é˜¶æ®µ1ã€‘NLUç†è§£
    API->>Bot: chat(user_input)
    Bot->>NLU: understand()
    NLU->>NLU: é¢„å¤„ç† + ä¸Šä¸‹æ–‡
    NLU->>DeepSeek: Function Calling
    DeepSeek-->>NLU: Function + å‚æ•°
    NLU-->>Bot: NLUResult
    
    Note over Bot,DST: ã€é˜¶æ®µ2ã€‘DSTè·Ÿè¸ª
    Bot->>DST: track(nlu_result)
    DST->>Redis: load(session_id)
    Redis-->>DST: old_state
    DST->>DST: åˆå¹¶æ§½ä½ + æ›´æ–°ä¸Šä¸‹æ–‡
    DST->>Redis: save(new_state)
    DST-->>Bot: DialogState
    
    Note over Bot,Policy: ã€é˜¶æ®µ3ã€‘Policyå†³ç­–
    Bot->>Policy: decide(state, exec_result=None)
    
    alt éœ€è¦ç¡®è®¤
        Policy-->>Bot: Action(CONFIRM)
        Bot->>DST: set_pending_confirmation()
        Bot->>NLG: generate(CONFIRM)
        NLG-->>Bot: ç¡®è®¤è¯æœ¯
        Bot-->>API: è¿”å›ç¡®è®¤è¯·æ±‚
        API-->>W: å‘é€ç¡®è®¤è¯·æ±‚
        W-->>U: æ˜¾ç¤ºç¡®è®¤è¯·æ±‚
    else éœ€è¦æ¾„æ¸…
        Policy-->>Bot: Action(REQUEST)
        Bot->>NLG: generate(REQUEST)
        NLG-->>Bot: è¿½é—®è¯æœ¯
        Bot-->>API: è¿”å›è¿½é—®
        API-->>W: å‘é€è¿½é—®
        W-->>U: æ˜¾ç¤ºè¿½é—®
    else æ‰§è¡Œä¸šåŠ¡
        Policy-->>Bot: Action(EXECUTE)
        Bot->>Exec: execute_function()
        Exec->>DB: SQLæŸ¥è¯¢
        DB-->>Exec: æŸ¥è¯¢ç»“æœ
        Exec-->>Bot: exec_result
        
        Bot->>Policy: decide(state, exec_result)
        Policy-->>Bot: Action(INFORM)
        Bot->>NLG: generate(INFORM)
        NLG-->>Bot: å›å¤æ–‡æœ¬
        Bot-->>API: è¿”å›ç»“æœ
        API-->>W: å‘é€ç»“æœ
        W-->>U: æ˜¾ç¤ºç»“æœ
    end
```

## 5. å¸¸è§å¯¹è¯åœºæ™¯

### 5.1 åœºæ™¯1ï¼šç®€å•å¥—é¤æŸ¥è¯¢

**å¯¹è¯ç¤ºä¾‹**ï¼š

```
ç”¨æˆ·: æœ‰100å…ƒä»¥å†…çš„å¥—é¤å—
ç³»ç»Ÿ: ä¸ºæ‚¨æ‰¾åˆ°1ä¸ªåˆé€‚çš„å¥—é¤ï¼š

ã€ç»æµå¥—é¤ã€‘
ğŸ’° æœˆè´¹: 50å…ƒ
ğŸ“Š æµé‡: 10GB/æœˆ
ğŸ“ é€šè¯: 100åˆ†é’Ÿ/æœˆ
ğŸ‘¥ é€‚ç”¨: æ— é™åˆ¶
ğŸ“ é€‚åˆè½»åº¦ä¸Šç½‘ç”¨æˆ·,æ€§ä»·æ¯”é«˜

å¦‚éœ€åŠç†æˆ–äº†è§£è¯¦æƒ…,è¯·å‘Šè¯‰æˆ‘å¥—é¤åç§°å’Œæ‚¨çš„æ‰‹æœºå·ç ã€‚
```

**æ—¶åºå›¾**ï¼š

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant Bot as Chatbot
    participant NLU as NLU
    participant DST as DST
    participant Exec as Executor
    participant DB as MySQL
    
    U->>Bot: "æœ‰100å…ƒä»¥å†…çš„å¥—é¤å—"
    
    Bot->>NLU: understand()
    NLU-->>Bot: intent=query_packages, params={price_max:100}
    
    Bot->>DST: track()
    DST-->>Bot: state{slots:{price_max:100}, needs_clarification=False}
    
    Bot->>Exec: execute_function(query_packages)
    Exec->>DB: SELECT * FROM packages WHERE price <= 100
    DB-->>Exec: [ç»æµå¥—é¤]
    Exec-->>Bot: {success:true, data:[...], count:1}
    
    Bot->>Bot: NLGç”Ÿæˆå›å¤
    Bot-->>U: "ä¸ºæ‚¨æ‰¾åˆ°1ä¸ªåˆé€‚çš„å¥—é¤..."
```

### 5.2 åœºæ™¯2ï¼šå¤šè½®æ§½ä½å¡«å……

**å¯¹è¯ç¤ºä¾‹**ï¼š

```
ç”¨æˆ·: æˆ‘è¦åŠç†ç»æµå¥—é¤
ç³»ç»Ÿ: è¯·é—®æ‚¨çš„æ‰‹æœºå·æ˜¯å¤šå°‘å‘¢ï¼Ÿ

ç”¨æˆ·: 13800138000
ç³»ç»Ÿ: è¯·ç¡®è®¤ï¼šä¸ºæ‰‹æœºå· 13800138000 åŠç†ã€ç»æµå¥—é¤ã€‘å¥—é¤ï¼Œæ˜¯å¦ç¡®è®¤ï¼Ÿ

ç”¨æˆ·: ç¡®è®¤
ç³»ç»Ÿ: å·²æˆåŠŸä¸ºæ‚¨åŠç†ã€ç»æµå¥—é¤ã€‘ï¼Œæ¬¡æœˆç”Ÿæ•ˆï¼
```

**æ—¶åºå›¾**ï¼š

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant Bot as Chatbot
    participant DST as DST
    participant Policy as Policy
    participant Exec as Executor
    
    Note over U,Exec: ç¬¬1è½®ï¼šæ„å›¾è¯†åˆ«
    U->>Bot: "æˆ‘è¦åŠç†ç»æµå¥—é¤"
    Bot->>DST: track()
    DST-->>Bot: state{intent:change_package, slots:{new_package_name:ç»æµå¥—é¤}, missing:[phone]}
    Bot->>Policy: decide()
    Policy-->>Bot: Action(REQUEST, slot=phone)
    Bot-->>U: "è¯·é—®æ‚¨çš„æ‰‹æœºå·æ˜¯å¤šå°‘å‘¢ï¼Ÿ"
    
    Note over U,Exec: ç¬¬2è½®ï¼šæ§½ä½å¡«å……
    U->>Bot: "13800138000"
    Bot->>DST: track()
    DST-->>Bot: state{slots:{new_package_name:ç»æµå¥—é¤, phone:138...}, complete=true}
    Bot->>Policy: decide()
    Policy-->>Bot: Action(CONFIRM, requires_confirmation=true)
    Bot->>DST: set_pending_confirmation()
    Bot-->>U: "è¯·ç¡®è®¤ï¼šä¸ºæ‰‹æœºå·..."
    
    Note over U,Exec: ç¬¬3è½®ï¼šç¡®è®¤å“åº”
    U->>Bot: "ç¡®è®¤"
    Bot->>Bot: æ£€æµ‹åˆ°ç¡®è®¤è¯ + pending_confirmation
    Bot->>Exec: execute_function(change_package)
    Exec-->>Bot: {success:true, message:åŠç†æˆåŠŸ}
    Bot->>DST: clear_pending_confirmation()
    Bot-->>U: "å·²æˆåŠŸä¸ºæ‚¨åŠç†..."
```

### 5.3 åœºæ™¯3ï¼šæ„å›¾åˆ‡æ¢ä¸ä¸Šä¸‹æ–‡ç»§æ‰¿

**å¯¹è¯ç¤ºä¾‹**ï¼š

```tex
ç”¨æˆ·: æœ‰ä¾¿å®œçš„å¥—é¤å—
ç³»ç»Ÿ: ä¸ºæ‚¨æ‰¾åˆ°4ä¸ªåˆé€‚çš„å¥—é¤... [å±•ç¤ºåˆ—è¡¨]

ç”¨æˆ·: æµé‡è¦50Gä»¥ä¸Š
ç³»ç»Ÿ: ä¸ºæ‚¨æ‰¾åˆ°2ä¸ªåˆé€‚çš„å¥—é¤... [ç­›é€‰ååˆ—è¡¨]

ç”¨æˆ·: æŸ¥ä¸‹æˆ‘çš„å½“å‰å¥—é¤
ç³»ç»Ÿ: è¯·é—®æ‚¨çš„æ‰‹æœºå·æ˜¯å¤šå°‘å‘¢ï¼Ÿ

ç”¨æˆ·: 13800138000
ç³»ç»Ÿ: ğŸ“± æ‚¨å½“å‰ä½¿ç”¨çš„æ˜¯ã€ç»æµå¥—é¤ã€‘...
```

**å…³é”®ç‚¹**ï¼š

- âœ… ç¬¬2è½®ï¼šæ„å›¾ä¸å˜ï¼ˆquery_packagesï¼‰ï¼Œæ§½ä½ç»§æ‰¿ï¼ˆsort_byï¼‰ + æ–°å¢ï¼ˆdata_minï¼‰
- âœ… ç¬¬3è½®ï¼šæ„å›¾åˆ‡æ¢ï¼ˆquery_current_packageï¼‰ï¼Œæ¸…ç©ºä¸šåŠ¡æ§½ä½ï¼Œä¿ç•™ç”¨æˆ·ä¿¡æ¯
- âœ… ç¬¬4è½®ï¼šæ§½ä½å¡«å……ï¼ˆphoneï¼‰ï¼Œè‡ªåŠ¨ç»§æ‰¿åˆ°åç»­å¯¹è¯

**æ—¶åºå›¾**ï¼š

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant DST as DST
    participant SlotMgr as SlotManager
    
    Note over U,SlotMgr: ç¬¬1è½®
    U->>DST: "æœ‰ä¾¿å®œçš„å¥—é¤å—"
    DST->>DST: intent=query_packages
    DST-->>U: state{slots:{sort_by:price_asc}}
    
    Note over U,SlotMgr: ç¬¬2è½®ï¼šæ„å›¾ä¸å˜
    U->>DST: "æµé‡è¦50Gä»¥ä¸Š"
    DST->>DST: intent=query_packages (ä¸å˜)
    DST->>SlotMgr: fill_slots(intent_changed=False)
    SlotMgr-->>DST: åˆå¹¶æ§½ä½
    DST-->>U: state{slots:{sort_by:price_asc, data_min:50}}
    
    Note over U,SlotMgr: ç¬¬3è½®ï¼šæ„å›¾åˆ‡æ¢
    U->>DST: "æŸ¥ä¸‹æˆ‘çš„å½“å‰å¥—é¤"
    DST->>DST: intent=query_current_package (åˆ‡æ¢)
    DST->>SlotMgr: fill_slots(intent_changed=True)
    SlotMgr->>SlotMgr: æ¸…ç©ºä¸šåŠ¡æ§½ä½
    SlotMgr-->>DST: ä»…ä¿ç•™ç”¨æˆ·ä¿¡æ¯
    DST-->>U: state{slots:{}, missing:[phone]}
```

### 5.4 åœºæ™¯4ï¼šç¡®è®¤æµç¨‹å®Œæ•´ç¤ºä¾‹

**å¯¹è¯ç¤ºä¾‹**ï¼š

```
ç”¨æˆ·: å¸®æˆ‘åŠç†ç•…æ¸¸å¥—é¤ï¼Œæ‰‹æœºå·13800138000
ç³»ç»Ÿ: è¯·ç¡®è®¤ï¼šä¸ºæ‰‹æœºå· 13800138000 åŠç†ã€ç•…æ¸¸å¥—é¤ã€‘(180å…ƒ/æœˆ)ï¼Œæ˜¯å¦ç¡®è®¤ï¼Ÿ

ç”¨æˆ·: ç¡®è®¤
ç³»ç»Ÿ: å·²æˆåŠŸä¸ºæ‚¨åŠç†ã€ç•…æ¸¸å¥—é¤ã€‘ï¼Œæ¬¡æœˆç”Ÿæ•ˆï¼
```

**ç¡®è®¤æµç¨‹å›¾**ï¼š

```mermaid
stateDiagram-v2
    [*] --> æ¥æ”¶åŠç†è¯·æ±‚
    æ¥æ”¶åŠç†è¯·æ±‚ --> NLUç†è§£
    NLUç†è§£ --> DSTè·Ÿè¸ª
    DSTè·Ÿè¸ª --> Policyå†³ç­–
    
    Policyå†³ç­– --> éœ€è¦ç¡®è®¤?: æ£€æŸ¥ç¡®è®¤è§„åˆ™
    
    éœ€è¦ç¡®è®¤? --> ä¿å­˜å¾…ç¡®è®¤çŠ¶æ€: æ˜¯
    éœ€è¦ç¡®è®¤? --> ç›´æ¥æ‰§è¡Œ: å¦
    
    ä¿å­˜å¾…ç¡®è®¤çŠ¶æ€ --> NLGç”Ÿæˆç¡®è®¤è¯æœ¯
    NLGç”Ÿæˆç¡®è®¤è¯æœ¯ --> è¿”å›ç¡®è®¤è¯·æ±‚
    è¿”å›ç¡®è®¤è¯·æ±‚ --> ç­‰å¾…ç”¨æˆ·å“åº”
    
    ç­‰å¾…ç”¨æˆ·å“åº” --> æ¥æ”¶ç¡®è®¤å“åº”
    æ¥æ”¶ç¡®è®¤å“åº” --> è¯†åˆ«ç¡®è®¤è¯
    
    è¯†åˆ«ç¡®è®¤è¯ --> ç”¨æˆ·ç¡®è®¤?: åˆ¤æ–­
    
    ç”¨æˆ·ç¡®è®¤? --> æ‰§è¡Œä¸šåŠ¡: æ˜¯
    ç”¨æˆ·ç¡®è®¤? --> å–æ¶ˆæ“ä½œ: å¦
    
    æ‰§è¡Œä¸šåŠ¡ --> æ¸…é™¤ç¡®è®¤çŠ¶æ€
    å–æ¶ˆæ“ä½œ --> æ¸…é™¤ç¡®è®¤çŠ¶æ€
    
    æ¸…é™¤ç¡®è®¤çŠ¶æ€ --> NLGç”Ÿæˆç»“æœ
    ç›´æ¥æ‰§è¡Œ --> NLGç”Ÿæˆç»“æœ
    NLGç”Ÿæˆç»“æœ --> [*]
```

### 5.5 åœºæ™¯5ï¼šæ¨èè§¦å‘åœºæ™¯

**å¯¹è¯ç¤ºä¾‹**ï¼š

```
ç”¨æˆ·: æ¨èä¸€ä¸ªå¥—é¤
ç³»ç»Ÿ: ä¸ºæ‚¨æ‰¾åˆ°4ä¸ªåˆé€‚çš„å¥—é¤ï¼š

[å±•ç¤º4ä¸ªå¥—é¤åˆ—è¡¨]

ğŸ’¡ æ ¹æ®æ‚¨çš„éœ€æ±‚ï¼Œæ¨èã€ç•…æ¸¸å¥—é¤ã€‘
æ¨èç†ç”±ï¼šæµé‡å……è¶³ã€æ€§ä»·æ¯”å¾ˆé«˜

å¦‚éœ€åŠç†ï¼Œè¯·å‘Šè¯‰æˆ‘æ‚¨çš„æ‰‹æœºå·ç ã€‚
```

**æ¨èæµç¨‹**ï¼š

```mermaid
graph LR
    A[æŸ¥è¯¢ç»“æœ] --> B{ç»“æœæ•°é‡}
    B -->|2-10ä¸ª| C[è§¦å‘æ¨è]
    B -->|å…¶ä»–| D[ä¸æ¨è]
    
    C --> E[æå–ç”¨æˆ·ç‰¹å¾]
    E --> F[è®¡ç®—æ¨èåˆ†æ•°]
    F --> G[é€‰æ‹©æœ€ä½³å¥—é¤]
    G --> H[ç”Ÿæˆæ¨èç†ç”±]
    H --> I[è¿”å›æ¨è]
```

## 6. æŠ€æœ¯å®ç°è¦ç‚¹

### 6.1 æ ¸å¿ƒæŠ€æœ¯æ ˆ

| æŠ€æœ¯      | ç‰ˆæœ¬          | ç”¨é€”       |
| --------- | ------------- | ---------- |
| Python    | 3.13          | ä¸»å¼€å‘è¯­è¨€ |
| FastAPI   | æœ€æ–°          | Webæ¡†æ¶    |
| DeepSeek  | deepseek-chat | å¤§è¯­è¨€æ¨¡å‹ |
| MySQL     | 8.0           | ä¸šåŠ¡æ•°æ®åº“ |
| Redis     | 7.0           | ä¼šè¯å­˜å‚¨   |
| WebSocket | -             | å®æ—¶é€šä¿¡   |

### 6.2 å…³é”®é…ç½®

```python
# config/settings.py
class Settings(BaseSettings):
    # å¤§æ¨¡å‹é…ç½®
    LLM_PROVIDER: str = "deepseek"
    DEEPSEEK_API_KEY: str
    DEEPSEEK_MODEL: str = "deepseek-chat"
    
    # æ•°æ®åº“é…ç½®
    DB_HOST: str = "localhost"
    DB_PORT: int = 3306
    DB_NAME: str = "telecom_chatbot"
    
    # Redisé…ç½®
    REDIS_HOST: str = "localhost"
    REDIS_PORT: int = 6379
    
    # ä¼šè¯é…ç½®
    SESSION_TIMEOUT: int = 1800  # 30åˆ†é’Ÿ
    MAX_CONTEXT_TURNS: int = 10
    
    # ç¡®è®¤é…ç½®
    CONFIRMATION_TIMEOUT_MINUTES: int = 5
```

### 6.3 æ€§èƒ½ä¼˜åŒ–

#### 6.3.1 ç¼“å­˜ç­–ç•¥

```python
class ResponseCache:
    """å“åº”ç¼“å­˜"""
    
    def __init__(self, ttl=300, max_size=1000):
        self.cache = {}
        self.ttl = ttl  # 5åˆ†é’Ÿ
        self.max_size = max_size
    
    def get(self, cache_key: str) -> Optional[str]:
        """è·å–ç¼“å­˜"""
        if cache_key in self.cache:
            cached = self.cache[cache_key]
            if time.time() - cached["time"] < self.ttl:
                return cached["response"]
        return None
```

**ç¼“å­˜ç­–ç•¥**ï¼š

- âœ… å¯¹REQUEST/CONFIRMç±»åŠ¨ä½œç¼“å­˜ï¼ˆç¡®å®šæ€§å›å¤ï¼‰
- âŒ å¯¹INFORMç±»åŠ¨ä½œä¸ç¼“å­˜ï¼ˆæ•°æ®å®æ—¶æ€§ï¼‰
- ğŸ”„ TTL=5åˆ†é’Ÿï¼Œè¶…æ—¶è‡ªåŠ¨å¤±æ•ˆ

#### 6.3.2 æ•°æ®åº“è¿æ¥æ± 

```python
from sqlalchemy import create_engine, QueuePool

engine = create_engine(
    database_url,
    poolclass=QueuePool,
    pool_size=5,
    max_overflow=10,
    pool_recycle=3600
)
```



## 7. ä¼˜åŒ–ä¸å»ºè®®

### 7.1 å½“å‰æ–¹æ¡ˆä¸è¶³

#### 7.1.1 æ¶æ„å±‚é¢

| é—®é¢˜       | æè¿°                     | å½±å“                   |
| ---------- | ------------------------ | ---------------------- |
| å•ä½“æ¶æ„   | æ‰€æœ‰æ¨¡å—è€¦åˆåœ¨ä¸€ä¸ªåº”ç”¨ä¸­ | æ‰©å±•æ€§å·®ï¼Œéš¾ä»¥æ°´å¹³æ‰©å±• |
| æ— æœåŠ¡æ²»ç† | ç¼ºå°‘æœåŠ¡æ³¨å†Œ/å‘ç°æœºåˆ¶    | å¤šå®ä¾‹éƒ¨ç½²å›°éš¾         |
| æ— è´Ÿè½½å‡è¡¡ | å•ç‚¹æ•…éšœé£é™©             | é«˜å¹¶å‘åœºæ™¯æ€§èƒ½ç“¶é¢ˆ     |
| æ—¥å¿—åˆ†æ•£   | æ— ç»Ÿä¸€æ—¥å¿—æ”¶é›†           | é—®é¢˜æ’æŸ¥å›°éš¾           |

#### 7.1.2 åŠŸèƒ½å±‚é¢

| é—®é¢˜         | æè¿°                   | å½±å“                 |
| ------------ | ---------------------- | -------------------- |
| RAGæœªå®ç°    | ä¸šåŠ¡å’¨è¯¢åŠŸèƒ½é¢„ç•™æœªå¼€å‘ | æ— æ³•å›ç­”å¤æ‚ä¸šåŠ¡é—®é¢˜ |
| æ— ç”¨æˆ·ç”»åƒ   | ç¼ºå°‘ç”¨æˆ·å†å²è¡Œä¸ºåˆ†æ   | æ¨èæ•ˆæœä¸€èˆ¬         |
| å•ä¸€æ¨èç­–ç•¥ | ä»…åŸºäºè§„åˆ™æ¨è         | æ¨èç²¾å‡†åº¦æœ‰é™       |
| æ— A/Bæµ‹è¯•    | æ— æ³•è¯„ä¼°ç­–ç•¥æ•ˆæœ       | ä¼˜åŒ–è¿­ä»£å›°éš¾         |

#### 7.1.3 å·¥ç¨‹å±‚é¢

| é—®é¢˜       | æè¿°                   | å½±å“             |
| ---------- | ---------------------- | ---------------- |
| æ— ç›‘æ§å‘Šè­¦ | ç¼ºå°‘Prometheus/Grafana | æ— æ³•åŠæ—¶å‘ç°é—®é¢˜ |
| æ— é“¾è·¯è¿½è¸ª | ç¼ºå°‘Jaeger/SkyWalking  | æ€§èƒ½ç“¶é¢ˆå®šä½å›°éš¾ |
| æµ‹è¯•è¦†ç›–ä½ | å•å…ƒæµ‹è¯•ä¸å®Œå–„         | å›å½’é£é™©é«˜       |
| æ— ç°åº¦å‘å¸ƒ | ç›´æ¥å…¨é‡ä¸Šçº¿           | é£é™©é«˜           |

#### 7.1.4 NLUæ¨¡å—æ ¸å¿ƒé—®é¢˜ â­ **ï¼ˆé‡ç‚¹ï¼‰**

##### é—®é¢˜1ï¼šè¿‡åº¦ä¾èµ–LLM

**ç°çŠ¶**ï¼š

```python
# å½“å‰æ–¹æ¡ˆï¼š100%ä¾èµ–LLM Function Calling
response = llm.chat.completions.create(
    model="deepseek-chat",
    messages=[...],
    tools=FUNCTION_DEFINITIONS,  # 6ä¸ªFunctionå…¨é‡æä¾›
    tool_choice="required"        # å¼ºåˆ¶è°ƒç”¨
)
```

**é—®é¢˜åˆ†æ**ï¼š

| ç»´åº¦     | ç°çŠ¶                 | é—®é¢˜           |
| -------- | -------------------- | -------------- |
| å“åº”æ—¶é—´ | 500-1000ms           | ç”¨æˆ·ä½“éªŒå·®     |
| APIæˆæœ¬  | $1000/æœˆï¼ˆé«˜é¢‘è°ƒç”¨ï¼‰ | è¿è¥æˆæœ¬é«˜     |
| å‡†ç¡®ç‡   | 80-85%               | é•¿å°¾åœºæ™¯è¯¯åˆ¤å¤š |
| å¯æ§æ€§   | ä½ï¼ˆé»‘ç›’æ¨¡å‹ï¼‰       | éš¾ä»¥è°ƒè¯•ä¼˜åŒ–   |
| ç¨³å®šæ€§   | ä¾èµ–å¤–éƒ¨API          | æœåŠ¡å¯ç”¨æ€§é£é™© |

##### é—®é¢˜2ï¼šå®ä½“è¯†åˆ«èƒ½åŠ›ä¸è¶³

**ç°çŠ¶**ï¼š

- ä»…æ”¯æŒ4ä¸ªå¥—é¤çš„ç²¾ç¡®åŒ¹é…
- ç”¨æˆ·è¾“å…¥"ç•…æƒ³å¥—é¤"è¯†åˆ«å¤±è´¥
- æ— æ³•å¤„ç†åŒä¹‰è¯ã€æ‹¼å†™é”™è¯¯

**å½±å“**ï¼š

```
ç”¨æˆ·: "æˆ‘è¦åŠç†ç•…æƒ³å¥—é¤"  âŒ
â””â”€> æ— æ³•è¯†åˆ«ï¼ˆå®é™…åº”ä¸º"ç•…æ¸¸å¥—é¤"ï¼‰

ç”¨æˆ·: "æœ‰æ²¡æœ‰100å¿«çš„"  âŒ
â””â”€> æ— æ³•è¯†åˆ«ï¼ˆå¿« â†’ å— â†’ å…ƒï¼‰

ç”¨æˆ·: "å­¦ç”Ÿä¼˜æƒ å¥—é¤"  âŒ
â””â”€> æ— æ³•è¯†åˆ«ï¼ˆåº”ä¸º"æ ¡å›­å¥—é¤"ï¼‰
```

##### é—®é¢˜3ï¼šæ— å±‚çº§æ„å›¾åˆ†ç±»

**ç°çŠ¶**ï¼š

- ç›´æ¥ä»6ä¸ªFunctionä¸­é€‰æ‹©
- æ— ä¸€çº§åˆ†æµæœºåˆ¶
- æ¯æ¬¡éƒ½è¦å¤„ç†å…¨éƒ¨å¯èƒ½æ€§

**æ•ˆç‡é—®é¢˜**ï¼š

```
å½“å‰ï¼š6ä¸ªFunctionå…¨é‡åˆ¤æ–­
ä¼˜åŒ–ï¼šå…ˆä¸€çº§åˆ†ç±»(3-4ç±») â†’ å†äºŒçº§åˆ†ç±»(2-3ä¸ª)
æ•ˆç‡æå‡ï¼šO(6) â†’ O(3+2) = æå‡20%+
```

### 7.2 ä¼˜åŒ–

#### 7.2.1 æˆç†ŸNLUç³»ç»Ÿå®Œæ•´æ–¹æ¡ˆ â­

#### 1. æ ¸å¿ƒè®¾è®¡åŸåˆ™

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              æˆç†ŸNLUç³»ç»Ÿçš„ä¸‰å¤§åŸåˆ™                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                      â”‚
â”‚  1ï¸âƒ£ åˆ†å±‚é™ç»´ (Divide & Conquer)                     â”‚
â”‚     å¤æ‚é—®é¢˜ â†’ å¤šä¸ªç®€å•é—®é¢˜                          â”‚
â”‚     100ä¸ªæ„å›¾ â†’ 10Ã—10åˆ†ç»„                            â”‚
â”‚     å¤æ‚åº¦: O(nÂ²) â†’ O(2n)                            â”‚
â”‚                                                      â”‚
â”‚  2ï¸âƒ£ æ··åˆæ¶æ„ (Hybrid Approach)                      â”‚
â”‚     è§„åˆ™å¤„ç†é«˜é¢‘(80%) â†’ å¿«é€Ÿã€å‡†ç¡®                   â”‚
â”‚     æ¨¡å‹å¤„ç†å¤æ‚(15%) â†’ å¯æ§ã€ä¼˜åŒ–                   â”‚
â”‚     LLMå…œåº•(5%) â†’ çµæ´»ã€è¦†ç›–é•¿å°¾                     â”‚
â”‚                                                      â”‚
â”‚  3ï¸âƒ£ å„å¸å…¶èŒ (Specialized Components)               â”‚
â”‚     æ¯ä¸ªæ¨¡å—åšæ“…é•¿çš„äº‹                               â”‚
â”‚     ä¸å¼ºæ±‚ç«¯åˆ°ç«¯å¤§æ¨¡å‹                               â”‚
â”‚                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

##### 2. å®Œæ•´æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ç”¨æˆ·è¾“å…¥å±‚                          â”‚
â”‚              "æˆ‘è¦åŠç†ç•…æƒ³å¥—é¤"                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              é¢„å¤„ç†å±‚ (10ms)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ ASRçº é”™  â”‚â†’â”‚  åˆ†è¯    â”‚â†’â”‚  å½’ä¸€åŒ–  â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        ğŸš€ ä¸€çº§æ„å›¾åˆ†ç±» (50ms) - å¿«é€Ÿåˆ†æµ              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  FastText/BERTåˆ†ç±»å™¨ (10-20ä¸ªå¤§ç±»)          â”‚    â”‚
â”‚  â”‚  - query     (æŸ¥è¯¢ç±»)                       â”‚    â”‚
â”‚  â”‚  - transaction (åŠç†ç±») âœ“                   â”‚    â”‚
â”‚  â”‚  - consultation (å’¨è¯¢ç±»)                    â”‚    â”‚
â”‚  â”‚  - complaint (æŠ•è¯‰ç±»)                       â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     ğŸ¯ å®ä½“è¯†åˆ« + é“¾æ¥ (30ms) - å¤„ç†æµ·é‡å®ä½“          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  NERæ¨¡å‹ (BiLSTM-CRF) + å‘é‡æ£€ç´¢             â”‚    â”‚
â”‚  â”‚  "ç•…æƒ³" â†’ Embedding â†’ ç›¸ä¼¼åº¦æœç´¢             â”‚    â”‚
â”‚  â”‚          â†’ "ç•…æ¸¸å¥—é¤" (0.95ç›¸ä¼¼åº¦)           â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚  æ”¯æŒï¼š1ä¸‡+ å¥—é¤ã€æ¨¡ç³ŠåŒ¹é…ã€æ‹¼å†™çº é”™                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      ğŸ§  äºŒçº§æ„å›¾è¯†åˆ« (100ms) - ç²¾å‡†åˆ†ç±»               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  ç­–ç•¥1: è§„åˆ™åŒ¹é… (80%åœºæ™¯, 5ms)              â”‚    â”‚
â”‚  â”‚  - é«˜é¢‘æ¨¡å¼: "åŠç†+å¥—é¤å" â†’ change_package   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚            â†“ æœªå‘½ä¸­                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  ç­–ç•¥2: åˆ†ç±»å™¨ (15%åœºæ™¯, 50ms)               â”‚    â”‚
â”‚  â”‚  - ç›¸åŒå¤§ç±»ä¸‹çš„ç»†åˆ†ç±»: BERTå¾®è°ƒæ¨¡å‹           â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚            â†“ æœªå‘½ä¸­                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  ç­–ç•¥3: LLM Function Calling (5%åœºæ™¯, 500ms) â”‚    â”‚
â”‚  â”‚  - åŠ¨æ€é€‰æ‹©5-10ä¸ªç›¸å…³Function                â”‚    â”‚
â”‚  â”‚  - å¤æ‚åœºæ™¯å…œåº•                              â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           ğŸ“ æ§½ä½å¡«å…… + éªŒè¯ (50ms)                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  - å‚æ•°å®Œæ•´æ€§æ£€æŸ¥                            â”‚    â”‚
â”‚  â”‚  - ä¸Šä¸‹æ–‡è¡¥å…¨                                â”‚    â”‚
â”‚  â”‚  - å¤šè½®å¯¹è¯ç®¡ç† (DST)                        â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           ğŸ­ å¯¹è¯ç­–ç•¥ + NLG (100ms)                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Policy: ç¡®è®¤/æ‰§è¡Œ/è¿½é—®/æ¨è                 â”‚    â”‚
â”‚  â”‚  NLG: æ¨¡æ¿(80%) + LLM(20%)                  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“
                  ç»“æ„åŒ–è¾“å‡º
            {intent, entities, action}
```

##### 3. è¯¦ç»†æ•°æ®æµç¨‹

**å®Œæ•´æµç¨‹ï¼ˆä»¥"æˆ‘è¦åŠç†ç•…æƒ³å¥—é¤"ä¸ºä¾‹ï¼‰**ï¼š

| é˜¶æ®µ        | è¾“å…¥                 | å¤„ç†         | è¾“å‡º                 | æ—¶é—´  |
| ----------- | -------------------- | ------------ | -------------------- | ----- |
| 0. é¢„å¤„ç†   | "æˆ‘è¦åŠç†ç•…æƒ³å¥—é¤"   | åˆ†è¯ã€å½’ä¸€åŒ– | "æˆ‘è¦/åŠç†/ç•…æƒ³å¥—é¤" | 10ms  |
| 1. ä¸€çº§æ„å›¾ | å¤„ç†åæ–‡æœ¬           | FastTextåˆ†ç±» | transaction          | 20ms  |
| 2. å®ä½“è¯†åˆ« | "ç•…æƒ³å¥—é¤"           | å‘é‡æ£€ç´¢     | "ç•…æ¸¸å¥—é¤"(0.95)     | 30ms  |
| 3. äºŒçº§æ„å›¾ | transaction + "åŠç†" | è§„åˆ™åŒ¹é…     | change_package       | 5ms   |
| 4. æ§½ä½å¡«å…… | å·²çŸ¥: å¥—é¤å         | å‚æ•°éªŒè¯     | ç¼ºå¤±: phone          | 10ms  |
| 5. å¯¹è¯ç®¡ç† | çŠ¶æ€ + æ„å›¾          | DST + Policy | REQUEST(phone)       | 20ms  |
| 6. NLGç”Ÿæˆ  | REQUEST(phone)       | æ¨¡æ¿         | "è¯·é—®æ‚¨çš„æ‰‹æœºå·ï¼Ÿ"   | 5ms   |
| æ€»è®¡        |                      |              |                      | 100ms |

##### 4. å…³é”®å†³ç­–æµç¨‹å›¾

```mermaid
graph TB
    Start[ç”¨æˆ·è¾“å…¥] --> Preprocess[é¢„å¤„ç†]
    Preprocess --> L1[ä¸€çº§æ„å›¾åˆ†ç±»]
    
    L1 --> |transaction| Rule1[è§„åˆ™åŒ¹é…]
    L1 --> |query| Rule2[è§„åˆ™åŒ¹é…]
    L1 --> |consultation| Rule3[è§„åˆ™åŒ¹é…]
    
    Rule1 --> |å‘½ä¸­80%| Intent1[change_package]
    Rule1 --> |æœªå‘½ä¸­20%| Classifier[BERTåˆ†ç±»å™¨]
    
    Classifier --> |å‘½ä¸­15%| Intent2[å…·ä½“æ„å›¾]
    Classifier --> |æœªå‘½ä¸­5%| LLM[LLMå…œåº•]
    
    LLM --> Intent3[å…œåº•æ„å›¾]
    
    Intent1 --> Entity[å®ä½“è¯†åˆ«]
    Intent2 --> Entity
    Intent3 --> Entity
    
    Entity --> |å‘é‡æ£€ç´¢| Linked[æ ‡å‡†å®ä½“]
    
    Linked --> Slot[æ§½ä½å¡«å……]
    Slot --> |å®Œæ•´| Execute[æ‰§è¡Œ]
    Slot --> |ç¼ºå¤±| Clarify[è¿½é—®]
    
    Execute --> Response[ç”Ÿæˆå›å¤]
    Clarify --> Response
```

##### 5. æ ¸å¿ƒæŠ€æœ¯é€‰å‹

| æ¨¡å—     | æŠ€æœ¯                   | ä½œç”¨      | æ€§èƒ½    | æˆæœ¬  |
| -------- | ---------------------- | --------- | ------- | ----- |
| ä¸€çº§æ„å›¾ | FastText / BERT        | 10-20åˆ†ç±» | 20-50ms | ä½    |
| äºŒçº§æ„å›¾ | è§„åˆ™ â†’ åˆ†ç±»å™¨ â†’ LLM    | ç²¾å‡†è¯†åˆ«  | 5-500ms | ä½â†’é«˜ |
| å®ä½“è¯†åˆ« | BiLSTM-CRF             | NER       | 30ms    | ä¸­    |
| å®ä½“é“¾æ¥ | Sentence-BERT + å‘é‡DB | 1ä¸‡+å®ä½“  | 30ms    | ä¸­    |
| å‘é‡æ£€ç´¢ | Milvus / Qdrant        | é«˜é€Ÿæ£€ç´¢  | <10ms   | ä½    |
| å¯¹è¯ç®¡ç† | DST (è‡ªç ”)             | çŠ¶æ€è·Ÿè¸ª  | 20ms    | ä½    |
| NLG      | æ¨¡æ¿ + LLM             | ç”Ÿæˆå›å¤  | 5-100ms | ä½â†’ä¸­ |

##### 6. å‡†ç¡®ç‡

**æ€»ä½“å‡†ç¡®ç‡ï¼š95%+**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è§„åˆ™åŒ¹é…:     80% â†’ 98%å‡†ç¡®ç‡    â”‚ â† é«˜é¢‘åœºæ™¯
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ BERTåˆ†ç±»å™¨:   15% â†’ 92%å‡†ç¡®ç‡    â”‚ â† ä¸­ç­‰å¤æ‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ LLMå…œåº•:       5% â†’ 85%å‡†ç¡®ç‡    â”‚ â† é•¿å°¾åœºæ™¯
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åŠ æƒå¹³å‡: 0.8Ã—0.98 + 0.15Ã—0.92 + 0.05Ã—0.85 = 96.5%
```

##### 7. æˆæœ¬å¯¹æ¯”

**çº¯LLMæ–¹æ¡ˆ vs æ··åˆæ¶æ„**ï¼š

| æŒ‡æ ‡     | çº¯LLMï¼ˆå½“å‰ï¼‰ | æ··åˆæ¶æ„ï¼ˆä¼˜åŒ–ï¼‰ | æ”¹å–„  |
| -------- | ------------- | ---------------- | ----- |
| å‡†ç¡®ç‡   | 80-85%        | 95-98%           | +15%  |
| å“åº”æ—¶é—´ | 500ms         | 100ms            | -80%  |
| APIæˆæœ¬  | $1000/æœˆ      | $200/æœˆ          | -80%  |
| å¯æ§æ€§   | ä½ï¼ˆé»‘ç›’ï¼‰    | é«˜ï¼ˆå¯è°ƒè¯•ï¼‰     | +++++ |
| ç¨³å®šæ€§   | ä¾èµ–å¤–éƒ¨API   | è‡ªä¸»å¯æ§         | +++++ |

##### 8. æ ¸å¿ƒä»£ç æ¡†æ¶

```python
class MatureNLUEngine:
    """æˆç†Ÿçš„NLUå¼•æ“ - æ··åˆæ¶æ„"""
    
    def __init__(self):
        # æ ¸å¿ƒç»„ä»¶
        self.level1_classifier = FastTextClassifier()    # ä¸€çº§åˆ†ç±»
        self.rule_engine = RuleEngine()                  # è§„åˆ™å¼•æ“
        self.level2_classifier = BERTClassifier()        # äºŒçº§åˆ†ç±»
        self.entity_linker = EntityLinker()              # å®ä½“é“¾æ¥
        self.llm_fallback = LLMEngine()                  # LLMå…œåº•
    
    def understand(self, user_input: str) -> NLUResult:
        """
        å®Œæ•´çš„ç†è§£æµç¨‹
        
        æµç¨‹: é¢„å¤„ç† â†’ ä¸€çº§åˆ†ç±» â†’ å®ä½“è¯†åˆ« â†’ äºŒçº§åˆ†ç±» â†’ æ§½ä½å¡«å……
        ç­–ç•¥: è§„åˆ™(80%) â†’ åˆ†ç±»å™¨(15%) â†’ LLM(5%)
        """
        # 1. é¢„å¤„ç†
        text = self.preprocess(user_input)
        
        # 2. ä¸€çº§æ„å›¾åˆ†ç±»ï¼ˆå¿«é€Ÿåˆ†æµï¼‰
        level1 = self.level1_classifier.predict(text)  # transaction
        
        # 3. å®ä½“è¯†åˆ« + é“¾æ¥ï¼ˆå¤„ç†1ä¸‡+å®ä½“ï¼‰
        entities = self.entity_linker.extract(text)    # {"å¥—é¤": "ç•…æ¸¸å¥—é¤"}
        
        # 4. äºŒçº§æ„å›¾è¯†åˆ«ï¼ˆä¸‰çº§é™çº§ï¼‰
        # å°è¯•1: è§„åˆ™åŒ¹é…
        intent = self.rule_engine.match(text, level1, entities)
        if intent:  # 80%å‘½ä¸­
            return NLUResult(
                intent=intent, 
                entities=entities, 
                source="rule",
                latency=5
            )
        
        # å°è¯•2: BERTåˆ†ç±»å™¨
        intent, confidence = self.level2_classifier.predict(text, level1)
        if intent and confidence > 0.8:  # 15%å‘½ä¸­
            return NLUResult(
                intent=intent, 
                entities=entities, 
                source="classifier",
                latency=50
            )
        
        # å°è¯•3: LLMå…œåº•
        result = self.llm_fallback.predict(text, level1, entities)  # 5%å‘½ä¸­
        return NLUResult(
            intent=result.intent, 
            entities=entities, 
            source="llm",
            latency=500
        )


class RuleEngine:
    """è§„åˆ™å¼•æ“ - å¤„ç†80%é«˜é¢‘åœºæ™¯"""
    
    def __init__(self):
        self.rules = self._load_rules()
    
    def match(self, text: str, level1: str, entities: dict) -> Optional[str]:
        """è§„åˆ™åŒ¹é…"""
        # è§„åˆ™1: "åŠç†" + å¥—é¤å â†’ change_package
        if level1 == "transaction":
            if "åŠç†" in text and entities.get("å¥—é¤"):
                return "change_package"
            if "æ¢" in text and entities.get("å¥—é¤"):
                return "change_package"
        
        # è§„åˆ™2: "æŸ¥è¯¢" + "å½“å‰" â†’ query_current_package
        if level1 == "query":
            if any(w in text for w in ["æˆ‘çš„", "å½“å‰", "ç°åœ¨çš„"]):
                return "query_current_package"
        
        # è§„åˆ™3: "æ¨è" â†’ query_packages
        if "æ¨è" in text or "æœ‰ä»€ä¹ˆ" in text:
            return "query_packages"
        
        return None


class EntityLinker:
    """å®ä½“é“¾æ¥ - å‘é‡æ£€ç´¢"""
    
    def __init__(self):
        self.vectorstore = MilvusClient()
        self.embedding_model = SentenceBERT()
        
        # é¢„å…ˆåŠ è½½æ‰€æœ‰å¥—é¤çš„å‘é‡
        self.package_vectors = self._load_package_embeddings()
    
    def extract(self, text: str) -> dict:
        """æå–å¹¶é“¾æ¥å®ä½“"""
        entities = {}
        
        # 1. NERè¯†åˆ«å€™é€‰å®ä½“
        candidates = self.ner_model.extract(text)
        
        # 2. å‘é‡æ£€ç´¢æ ‡å‡†åŒ–
        for candidate in candidates:
            # å‘é‡åŒ–
            query_vec = self.embedding_model.encode(candidate)
            
            # æ£€ç´¢æœ€ç›¸ä¼¼çš„æ ‡å‡†å®ä½“
            results = self.vectorstore.search(
                query_vec,
                top_k=1,
                threshold=0.85  # ç›¸ä¼¼åº¦é˜ˆå€¼
            )
            
            if results:
                entities["å¥—é¤"] = results[0].entity
                entities["similarity"] = results[0].score
        
        return entities
```

##### 9. å®ä½“å‘é‡æ£€ç´¢ç¤ºä¾‹

```python
class PackageVectorStore:
    """å¥—é¤å‘é‡åº“"""
    
    def __init__(self):
        self.client = MilvusClient()
        self.embedding_model = SentenceBERT()
        
        # åˆå§‹åŒ–å¥—é¤æ•°æ®
        self.packages = [
            {"id": 1, "name": "ç»æµå¥—é¤", "aliases": ["ç»æµ", "çœé’±", "ä¾¿å®œ"]},
            {"id": 2, "name": "ç•…æ¸¸å¥—é¤", "aliases": ["ç•…æ¸¸", "ç•…æƒ³", "ç•…ç©"]},
            {"id": 3, "name": "æ— é™å¥—é¤", "aliases": ["æ— é™", "ä¸é™", "æ— é™é‡"]},
            {"id": 4, "name": "æ ¡å›­å¥—é¤", "aliases": ["æ ¡å›­", "å­¦ç”Ÿ", "å­¦ç”Ÿä¼˜æƒ "]}
        ]
        
        self._build_index()
    
    def _build_index(self):
        """æ„å»ºå‘é‡ç´¢å¼•"""
        for pkg in self.packages:
            # ä¸»åç§° + æ‰€æœ‰åˆ«å
            texts = [pkg["name"]] + pkg["aliases"]
            
            for text in texts:
                vector = self.embedding_model.encode(text)
                self.client.insert({
                    "vector": vector,
                    "package_id": pkg["id"],
                    "package_name": pkg["name"],
                    "text": text
                })
    
    def search(self, query: str, top_k: int = 1):
        """æœç´¢æœ€ç›¸ä¼¼çš„å¥—é¤"""
        query_vector = self.embedding_model.encode(query)
        
        results = self.client.search(
            collection_name="packages",
            data=[query_vector],
            limit=top_k,
            output_fields=["package_name", "text"]
        )
        
        return results


# ä½¿ç”¨ç¤ºä¾‹
store = PackageVectorStore()

# ç”¨æˆ·è¾“å…¥"ç•…æƒ³å¥—é¤"
result = store.search("ç•…æƒ³")
# è¾“å‡º: {"package_name": "ç•…æ¸¸å¥—é¤", "similarity": 0.95}

# ç”¨æˆ·è¾“å…¥"å­¦ç”Ÿä¼˜æƒ "
result = store.search("å­¦ç”Ÿä¼˜æƒ ")
# è¾“å‡º: {"package_name": "æ ¡å›­å¥—é¤", "similarity": 0.92}
```

#### 7.2.2 RAGè¯†åˆ«ç³»ç»Ÿ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              RAG (æ£€ç´¢å¢å¼ºç”Ÿæˆ) ç³»ç»Ÿ                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                      â”‚
â”‚  1. çŸ¥è¯†åº“æ„å»º                                        â”‚
â”‚     â”œâ”€â”€ æ–‡æ¡£é‡‡é›† (FAQã€æ”¿ç­–æ–‡æ¡£ã€æ“ä½œæ‰‹å†Œ)           â”‚
â”‚     â”œâ”€â”€ æ–‡æ¡£è§£æ (PDF/Word/HTML â†’ Text)              â”‚
â”‚     â”œâ”€â”€ åˆ†å—å¤„ç† (Chunk Size: 500-1000 tokens)       â”‚
â”‚     â””â”€â”€ å‘é‡åŒ– (Embedding Model: text-embedding-3)   â”‚
â”‚                                                      â”‚
â”‚  2. å‘é‡å­˜å‚¨                                          â”‚
â”‚     â”œâ”€â”€ Milvus (å‘é‡æ•°æ®åº“)                          â”‚
â”‚     â”œâ”€â”€ ç´¢å¼•ç­–ç•¥ (HNSW/IVF)                          â”‚
â”‚     â””â”€â”€ å…ƒæ•°æ®ç®¡ç† (æ–‡æ¡£æ¥æºã€ç‰ˆæœ¬ã€æ—¶é—´æˆ³)          â”‚
â”‚                                                      â”‚
â”‚  3. æ£€ç´¢æ¨¡å—                                          â”‚
â”‚     â”œâ”€â”€ å‘é‡æ£€ç´¢ (Cosine Similarity)                 â”‚
â”‚     â”œâ”€â”€ é‡æ’åº (Rerank Model)                        â”‚
â”‚     â”œâ”€â”€ æ··åˆæ£€ç´¢ (å‘é‡ + BM25)                       â”‚
â”‚     â””â”€â”€ Top-K ç»“æœè¿‡æ»¤                                â”‚
â”‚                                                      â”‚
â”‚  4. ç”Ÿæˆæ¨¡å—                                          â”‚
â”‚     â”œâ”€â”€ Promptå·¥ç¨‹ (ä¸Šä¸‹æ–‡æ³¨å…¥)                      â”‚
â”‚     â”œâ”€â”€ LLMç”Ÿæˆ (DeepSeek/GPT-4)                     â”‚
â”‚     â”œâ”€â”€ ç­”æ¡ˆéªŒè¯ (äº‹å®æ€§æ£€æŸ¥)                        â”‚
â”‚     â””â”€â”€ å¼•ç”¨æ ‡æ³¨ (Citation)                          â”‚
â”‚                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**RAGå®ç°ç¤ºä¾‹**ï¼š

```python
class RAGEngine:
    """RAGå¼•æ“"""
    
    def __init__(self):
        self.vectorstore = MilvusClient()
        self.embedding_model = OpenAIEmbeddings()
        self.llm = ChatOpenAI(model="deepseek-chat")
    
    def retrieve(self, query: str, top_k: int = 3):
        """æ£€ç´¢ç›¸å…³æ–‡æ¡£"""
        # 1. æŸ¥è¯¢å‘é‡åŒ–
        query_vector = self.embedding_model.embed_query(query)
        
        # 2. å‘é‡æ£€ç´¢
        results = self.vectorstore.search(
            query_vector,
            limit=top_k,
            metric_type="COSINE"
        )
        
        # 3. é‡æ’åº
        reranked = self.rerank(query, results)
        
        return reranked
    
    def generate(self, query: str, context: List[str]):
        """ç”Ÿæˆå›ç­”"""
        prompt = f"""åŸºäºä»¥ä¸‹å‚è€ƒèµ„æ–™å›ç­”é—®é¢˜:

ã€å‚è€ƒèµ„æ–™ã€‘
{chr(10).join(context)}

ã€é—®é¢˜ã€‘{query}

ã€å›ç­”ã€‘"""
        
        response = self.llm.invoke(prompt)
        return response.content
```

#### 7.2.3 ç”¨æˆ·ç”»åƒç³»ç»Ÿ

```
ç”¨æˆ·ç”»åƒç³»ç»Ÿ
â”œâ”€â”€ åŸºç¡€ä¿¡æ¯
â”‚   â”œâ”€â”€ æ³¨å†Œæ—¶é—´
â”‚   â”œâ”€â”€ ç”¨æˆ·ç­‰çº§
â”‚   â””â”€â”€ è®¤è¯çŠ¶æ€
â”œâ”€â”€ è¡Œä¸ºç‰¹å¾
â”‚   â”œâ”€â”€ å¯¹è¯é¢‘æ¬¡
â”‚   â”œâ”€â”€ å¸¸ç”¨æ„å›¾
â”‚   â”œâ”€â”€ æ´»è·ƒæ—¶æ®µ
â”‚   â””â”€â”€ è®¾å¤‡ç±»å‹
â”œâ”€â”€ åå¥½æ ‡ç­¾
â”‚   â”œâ”€â”€ ä»·æ ¼æ•æ„Ÿåº¦
â”‚   â”œâ”€â”€ æµé‡éœ€æ±‚é‡
â”‚   â”œâ”€â”€ å¥—é¤ç±»å‹åå¥½
â”‚   â””â”€â”€ æœåŠ¡è´¨é‡è¦æ±‚
â””â”€â”€ é¢„æµ‹æ¨¡å‹
    â”œâ”€â”€ æµå¤±é£é™©é¢„æµ‹
    â”œâ”€â”€ å¥—é¤æ¨èæ¨¡å‹
    â””â”€â”€ ä»·å€¼è¯„åˆ†æ¨¡å‹
```

#### 7.2.4 æ™ºèƒ½æ¨èç³»ç»Ÿ

**æ¨èç®—æ³•**ï¼š

| ç®—æ³•     | åº”ç”¨åœºæ™¯         | å®ç°æ–¹å¼      |
| -------- | ---------------- | ------------- |
| ååŒè¿‡æ»¤ | åŸºäºç›¸ä¼¼ç”¨æˆ·æ¨è | UserCF/ItemCF |
| å†…å®¹æ¨è | åŸºäºå¥—é¤å±æ€§åŒ¹é… | ç‰¹å¾åŒ¹é…      |
| æ·±åº¦å­¦ä¹  | ç«¯åˆ°ç«¯æ¨è       | DNN/Wide&Deep |
| å¼ºåŒ–å­¦ä¹  | åŠ¨æ€ç­–ç•¥ä¼˜åŒ–     | DQN/A3C       |

**æ¨èæµç¨‹ï¼š**

```
ç”¨æˆ·è¯·æ±‚
   â†“
å¬å›å±‚ (å¤šè·¯å¬å›)
â”œâ”€â”€ çƒ­é—¨å¥—é¤ (Top 100)
â”œâ”€â”€ ååŒè¿‡æ»¤ (ç›¸ä¼¼ç”¨æˆ·)
â”œâ”€â”€ å†…å®¹æ¨è (å±æ€§åŒ¹é…)
â””â”€â”€ å†å²åå¥½
   â†“
ç²—æ’å±‚ (å¿«é€Ÿç­›é€‰)
â””â”€â”€ LR/GBDT æ¨¡å‹
   â†“
ç²¾æ’å±‚ (ç²¾å‡†æ’åº)
â””â”€â”€ DNN/Wide&Deep
   â†“
é‡æ’å±‚ (ä¸šåŠ¡è§„åˆ™)
â”œâ”€â”€ å¤šæ ·æ€§
â”œâ”€â”€ æ–°é²œåº¦
â””â”€â”€ ä»·æ ¼ç­–ç•¥
   â†“
Top-K æ¨èç»“æœ
```

### 7.3 ä¼˜åŒ–å®æ–½è®¡åˆ’

#### Phase 1: å¿«é€ŸMVPï¼ˆ1å‘¨ï¼‰â­ **ç«‹å³å¯åš**

**ç›®æ ‡**ï¼šé›¶è®­ç»ƒæˆæœ¬ï¼Œå¿«é€Ÿæå‡å‡†ç¡®ç‡

```
âœ… 1. è§„åˆ™å¼•æ“ï¼ˆ80%é«˜é¢‘åœºæ™¯ï¼‰
   - åŠç† + å¥—é¤å â†’ change_package
   - æŸ¥è¯¢ + æˆ‘çš„/å½“å‰ â†’ query_current_package
   - æ¨è/æœ‰ä»€ä¹ˆ â†’ query_packages

âœ… 2. ç®€å•å®ä½“è¯†åˆ«ï¼ˆç²¾ç¡®+æ¨¡ç³Šï¼‰
   - ç²¾ç¡®åŒ¹é…ï¼š4ä¸ªå¥—é¤åç§°
   - æ¨¡ç³ŠåŒ¹é…ï¼šä½¿ç”¨difflibç›¸ä¼¼åº¦

âœ… 3. LLMå…œåº•
   - è§„åˆ™æœªå‘½ä¸­æ—¶ä½¿ç”¨ç°æœ‰LLM

âœ… 4. ç›‘æ§ç»Ÿè®¡
   - è®°å½•è§„åˆ™å‘½ä¸­ç‡
   - ç»Ÿè®¡å“åº”æ—¶é—´
```

**é¢„æœŸæ•ˆæœ**ï¼š

- å‡†ç¡®ç‡ï¼š85% â†’ 90%ï¼ˆ+5%ï¼‰
- å“åº”æ—¶é—´ï¼š500ms â†’ 100msï¼ˆè§„åˆ™å‘½ä¸­æ—¶ï¼‰
- æˆæœ¬ï¼šé›¶é¢å¤–æˆæœ¬
- å®æ–½éš¾åº¦ï¼šä½

**ä»£ç ç¤ºä¾‹**ï¼š

```python
class QuickOptimizedNLU:
    """å¿«é€Ÿä¼˜åŒ–ç‰ˆNLUï¼ˆPhase 1ï¼‰"""
    
    def understand(self, text: str) -> NLUResult:
        # 1. é¢„å¤„ç†
        text = text.strip().lower()
        
        # 2. è§„åˆ™åŒ¹é…ï¼ˆ80%åœºæ™¯ï¼‰
        intent = self._rule_match(text)
        if intent:
            return NLUResult(
                intent=intent,
                source="rule",
                latency=5
            )
        
        # 3. LLMå…œåº•ï¼ˆ20%åœºæ™¯ï¼‰
        return self._llm_fallback(text)
    
    def _rule_match(self, text: str) -> Optional[str]:
        """è§„åˆ™åŒ¹é…"""
        # æå–å¥—é¤å
        package = self._extract_package(text)
        
        # è§„åˆ™1: åŠç†ç±»
        if any(w in text for w in ["åŠç†", "æ¢", "æ›´æ¢", "å˜æ›´"]):
            if package:
                return "change_package"
        
        # è§„åˆ™2: æŸ¥è¯¢å½“å‰
        if any(w in text for w in ["æˆ‘çš„", "å½“å‰", "ç°åœ¨"]):
            return "query_current_package"
        
        # è§„åˆ™3: æŸ¥è¯¢å¥—é¤
        if any(w in text for w in ["æ¨è", "æœ‰ä»€ä¹ˆ", "æŸ¥è¯¢"]):
            return "query_packages"
        
        return None
    
    def _extract_package(self, text: str) -> Optional[str]:
        """æå–å¥—é¤åï¼ˆç²¾ç¡®+æ¨¡ç³Šï¼‰"""
        packages = ["ç»æµå¥—é¤", "ç•…æ¸¸å¥—é¤", "æ— é™å¥—é¤", "æ ¡å›­å¥—é¤"]
        
        # ç²¾ç¡®åŒ¹é…
        for pkg in packages:
            if pkg in text:
                return pkg
        
        # æ¨¡ç³ŠåŒ¹é…
        from difflib import get_close_matches
        words = text.split()
        for word in words:
            matches = get_close_matches(word, packages, n=1, cutoff=0.8)
            if matches:
                return matches[0]
        
        return None
```

#### Phase 2: æ¨¡å‹ä¼˜åŒ–ï¼ˆ1ä¸ªæœˆï¼‰

**ç›®æ ‡**ï¼šè®­ç»ƒåˆ†ç±»æ¨¡å‹ï¼Œæå‡å‡†ç¡®ç‡å’Œå“åº”é€Ÿåº¦

```
âœ… 1. è®­ç»ƒFastTextä¸€çº§åˆ†ç±»å™¨
   - æ•°æ®æ ‡æ³¨ï¼š1000æ¡æ ·æœ¬
   - åˆ†ç±»ï¼šquery/transaction/consultation/complaint
   - å‡†ç¡®ç‡ç›®æ ‡ï¼š>95%

âœ… 2. è®­ç»ƒBERTäºŒçº§åˆ†ç±»å™¨
   - æ¯ä¸ªå¤§ç±»ä¸‹çš„ç»†åˆ†ç±»
   - æ•°æ®ï¼š500æ¡/ç±»
   - å‡†ç¡®ç‡ç›®æ ‡ï¼š>92%

âœ… 3. æ¥å…¥å‘é‡æ•°æ®åº“
   - éƒ¨ç½²Milvus/Qdrant
   - å¥—é¤å‘é‡åŒ–å­˜å‚¨
   - æ”¯æŒæ¨¡ç³ŠåŒ¹é…

âœ… 4. å®Œå–„å®ä½“é“¾æ¥
   - åŒä¹‰è¯åº“æ„å»º
   - æ‹¼å†™çº é”™
   - åˆ«åæ˜ å°„
```

**é¢„æœŸæ•ˆæœ**ï¼š

- å‡†ç¡®ç‡ï¼š90% â†’ 95%ï¼ˆ+5%ï¼‰
- å“åº”æ—¶é—´ï¼š100msï¼ˆå¹³å‡ï¼‰
- è§„åˆ™è¦†ç›–ï¼š80%
- æ¨¡å‹è¦†ç›–ï¼š15%
- LLMè¦†ç›–ï¼š5%

**æŠ€æœ¯æ ˆ**ï¼š

- FastTextï¼šä¸€çº§åˆ†ç±»
- BERTï¼šäºŒçº§åˆ†ç±»
- Sentence-BERTï¼šå®ä½“å‘é‡åŒ–
- Milvusï¼šå‘é‡æ£€ç´¢

#### Phase 3: ç”Ÿäº§çº§ï¼ˆ3ä¸ªæœˆï¼‰

**ç›®æ ‡**ï¼šç«¯åˆ°ç«¯ä¼˜åŒ–ï¼Œè¾¾åˆ°ç”Ÿäº§çº§ç¨³å®šæ€§

```
âœ… 1. ç«¯åˆ°ç«¯ä¼˜åŒ–
   - æ¨¡å‹å‹ç¼©ï¼ˆONNX/TensorRTï¼‰
   - æ‰¹é‡æ¨ç†
   - å¼‚æ­¥å¤„ç†

âœ… 2. A/Bæµ‹è¯•æ¡†æ¶
   - æµé‡åˆ†ç»„
   - æŒ‡æ ‡å¯¹æ¯”
   - è‡ªåŠ¨åˆ‡æ¢

âœ… 3. å®æ—¶ç›‘æ§å‘Šè­¦
   - å‡†ç¡®ç‡ç›‘æ§
   - å“åº”æ—¶é—´ç›‘æ§
   - æˆæœ¬ç›‘æ§

âœ… 4. æŒç»­å­¦ä¹ æœºåˆ¶
   - Bad Caseæ”¶é›†
   - è‡ªåŠ¨æ ‡æ³¨
   - å¢é‡è®­ç»ƒ
```

**é¢„æœŸæ•ˆæœ**ï¼š

- å‡†ç¡®ç‡ï¼š95% â†’ 98%ï¼ˆ+3%ï¼‰
- ç¨³å®šæ€§ï¼š99.9%
- P99å»¶è¿Ÿï¼š<200ms
- æˆæœ¬ï¼š$200/æœˆ

### 7.4 ä¸å½“å‰ç³»ç»Ÿå¯¹æ¯”

#### 7.4.1 æ¶æ„å¯¹æ¯”

| ç»´åº¦         | å½“å‰ç³»ç»Ÿ    | æˆç†Ÿç³»ç»Ÿ        | æ”¹è¿›æ–¹å‘                      | ä¼˜å…ˆçº§ |
| ------------ | ----------- | --------------- | ----------------------------- | ------ |
| **æ„å›¾è¯†åˆ«** | çº¯LLM       | è§„åˆ™+åˆ†ç±»å™¨+LLM | æ„å»ºå¤šçº§è¯†åˆ«ä½“ç³»ï¼ŒLLMä½œä¸ºå…œåº• | â­â­â­â­â­  |
| **å®ä½“å¤„ç†** | æšä¸¾4ä¸ªå¥—é¤ | å‘é‡æ£€ç´¢1ä¸‡+    | å»ºç«‹çŸ¥è¯†åº“å’Œè¯­ä¹‰æ£€ç´¢èƒ½åŠ›      | â­â­â­â­â­  |
| **å“åº”æ—¶é—´** | 500ms       | 100ms           | ä¼˜åŒ–æµç¨‹ï¼Œå‡å°‘LLMä¾èµ–         | â­â­â­â­   |
| **å‡†ç¡®ç‡**   | 80%         | 95%+            | æå‡æ„å›¾è¯†åˆ«å’Œå®ä½“åŒ¹é…ç²¾åº¦    | â­â­â­â­â­  |
| **æˆæœ¬**     | $1000/æœˆ    | $200/æœˆ         | å‡å°‘APIè°ƒç”¨ï¼Œæœ¬åœ°åŒ–å¤„ç†       | â­â­â­â­â­  |
| **å¯æ§æ€§**   | ä½ï¼ˆé»‘ç›’ï¼‰  | é«˜ï¼ˆå¯è°ƒè¯•ï¼‰    | å»ºç«‹å¯é…ç½®çš„è§„åˆ™å¼•æ“          | â­â­â­â­â­  |

#### 7.4.2 æ€§èƒ½å¯¹æ¯”

| æŒ‡æ ‡                | å½“å‰å€¼   | ç›®æ ‡å€¼ï¼ˆPhase 1ï¼‰ | ç›®æ ‡å€¼ï¼ˆPhase 3ï¼‰ |
| ------------------- | -------- | ----------------- | ----------------- |
| **å‡†ç¡®ç‡**          | 80%      | 90%               | 98%               |
| **å“åº”æ—¶é—´ï¼ˆP50ï¼‰** | 500ms    | 100ms             | 50ms              |
| **å“åº”æ—¶é—´ï¼ˆP99ï¼‰** | 1000ms   | 500ms             | 200ms             |
| **APIæˆæœ¬**         | $1000/æœˆ | $500/æœˆ           | $200/æœˆ           |
| **è§„åˆ™è¦†ç›–ç‡**      | 0%       | 80%               | 80%               |
| **LLMä½¿ç”¨ç‡**       | 100%     | 20%               | 5%                |

### 7.5 ä¼˜åŒ–æ€»ç»“

#### æ ¸å¿ƒæ€æƒ³ï¼ˆä¸€å¥è¯ï¼‰

> **"è®©ç®€å•çš„ç®€å•ï¼Œè®©å¤æ‚çš„å¯æ§"**
>
> - 80%é«˜é¢‘åœºæ™¯ç”¨è§„åˆ™ï¼ˆå¿«é€Ÿã€å‡†ç¡®ï¼‰
> - 15%ä¸­ç­‰åœºæ™¯ç”¨æ¨¡å‹ï¼ˆå‡†ç¡®ã€å¯æ§ï¼‰
> - 5%é•¿å°¾åœºæ™¯ç”¨LLMï¼ˆçµæ´»ã€å…œåº•ï¼‰

#### æ¶æ„ç²¾é«“ï¼ˆä¸‰å¥è¯ï¼‰

1. **åˆ†å±‚é™ç»´**ï¼šå¤æ‚é—®é¢˜åˆ†è§£ä¸ºå¤šä¸ªç®€å•é—®é¢˜
2. **æ··åˆæ¶æ„**ï¼šè§„åˆ™+æ¨¡å‹+LLMå„å¸å…¶èŒ
3. **å‘é‡æ£€ç´¢**ï¼šç”¨Embeddingå¤„ç†æµ·é‡å®ä½“



## 8. éƒ¨ç½²æŒ‡å—

### 8.1 é¡¹ç›®è·å–ä¸é…ç½®

##### 8.1.1 å…‹éš†é¡¹ç›®

```
# 1. å…‹éš†ä»£ç ä»“åº“
git clone https://github.com/chaserZH/telecom-customer-service.git
cd telecom-ai-customer-service

# 2. æŸ¥çœ‹é¡¹ç›®ç»“æ„
```

é¡¹ç›®ç»“æ„ï¼š

```
telecom-ai-customer-service/
â”œâ”€â”€ api/                    # WebæœåŠ¡
â”œâ”€â”€ core/                   # æ ¸å¿ƒå¼•æ“
â”œâ”€â”€ database/              # æ•°æ®åº“è„šæœ¬
â”œâ”€â”€ config/                # é…ç½®æ–‡ä»¶
â”œâ”€â”€ utils/                 # å·¥å…·å‡½æ•°
â”œâ”€â”€ .env.example          # ç¯å¢ƒå˜é‡æ¨¡æ¿
â”œâ”€â”€ pyproject.toml        # Pythonä¾èµ–
â”œâ”€â”€ docker-compose.yml    # Dockeré…ç½®
â””â”€â”€ README.md
```

### 8.2 é…ç½®ç¯å¢ƒå˜é‡

```
# 1. å¤åˆ¶ç¯å¢ƒå˜é‡æ¨¡æ¿
cp .env.example .env

# 2. ç¼–è¾‘ç¯å¢ƒå˜é‡
vim .env  # æˆ–ä½¿ç”¨ä½ å–œæ¬¢çš„ç¼–è¾‘å™¨
```

**å®Œæ•´çš„.envé…ç½®ç¤ºä¾‹**ï¼š

```python
# ==================== åº”ç”¨é…ç½® ====================
APP_NAME=ç”µä¿¡å¥—é¤AIå®¢æœç³»ç»Ÿ
VERSION=0.1.0
DEBUG=True

# ==================== å¤§æ¨¡å‹é…ç½® ====================
# ä½¿ç”¨DeepSeekï¼ˆæ¨èï¼‰
LLM_PROVIDER=deepseek

# DeepSeek APIé…ç½®
DEEPSEEK_API_KEY=sk-your-deepseek-api-key-here
DEEPSEEK_BASE_URL=https://api.deepseek.com/v1
DEEPSEEK_MODEL=deepseek-chat

# OpenAIé…ç½®ï¼ˆå¯é€‰ï¼Œä½œä¸ºå¤‡ç”¨ï¼‰
OPENAI_API_KEY=sk-your-openai-key-here
OPENAI_MODEL=gpt-4

# ==================== æ•°æ®åº“é…ç½® ====================
DB_HOST=localhost          # Dockeréƒ¨ç½²æ—¶ä½¿ç”¨: mysql
DB_PORT=3306
DB_USER=root
DB_PASSWORD=your_strong_password_here
DB_NAME=telecom_chatbot

# ==================== Redisé…ç½® ====================
REDIS_HOST=localhost       # Dockeréƒ¨ç½²æ—¶ä½¿ç”¨: redis
REDIS_PORT=6379
REDIS_DB=0
REDIS_PASSWORD=
REDIS_MAX_CONNECTIONS=50

# ==================== ä¼šè¯é…ç½® ====================
SESSION_TIMEOUT=1800       # 30åˆ†é’Ÿ
MAX_CONTEXT_TURNS=10

# ==================== APIé…ç½® ====================
API_HOST=0.0.0.0
API_PORT=8000

# ==================== ç¡®è®¤é…ç½® ====================
CONFIRMATION_TIMEOUT_MINUTES=5
CONFIRMATION_STRICT_MODE=False
CONFIRMATION_REMINDER=True
```

**é…ç½®è¯´æ˜**ï¼š

| é…ç½®é¡¹           | è¯´æ˜                                   | å¿…å¡« |
| ---------------- | -------------------------------------- | ---- |
| DEEPSEEK_API_KEY | DeepSeek APIå¯†é’¥                       | âœ… æ˜¯ |
| DB_PASSWORD      | MySQLæ•°æ®åº“å¯†ç                         | âœ… æ˜¯ |
| DB_HOST          | æœ¬åœ°éƒ¨ç½²ç”¨`localhost`ï¼ŒDockerç”¨`mysql` | âœ… æ˜¯ |
| REDIS_HOST       | æœ¬åœ°éƒ¨ç½²ç”¨`localhost`ï¼ŒDockerç”¨`redis` | âœ… æ˜¯ |
| DEBUG            | å¼€å‘ç¯å¢ƒ`True`ï¼Œç”Ÿäº§ç¯å¢ƒ`False`        | âŒ å¦ |

### 8.3 Dockeréƒ¨ç½²æ–¹æ¡ˆï¼ˆæ¨èï¼‰

#### 8.3.1 Docker Composeé…ç½®

**docker-compose.yml**ï¼ˆå·²åŒ…å«åœ¨é¡¹ç›®ä¸­ï¼‰

#### 8.3.2 Dockerfile

**Dockerfile**ï¼ˆå·²åŒ…å«åœ¨é¡¹ç›®ä¸­ï¼‰

#### 8.3.3 Dockeréƒ¨ç½²æ­¥éª¤

```
# 1. ç¡®ä¿.envæ–‡ä»¶é…ç½®æ­£ç¡®
cat .env | grep -E "DEEPSEEK_API_KEY|DB_PASSWORD"

# 2. æ„å»ºå¹¶å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker-compose up -d --build

# 3. æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose ps

# é¢„æœŸè¾“å‡ºï¼š
# NAME              COMMAND                  STATUS        PORTS
# telecom_mysql     "docker-entrypoint.sâ€¦"   Up (healthy)  0.0.0.0:3306->3306/tcp
# telecom_redis     "docker-entrypoint.sâ€¦"   Up (healthy)  0.0.0.0:6379->6379/tcp
# telecom_web       "uvicorn api.main:apâ€¦"   Up            0.0.0.0:8000->8000/tcp

# 4. æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f

# 5. æŸ¥çœ‹WebæœåŠ¡æ—¥å¿—
docker-compose logs -f web

# 6. è¿›å…¥å®¹å™¨è°ƒè¯•
docker-compose exec web bash
```

#### 8.3.4 éªŒè¯éƒ¨ç½²

###### 1. æ£€æŸ¥çŠ¶æ€

```
docker-compose ps

# é¢„æœŸè¾“å‡º
NAME                      STATUS          PORTS
telecom_chatbot_app       Up 2 minutes    0.0.0.0:8000->8000/tcp
telecom_chatbot_mysql     Up 2 minutes (healthy)    0.0.0.0:3306->3306/tcp
telecom_chatbot_redis     Up 2 minutes (healthy)    0.0.0.0:6379->6379/tcp
```

##### 2. éªŒè¯æ•°æ®åº“åˆå§‹åŒ–

```
docker-compose exec mysql mysql -uroot -pMySecurePassword123 -e "SHOW DATABASES;"     
# é¢„æœŸè¾“å‡º
WARN[0000] /Applications/code/personal/ai/telecom-customer-service/docker-compose.yml: the attribute `version` is obsolete, it will be ignored, please remove it to avoid potential confusion 
mysql: [Warning] Using a password on the command line interface can be insecure.
+--------------------+
| Database           |
+--------------------+
| information_schema |
| mysql              |
| performance_schema |
| sys                |
| telecom_chatbot    |
+--------------------+
```

##### 3. éªŒè¯Redis

```
docker-compose exec redis redis-cli

# æµ‹è¯•
127.0.0.1:6379> PING
PONG
127.0.0.1:6379> SET test "Hello Docker"
OK
127.0.0.1:6379> GET test
"Hello Docker"
```

##### 4. æµ‹è¯•åº”ç”¨

```
# å¥åº·æ£€æŸ¥
curl http://localhost:8000/health

# æˆ–è®¿é—®æµè§ˆå™¨
http://localhost:8000
```

##### 5.æŸ¥çœ‹æ—¥å¿—

```
 docker-compose logs -f --tail=100 web 
```

#### 8.3.5 å¸¸ç”¨Dockerå‘½ä»¤

```
# å¯åŠ¨æœåŠ¡
docker-compose up -d

# åœæ­¢æœåŠ¡
docker-compose stop

# é‡å¯æœåŠ¡
docker-compose restart

# åœæ­¢å¹¶åˆ é™¤å®¹å™¨
docker-compose down

# åœæ­¢å¹¶åˆ é™¤å®¹å™¨å’Œæ•°æ®å·ï¼ˆâš ï¸ ä¼šåˆ é™¤æ•°æ®ï¼‰
docker-compose down -v

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f [service_name]

# è¿›å…¥å®¹å™¨
docker-compose exec web bash
docker-compose exec mysql bash
docker-compose exec redis redis-cli

# é‡æ–°æ„å»ºé•œåƒ
docker-compose build --no-cache

# æŸ¥çœ‹èµ„æºä½¿ç”¨
docker stats
```

### 8.4 æœ¬åœ°éƒ¨ç½²

#### 1 å®‰è£…mysql ä¸ redis

```
docker run -d --name my-redis -p 6379:6379 redis

$ docker run -d \
--name mysql-server \
-e MYSQL_ROOT_PASSWORD=root \
-e MYSQL_DATABASE=telecom_chatbot \
-e MYSQL_USER=user \
-e MYSQL_PASSWORD=user \
-p 3306:3306 \
mysql
```

#### 2. ç¼–è¾‘ç¯å¢ƒå˜é‡æ–‡ä»¶

```
cp .env.local .env
```

#### 3. åˆå§‹åŒ–sql

åˆå§‹åŒ–sqlè„šæœ¬

##### 4. å¯åŠ¨

```
# ä½¿ç”¨uvicornç›´æ¥å¯åŠ¨
python -m uvicorn api.main:app --host 0.0.0.0 --port 8000 --reload
```

##### 5. **è®¿é—®Webç•Œé¢**

```bash
# åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€
open http://localhost:8000

# æˆ–ä½¿ç”¨curlæŸ¥çœ‹HTML
curl http://localhost:8000
```















