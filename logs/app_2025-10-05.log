2025-10-05 11:21:35.208 | INFO     | database.db_manager:_initialize:38 - 数据库连接初始化成功
2025-10-05 11:21:35.208 | ERROR    | database.redis_manager:_initialize:45 - Redis连接池初始化失败: 'Settings' object has no attribute 'get'
2025-10-05 11:23:07.680 | INFO     | database.db_manager:_initialize:38 - 数据库连接初始化成功
2025-10-05 11:23:07.680 | ERROR    | database.redis_manager:_initialize:45 - Redis连接池初始化失败: 'Settings' object has no attribute 'get'
2025-10-05 11:23:20.813 | INFO     | database.db_manager:_initialize:38 - 数据库连接初始化成功
2025-10-05 11:23:20.814 | ERROR    | database.redis_manager:_initialize:45 - Redis连接池初始化失败: 'Settings' object has no attribute 'get'
2025-10-05 11:24:26.836 | INFO     | database.db_manager:_initialize:38 - 数据库连接初始化成功
2025-10-05 11:24:26.837 | ERROR    | database.redis_manager:_initialize:45 - Redis连接池初始化失败: 'Settings' object has no attribute 'get'
2025-10-05 11:38:40.757 | INFO     | database.db_manager:_initialize:38 - 数据库连接初始化成功
2025-10-05 11:38:40.757 | ERROR    | database.redis_manager:_initialize:45 - Redis连接池初始化失败: 'Settings' object has no attribute 'get'
2025-10-05 11:39:11.989 | DEBUG    | core.dst.slot_manager:fill_slots:43 - 意图不变，合并槽位: ['data_min']
2025-10-05 11:39:48.267 | INFO     | database.db_manager:_initialize:38 - 数据库连接初始化成功
2025-10-05 11:39:48.267 | ERROR    | database.redis_manager:_initialize:45 - Redis连接池初始化失败: 'Settings' object has no attribute 'get'
2025-10-05 11:40:39.438 | DEBUG    | core.dst.slot_manager:fill_slots:61 - 不同领域，仅保留用户信息: ['phone']
2025-10-05 11:42:34.228 | INFO     | database.db_manager:_initialize:38 - 数据库连接初始化成功
2025-10-05 11:42:34.228 | ERROR    | database.redis_manager:_initialize:45 - Redis连接池初始化失败: 'Settings' object has no attribute 'get'
2025-10-05 11:43:14.864 | INFO     | core.dst.slot_manager:validate_slots:103 - 缺失槽位: ['phone', 'package_name']
2025-10-05 11:44:27.835 | INFO     | database.db_manager:_initialize:38 - 数据库连接初始化成功
2025-10-05 11:44:27.835 | ERROR    | database.redis_manager:_initialize:45 - Redis连接池初始化失败: 'Settings' object has no attribute 'get'
2025-10-05 11:46:07.679 | INFO     | database.db_manager:_initialize:38 - 数据库连接初始化成功
2025-10-05 11:46:07.680 | ERROR    | database.redis_manager:_initialize:45 - Redis连接池初始化失败: 'Settings' object has no attribute 'get'
2025-10-05 11:46:40.924 | DEBUG    | core.dst.context_manager:_clean_expired_context:66 - 清理1个过期上下文
2025-10-05 11:50:35.349 | INFO     | database.db_manager:_initialize:38 - 数据库连接初始化成功
2025-10-05 11:50:35.350 | ERROR    | database.redis_manager:_initialize:45 - Redis连接池初始化失败: 'Settings' object has no attribute 'get'
2025-10-05 11:50:35.360 | ERROR    | core.dst.state_store:__init__:28 - Redis初始化失败: Redis连接池未初始化, 使用内存存储
2025-10-05 11:50:35.360 | INFO     | core.dst.dialog_state_tracker:__init__:27 - 对话状态跟踪器初始化完成
2025-10-05 11:50:56.939 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: test_session
2025-10-05 11:51:16.998 | DEBUG    | core.dst.state_store:_load_from_memory:121 - 内存中不存在会话: test_session, 返回新状态
2025-10-05 11:52:54.648 | INFO     | core.dst.dialog_state_tracker:track:59 - 意图改变: None → query_packages
2025-10-05 11:53:10.916 | DEBUG    | core.dst.slot_manager:fill_slots:61 - 不同领域，仅保留用户信息: []
2025-10-05 11:54:24.342 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: test_session
2025-10-05 11:54:24.344 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=1, 需要澄清=False
2025-10-05 11:59:37.346 | INFO     | database.db_manager:_initialize:38 - 数据库连接初始化成功
2025-10-05 11:59:37.346 | ERROR    | database.redis_manager:_initialize:45 - Redis连接池初始化失败: 'Settings' object has no attribute 'get'
2025-10-05 11:59:37.358 | ERROR    | core.dst.state_store:__init__:28 - Redis初始化失败: Redis连接池未初始化, 使用内存存储
2025-10-05 11:59:37.358 | INFO     | core.dst.dialog_state_tracker:__init__:27 - 对话状态跟踪器初始化完成
2025-10-05 11:59:58.291 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: multi_turn_test
2025-10-05 12:00:19.307 | DEBUG    | core.dst.state_store:_load_from_memory:121 - 内存中不存在会话: multi_turn_test, 返回新状态
2025-10-05 12:02:51.724 | INFO     | core.dst.dialog_state_tracker:track:59 - 意图改变: None → query_packages
2025-10-05 12:03:23.526 | DEBUG    | core.dst.slot_manager:fill_slots:61 - 不同领域，仅保留用户信息: []
2025-10-05 12:03:59.328 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: multi_turn_test
2025-10-05 12:03:59.330 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=1, 需要澄清=False
2025-10-05 12:03:59.331 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: multi_turn_test
2025-10-05 12:04:00.171 | DEBUG    | core.dst.state_store:_load_from_memory:118 - 从内存加载状态: multi_turn_test
2025-10-05 12:04:07.367 | DEBUG    | core.dst.slot_manager:fill_slots:43 - 意图不变，合并槽位: ['data_min']
2025-10-05 12:04:15.401 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: multi_turn_test
2025-10-05 12:04:15.402 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=2, 需要澄清=False
2025-10-05 16:42:03.782 | INFO     | database.db_manager:_initialize:38 - 数据库连接初始化成功
2025-10-05 16:42:03.782 | ERROR    | database.redis_manager:_initialize:45 - Redis连接池初始化失败: 'Settings' object has no attribute 'get'
2025-10-05 16:42:04.762 | INFO     | core.nlu.nlu_engine:__init__:50 - ✓ NLU引擎初始化成功: DeepSeek (deepseek-chat)
2025-10-05 16:42:04.763 | ERROR    | core.dst.state_store:__init__:28 - Redis初始化失败: Redis连接池未初始化, 使用内存存储
2025-10-05 16:42:04.763 | INFO     | core.dst.dialog_state_tracker:__init__:27 - 对话状态跟踪器初始化完成
2025-10-05 16:42:04.763 | INFO     | executor.db_executor:__init__:16 - 数据库执行器初始化完成
2025-10-05 16:42:04.763 | INFO     | core.chatbot_dst:__init__:23 - 第二阶段对话系统初始化完成（含DST支持）
2025-10-05 16:42:30.026 | INFO     | core.chatbot_dst:chat:46 - [integration_test_001] 收到用户输入: 有100元以内的套餐吗
2025-10-05 16:42:32.705 | INFO     | core.nlu.nlu_engine:understand:80 - [integration_test_001] 开始NLU理解: 有100元以内的套餐吗
2025-10-05 16:42:32.707 | DEBUG    | core.nlu.nlu_engine:understand:85 - [integration_test_001] 预处理后: 有100元以内的套餐吗
2025-10-05 16:42:38.367 | INFO     | core.nlu.nlu_engine:understand:110 - [integration_test_001] NLU完成: intent=query_packages
2025-10-05 16:43:39.388 | INFO     | database.db_manager:_initialize:38 - 数据库连接初始化成功
2025-10-05 16:43:39.388 | ERROR    | database.redis_manager:_initialize:45 - Redis连接池初始化失败: 'Settings' object has no attribute 'get'
2025-10-05 16:43:40.362 | INFO     | core.nlu.nlu_engine:__init__:50 - ✓ NLU引擎初始化成功: DeepSeek (deepseek-chat)
2025-10-05 16:43:40.363 | ERROR    | core.dst.state_store:__init__:28 - Redis初始化失败: Redis连接池未初始化, 使用内存存储
2025-10-05 16:43:40.363 | INFO     | core.dst.dialog_state_tracker:__init__:27 - 对话状态跟踪器初始化完成
2025-10-05 16:43:40.363 | INFO     | executor.db_executor:__init__:16 - 数据库执行器初始化完成
2025-10-05 16:43:40.363 | INFO     | core.chatbot_dst:__init__:23 - 第二阶段对话系统初始化完成（含DST支持）
2025-10-05 16:43:46.365 | INFO     | core.chatbot_dst:chat:46 - [integration_test_001] 收到用户输入: 有100元以内的套餐吗
2025-10-05 16:43:49.094 | INFO     | core.nlu.nlu_engine:understand:80 - [integration_test_001] 开始NLU理解: 有100元以内的套餐吗
2025-10-05 16:43:49.096 | DEBUG    | core.nlu.nlu_engine:understand:85 - [integration_test_001] 预处理后: 有100元以内的套餐吗
2025-10-05 16:43:56.071 | INFO     | core.nlu.nlu_engine:understand:110 - [integration_test_001] NLU完成: intent=query_packages
2025-10-05 16:44:57.545 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_001
2025-10-05 16:45:33.890 | DEBUG    | core.dst.state_store:_load_from_memory:121 - 内存中不存在会话: integration_test_001, 返回新状态
2025-10-05 16:46:26.002 | INFO     | core.dst.dialog_state_tracker:track:59 - 意图改变: None → query_packages
2025-10-05 16:47:00.260 | DEBUG    | core.dst.slot_manager:fill_slots:61 - 不同领域，仅保留用户信息: []
2025-10-05 16:48:24.007 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_001
2025-10-05 16:48:25.784 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=1, 需要澄清=False
2025-10-05 16:49:03.747 | INFO     | executor.db_executor:execute_function:29 - 执行Function: query_packages, 参数: {'price_max': 100, 'sort_by': 'price_asc'}
2025-10-05 16:49:20.075 | ERROR    | executor.db_executor:execute_function:53 - Function执行失败: query_packages, 错误: 'cryptography' package is required for sha256_password or caching_sha2_password auth methods
2025-10-05 16:49:46.694 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_001
2025-10-05 16:49:46.697 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_001] 对话完成 | 意图: query_packages | 轮次: 2 | 耗时: 360331ms
2025-10-05 16:49:48.156 | INFO     | core.chatbot_dst:chat:46 - [integration_test_001] 收到用户输入: 流量要50G以上
2025-10-05 16:49:48.919 | INFO     | core.nlu.nlu_engine:understand:80 - [integration_test_001] 开始NLU理解: 流量要50G以上
2025-10-05 16:49:48.921 | DEBUG    | core.nlu.nlu_engine:understand:85 - [integration_test_001] 预处理后: 流量要50G以上
2025-10-05 16:49:52.314 | INFO     | core.nlu.nlu_engine:understand:110 - [integration_test_001] NLU完成: intent=query_packages
2025-10-05 16:49:54.053 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_001
2025-10-05 16:49:55.571 | DEBUG    | core.dst.state_store:_load_from_memory:118 - 从内存加载状态: integration_test_001
2025-10-05 16:49:57.486 | DEBUG    | core.dst.slot_manager:fill_slots:43 - 意图不变，合并槽位: ['price_max', 'data_max', 'sort_by']
2025-10-05 16:50:00.024 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_001
2025-10-05 16:50:00.025 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=3, 需要澄清=False
2025-10-05 16:50:00.930 | INFO     | executor.db_executor:execute_function:29 - 执行Function: query_packages, 参数: {'price_max': 100, 'sort_by': 'price_asc', 'data_max': 50}
2025-10-05 16:50:01.606 | ERROR    | executor.db_executor:execute_function:53 - Function执行失败: query_packages, 错误: 'cryptography' package is required for sha256_password or caching_sha2_password auth methods
2025-10-05 16:50:02.536 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_001
2025-10-05 16:50:02.538 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_001] 对话完成 | 意图: query_packages | 轮次: 4 | 耗时: 14383ms
2025-10-05 16:52:07.718 | INFO     | database.db_manager:_initialize:38 - 数据库连接初始化成功
2025-10-05 16:52:07.718 | ERROR    | database.redis_manager:_initialize:45 - Redis连接池初始化失败: 'Settings' object has no attribute 'get'
2025-10-05 16:52:08.698 | INFO     | core.nlu.nlu_engine:__init__:50 - ✓ NLU引擎初始化成功: DeepSeek (deepseek-chat)
2025-10-05 16:52:08.698 | ERROR    | core.dst.state_store:__init__:28 - Redis初始化失败: Redis连接池未初始化, 使用内存存储
2025-10-05 16:52:08.698 | INFO     | core.dst.dialog_state_tracker:__init__:27 - 对话状态跟踪器初始化完成
2025-10-05 16:52:08.698 | INFO     | executor.db_executor:__init__:16 - 数据库执行器初始化完成
2025-10-05 16:52:08.698 | INFO     | core.chatbot_dst:__init__:23 - 第二阶段对话系统初始化完成（含DST支持）
2025-10-05 16:52:25.509 | INFO     | database.db_manager:_initialize:38 - 数据库连接初始化成功
2025-10-05 16:52:25.509 | ERROR    | database.redis_manager:_initialize:45 - Redis连接池初始化失败: 'Settings' object has no attribute 'get'
2025-10-05 16:52:26.458 | INFO     | core.nlu.nlu_engine:__init__:50 - ✓ NLU引擎初始化成功: DeepSeek (deepseek-chat)
2025-10-05 16:52:26.458 | ERROR    | core.dst.state_store:__init__:28 - Redis初始化失败: Redis连接池未初始化, 使用内存存储
2025-10-05 16:52:26.458 | INFO     | core.dst.dialog_state_tracker:__init__:27 - 对话状态跟踪器初始化完成
2025-10-05 16:52:26.459 | INFO     | executor.db_executor:__init__:16 - 数据库执行器初始化完成
2025-10-05 16:52:26.459 | INFO     | core.chatbot_dst:__init__:23 - 第二阶段对话系统初始化完成（含DST支持）
2025-10-05 16:52:32.387 | INFO     | core.chatbot_dst:chat:46 - [integration_test_001] 收到用户输入: 有100元以内的套餐吗
2025-10-05 16:52:36.532 | INFO     | core.nlu.nlu_engine:understand:80 - [integration_test_001] 开始NLU理解: 有100元以内的套餐吗
2025-10-05 16:52:36.532 | DEBUG    | core.nlu.nlu_engine:understand:85 - [integration_test_001] 预处理后: 有100元以内的套餐吗
2025-10-05 16:52:40.801 | INFO     | core.nlu.nlu_engine:understand:110 - [integration_test_001] NLU完成: intent=query_packages
2025-10-05 16:52:46.852 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_001
2025-10-05 16:52:58.068 | DEBUG    | core.dst.state_store:_load_from_memory:121 - 内存中不存在会话: integration_test_001, 返回新状态
2025-10-05 16:53:10.075 | INFO     | core.dst.dialog_state_tracker:track:59 - 意图改变: None → query_packages
2025-10-05 16:53:22.035 | DEBUG    | core.dst.slot_manager:fill_slots:61 - 不同领域，仅保留用户信息: []
2025-10-05 16:53:42.694 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_001
2025-10-05 16:53:42.696 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=1, 需要澄清=False
2025-10-05 16:53:52.196 | INFO     | executor.db_executor:execute_function:29 - 执行Function: query_packages, 参数: {'price_max': 100}
2025-10-05 16:54:10.123 | ERROR    | executor.db_executor:execute_function:53 - Function执行失败: query_packages, 错误: 'cryptography' package is required for sha256_password or caching_sha2_password auth methods
2025-10-05 16:54:20.579 | INFO     | executor.db_executor:execute_function:29 - 执行Function: query_packages, 参数: {'price_max': 100}
2025-10-05 16:54:20.585 | ERROR    | executor.db_executor:execute_function:53 - Function执行失败: query_packages, 错误: 'cryptography' package is required for sha256_password or caching_sha2_password auth methods
2025-10-05 16:54:37.063 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_001
2025-10-05 16:54:37.065 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_001] 对话完成 | 意图: query_packages | 轮次: 2 | 耗时: 124678ms
2025-10-05 16:54:38.579 | INFO     | core.chatbot_dst:chat:46 - [integration_test_001] 收到用户输入: 流量要50G以上
2025-10-05 16:54:38.580 | INFO     | core.nlu.nlu_engine:understand:80 - [integration_test_001] 开始NLU理解: 流量要50G以上
2025-10-05 16:54:38.581 | DEBUG    | core.nlu.nlu_engine:understand:85 - [integration_test_001] 预处理后: 流量要50G以上
2025-10-05 16:54:41.944 | INFO     | core.nlu.nlu_engine:understand:110 - [integration_test_001] NLU完成: intent=query_packages
2025-10-05 16:54:41.945 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_001
2025-10-05 16:54:41.946 | DEBUG    | core.dst.state_store:_load_from_memory:118 - 从内存加载状态: integration_test_001
2025-10-05 16:54:41.946 | DEBUG    | core.dst.slot_manager:fill_slots:43 - 意图不变，合并槽位: ['price_max', 'data_max', 'sort_by']
2025-10-05 16:54:41.947 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_001
2025-10-05 16:54:41.947 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=3, 需要澄清=False
2025-10-05 16:54:54.667 | INFO     | executor.db_executor:execute_function:29 - 执行Function: query_packages, 参数: {'price_max': 100, 'data_max': 50, 'sort_by': 'price_asc'}
2025-10-05 16:54:56.383 | ERROR    | executor.db_executor:execute_function:53 - Function执行失败: query_packages, 错误: 'cryptography' package is required for sha256_password or caching_sha2_password auth methods
2025-10-05 16:54:57.636 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_001
2025-10-05 16:54:57.637 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_001] 对话完成 | 意图: query_packages | 轮次: 4 | 耗时: 19058ms
2025-10-05 16:56:51.531 | INFO     | database.db_manager:_initialize:38 - 数据库连接初始化成功
2025-10-05 16:56:51.532 | ERROR    | database.redis_manager:_initialize:45 - Redis连接池初始化失败: 'Settings' object has no attribute 'get'
2025-10-05 16:56:52.562 | INFO     | core.nlu.nlu_engine:__init__:50 - ✓ NLU引擎初始化成功: DeepSeek (deepseek-chat)
2025-10-05 16:56:52.562 | ERROR    | core.dst.state_store:__init__:28 - Redis初始化失败: Redis连接池未初始化, 使用内存存储
2025-10-05 16:56:52.562 | INFO     | core.dst.dialog_state_tracker:__init__:27 - 对话状态跟踪器初始化完成
2025-10-05 16:56:52.562 | INFO     | executor.db_executor:__init__:16 - 数据库执行器初始化完成
2025-10-05 16:56:52.563 | INFO     | core.chatbot_dst:__init__:23 - 第二阶段对话系统初始化完成（含DST支持）
2025-10-05 16:56:58.315 | INFO     | core.chatbot_dst:chat:46 - [integration_test_001] 收到用户输入: 有100元以内的套餐吗
2025-10-05 16:56:58.315 | INFO     | core.nlu.nlu_engine:understand:80 - [integration_test_001] 开始NLU理解: 有100元以内的套餐吗
2025-10-05 16:56:58.316 | DEBUG    | core.nlu.nlu_engine:understand:85 - [integration_test_001] 预处理后: 有100元以内的套餐吗
2025-10-05 16:57:02.110 | INFO     | core.nlu.nlu_engine:understand:110 - [integration_test_001] NLU完成: intent=query_packages
2025-10-05 16:57:02.110 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_001
2025-10-05 16:57:02.110 | DEBUG    | core.dst.state_store:_load_from_memory:121 - 内存中不存在会话: integration_test_001, 返回新状态
2025-10-05 16:57:02.110 | INFO     | core.dst.dialog_state_tracker:track:59 - 意图改变: None → query_packages
2025-10-05 16:57:02.110 | DEBUG    | core.dst.slot_manager:fill_slots:61 - 不同领域，仅保留用户信息: []
2025-10-05 16:57:02.110 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_001
2025-10-05 16:57:02.110 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=1, 需要澄清=False
2025-10-05 16:57:07.506 | INFO     | executor.db_executor:execute_function:29 - 执行Function: query_packages, 参数: {'price_max': 100, 'sort_by': 'price_asc'}
2025-10-05 16:57:38.001 | INFO     | executor.db_executor:execute_function:50 - Function执行成功: query_packages
2025-10-05 16:58:05.088 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_001
2025-10-05 16:58:24.147 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_001] 对话完成 | 意图: query_packages | 轮次: 2 | 耗时: 85832ms
2025-10-05 16:58:29.870 | INFO     | core.chatbot_dst:chat:46 - [integration_test_001] 收到用户输入: 流量要50G以上
2025-10-05 16:58:29.871 | INFO     | core.nlu.nlu_engine:understand:80 - [integration_test_001] 开始NLU理解: 流量要50G以上
2025-10-05 16:58:29.872 | DEBUG    | core.nlu.nlu_engine:understand:85 - [integration_test_001] 预处理后: 流量要50G以上
2025-10-05 16:58:33.536 | INFO     | core.nlu.nlu_engine:understand:110 - [integration_test_001] NLU完成: intent=query_packages
2025-10-05 16:58:33.538 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_001
2025-10-05 16:58:33.539 | DEBUG    | core.dst.state_store:_load_from_memory:118 - 从内存加载状态: integration_test_001
2025-10-05 16:58:33.539 | DEBUG    | core.dst.slot_manager:fill_slots:43 - 意图不变，合并槽位: ['price_max', 'data_max', 'sort_by']
2025-10-05 16:58:33.540 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_001
2025-10-05 16:58:33.540 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=3, 需要澄清=False
2025-10-05 16:59:22.329 | INFO     | executor.db_executor:execute_function:29 - 执行Function: query_packages, 参数: {'price_max': 100, 'sort_by': 'price_asc', 'data_max': 50}
2025-10-05 16:59:45.153 | INFO     | executor.db_executor:execute_function:50 - Function执行成功: query_packages
2025-10-05 16:59:50.886 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_001
2025-10-05 16:59:55.561 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_001] 对话完成 | 意图: query_packages | 轮次: 4 | 耗时: 85691ms
2025-10-05 17:03:32.586 | INFO     | database.db_manager:_initialize:38 - 数据库连接初始化成功
2025-10-05 17:03:32.586 | ERROR    | database.redis_manager:_initialize:45 - Redis连接池初始化失败: 'Settings' object has no attribute 'get'
2025-10-05 17:03:32.824 | INFO     | core.nlu.nlu_engine:__init__:50 - ✓ NLU引擎初始化成功: DeepSeek (deepseek-chat)
2025-10-05 17:03:32.824 | ERROR    | core.dst.state_store:__init__:28 - Redis初始化失败: Redis连接池未初始化, 使用内存存储
2025-10-05 17:03:32.824 | INFO     | core.dst.dialog_state_tracker:__init__:27 - 对话状态跟踪器初始化完成
2025-10-05 17:03:32.824 | INFO     | executor.db_executor:__init__:16 - 数据库执行器初始化完成
2025-10-05 17:03:32.824 | INFO     | core.chatbot_dst:__init__:23 - 第二阶段对话系统初始化完成（含DST支持）
2025-10-05 17:03:32.824 | INFO     | core.chatbot_dst:chat:46 - [integration_test_001] 收到用户输入: 有100元以内的套餐吗
2025-10-05 17:03:32.824 | INFO     | core.nlu.nlu_engine:understand:80 - [integration_test_001] 开始NLU理解: 有100元以内的套餐吗
2025-10-05 17:03:32.824 | DEBUG    | core.nlu.nlu_engine:understand:85 - [integration_test_001] 预处理后: 有100元以内的套餐吗
2025-10-05 17:03:35.848 | INFO     | core.nlu.nlu_engine:understand:110 - [integration_test_001] NLU完成: intent=query_packages
2025-10-05 17:03:35.848 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_001
2025-10-05 17:03:35.848 | DEBUG    | core.dst.state_store:_load_from_memory:121 - 内存中不存在会话: integration_test_001, 返回新状态
2025-10-05 17:03:35.849 | INFO     | core.dst.dialog_state_tracker:track:59 - 意图改变: None → query_packages
2025-10-05 17:03:35.849 | DEBUG    | core.dst.slot_manager:fill_slots:61 - 不同领域，仅保留用户信息: []
2025-10-05 17:03:35.849 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_001
2025-10-05 17:03:35.849 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=1, 需要澄清=False
2025-10-05 17:03:35.849 | INFO     | executor.db_executor:execute_function:29 - 执行Function: query_packages, 参数: {'price_max': 100, 'sort_by': 'price_asc'}
2025-10-05 17:03:35.904 | INFO     | executor.db_executor:execute_function:50 - Function执行成功: query_packages
2025-10-05 17:03:35.905 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_001
2025-10-05 17:03:35.905 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_001] 对话完成 | 意图: query_packages | 轮次: 2 | 耗时: 3081ms
2025-10-05 17:03:35.905 | INFO     | tests.test_integration:test_multi_turn_conversation:74 - 第一轮返回结果: {'session_id': 'integration_test_001', 'response': '为您找到 1 个合适的套餐:\n\n【经济套餐】\n  💰 月费: 50.0元\n  📊 流量: 10GB/月\n  📞 通话: 100分钟/月\n  👥 适用: 无限制\n  📝 适合轻度上网用户,性价比高,包含10GB流量和100分钟通话\n\n如需办理或了解详情,请告诉我套餐名称和您的手机号码。', 'intent': 'query_packages', 'function': 'query_packages', 'parameters': {'price_max': 100, 'sort_by': 'price_asc'}, 'data': {'success': True, 'data': [{'id': 1, 'name': '经济套餐', 'data_gb': 10, 'voice_minutes': 100, 'price': 50.0, 'target_user': '无限制', 'description': '适合轻度上网用户,性价比高,包含10GB流量和100分钟通话'}], 'count': 1}, 'requires_input': False, 'state': {'session_id': 'integration_test_001', 'user_phone': None, 'user_name': None, 'current_intent': 'query_packages', 'previous_intent': None, 'slots': {'price_max': 100, 'sort_by': 'price_asc'}, 'history': [{'turn_id': 1, 'role': 'user', 'content': '有100元以内的套餐吗', 'intent': 'query_packages', 'entities': {}, 'timestamp': '2025-10-05T17:03:35.849051'}, {'turn_id': 2, 'role': 'assistant', 'content': '为您找到 1 个合适的套餐:\n\n【经济套餐】\n  💰 月费: 50.0元\n  📊 流量: 10GB/月\n  📞 通话: 100分钟/月\n  👥 适用: 无限制\n  📝 适合轻度上网用户,性价比高,包含10GB流量和100分钟通话\n\n如需办理或了解详情,请告诉我套餐名称和您的手机号码。', 'intent': None, 'entities': {}, 'timestamp': '2025-10-05T17:03:35.905301'}], 'context_stack': [{'intent': 'query_packages', 'parameters': {'price_max': 100, 'sort_by': 'price_asc'}, 'confidence': 0.9, 'timestamp': datetime.datetime(2025, 10, 5, 17, 3, 35, 849199), 'turn_id': 1}], 'turn_count': 2, 'created_at': '2025-10-05T17:03:35.849015', 'updated_at': '2025-10-05T17:03:35.905305', 'is_completed': False, 'needs_clarification': False, 'missing_slots': [], 'user_profile': {}}, 'timestamp': '2025-10-05T17:03:35.905496'}
2025-10-05 17:03:35.905 | INFO     | core.chatbot_dst:chat:46 - [integration_test_001] 收到用户输入: 流量要50G以上
2025-10-05 17:03:35.905 | INFO     | core.nlu.nlu_engine:understand:80 - [integration_test_001] 开始NLU理解: 流量要50G以上
2025-10-05 17:03:35.906 | DEBUG    | core.nlu.nlu_engine:understand:85 - [integration_test_001] 预处理后: 流量要50G以上
2025-10-05 17:03:39.186 | INFO     | core.nlu.nlu_engine:understand:110 - [integration_test_001] NLU完成: intent=query_packages
2025-10-05 17:03:39.187 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_001
2025-10-05 17:03:39.187 | DEBUG    | core.dst.state_store:_load_from_memory:118 - 从内存加载状态: integration_test_001
2025-10-05 17:03:39.187 | DEBUG    | core.dst.slot_manager:fill_slots:43 - 意图不变，合并槽位: ['price_max', 'data_max', 'sort_by']
2025-10-05 17:03:39.187 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_001
2025-10-05 17:03:39.187 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=3, 需要澄清=False
2025-10-05 17:03:39.187 | INFO     | executor.db_executor:execute_function:29 - 执行Function: query_packages, 参数: {'price_max': 100, 'sort_by': 'price_asc', 'data_max': 50}
2025-10-05 17:03:39.192 | INFO     | executor.db_executor:execute_function:50 - Function执行成功: query_packages
2025-10-05 17:03:39.193 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_001
2025-10-05 17:03:39.193 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_001] 对话完成 | 意图: query_packages | 轮次: 4 | 耗时: 3287ms
2025-10-05 17:03:39.193 | INFO     | tests.test_integration:test_multi_turn_conversation:86 - 第二轮返回结果: {'session_id': 'integration_test_001', 'user_phone': None, 'user_name': None, 'current_intent': 'query_packages', 'previous_intent': 'query_packages', 'slots': {'price_max': 100, 'sort_by': 'price_asc', 'data_max': 50}, 'history': [{'turn_id': 1, 'role': 'user', 'content': '有100元以内的套餐吗', 'intent': 'query_packages', 'entities': {}, 'timestamp': '2025-10-05T17:03:35.849051'}, {'turn_id': 2, 'role': 'assistant', 'content': '为您找到 1 个合适的套餐:\n\n【经济套餐】\n  💰 月费: 50.0元\n  📊 流量: 10GB/月\n  📞 通话: 100分钟/月\n  👥 适用: 无限制\n  📝 适合轻度上网用户,性价比高,包含10GB流量和100分钟通话\n\n如需办理或了解详情,请告诉我套餐名称和您的手机号码。', 'intent': None, 'entities': {}, 'timestamp': '2025-10-05T17:03:35.905301'}, {'turn_id': 3, 'role': 'user', 'content': '流量要50G以上', 'intent': 'query_packages', 'entities': {}, 'timestamp': '2025-10-05T17:03:39.187328'}, {'turn_id': 4, 'role': 'assistant', 'content': '为您找到 1 个合适的套餐:\n\n【经济套餐】\n  💰 月费: 50.0元\n  📊 流量: 10GB/月\n  📞 通话: 100分钟/月\n  👥 适用: 无限制\n  📝 适合轻度上网用户,性价比高,包含10GB流量和100分钟通话\n\n如需办理或了解详情,请告诉我套餐名称和您的手机号码。', 'intent': None, 'entities': {}, 'timestamp': '2025-10-05T17:03:39.193010'}], 'context_stack': [{'intent': 'query_packages', 'parameters': {'price_max': 100, 'sort_by': 'price_asc'}, 'confidence': 0.9, 'timestamp': datetime.datetime(2025, 10, 5, 17, 3, 35, 849199), 'turn_id': 1}, {'intent': 'query_packages', 'parameters': {'price_max': 100, 'data_max': 50, 'sort_by': 'price_asc'}, 'confidence': 0.9, 'timestamp': datetime.datetime(2025, 10, 5, 17, 3, 39, 187479), 'turn_id': 2}], 'turn_count': 4, 'created_at': '2025-10-05T17:03:35.849015', 'updated_at': '2025-10-05T17:03:39.193013', 'is_completed': False, 'needs_clarification': False, 'missing_slots': [], 'user_profile': {}}
2025-10-05 17:08:15.229 | INFO     | database.db_manager:_initialize:38 - 数据库连接初始化成功
2025-10-05 17:08:15.230 | ERROR    | database.redis_manager:_initialize:45 - Redis连接池初始化失败: 'Settings' object has no attribute 'get'
2025-10-05 17:08:16.205 | INFO     | core.nlu.nlu_engine:__init__:50 - ✓ NLU引擎初始化成功: DeepSeek (deepseek-chat)
2025-10-05 17:08:16.205 | ERROR    | core.dst.state_store:__init__:28 - Redis初始化失败: Redis连接池未初始化, 使用内存存储
2025-10-05 17:08:16.205 | INFO     | core.dst.dialog_state_tracker:__init__:27 - 对话状态跟踪器初始化完成
2025-10-05 17:08:16.205 | INFO     | executor.db_executor:__init__:16 - 数据库执行器初始化完成
2025-10-05 17:08:16.206 | INFO     | core.chatbot_dst:__init__:23 - 第二阶段对话系统初始化完成（含DST支持）
2025-10-05 17:08:35.529 | INFO     | core.chatbot_dst:chat:46 - [integration_test_001] 收到用户输入: 有100元以内的套餐吗
2025-10-05 17:08:35.530 | INFO     | core.nlu.nlu_engine:understand:80 - [integration_test_001] 开始NLU理解: 有100元以内的套餐吗
2025-10-05 17:08:35.530 | DEBUG    | core.nlu.nlu_engine:understand:85 - [integration_test_001] 预处理后: 有100元以内的套餐吗
2025-10-05 17:08:40.133 | INFO     | core.nlu.nlu_engine:understand:110 - [integration_test_001] NLU完成: intent=query_packages
2025-10-05 17:08:40.134 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_001
2025-10-05 17:08:40.134 | DEBUG    | core.dst.state_store:_load_from_memory:121 - 内存中不存在会话: integration_test_001, 返回新状态
2025-10-05 17:08:40.134 | INFO     | core.dst.dialog_state_tracker:track:59 - 意图改变: None → query_packages
2025-10-05 17:08:40.134 | DEBUG    | core.dst.slot_manager:fill_slots:61 - 不同领域，仅保留用户信息: []
2025-10-05 17:08:40.134 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_001
2025-10-05 17:08:40.134 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=1, 需要澄清=False
2025-10-05 17:09:06.180 | INFO     | executor.db_executor:execute_function:29 - 执行Function: query_packages, 参数: {'price_max': 100, 'sort_by': 'price_asc'}
2025-10-05 17:09:10.347 | INFO     | executor.db_executor:execute_function:50 - Function执行成功: query_packages
2025-10-05 17:09:12.959 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_001
2025-10-05 17:09:12.960 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_001] 对话完成 | 意图: query_packages | 轮次: 2 | 耗时: 37432ms
2025-10-05 17:09:12.961 | INFO     | tests.test_integration:test_multi_turn_conversation:74 - 第一轮返回结果: {'session_id': 'integration_test_001', 'response': '为您找到 1 个合适的套餐:\n\n【经济套餐】\n  💰 月费: 50.0元\n  📊 流量: 10GB/月\n  📞 通话: 100分钟/月\n  👥 适用: 无限制\n  📝 适合轻度上网用户,性价比高,包含10GB流量和100分钟通话\n\n如需办理或了解详情,请告诉我套餐名称和您的手机号码。', 'intent': 'query_packages', 'function': 'query_packages', 'parameters': {'price_max': 100, 'sort_by': 'price_asc'}, 'data': {'success': True, 'data': [{'id': 1, 'name': '经济套餐', 'data_gb': 10, 'voice_minutes': 100, 'price': 50.0, 'target_user': '无限制', 'description': '适合轻度上网用户,性价比高,包含10GB流量和100分钟通话'}], 'count': 1}, 'requires_input': False, 'state': {'session_id': 'integration_test_001', 'user_phone': None, 'user_name': None, 'current_intent': 'query_packages', 'previous_intent': None, 'slots': {'price_max': 100, 'sort_by': 'price_asc'}, 'history': [{'turn_id': 1, 'role': 'user', 'content': '有100元以内的套餐吗', 'intent': 'query_packages', 'entities': {}, 'timestamp': '2025-10-05T17:08:40.134323'}, {'turn_id': 2, 'role': 'assistant', 'content': '为您找到 1 个合适的套餐:\n\n【经济套餐】\n  💰 月费: 50.0元\n  📊 流量: 10GB/月\n  📞 通话: 100分钟/月\n  👥 适用: 无限制\n  📝 适合轻度上网用户,性价比高,包含10GB流量和100分钟通话\n\n如需办理或了解详情,请告诉我套餐名称和您的手机号码。', 'intent': None, 'entities': {}, 'timestamp': '2025-10-05T17:09:12.959550'}], 'context_stack': [{'intent': 'query_packages', 'parameters': {'price_max': 100, 'sort_by': 'price_asc'}, 'confidence': 0.9, 'timestamp': datetime.datetime(2025, 10, 5, 17, 8, 40, 134501), 'turn_id': 1}], 'turn_count': 2, 'created_at': '2025-10-05T17:08:40.134299', 'updated_at': '2025-10-05T17:09:12.959567', 'is_completed': False, 'needs_clarification': False, 'missing_slots': [], 'user_profile': {}}, 'timestamp': '2025-10-05T17:09:12.960687'}
2025-10-05 17:09:15.136 | INFO     | core.chatbot_dst:chat:46 - [integration_test_001] 收到用户输入: 流量要50G以上
2025-10-05 17:09:28.057 | INFO     | core.nlu.nlu_engine:understand:80 - [integration_test_001] 开始NLU理解: 流量要50G以上
2025-10-05 17:09:29.544 | DEBUG    | core.nlu.nlu_engine:understand:85 - [integration_test_001] 预处理后: 流量要50G以上
2025-10-05 17:09:54.059 | INFO     | core.nlu.nlu_engine:understand:110 - [integration_test_001] NLU完成: intent=query_packages
2025-10-05 17:10:07.992 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_001
2025-10-05 17:10:07.994 | DEBUG    | core.dst.state_store:_load_from_memory:118 - 从内存加载状态: integration_test_001
2025-10-05 17:10:07.995 | DEBUG    | core.dst.slot_manager:fill_slots:43 - 意图不变，合并槽位: ['price_max', 'data_min']
2025-10-05 17:10:07.996 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_001
2025-10-05 17:10:07.996 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=3, 需要澄清=False
2025-10-05 17:10:11.689 | INFO     | executor.db_executor:execute_function:29 - 执行Function: query_packages, 参数: {'price_max': 100, 'sort_by': 'price_asc', 'data_min': 50}
2025-10-05 17:10:45.724 | INFO     | executor.db_executor:execute_function:50 - Function执行成功: query_packages
2025-10-05 17:10:48.122 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_001
2025-10-05 17:10:48.124 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_001] 对话完成 | 意图: query_packages | 轮次: 4 | 耗时: 92989ms
2025-10-05 17:10:48.125 | INFO     | tests.test_integration:test_multi_turn_conversation:86 - 第二轮返回结果: {'session_id': 'integration_test_001', 'user_phone': None, 'user_name': None, 'current_intent': 'query_packages', 'previous_intent': 'query_packages', 'slots': {'price_max': 100, 'sort_by': 'price_asc', 'data_min': 50}, 'history': [{'turn_id': 1, 'role': 'user', 'content': '有100元以内的套餐吗', 'intent': 'query_packages', 'entities': {}, 'timestamp': '2025-10-05T17:08:40.134323'}, {'turn_id': 2, 'role': 'assistant', 'content': '为您找到 1 个合适的套餐:\n\n【经济套餐】\n  💰 月费: 50.0元\n  📊 流量: 10GB/月\n  📞 通话: 100分钟/月\n  👥 适用: 无限制\n  📝 适合轻度上网用户,性价比高,包含10GB流量和100分钟通话\n\n如需办理或了解详情,请告诉我套餐名称和您的手机号码。', 'intent': None, 'entities': {}, 'timestamp': '2025-10-05T17:09:12.959550'}, {'turn_id': 3, 'role': 'user', 'content': '流量要50G以上', 'intent': 'query_packages', 'entities': {}, 'timestamp': '2025-10-05T17:10:07.995493'}, {'turn_id': 4, 'role': 'assistant', 'content': '抱歉,没有找到符合条件的套餐。要不要看看其他套餐?', 'intent': None, 'entities': {}, 'timestamp': '2025-10-05T17:10:48.122705'}], 'context_stack': [{'intent': 'query_packages', 'parameters': {'price_max': 100, 'sort_by': 'price_asc'}, 'confidence': 0.9, 'timestamp': datetime.datetime(2025, 10, 5, 17, 8, 40, 134501), 'turn_id': 1}, {'intent': 'query_packages', 'parameters': {'price_max': 100, 'data_min': 50}, 'confidence': 0.9, 'timestamp': datetime.datetime(2025, 10, 5, 17, 10, 7, 996030), 'turn_id': 2}], 'turn_count': 4, 'created_at': '2025-10-05T17:08:40.134299', 'updated_at': '2025-10-05T17:10:48.122748', 'is_completed': False, 'needs_clarification': False, 'missing_slots': [], 'user_profile': {}}
2025-10-05 17:12:34.461 | INFO     | database.db_manager:_initialize:38 - 数据库连接初始化成功
2025-10-05 17:12:34.461 | ERROR    | database.redis_manager:_initialize:45 - Redis连接池初始化失败: 'Settings' object has no attribute 'get'
2025-10-05 17:12:35.413 | INFO     | core.nlu.nlu_engine:__init__:50 - ✓ NLU引擎初始化成功: DeepSeek (deepseek-chat)
2025-10-05 17:12:35.413 | ERROR    | core.dst.state_store:__init__:28 - Redis初始化失败: Redis连接池未初始化, 使用内存存储
2025-10-05 17:12:35.413 | INFO     | core.dst.dialog_state_tracker:__init__:27 - 对话状态跟踪器初始化完成
2025-10-05 17:12:35.413 | INFO     | executor.db_executor:__init__:16 - 数据库执行器初始化完成
2025-10-05 17:12:35.413 | INFO     | core.chatbot_dst:__init__:23 - 第二阶段对话系统初始化完成（含DST支持）
2025-10-05 17:12:43.209 | INFO     | core.chatbot_dst:chat:46 - [integration_test_002] 收到用户输入: 查下我的套餐
2025-10-05 17:12:45.974 | INFO     | core.nlu.nlu_engine:understand:80 - [integration_test_002] 开始NLU理解: 查下我的套餐
2025-10-05 17:12:47.616 | DEBUG    | core.nlu.nlu_engine:understand:85 - [integration_test_002] 预处理后: 查下我的套餐
2025-10-05 17:14:54.952 | INFO     | database.db_manager:_initialize:38 - 数据库连接初始化成功
2025-10-05 17:14:54.952 | ERROR    | database.redis_manager:_initialize:45 - Redis连接池初始化失败: 'Settings' object has no attribute 'get'
2025-10-05 17:14:55.915 | INFO     | core.nlu.nlu_engine:__init__:50 - ✓ NLU引擎初始化成功: DeepSeek (deepseek-chat)
2025-10-05 17:14:55.915 | ERROR    | core.dst.state_store:__init__:28 - Redis初始化失败: Redis连接池未初始化, 使用内存存储
2025-10-05 17:14:55.915 | INFO     | core.dst.dialog_state_tracker:__init__:27 - 对话状态跟踪器初始化完成
2025-10-05 17:14:55.915 | INFO     | executor.db_executor:__init__:16 - 数据库执行器初始化完成
2025-10-05 17:14:55.915 | INFO     | core.chatbot_dst:__init__:23 - 第二阶段对话系统初始化完成（含DST支持）
2025-10-05 17:14:58.242 | INFO     | core.chatbot_dst:chat:46 - [integration_test_002] 收到用户输入: 查下我的套餐
2025-10-05 17:15:10.612 | INFO     | core.nlu.nlu_engine:understand:80 - [integration_test_002] 开始NLU理解: 查下我的套餐
2025-10-05 17:15:12.223 | DEBUG    | core.nlu.nlu_engine:understand:85 - [integration_test_002] 预处理后: 查下我的套餐
2025-10-05 17:18:03.826 | INFO     | database.db_manager:_initialize:38 - 数据库连接初始化成功
2025-10-05 17:18:03.827 | ERROR    | database.redis_manager:_initialize:45 - Redis连接池初始化失败: 'Settings' object has no attribute 'get'
2025-10-05 17:18:04.805 | INFO     | core.nlu.nlu_engine:__init__:50 - ✓ NLU引擎初始化成功: DeepSeek (deepseek-chat)
2025-10-05 17:18:04.805 | ERROR    | core.dst.state_store:__init__:28 - Redis初始化失败: Redis连接池未初始化, 使用内存存储
2025-10-05 17:18:04.805 | INFO     | core.dst.dialog_state_tracker:__init__:27 - 对话状态跟踪器初始化完成
2025-10-05 17:18:04.805 | INFO     | executor.db_executor:__init__:16 - 数据库执行器初始化完成
2025-10-05 17:18:04.805 | INFO     | core.chatbot_dst:__init__:23 - 第二阶段对话系统初始化完成（含DST支持）
2025-10-05 17:18:06.914 | INFO     | core.chatbot_dst:chat:46 - [integration_test_002] 收到用户输入: 查下我的套餐
2025-10-05 17:18:09.288 | INFO     | core.nlu.nlu_engine:understand:80 - [integration_test_002] 开始NLU理解: 查下我的套餐
2025-10-05 17:18:09.289 | DEBUG    | core.nlu.nlu_engine:understand:85 - [integration_test_002] 预处理后: 查下我的套餐
2025-10-05 17:18:15.272 | INFO     | core.nlu.nlu_engine:understand:110 - [integration_test_002] NLU完成: intent=chat
2025-10-05 17:18:30.699 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_002
2025-10-05 17:18:30.701 | DEBUG    | core.dst.state_store:_load_from_memory:121 - 内存中不存在会话: integration_test_002, 返回新状态
2025-10-05 17:18:30.702 | INFO     | core.dst.dialog_state_tracker:track:59 - 意图改变: None → chat
2025-10-05 17:18:30.703 | DEBUG    | core.dst.slot_manager:fill_slots:61 - 不同领域，仅保留用户信息: []
2025-10-05 17:18:30.703 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_002
2025-10-05 17:18:30.704 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=1, 需要澄清=False
2025-10-05 17:18:34.231 | INFO     | executor.db_executor:execute_function:29 - 执行Function: chat, 参数: {}
2025-10-05 17:18:54.717 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_002
2025-10-05 17:18:58.511 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_002] 对话完成 | 意图: chat | 轮次: 2 | 耗时: 51597ms
2025-10-05 17:21:33.357 | INFO     | database.db_manager:_initialize:38 - 数据库连接初始化成功
2025-10-05 17:21:33.358 | ERROR    | database.redis_manager:_initialize:45 - Redis连接池初始化失败: 'Settings' object has no attribute 'get'
2025-10-05 17:21:34.330 | INFO     | core.nlu.nlu_engine:__init__:50 - ✓ NLU引擎初始化成功: DeepSeek (deepseek-chat)
2025-10-05 17:21:34.330 | ERROR    | core.dst.state_store:__init__:28 - Redis初始化失败: Redis连接池未初始化, 使用内存存储
2025-10-05 17:21:34.330 | INFO     | core.dst.dialog_state_tracker:__init__:27 - 对话状态跟踪器初始化完成
2025-10-05 17:21:34.330 | INFO     | executor.db_executor:__init__:16 - 数据库执行器初始化完成
2025-10-05 17:21:34.330 | INFO     | core.chatbot_dst:__init__:23 - 第二阶段对话系统初始化完成（含DST支持）
2025-10-05 17:21:37.183 | INFO     | core.chatbot_dst:chat:46 - [integration_test_002] 收到用户输入: 查下我的套餐
2025-10-05 17:21:44.337 | INFO     | core.nlu.nlu_engine:understand:80 - [integration_test_002] 开始NLU理解: 查下我的套餐
2025-10-05 17:21:44.339 | DEBUG    | core.nlu.nlu_engine:understand:85 - [integration_test_002] 预处理后: 查下我的套餐
2025-10-05 17:21:48.370 | INFO     | core.nlu.nlu_engine:understand:110 - [integration_test_002] NLU完成: intent=chat
2025-10-05 17:22:13.057 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_002
2025-10-05 17:22:14.931 | DEBUG    | core.dst.state_store:_load_from_memory:121 - 内存中不存在会话: integration_test_002, 返回新状态
2025-10-05 17:23:00.271 | INFO     | core.dst.dialog_state_tracker:track:59 - 意图改变: None → chat
2025-10-05 17:23:05.275 | DEBUG    | core.dst.slot_manager:fill_slots:61 - 不同领域，仅保留用户信息: []
2025-10-05 17:24:32.967 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_002
2025-10-05 17:24:35.288 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=1, 需要澄清=False
2025-10-05 17:29:46.502 | INFO     | database.db_manager:_initialize:38 - 数据库连接初始化成功
2025-10-05 17:29:46.503 | ERROR    | database.redis_manager:_initialize:45 - Redis连接池初始化失败: 'Settings' object has no attribute 'get'
2025-10-05 17:29:47.466 | INFO     | core.nlu.nlu_engine:__init__:50 - ✓ NLU引擎初始化成功: DeepSeek (deepseek-chat)
2025-10-05 17:29:47.467 | ERROR    | core.dst.state_store:__init__:28 - Redis初始化失败: Redis连接池未初始化, 使用内存存储
2025-10-05 17:29:47.467 | INFO     | core.dst.dialog_state_tracker:__init__:27 - 对话状态跟踪器初始化完成
2025-10-05 17:29:47.467 | INFO     | executor.db_executor:__init__:16 - 数据库执行器初始化完成
2025-10-05 17:29:47.467 | INFO     | core.chatbot_dst:__init__:23 - 第二阶段对话系统初始化完成（含DST支持）
2025-10-05 17:29:50.031 | INFO     | core.chatbot_dst:chat:46 - [integration_test_0002] 收到用户输入: 查下我的套餐
2025-10-05 17:29:54.135 | INFO     | core.nlu.nlu_engine:understand:80 - [integration_test_0002] 开始NLU理解: 查下我的套餐
2025-10-05 17:29:54.136 | DEBUG    | core.nlu.nlu_engine:understand:85 - [integration_test_0002] 预处理后: 查下我的套餐
2025-10-05 17:29:58.215 | INFO     | core.nlu.nlu_engine:understand:110 - [integration_test_0002] NLU完成: intent=chat
2025-10-05 17:30:59.743 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_0002
2025-10-05 17:31:00.365 | DEBUG    | core.dst.state_store:_load_from_memory:121 - 内存中不存在会话: integration_test_0002, 返回新状态
2025-10-05 17:31:14.668 | INFO     | core.dst.dialog_state_tracker:track:59 - 意图改变: None → chat
2025-10-05 17:31:36.140 | DEBUG    | core.dst.slot_manager:fill_slots:61 - 不同领域，仅保留用户信息: []
2025-10-05 17:34:57.984 | INFO     | database.db_manager:_initialize:38 - 数据库连接初始化成功
2025-10-05 17:34:57.985 | ERROR    | database.redis_manager:_initialize:45 - Redis连接池初始化失败: 'Settings' object has no attribute 'get'
2025-10-05 17:34:58.937 | INFO     | core.nlu.nlu_engine:__init__:50 - ✓ NLU引擎初始化成功: DeepSeek (deepseek-chat)
2025-10-05 17:34:58.937 | ERROR    | core.dst.state_store:__init__:28 - Redis初始化失败: Redis连接池未初始化, 使用内存存储
2025-10-05 17:34:58.937 | INFO     | core.dst.dialog_state_tracker:__init__:27 - 对话状态跟踪器初始化完成
2025-10-05 17:34:58.937 | INFO     | executor.db_executor:__init__:16 - 数据库执行器初始化完成
2025-10-05 17:34:58.937 | INFO     | core.chatbot_dst:__init__:23 - 第二阶段对话系统初始化完成（含DST支持）
2025-10-05 17:35:01.064 | INFO     | core.chatbot_dst:chat:46 - [integration_test_0002] 收到用户输入: 查下我的套餐
2025-10-05 17:35:03.332 | INFO     | core.nlu.nlu_engine:understand:80 - [integration_test_0002] 开始NLU理解: 查下我的套餐
2025-10-05 17:35:03.333 | DEBUG    | core.nlu.nlu_engine:understand:85 - [integration_test_0002] 预处理后: 查下我的套餐
2025-10-05 17:35:07.175 | INFO     | core.nlu.nlu_engine:understand:110 - [integration_test_0002] NLU完成: intent=chat
2025-10-05 17:37:33.970 | INFO     | database.db_manager:_initialize:38 - 数据库连接初始化成功
2025-10-05 17:37:33.970 | ERROR    | database.redis_manager:_initialize:45 - Redis连接池初始化失败: 'Settings' object has no attribute 'get'
2025-10-05 17:37:34.926 | INFO     | core.nlu.nlu_engine:__init__:50 - ✓ NLU引擎初始化成功: DeepSeek (deepseek-chat)
2025-10-05 17:37:34.926 | ERROR    | core.dst.state_store:__init__:28 - Redis初始化失败: Redis连接池未初始化, 使用内存存储
2025-10-05 17:37:34.926 | INFO     | core.dst.dialog_state_tracker:__init__:27 - 对话状态跟踪器初始化完成
2025-10-05 17:37:34.926 | INFO     | executor.db_executor:__init__:16 - 数据库执行器初始化完成
2025-10-05 17:37:34.926 | INFO     | core.chatbot_dst:__init__:23 - 第二阶段对话系统初始化完成（含DST支持）
2025-10-05 17:37:37.103 | INFO     | core.chatbot_dst:chat:46 - [integration_test_0002] 收到用户输入: 查下我的套餐
2025-10-05 17:37:38.249 | INFO     | core.nlu.nlu_engine:understand:80 - [integration_test_0002] 开始NLU理解: 查下我的套餐
2025-10-05 17:37:38.249 | DEBUG    | core.nlu.nlu_engine:understand:85 - [integration_test_0002] 预处理后: 查下我的套餐
2025-10-05 17:40:18.661 | INFO     | database.db_manager:_initialize:38 - 数据库连接初始化成功
2025-10-05 17:40:18.661 | ERROR    | database.redis_manager:_initialize:45 - Redis连接池初始化失败: 'Settings' object has no attribute 'get'
2025-10-05 17:40:18.886 | INFO     | core.nlu.nlu_engine:__init__:50 - ✓ NLU引擎初始化成功: DeepSeek (deepseek-chat)
2025-10-05 17:40:18.886 | ERROR    | core.dst.state_store:__init__:28 - Redis初始化失败: Redis连接池未初始化, 使用内存存储
2025-10-05 17:40:18.886 | INFO     | core.dst.dialog_state_tracker:__init__:27 - 对话状态跟踪器初始化完成
2025-10-05 17:40:18.886 | INFO     | executor.db_executor:__init__:16 - 数据库执行器初始化完成
2025-10-05 17:40:18.886 | INFO     | core.chatbot_dst:__init__:23 - 第二阶段对话系统初始化完成（含DST支持）
2025-10-05 17:40:18.887 | INFO     | core.chatbot_dst:chat:46 - [integration_test_0002] 收到用户输入: 查下我的套餐
2025-10-05 17:40:18.887 | INFO     | core.nlu.nlu_engine:understand:80 - [integration_test_0002] 开始NLU理解: 查下我的套餐
2025-10-05 17:40:18.887 | DEBUG    | core.nlu.nlu_engine:understand:85 - [integration_test_0002] 预处理后: 查下我的套餐
2025-10-05 17:40:22.181 | INFO     | core.nlu.nlu_engine:understand:110 - [integration_test_0002] NLU完成: intent=chat
2025-10-05 17:40:22.182 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_0002
2025-10-05 17:40:22.182 | DEBUG    | core.dst.state_store:_load_from_memory:121 - 内存中不存在会话: integration_test_0002, 返回新状态
2025-10-05 17:40:22.182 | INFO     | core.dst.dialog_state_tracker:track:59 - 意图改变: None → chat
2025-10-05 17:40:22.182 | DEBUG    | core.dst.slot_manager:fill_slots:61 - 不同领域，仅保留用户信息: []
2025-10-05 17:40:22.182 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_0002
2025-10-05 17:40:22.182 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=1, 需要澄清=False
2025-10-05 17:40:22.182 | INFO     | executor.db_executor:execute_function:29 - 执行Function: chat, 参数: {}
2025-10-05 17:40:22.182 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_0002
2025-10-05 17:40:22.183 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_0002] 对话完成 | 意图: chat | 轮次: 2 | 耗时: 3296ms
2025-10-05 17:41:39.986 | INFO     | database.db_manager:_initialize:38 - 数据库连接初始化成功
2025-10-05 17:41:39.986 | ERROR    | database.redis_manager:_initialize:45 - Redis连接池初始化失败: 'Settings' object has no attribute 'get'
2025-10-05 17:41:40.205 | INFO     | core.nlu.nlu_engine:__init__:50 - ✓ NLU引擎初始化成功: DeepSeek (deepseek-chat)
2025-10-05 17:41:40.205 | ERROR    | core.dst.state_store:__init__:28 - Redis初始化失败: Redis连接池未初始化, 使用内存存储
2025-10-05 17:41:40.205 | INFO     | core.dst.dialog_state_tracker:__init__:27 - 对话状态跟踪器初始化完成
2025-10-05 17:41:40.205 | INFO     | executor.db_executor:__init__:16 - 数据库执行器初始化完成
2025-10-05 17:41:40.205 | INFO     | core.chatbot_dst:__init__:23 - 第二阶段对话系统初始化完成（含DST支持）
2025-10-05 17:41:40.206 | INFO     | core.chatbot_dst:chat:46 - [integration_test_0002] 收到用户输入: 查下我的套餐
2025-10-05 17:41:40.206 | INFO     | core.nlu.nlu_engine:understand:80 - [integration_test_0002] 开始NLU理解: 查下我的套餐
2025-10-05 17:41:40.206 | DEBUG    | core.nlu.nlu_engine:understand:85 - [integration_test_0002] 预处理后: 查下我的套餐
2025-10-05 17:41:43.276 | INFO     | core.nlu.nlu_engine:understand:110 - [integration_test_0002] NLU完成: intent=chat
2025-10-05 17:41:43.276 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_0002
2025-10-05 17:41:43.276 | DEBUG    | core.dst.state_store:_load_from_memory:121 - 内存中不存在会话: integration_test_0002, 返回新状态
2025-10-05 17:41:43.276 | INFO     | core.dst.dialog_state_tracker:track:59 - 意图改变: None → chat
2025-10-05 17:41:43.277 | DEBUG    | core.dst.slot_manager:fill_slots:61 - 不同领域，仅保留用户信息: []
2025-10-05 17:41:43.277 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_0002
2025-10-05 17:41:43.277 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=1, 需要澄清=False
2025-10-05 17:41:43.277 | INFO     | executor.db_executor:execute_function:29 - 执行Function: chat, 参数: {}
2025-10-05 17:41:43.277 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_0002
2025-10-05 17:41:43.277 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_0002] 对话完成 | 意图: chat | 轮次: 2 | 耗时: 3072ms
2025-10-05 17:46:58.834 | INFO     | database.db_manager:_initialize:38 - 数据库连接初始化成功
2025-10-05 17:46:58.835 | ERROR    | database.redis_manager:_initialize:45 - Redis连接池初始化失败: 'Settings' object has no attribute 'get'
2025-10-05 17:46:59.876 | INFO     | core.nlu.nlu_engine:__init__:50 - ✓ NLU引擎初始化成功: DeepSeek (deepseek-chat)
2025-10-05 17:46:59.876 | ERROR    | core.dst.state_store:__init__:28 - Redis初始化失败: Redis连接池未初始化, 使用内存存储
2025-10-05 17:46:59.876 | INFO     | core.dst.dialog_state_tracker:__init__:27 - 对话状态跟踪器初始化完成
2025-10-05 17:46:59.876 | INFO     | executor.db_executor:__init__:16 - 数据库执行器初始化完成
2025-10-05 17:46:59.876 | INFO     | core.chatbot_dst:__init__:23 - 第二阶段对话系统初始化完成（含DST支持）
2025-10-05 17:47:02.130 | INFO     | core.chatbot_dst:chat:46 - [integration_test_0002] 收到用户输入: 查下我的套餐
2025-10-05 17:47:03.086 | INFO     | core.nlu.nlu_engine:understand:80 - [integration_test_0002] 开始NLU理解: 查下我的套餐
2025-10-05 17:47:03.086 | DEBUG    | core.nlu.nlu_engine:understand:85 - [integration_test_0002] 预处理后: 查下我的套餐
2025-10-05 17:51:02.001 | INFO     | database.db_manager:_initialize:38 - 数据库连接初始化成功
2025-10-05 17:51:02.001 | ERROR    | database.redis_manager:_initialize:45 - Redis连接池初始化失败: 'Settings' object has no attribute 'get'
2025-10-05 17:51:02.989 | INFO     | core.nlu.nlu_engine:__init__:50 - ✓ NLU引擎初始化成功: DeepSeek (deepseek-chat)
2025-10-05 17:51:02.989 | ERROR    | core.dst.state_store:__init__:28 - Redis初始化失败: Redis连接池未初始化, 使用内存存储
2025-10-05 17:51:02.989 | INFO     | core.dst.dialog_state_tracker:__init__:27 - 对话状态跟踪器初始化完成
2025-10-05 17:51:02.989 | INFO     | executor.db_executor:__init__:16 - 数据库执行器初始化完成
2025-10-05 17:51:02.989 | INFO     | core.chatbot_dst:__init__:23 - 第二阶段对话系统初始化完成（含DST支持）
2025-10-05 17:51:05.247 | INFO     | core.chatbot_dst:chat:46 - [integration_test_0002] 收到用户输入: 查下我的套餐
2025-10-05 17:51:05.965 | INFO     | core.nlu.nlu_engine:understand:80 - [integration_test_0002] 开始NLU理解: 查下我的套餐
2025-10-05 17:51:05.965 | DEBUG    | core.nlu.nlu_engine:understand:85 - [integration_test_0002] 预处理后: 查下我的套餐
2025-10-05 17:54:02.807 | INFO     | database.db_manager:_initialize:38 - 数据库连接初始化成功
2025-10-05 17:54:02.808 | ERROR    | database.redis_manager:_initialize:45 - Redis连接池初始化失败: 'Settings' object has no attribute 'get'
2025-10-05 17:54:03.784 | INFO     | core.nlu.nlu_engine:__init__:50 - ✓ NLU引擎初始化成功: DeepSeek (deepseek-chat)
2025-10-05 17:54:03.784 | ERROR    | core.dst.state_store:__init__:28 - Redis初始化失败: Redis连接池未初始化, 使用内存存储
2025-10-05 17:54:03.784 | INFO     | core.dst.dialog_state_tracker:__init__:27 - 对话状态跟踪器初始化完成
2025-10-05 17:54:03.784 | INFO     | executor.db_executor:__init__:16 - 数据库执行器初始化完成
2025-10-05 17:54:03.784 | INFO     | core.chatbot_dst:__init__:23 - 第二阶段对话系统初始化完成（含DST支持）
2025-10-05 17:54:05.937 | INFO     | core.chatbot_dst:chat:46 - [integration_test_0002] 收到用户输入: 查下我的套餐
2025-10-05 17:54:06.725 | INFO     | core.nlu.nlu_engine:understand:80 - [integration_test_0002] 开始NLU理解: 查下我的套餐
2025-10-05 17:54:06.725 | DEBUG    | core.nlu.nlu_engine:understand:85 - [integration_test_0002] 预处理后: 查下我的套餐
2025-10-05 17:54:10.274 | ERROR    | core.nlu.nlu_engine:understand:114 - [integration_test_0002] NLU异常: Error code: 400 - {'error': {'message': "An assistant message with 'tool_calls' must be followed by tool messages responding to each 'tool_call_id'. (insufficient tool messages following tool_calls message)", 'type': 'invalid_request_error', 'param': None, 'code': 'invalid_request_error'}}
2025-10-05 17:55:03.168 | INFO     | database.db_manager:_initialize:38 - 数据库连接初始化成功
2025-10-05 17:55:03.169 | ERROR    | database.redis_manager:_initialize:45 - Redis连接池初始化失败: 'Settings' object has no attribute 'get'
2025-10-05 17:55:04.142 | INFO     | core.nlu.nlu_engine:__init__:50 - ✓ NLU引擎初始化成功: DeepSeek (deepseek-chat)
2025-10-05 17:55:04.143 | ERROR    | core.dst.state_store:__init__:28 - Redis初始化失败: Redis连接池未初始化, 使用内存存储
2025-10-05 17:55:04.143 | INFO     | core.dst.dialog_state_tracker:__init__:27 - 对话状态跟踪器初始化完成
2025-10-05 17:55:04.143 | INFO     | executor.db_executor:__init__:16 - 数据库执行器初始化完成
2025-10-05 17:55:04.143 | INFO     | core.chatbot_dst:__init__:23 - 第二阶段对话系统初始化完成（含DST支持）
2025-10-05 17:55:06.134 | INFO     | core.chatbot_dst:chat:46 - [integration_test_0002] 收到用户输入: 查下我的套餐
2025-10-05 17:55:06.874 | INFO     | core.nlu.nlu_engine:understand:80 - [integration_test_0002] 开始NLU理解: 查下我的套餐
2025-10-05 17:55:06.874 | DEBUG    | core.nlu.nlu_engine:understand:85 - [integration_test_0002] 预处理后: 查下我的套餐
2025-10-05 17:55:10.645 | ERROR    | core.nlu.nlu_engine:understand:114 - [integration_test_0002] NLU异常: Error code: 400 - {'error': {'message': "An assistant message with 'tool_calls' must be followed by tool messages responding to each 'tool_call_id'. (insufficient tool messages following tool_calls message)", 'type': 'invalid_request_error', 'param': None, 'code': 'invalid_request_error'}}
2025-10-05 17:55:15.473 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_0002
2025-10-05 17:55:15.474 | DEBUG    | core.dst.state_store:_load_from_memory:121 - 内存中不存在会话: integration_test_0002, 返回新状态
2025-10-05 17:55:15.474 | INFO     | core.dst.dialog_state_tracker:track:59 - 意图改变: None → error
2025-10-05 17:55:15.474 | DEBUG    | core.dst.slot_manager:fill_slots:61 - 不同领域，仅保留用户信息: []
2025-10-05 17:55:19.437 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_0002
2025-10-05 17:55:19.438 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=1, 需要澄清=False
2025-10-05 17:55:21.640 | INFO     | executor.db_executor:execute_function:29 - 执行Function: error, 参数: {}
2025-10-05 17:55:23.857 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_0002
2025-10-05 17:55:23.858 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_0002] 对话完成 | 意图: error | 轮次: 2 | 耗时: 17723ms
2025-10-05 18:12:24.187 | INFO     | database.db_manager:_initialize:38 - 数据库连接初始化成功
2025-10-05 18:12:24.188 | ERROR    | database.redis_manager:_initialize:45 - Redis连接池初始化失败: 'Settings' object has no attribute 'get'
2025-10-05 18:12:25.209 | INFO     | core.nlu.nlu_engine:__init__:50 - ✓ NLU引擎初始化成功: DeepSeek (deepseek-chat)
2025-10-05 18:12:25.210 | ERROR    | core.dst.state_store:__init__:28 - Redis初始化失败: Redis连接池未初始化, 使用内存存储
2025-10-05 18:12:25.210 | INFO     | core.dst.dialog_state_tracker:__init__:27 - 对话状态跟踪器初始化完成
2025-10-05 18:12:25.210 | INFO     | executor.db_executor:__init__:16 - 数据库执行器初始化完成
2025-10-05 18:12:25.210 | INFO     | core.chatbot_dst:__init__:23 - 第二阶段对话系统初始化完成（含DST支持）
2025-10-05 18:12:27.803 | INFO     | core.chatbot_dst:chat:46 - [integration_test_0002] 收到用户输入: 查下我的套餐
2025-10-05 18:12:29.706 | INFO     | core.nlu.nlu_engine:understand:80 - [integration_test_0002] 开始NLU理解: 查下我的套餐
2025-10-05 18:12:29.708 | DEBUG    | core.nlu.nlu_engine:understand:85 - [integration_test_0002] 预处理后: 查下我的套餐
2025-10-05 18:12:53.967 | INFO     | core.nlu.nlu_engine:understand:110 - [integration_test_0002] NLU完成: intent=chat
2025-10-05 18:12:56.061 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_0002
2025-10-05 18:12:56.062 | DEBUG    | core.dst.state_store:_load_from_memory:121 - 内存中不存在会话: integration_test_0002, 返回新状态
2025-10-05 18:12:56.062 | INFO     | core.dst.dialog_state_tracker:track:59 - 意图改变: None → chat
2025-10-05 18:12:56.062 | DEBUG    | core.dst.slot_manager:fill_slots:61 - 不同领域，仅保留用户信息: []
2025-10-05 18:13:00.156 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_0002
2025-10-05 18:13:00.158 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=1, 需要澄清=False
2025-10-05 18:13:04.777 | INFO     | executor.db_executor:execute_function:29 - 执行Function: chat, 参数: {}
2025-10-05 18:13:04.778 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_0002
2025-10-05 18:13:04.778 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_0002] 对话完成 | 意图: chat | 轮次: 2 | 耗时: 36975ms
2025-10-05 18:18:52.388 | INFO     | database.db_manager:_initialize:38 - 数据库连接初始化成功
2025-10-05 18:18:52.389 | ERROR    | database.redis_manager:_initialize:45 - Redis连接池初始化失败: 'Settings' object has no attribute 'get'
2025-10-05 18:18:53.365 | INFO     | core.nlu.nlu_engine:__init__:50 - ✓ NLU引擎初始化成功: DeepSeek (deepseek-chat)
2025-10-05 18:18:53.366 | ERROR    | core.dst.state_store:__init__:28 - Redis初始化失败: Redis连接池未初始化, 使用内存存储
2025-10-05 18:18:53.366 | INFO     | core.dst.dialog_state_tracker:__init__:27 - 对话状态跟踪器初始化完成
2025-10-05 18:18:53.366 | INFO     | executor.db_executor:__init__:16 - 数据库执行器初始化完成
2025-10-05 18:18:53.366 | INFO     | core.chatbot_dst:__init__:23 - 第二阶段对话系统初始化完成（含DST支持）
2025-10-05 18:18:53.367 | INFO     | core.chatbot_dst:chat:46 - [integration_test_0002] 收到用户输入: 查下我的套餐
2025-10-05 18:18:53.367 | INFO     | core.nlu.nlu_engine:understand:80 - [integration_test_0002] 开始NLU理解: 查下我的套餐
2025-10-05 18:18:53.367 | DEBUG    | core.nlu.nlu_engine:understand:85 - [integration_test_0002] 预处理后: 查下我的套餐
2025-10-05 18:18:57.071 | INFO     | core.nlu.nlu_engine:understand:110 - [integration_test_0002] NLU完成: intent=chat
2025-10-05 18:18:57.071 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_0002
2025-10-05 18:18:57.071 | DEBUG    | core.dst.state_store:_load_from_memory:121 - 内存中不存在会话: integration_test_0002, 返回新状态
2025-10-05 18:18:57.071 | INFO     | core.dst.dialog_state_tracker:track:59 - 意图改变: None → chat
2025-10-05 18:18:57.071 | DEBUG    | core.dst.slot_manager:fill_slots:61 - 不同领域，仅保留用户信息: []
2025-10-05 18:18:57.071 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_0002
2025-10-05 18:18:57.071 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=1, 需要澄清=False
2025-10-05 18:18:57.072 | INFO     | executor.db_executor:execute_function:29 - 执行Function: chat, 参数: {}
2025-10-05 18:18:57.072 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_0002
2025-10-05 18:18:57.072 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_0002] 对话完成 | 意图: chat | 轮次: 2 | 耗时: 3705ms
2025-10-05 18:20:06.540 | INFO     | database.db_manager:_initialize:38 - 数据库连接初始化成功
2025-10-05 18:20:06.540 | ERROR    | database.redis_manager:_initialize:45 - Redis连接池初始化失败: 'Settings' object has no attribute 'get'
2025-10-05 18:20:07.517 | INFO     | core.nlu.nlu_engine:__init__:50 - ✓ NLU引擎初始化成功: DeepSeek (deepseek-chat)
2025-10-05 18:20:07.518 | ERROR    | core.dst.state_store:__init__:28 - Redis初始化失败: Redis连接池未初始化, 使用内存存储
2025-10-05 18:20:07.518 | INFO     | core.dst.dialog_state_tracker:__init__:27 - 对话状态跟踪器初始化完成
2025-10-05 18:20:07.518 | INFO     | executor.db_executor:__init__:16 - 数据库执行器初始化完成
2025-10-05 18:20:07.518 | INFO     | core.chatbot_dst:__init__:23 - 第二阶段对话系统初始化完成（含DST支持）
2025-10-05 18:20:07.519 | INFO     | core.chatbot_dst:chat:46 - [integration_test_0002] 收到用户输入: 查下我的套餐
2025-10-05 18:20:07.519 | INFO     | core.nlu.nlu_engine:understand:80 - [integration_test_0002] 开始NLU理解: 查下我的套餐
2025-10-05 18:20:07.519 | DEBUG    | core.nlu.nlu_engine:understand:85 - [integration_test_0002] 预处理后: 查下我的套餐
2025-10-05 18:20:10.649 | INFO     | core.nlu.nlu_engine:understand:110 - [integration_test_0002] NLU完成: intent=query_current_package
2025-10-05 18:20:10.649 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_0002
2025-10-05 18:20:10.649 | DEBUG    | core.dst.state_store:_load_from_memory:121 - 内存中不存在会话: integration_test_0002, 返回新状态
2025-10-05 18:20:10.650 | INFO     | core.dst.dialog_state_tracker:track:59 - 意图改变: None → query_current_package
2025-10-05 18:20:10.650 | DEBUG    | core.dst.slot_manager:fill_slots:61 - 不同领域，仅保留用户信息: []
2025-10-05 18:20:10.650 | INFO     | core.dst.slot_manager:validate_slots:103 - 缺失槽位: ['phone']
2025-10-05 18:20:10.650 | INFO     | core.dst.dialog_state_tracker:_validate_slots:134 - 缺失必填槽位: ['phone']
2025-10-05 18:20:10.650 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_0002
2025-10-05 18:20:10.650 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=1, 需要澄清=True
2025-10-05 18:20:10.650 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_0002] 对话完成 | 意图: query_current_package | 轮次: 1 | 耗时: 3131ms
2025-10-05 18:20:10.650 | INFO     | core.chatbot_dst:chat:46 - [integration_test_0002] 收到用户输入: 13800138000
2025-10-05 18:20:10.650 | INFO     | core.nlu.nlu_engine:understand:80 - [integration_test_0002] 开始NLU理解: 13800138000
2025-10-05 18:20:10.650 | DEBUG    | core.nlu.nlu_engine:understand:85 - [integration_test_0002] 预处理后: 13800138000
2025-10-05 18:20:13.251 | INFO     | core.nlu.nlu_engine:understand:110 - [integration_test_0002] NLU完成: intent=query_current_package
2025-10-05 18:20:13.252 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_0002
2025-10-05 18:20:13.252 | DEBUG    | core.dst.state_store:_load_from_memory:118 - 从内存加载状态: integration_test_0002
2025-10-05 18:20:13.252 | DEBUG    | core.dst.slot_manager:fill_slots:43 - 意图不变，合并槽位: ['phone']
2025-10-05 18:20:13.253 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_0002
2025-10-05 18:20:13.253 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=2, 需要澄清=False
2025-10-05 18:20:13.253 | INFO     | executor.db_executor:execute_function:29 - 执行Function: query_current_package, 参数: {'phone': '13800138000'}
2025-10-05 18:20:13.374 | INFO     | executor.db_executor:execute_function:50 - Function执行成功: query_current_package
2025-10-05 18:20:13.375 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_0002
2025-10-05 18:20:13.375 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_0002] 对话完成 | 意图: query_current_package | 轮次: 3 | 耗时: 2725ms
2025-10-05 18:20:13.375 | INFO     | core.chatbot_dst:chat:46 - [integration_test_0002] 收到用户输入: 我用了多少流量
2025-10-05 18:20:13.376 | INFO     | core.nlu.nlu_engine:understand:80 - [integration_test_0002] 开始NLU理解: 我用了多少流量
2025-10-05 18:20:13.376 | DEBUG    | core.nlu.nlu_engine:understand:85 - [integration_test_0002] 预处理后: 我用了多少流量
2025-10-05 18:20:16.407 | INFO     | core.nlu.nlu_engine:understand:110 - [integration_test_0002] NLU完成: intent=query_current_package
2025-10-05 18:20:16.408 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_0002
2025-10-05 18:20:16.408 | DEBUG    | core.dst.state_store:_load_from_memory:118 - 从内存加载状态: integration_test_0002
2025-10-05 18:20:16.408 | DEBUG    | core.dst.slot_manager:fill_slots:43 - 意图不变，合并槽位: ['phone']
2025-10-05 18:20:16.408 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_0002
2025-10-05 18:20:16.408 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=4, 需要澄清=False
2025-10-05 18:20:16.409 | INFO     | executor.db_executor:execute_function:29 - 执行Function: query_current_package, 参数: {'phone': '13800138000'}
2025-10-05 18:20:16.416 | INFO     | executor.db_executor:execute_function:50 - Function执行成功: query_current_package
2025-10-05 18:20:16.417 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_0002
2025-10-05 18:20:16.417 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_0002] 对话完成 | 意图: query_current_package | 轮次: 5 | 耗时: 3042ms
2025-10-05 18:23:49.843 | INFO     | database.db_manager:_initialize:38 - 数据库连接初始化成功
2025-10-05 18:23:49.843 | ERROR    | database.redis_manager:_initialize:45 - Redis连接池初始化失败: 'Settings' object has no attribute 'get'
2025-10-05 18:23:50.080 | INFO     | core.nlu.nlu_engine:__init__:50 - ✓ NLU引擎初始化成功: DeepSeek (deepseek-chat)
2025-10-05 18:23:50.080 | ERROR    | core.dst.state_store:__init__:28 - Redis初始化失败: Redis连接池未初始化, 使用内存存储
2025-10-05 18:23:50.080 | INFO     | core.dst.dialog_state_tracker:__init__:27 - 对话状态跟踪器初始化完成
2025-10-05 18:23:50.080 | INFO     | executor.db_executor:__init__:16 - 数据库执行器初始化完成
2025-10-05 18:23:50.080 | INFO     | core.chatbot_dst:__init__:23 - 第二阶段对话系统初始化完成（含DST支持）
2025-10-05 18:23:50.081 | INFO     | core.chatbot_dst:chat:46 - [integration_test_0002] 收到用户输入: 查下我的套餐
2025-10-05 18:23:50.081 | INFO     | core.nlu.nlu_engine:understand:80 - [integration_test_0002] 开始NLU理解: 查下我的套餐
2025-10-05 18:23:50.081 | DEBUG    | core.nlu.nlu_engine:understand:85 - [integration_test_0002] 预处理后: 查下我的套餐
2025-10-05 18:23:52.808 | INFO     | core.nlu.nlu_engine:understand:110 - [integration_test_0002] NLU完成: intent=chat
2025-10-05 18:23:52.809 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_0002
2025-10-05 18:23:52.809 | DEBUG    | core.dst.state_store:_load_from_memory:121 - 内存中不存在会话: integration_test_0002, 返回新状态
2025-10-05 18:23:52.809 | INFO     | core.dst.dialog_state_tracker:track:59 - 意图改变: None → chat
2025-10-05 18:23:52.809 | DEBUG    | core.dst.slot_manager:fill_slots:61 - 不同领域，仅保留用户信息: []
2025-10-05 18:23:52.809 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_0002
2025-10-05 18:23:52.809 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=1, 需要澄清=False
2025-10-05 18:23:52.809 | INFO     | executor.db_executor:execute_function:29 - 执行Function: chat, 参数: {}
2025-10-05 18:23:52.809 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_0002
2025-10-05 18:23:52.810 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_0002] 对话完成 | 意图: chat | 轮次: 2 | 耗时: 2729ms
2025-10-05 18:25:13.784 | INFO     | database.db_manager:_initialize:38 - 数据库连接初始化成功
2025-10-05 18:25:13.785 | ERROR    | database.redis_manager:_initialize:45 - Redis连接池初始化失败: 'Settings' object has no attribute 'get'
2025-10-05 18:25:14.763 | INFO     | core.nlu.nlu_engine:__init__:50 - ✓ NLU引擎初始化成功: DeepSeek (deepseek-chat)
2025-10-05 18:25:14.763 | ERROR    | core.dst.state_store:__init__:28 - Redis初始化失败: Redis连接池未初始化, 使用内存存储
2025-10-05 18:25:14.764 | INFO     | core.dst.dialog_state_tracker:__init__:27 - 对话状态跟踪器初始化完成
2025-10-05 18:25:14.764 | INFO     | executor.db_executor:__init__:16 - 数据库执行器初始化完成
2025-10-05 18:25:14.764 | INFO     | core.chatbot_dst:__init__:23 - 第二阶段对话系统初始化完成（含DST支持）
2025-10-05 18:25:14.765 | INFO     | core.chatbot_dst:chat:46 - [integration_test_0002] 收到用户输入: 查下我的套餐
2025-10-05 18:25:14.765 | INFO     | core.nlu.nlu_engine:understand:80 - [integration_test_0002] 开始NLU理解: 查下我的套餐
2025-10-05 18:25:14.765 | DEBUG    | core.nlu.nlu_engine:understand:85 - [integration_test_0002] 预处理后: 查下我的套餐
2025-10-05 18:25:18.561 | INFO     | core.nlu.nlu_engine:understand:110 - [integration_test_0002] NLU完成: intent=chat
2025-10-05 18:25:18.561 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_0002
2025-10-05 18:25:18.561 | DEBUG    | core.dst.state_store:_load_from_memory:121 - 内存中不存在会话: integration_test_0002, 返回新状态
2025-10-05 18:25:18.561 | INFO     | core.dst.dialog_state_tracker:track:59 - 意图改变: None → chat
2025-10-05 18:25:18.561 | DEBUG    | core.dst.slot_manager:fill_slots:61 - 不同领域，仅保留用户信息: []
2025-10-05 18:25:18.561 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_0002
2025-10-05 18:25:18.561 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=1, 需要澄清=False
2025-10-05 18:25:18.562 | INFO     | executor.db_executor:execute_function:29 - 执行Function: chat, 参数: {}
2025-10-05 18:25:18.562 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_0002
2025-10-05 18:25:18.562 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_0002] 对话完成 | 意图: chat | 轮次: 2 | 耗时: 3797ms
2025-10-05 18:26:51.428 | INFO     | database.db_manager:_initialize:38 - 数据库连接初始化成功
2025-10-05 18:26:51.428 | ERROR    | database.redis_manager:_initialize:45 - Redis连接池初始化失败: 'Settings' object has no attribute 'get'
2025-10-05 18:26:52.442 | INFO     | core.nlu.nlu_engine:__init__:50 - ✓ NLU引擎初始化成功: DeepSeek (deepseek-chat)
2025-10-05 18:26:52.442 | ERROR    | core.dst.state_store:__init__:28 - Redis初始化失败: Redis连接池未初始化, 使用内存存储
2025-10-05 18:26:52.442 | INFO     | core.dst.dialog_state_tracker:__init__:27 - 对话状态跟踪器初始化完成
2025-10-05 18:26:52.442 | INFO     | executor.db_executor:__init__:16 - 数据库执行器初始化完成
2025-10-05 18:26:52.442 | INFO     | core.chatbot_dst:__init__:23 - 第二阶段对话系统初始化完成（含DST支持）
2025-10-05 18:26:52.443 | INFO     | core.chatbot_dst:chat:46 - [integration_test_003] 收到用户输入: 100元以内的套餐
2025-10-05 18:26:52.443 | INFO     | core.nlu.nlu_engine:understand:80 - [integration_test_003] 开始NLU理解: 100元以内的套餐
2025-10-05 18:26:52.444 | DEBUG    | core.nlu.nlu_engine:understand:85 - [integration_test_003] 预处理后: 100元以内的套餐
2025-10-05 18:27:09.321 | INFO     | core.nlu.nlu_engine:understand:110 - [integration_test_003] NLU完成: intent=query_packages
2025-10-05 18:27:18.171 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_003
2025-10-05 18:27:18.171 | DEBUG    | core.dst.state_store:_load_from_memory:121 - 内存中不存在会话: integration_test_003, 返回新状态
2025-10-05 18:27:18.172 | INFO     | core.dst.dialog_state_tracker:track:59 - 意图改变: None → query_packages
2025-10-05 18:27:18.172 | DEBUG    | core.dst.slot_manager:fill_slots:61 - 不同领域，仅保留用户信息: []
2025-10-05 18:27:32.873 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_003
2025-10-05 18:27:32.874 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=1, 需要澄清=False
2025-10-05 18:27:46.891 | INFO     | executor.db_executor:execute_function:29 - 执行Function: query_packages, 参数: {'price_max': 100, 'sort_by': 'price_asc'}
2025-10-05 18:28:02.085 | INFO     | executor.db_executor:execute_function:50 - Function执行成功: query_packages
2025-10-05 18:28:09.861 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_003
2025-10-05 18:28:09.862 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_003] 对话完成 | 意图: query_packages | 轮次: 2 | 耗时: 77419ms
2025-10-05 18:28:29.942 | INFO     | core.chatbot_dst:chat:46 - [integration_test_003] 收到用户输入: 我要办理套餐
2025-10-05 18:28:29.945 | INFO     | core.nlu.nlu_engine:understand:80 - [integration_test_003] 开始NLU理解: 我要办理套餐
2025-10-05 18:28:29.946 | DEBUG    | core.nlu.nlu_engine:understand:85 - [integration_test_003] 预处理后: 我要办理套餐
2025-10-05 18:28:32.654 | INFO     | core.nlu.nlu_engine:understand:110 - [integration_test_003] NLU完成: intent=query_packages
2025-10-05 18:28:32.655 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_003
2025-10-05 18:28:32.656 | DEBUG    | core.dst.state_store:_load_from_memory:118 - 从内存加载状态: integration_test_003
2025-10-05 18:28:32.657 | DEBUG    | core.dst.slot_manager:fill_slots:43 - 意图不变，合并槽位: ['price_max']
2025-10-05 18:28:32.657 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_003
2025-10-05 18:28:32.657 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=3, 需要澄清=False
2025-10-05 18:28:32.658 | INFO     | executor.db_executor:execute_function:29 - 执行Function: query_packages, 参数: {'price_max': 100, 'sort_by': 'price_asc'}
2025-10-05 18:28:32.674 | INFO     | executor.db_executor:execute_function:50 - Function执行成功: query_packages
2025-10-05 18:28:32.675 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_003
2025-10-05 18:28:32.676 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_003] 对话完成 | 意图: query_packages | 轮次: 4 | 耗时: 2733ms
2025-10-05 18:36:18.949 | INFO     | database.db_manager:_initialize:38 - 数据库连接初始化成功
2025-10-05 18:36:18.950 | ERROR    | database.redis_manager:_initialize:45 - Redis连接池初始化失败: 'Settings' object has no attribute 'get'
2025-10-05 18:36:19.187 | INFO     | core.nlu.nlu_engine:__init__:50 - ✓ NLU引擎初始化成功: DeepSeek (deepseek-chat)
2025-10-05 18:36:19.187 | ERROR    | core.dst.state_store:__init__:28 - Redis初始化失败: Redis连接池未初始化, 使用内存存储
2025-10-05 18:36:19.187 | INFO     | core.dst.dialog_state_tracker:__init__:27 - 对话状态跟踪器初始化完成
2025-10-05 18:36:19.187 | INFO     | executor.db_executor:__init__:16 - 数据库执行器初始化完成
2025-10-05 18:36:19.187 | INFO     | core.chatbot_dst:__init__:23 - 第二阶段对话系统初始化完成（含DST支持）
2025-10-05 18:36:19.188 | INFO     | core.chatbot_dst:chat:46 - [integration_test_003] 收到用户输入: 100元以内的套餐
2025-10-05 18:36:19.188 | INFO     | core.nlu.nlu_engine:understand:80 - [integration_test_003] 开始NLU理解: 100元以内的套餐
2025-10-05 18:36:19.188 | DEBUG    | core.nlu.nlu_engine:understand:85 - [integration_test_003] 预处理后: 100元以内的套餐
2025-10-05 18:36:22.474 | INFO     | core.nlu.nlu_engine:understand:110 - [integration_test_003] NLU完成: intent=query_packages
2025-10-05 18:36:22.474 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_003
2025-10-05 18:36:22.474 | DEBUG    | core.dst.state_store:_load_from_memory:121 - 内存中不存在会话: integration_test_003, 返回新状态
2025-10-05 18:36:22.474 | INFO     | core.dst.dialog_state_tracker:track:59 - 意图改变: None → query_packages
2025-10-05 18:36:22.474 | DEBUG    | core.dst.slot_manager:fill_slots:61 - 不同领域，仅保留用户信息: []
2025-10-05 18:36:22.474 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_003
2025-10-05 18:36:22.474 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=1, 需要澄清=False
2025-10-05 18:36:22.474 | INFO     | executor.db_executor:execute_function:29 - 执行Function: query_packages, 参数: {'price_max': 100}
2025-10-05 18:36:22.548 | INFO     | executor.db_executor:execute_function:50 - Function执行成功: query_packages
2025-10-05 18:36:22.548 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_003
2025-10-05 18:36:22.549 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_003] 对话完成 | 意图: query_packages | 轮次: 2 | 耗时: 3361ms
2025-10-05 18:36:22.549 | INFO     | core.chatbot_dst:chat:46 - [integration_test_003] 收到用户输入: 我用了多少流量
2025-10-05 18:36:22.549 | INFO     | core.nlu.nlu_engine:understand:80 - [integration_test_003] 开始NLU理解: 我用了多少流量
2025-10-05 18:36:22.549 | DEBUG    | core.nlu.nlu_engine:understand:85 - [integration_test_003] 预处理后: 我用了多少流量
2025-10-05 18:36:25.529 | INFO     | core.nlu.nlu_engine:understand:110 - [integration_test_003] NLU完成: intent=query_packages
2025-10-05 18:36:25.530 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_003
2025-10-05 18:36:25.530 | DEBUG    | core.dst.state_store:_load_from_memory:118 - 从内存加载状态: integration_test_003
2025-10-05 18:36:25.530 | DEBUG    | core.dst.slot_manager:fill_slots:43 - 意图不变，合并槽位: ['price_max']
2025-10-05 18:36:25.530 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_003
2025-10-05 18:36:25.530 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=3, 需要澄清=False
2025-10-05 18:36:25.530 | INFO     | executor.db_executor:execute_function:29 - 执行Function: query_packages, 参数: {'price_max': 100}
2025-10-05 18:36:25.537 | INFO     | executor.db_executor:execute_function:50 - Function执行成功: query_packages
2025-10-05 18:36:25.538 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_003
2025-10-05 18:36:25.538 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_003] 对话完成 | 意图: query_packages | 轮次: 4 | 耗时: 2989ms
2025-10-05 19:28:43.108 | INFO     | database.db_manager:_initialize:38 - 数据库连接初始化成功
2025-10-05 19:28:43.109 | ERROR    | database.redis_manager:_initialize:45 - Redis连接池初始化失败: 'Settings' object has no attribute 'get'
2025-10-05 19:28:43.348 | INFO     | core.nlu.nlu_engine:__init__:50 - ✓ NLU引擎初始化成功: DeepSeek (deepseek-chat)
2025-10-05 19:28:43.348 | ERROR    | core.dst.state_store:__init__:28 - Redis初始化失败: Redis连接池未初始化, 使用内存存储
2025-10-05 19:28:43.348 | INFO     | core.dst.dialog_state_tracker:__init__:27 - 对话状态跟踪器初始化完成
2025-10-05 19:28:43.348 | INFO     | executor.db_executor:__init__:16 - 数据库执行器初始化完成
2025-10-05 19:28:43.348 | INFO     | core.chatbot_dst:__init__:23 - 第二阶段对话系统初始化完成（含DST支持）
2025-10-05 19:28:43.349 | INFO     | core.chatbot_dst:chat:46 - [integration_test_003] 收到用户输入: 100元以内的套餐
2025-10-05 19:28:43.349 | INFO     | core.nlu.nlu_engine:understand:80 - [integration_test_003] 开始NLU理解: 100元以内的套餐
2025-10-05 19:28:43.349 | DEBUG    | core.nlu.nlu_engine:understand:85 - [integration_test_003] 预处理后: 100元以内的套餐
2025-10-05 19:28:46.403 | INFO     | core.nlu.nlu_engine:understand:110 - [integration_test_003] NLU完成: intent=query_packages
2025-10-05 19:28:46.403 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_003
2025-10-05 19:28:46.404 | DEBUG    | core.dst.state_store:_load_from_memory:121 - 内存中不存在会话: integration_test_003, 返回新状态
2025-10-05 19:28:46.404 | INFO     | core.dst.dialog_state_tracker:track:59 - 意图改变: None → query_packages
2025-10-05 19:28:46.404 | DEBUG    | core.dst.slot_manager:fill_slots:61 - 不同领域，仅保留用户信息: []
2025-10-05 19:28:46.404 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_003
2025-10-05 19:28:46.404 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=1, 需要澄清=False
2025-10-05 19:28:46.404 | INFO     | executor.db_executor:execute_function:29 - 执行Function: query_packages, 参数: {'price_max': 100, 'sort_by': 'price_asc'}
2025-10-05 19:28:46.499 | INFO     | executor.db_executor:execute_function:50 - Function执行成功: query_packages
2025-10-05 19:28:46.500 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_003
2025-10-05 19:28:46.500 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_003] 对话完成 | 意图: query_packages | 轮次: 2 | 耗时: 3151ms
2025-10-05 19:28:46.500 | INFO     | core.chatbot_dst:chat:46 - [integration_test_003] 收到用户输入: 我用了多少流量
2025-10-05 19:28:46.500 | INFO     | core.nlu.nlu_engine:understand:80 - [integration_test_003] 开始NLU理解: 我用了多少流量
2025-10-05 19:28:46.500 | DEBUG    | core.nlu.nlu_engine:understand:85 - [integration_test_003] 预处理后: 我用了多少流量
2025-10-05 19:28:49.143 | INFO     | core.nlu.nlu_engine:understand:110 - [integration_test_003] NLU完成: intent=query_packages
2025-10-05 19:28:49.144 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_003
2025-10-05 19:28:49.144 | DEBUG    | core.dst.state_store:_load_from_memory:118 - 从内存加载状态: integration_test_003
2025-10-05 19:28:49.144 | DEBUG    | core.dst.slot_manager:fill_slots:43 - 意图不变，合并槽位: ['price_max']
2025-10-05 19:28:49.144 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_003
2025-10-05 19:28:49.144 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=3, 需要澄清=False
2025-10-05 19:28:49.144 | INFO     | executor.db_executor:execute_function:29 - 执行Function: query_packages, 参数: {'price_max': 100, 'sort_by': 'price_asc'}
2025-10-05 19:28:49.148 | INFO     | executor.db_executor:execute_function:50 - Function执行成功: query_packages
2025-10-05 19:28:49.148 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_003
2025-10-05 19:28:49.148 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_003] 对话完成 | 意图: query_packages | 轮次: 4 | 耗时: 2648ms
2025-10-05 19:31:58.633 | INFO     | database.db_manager:_initialize:38 - 数据库连接初始化成功
2025-10-05 19:31:58.634 | ERROR    | database.redis_manager:_initialize:45 - Redis连接池初始化失败: 'Settings' object has no attribute 'get'
2025-10-05 19:31:59.621 | INFO     | core.nlu.nlu_engine:__init__:50 - ✓ NLU引擎初始化成功: DeepSeek (deepseek-chat)
2025-10-05 19:31:59.621 | ERROR    | core.dst.state_store:__init__:28 - Redis初始化失败: Redis连接池未初始化, 使用内存存储
2025-10-05 19:31:59.621 | INFO     | core.dst.dialog_state_tracker:__init__:27 - 对话状态跟踪器初始化完成
2025-10-05 19:31:59.621 | INFO     | executor.db_executor:__init__:16 - 数据库执行器初始化完成
2025-10-05 19:31:59.621 | INFO     | core.chatbot_dst:__init__:23 - 第二阶段对话系统初始化完成（含DST支持）
2025-10-05 19:31:59.622 | INFO     | core.chatbot_dst:chat:46 - [integration_test_003] 收到用户输入: 100元以内的套餐
2025-10-05 19:31:59.622 | INFO     | core.nlu.nlu_engine:understand:80 - [integration_test_003] 开始NLU理解: 100元以内的套餐
2025-10-05 19:31:59.623 | DEBUG    | core.nlu.nlu_engine:understand:85 - [integration_test_003] 预处理后: 100元以内的套餐
2025-10-05 19:32:03.213 | INFO     | core.nlu.nlu_engine:understand:110 - [integration_test_003] NLU完成: intent=query_packages
2025-10-05 19:32:03.213 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_003
2025-10-05 19:32:03.214 | DEBUG    | core.dst.state_store:_load_from_memory:121 - 内存中不存在会话: integration_test_003, 返回新状态
2025-10-05 19:32:03.214 | INFO     | core.dst.dialog_state_tracker:track:59 - 意图改变: None → query_packages
2025-10-05 19:32:03.214 | DEBUG    | core.dst.slot_manager:fill_slots:61 - 不同领域，仅保留用户信息: []
2025-10-05 19:32:03.214 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_003
2025-10-05 19:32:03.214 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=1, 需要澄清=False
2025-10-05 19:32:03.214 | INFO     | executor.db_executor:execute_function:29 - 执行Function: query_packages, 参数: {'price_max': 100, 'sort_by': 'price_asc'}
2025-10-05 19:32:03.257 | INFO     | executor.db_executor:execute_function:50 - Function执行成功: query_packages
2025-10-05 19:32:03.257 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_003
2025-10-05 19:32:03.257 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_003] 对话完成 | 意图: query_packages | 轮次: 2 | 耗时: 3635ms
2025-10-05 19:32:03.257 | INFO     | core.chatbot_dst:chat:46 - [integration_test_003] 收到用户输入: 我用了多少流量
2025-10-05 19:32:03.257 | INFO     | core.nlu.nlu_engine:understand:80 - [integration_test_003] 开始NLU理解: 我用了多少流量
2025-10-05 19:32:03.257 | DEBUG    | core.nlu.nlu_engine:understand:85 - [integration_test_003] 预处理后: 我用了多少流量
2025-10-05 19:32:06.547 | INFO     | core.nlu.nlu_engine:understand:110 - [integration_test_003] NLU完成: intent=query_packages
2025-10-05 19:32:06.548 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_003
2025-10-05 19:32:06.548 | DEBUG    | core.dst.state_store:_load_from_memory:118 - 从内存加载状态: integration_test_003
2025-10-05 19:32:06.549 | DEBUG    | core.dst.slot_manager:fill_slots:43 - 意图不变，合并槽位: ['price_max', 'sort_by']
2025-10-05 19:32:06.549 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_003
2025-10-05 19:32:06.549 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=3, 需要澄清=False
2025-10-05 19:32:06.549 | INFO     | executor.db_executor:execute_function:29 - 执行Function: query_packages, 参数: {'price_max': 100, 'sort_by': 'price_asc'}
2025-10-05 19:32:06.556 | INFO     | executor.db_executor:execute_function:50 - Function执行成功: query_packages
2025-10-05 19:32:06.556 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_003
2025-10-05 19:32:06.557 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_003] 对话完成 | 意图: query_packages | 轮次: 4 | 耗时: 3299ms
2025-10-05 19:32:23.137 | INFO     | database.db_manager:_initialize:38 - 数据库连接初始化成功
2025-10-05 19:32:23.137 | ERROR    | database.redis_manager:_initialize:45 - Redis连接池初始化失败: 'Settings' object has no attribute 'get'
2025-10-05 19:32:24.079 | INFO     | core.nlu.nlu_engine:__init__:50 - ✓ NLU引擎初始化成功: DeepSeek (deepseek-chat)
2025-10-05 19:32:24.079 | ERROR    | core.dst.state_store:__init__:28 - Redis初始化失败: Redis连接池未初始化, 使用内存存储
2025-10-05 19:32:24.079 | INFO     | core.dst.dialog_state_tracker:__init__:27 - 对话状态跟踪器初始化完成
2025-10-05 19:32:24.080 | INFO     | executor.db_executor:__init__:16 - 数据库执行器初始化完成
2025-10-05 19:32:24.080 | INFO     | core.chatbot_dst:__init__:23 - 第二阶段对话系统初始化完成（含DST支持）
2025-10-05 19:32:29.527 | INFO     | core.chatbot_dst:chat:46 - [integration_test_003] 收到用户输入: 100元以内的套餐
2025-10-05 19:32:29.527 | INFO     | core.nlu.nlu_engine:understand:80 - [integration_test_003] 开始NLU理解: 100元以内的套餐
2025-10-05 19:32:29.527 | DEBUG    | core.nlu.nlu_engine:understand:85 - [integration_test_003] 预处理后: 100元以内的套餐
2025-10-05 19:32:33.423 | INFO     | core.nlu.nlu_engine:understand:110 - [integration_test_003] NLU完成: intent=query_packages
2025-10-05 19:32:33.423 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_003
2025-10-05 19:32:33.423 | DEBUG    | core.dst.state_store:_load_from_memory:121 - 内存中不存在会话: integration_test_003, 返回新状态
2025-10-05 19:32:33.424 | INFO     | core.dst.dialog_state_tracker:track:59 - 意图改变: None → query_packages
2025-10-05 19:32:33.424 | DEBUG    | core.dst.slot_manager:fill_slots:61 - 不同领域，仅保留用户信息: []
2025-10-05 19:32:33.424 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_003
2025-10-05 19:32:33.424 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=1, 需要澄清=False
2025-10-05 19:32:33.424 | INFO     | executor.db_executor:execute_function:29 - 执行Function: query_packages, 参数: {'price_max': 100, 'sort_by': 'price_asc'}
2025-10-05 19:32:33.466 | INFO     | executor.db_executor:execute_function:50 - Function执行成功: query_packages
2025-10-05 19:32:33.466 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_003
2025-10-05 19:32:33.466 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_003] 对话完成 | 意图: query_packages | 轮次: 2 | 耗时: 3940ms
2025-10-05 19:32:33.466 | INFO     | core.chatbot_dst:chat:46 - [integration_test_003] 收到用户输入: 我用了多少流量
2025-10-05 19:32:33.466 | INFO     | core.nlu.nlu_engine:understand:80 - [integration_test_003] 开始NLU理解: 我用了多少流量
2025-10-05 19:32:33.466 | DEBUG    | core.nlu.nlu_engine:understand:85 - [integration_test_003] 预处理后: 我用了多少流量
2025-10-05 19:32:36.320 | INFO     | core.nlu.nlu_engine:understand:110 - [integration_test_003] NLU完成: intent=query_packages
2025-10-05 19:32:36.321 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_003
2025-10-05 19:32:36.321 | DEBUG    | core.dst.state_store:_load_from_memory:118 - 从内存加载状态: integration_test_003
2025-10-05 19:32:36.321 | DEBUG    | core.dst.slot_manager:fill_slots:43 - 意图不变，合并槽位: ['price_max', 'sort_by']
2025-10-05 19:32:36.322 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_003
2025-10-05 19:32:36.322 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=3, 需要澄清=False
2025-10-05 19:32:36.322 | INFO     | executor.db_executor:execute_function:29 - 执行Function: query_packages, 参数: {'price_max': 100, 'sort_by': 'price_asc'}
2025-10-05 19:32:36.328 | INFO     | executor.db_executor:execute_function:50 - Function执行成功: query_packages
2025-10-05 19:32:36.329 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_003
2025-10-05 19:32:36.329 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_003] 对话完成 | 意图: query_packages | 轮次: 4 | 耗时: 2863ms
2025-10-05 19:34:39.723 | INFO     | database.db_manager:_initialize:38 - 数据库连接初始化成功
2025-10-05 19:34:39.724 | ERROR    | database.redis_manager:_initialize:45 - Redis连接池初始化失败: 'Settings' object has no attribute 'get'
2025-10-05 19:34:39.962 | INFO     | core.nlu.nlu_engine:__init__:50 - ✓ NLU引擎初始化成功: DeepSeek (deepseek-chat)
2025-10-05 19:34:39.962 | ERROR    | core.dst.state_store:__init__:28 - Redis初始化失败: Redis连接池未初始化, 使用内存存储
2025-10-05 19:34:39.962 | INFO     | core.dst.dialog_state_tracker:__init__:27 - 对话状态跟踪器初始化完成
2025-10-05 19:34:39.962 | INFO     | executor.db_executor:__init__:16 - 数据库执行器初始化完成
2025-10-05 19:34:39.962 | INFO     | core.chatbot_dst:__init__:23 - 第二阶段对话系统初始化完成（含DST支持）
2025-10-05 19:34:39.962 | INFO     | core.chatbot_dst:chat:46 - [integration_test_003] 收到用户输入: 100元以内的套餐
2025-10-05 19:34:39.962 | INFO     | core.nlu.nlu_engine:understand:80 - [integration_test_003] 开始NLU理解: 100元以内的套餐
2025-10-05 19:34:39.962 | DEBUG    | core.nlu.nlu_engine:understand:85 - [integration_test_003] 预处理后: 100元以内的套餐
2025-10-05 19:34:42.692 | INFO     | core.nlu.nlu_engine:understand:110 - [integration_test_003] NLU完成: intent=query_packages
2025-10-05 19:34:42.692 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_003
2025-10-05 19:34:42.692 | DEBUG    | core.dst.state_store:_load_from_memory:121 - 内存中不存在会话: integration_test_003, 返回新状态
2025-10-05 19:34:42.692 | INFO     | core.dst.dialog_state_tracker:track:59 - 意图改变: None → query_packages
2025-10-05 19:34:42.693 | DEBUG    | core.dst.slot_manager:fill_slots:61 - 不同领域，仅保留用户信息: []
2025-10-05 19:34:42.693 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_003
2025-10-05 19:34:42.693 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=1, 需要澄清=False
2025-10-05 19:34:42.693 | INFO     | executor.db_executor:execute_function:29 - 执行Function: query_packages, 参数: {'price_max': 100, 'sort_by': 'price_asc'}
2025-10-05 19:34:42.750 | INFO     | executor.db_executor:execute_function:50 - Function执行成功: query_packages
2025-10-05 19:34:42.750 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_003
2025-10-05 19:34:42.750 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_003] 对话完成 | 意图: query_packages | 轮次: 2 | 耗时: 2788ms
2025-10-05 19:34:42.751 | INFO     | core.chatbot_dst:chat:46 - [integration_test_003] 收到用户输入: 查询我的流量使用情况
2025-10-05 19:34:42.751 | INFO     | core.nlu.nlu_engine:understand:80 - [integration_test_003] 开始NLU理解: 查询我的流量使用情况
2025-10-05 19:34:42.751 | DEBUG    | core.nlu.nlu_engine:understand:85 - [integration_test_003] 预处理后: 查询我的流量使用情况
2025-10-05 19:34:46.308 | INFO     | core.nlu.nlu_engine:understand:110 - [integration_test_003] NLU完成: intent=query_packages
2025-10-05 19:34:46.309 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_003
2025-10-05 19:34:46.309 | DEBUG    | core.dst.state_store:_load_from_memory:118 - 从内存加载状态: integration_test_003
2025-10-05 19:34:46.309 | DEBUG    | core.dst.slot_manager:fill_slots:43 - 意图不变，合并槽位: ['price_max', 'sort_by']
2025-10-05 19:34:46.309 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_003
2025-10-05 19:34:46.309 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=3, 需要澄清=False
2025-10-05 19:34:46.309 | INFO     | executor.db_executor:execute_function:29 - 执行Function: query_packages, 参数: {'price_max': 100, 'sort_by': 'price_asc'}
2025-10-05 19:34:46.315 | INFO     | executor.db_executor:execute_function:50 - Function执行成功: query_packages
2025-10-05 19:34:46.315 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_003
2025-10-05 19:34:46.315 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_003] 对话完成 | 意图: query_packages | 轮次: 4 | 耗时: 3565ms
2025-10-05 19:35:28.337 | INFO     | database.db_manager:_initialize:38 - 数据库连接初始化成功
2025-10-05 19:35:28.338 | ERROR    | database.redis_manager:_initialize:45 - Redis连接池初始化失败: 'Settings' object has no attribute 'get'
2025-10-05 19:35:29.323 | INFO     | core.nlu.nlu_engine:__init__:50 - ✓ NLU引擎初始化成功: DeepSeek (deepseek-chat)
2025-10-05 19:35:29.323 | ERROR    | core.dst.state_store:__init__:28 - Redis初始化失败: Redis连接池未初始化, 使用内存存储
2025-10-05 19:35:29.324 | INFO     | core.dst.dialog_state_tracker:__init__:27 - 对话状态跟踪器初始化完成
2025-10-05 19:35:29.324 | INFO     | executor.db_executor:__init__:16 - 数据库执行器初始化完成
2025-10-05 19:35:29.324 | INFO     | core.chatbot_dst:__init__:23 - 第二阶段对话系统初始化完成（含DST支持）
2025-10-05 19:35:29.325 | INFO     | core.chatbot_dst:chat:46 - [integration_test_003] 收到用户输入: 100元以内的套餐
2025-10-05 19:35:29.325 | INFO     | core.nlu.nlu_engine:understand:80 - [integration_test_003] 开始NLU理解: 100元以内的套餐
2025-10-05 19:35:29.325 | DEBUG    | core.nlu.nlu_engine:understand:85 - [integration_test_003] 预处理后: 100元以内的套餐
2025-10-05 19:35:33.331 | INFO     | core.nlu.nlu_engine:understand:110 - [integration_test_003] NLU完成: intent=query_packages
2025-10-05 19:35:33.332 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_003
2025-10-05 19:35:33.332 | DEBUG    | core.dst.state_store:_load_from_memory:121 - 内存中不存在会话: integration_test_003, 返回新状态
2025-10-05 19:35:33.332 | INFO     | core.dst.dialog_state_tracker:track:59 - 意图改变: None → query_packages
2025-10-05 19:35:33.332 | DEBUG    | core.dst.slot_manager:fill_slots:61 - 不同领域，仅保留用户信息: []
2025-10-05 19:35:33.332 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_003
2025-10-05 19:35:33.332 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=1, 需要澄清=False
2025-10-05 19:35:33.332 | INFO     | executor.db_executor:execute_function:29 - 执行Function: query_packages, 参数: {'price_max': 100, 'sort_by': 'price_asc'}
2025-10-05 19:35:33.365 | INFO     | executor.db_executor:execute_function:50 - Function执行成功: query_packages
2025-10-05 19:35:33.365 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_003
2025-10-05 19:35:33.365 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_003] 对话完成 | 意图: query_packages | 轮次: 2 | 耗时: 4040ms
2025-10-05 19:35:33.365 | INFO     | core.chatbot_dst:chat:46 - [integration_test_003] 收到用户输入: 查询我的流量使用情况
2025-10-05 19:35:33.365 | INFO     | core.nlu.nlu_engine:understand:80 - [integration_test_003] 开始NLU理解: 查询我的流量使用情况
2025-10-05 19:35:33.365 | DEBUG    | core.nlu.nlu_engine:understand:85 - [integration_test_003] 预处理后: 查询我的流量使用情况
2025-10-05 19:35:36.542 | INFO     | core.nlu.nlu_engine:understand:110 - [integration_test_003] NLU完成: intent=query_packages
2025-10-05 19:35:36.544 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_003
2025-10-05 19:35:36.545 | DEBUG    | core.dst.state_store:_load_from_memory:118 - 从内存加载状态: integration_test_003
2025-10-05 19:35:36.545 | DEBUG    | core.dst.slot_manager:fill_slots:43 - 意图不变，合并槽位: ['price_max', 'sort_by']
2025-10-05 19:35:36.545 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_003
2025-10-05 19:35:36.545 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=3, 需要澄清=False
2025-10-05 19:35:36.545 | INFO     | executor.db_executor:execute_function:29 - 执行Function: query_packages, 参数: {'price_max': 100, 'sort_by': 'price_asc'}
2025-10-05 19:35:36.554 | INFO     | executor.db_executor:execute_function:50 - Function执行成功: query_packages
2025-10-05 19:35:36.555 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_003
2025-10-05 19:35:36.555 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_003] 对话完成 | 意图: query_packages | 轮次: 4 | 耗时: 3190ms
2025-10-05 19:45:08.511 | INFO     | database.db_manager:_initialize:38 - 数据库连接初始化成功
2025-10-05 19:45:08.511 | ERROR    | database.redis_manager:_initialize:45 - Redis连接池初始化失败: 'Settings' object has no attribute 'get'
2025-10-05 19:45:08.608 | INFO     | core.nlu.nlu_engine:__init__:53 - ✓ NLU引擎初始化成功: DeepSeek (deepseek-chat)
2025-10-05 19:45:08.608 | ERROR    | core.dst.state_store:__init__:28 - Redis初始化失败: Redis连接池未初始化, 使用内存存储
2025-10-05 19:45:08.608 | INFO     | core.dst.dialog_state_tracker:__init__:27 - 对话状态跟踪器初始化完成
2025-10-05 19:45:08.608 | INFO     | executor.db_executor:__init__:16 - 数据库执行器初始化完成
2025-10-05 19:45:08.608 | INFO     | core.chatbot_dst:__init__:23 - 第二阶段对话系统初始化完成（含DST支持）
2025-10-05 19:45:08.609 | INFO     | core.chatbot_dst:chat:46 - [integration_test_003] 收到用户输入: 100元以内的套餐
2025-10-05 19:45:08.609 | INFO     | core.nlu.nlu_engine:understand:83 - [integration_test_003] 开始NLU理解: 100元以内的套餐
2025-10-05 19:45:08.609 | DEBUG    | core.nlu.nlu_engine:understand:88 - [integration_test_003] 预处理后: 100元以内的套餐
2025-10-05 19:45:12.196 | INFO     | core.nlu.nlu_engine:understand:113 - [integration_test_003] NLU完成: intent=query_packages
2025-10-05 19:45:12.196 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_003
2025-10-05 19:45:12.197 | DEBUG    | core.dst.state_store:_load_from_memory:121 - 内存中不存在会话: integration_test_003, 返回新状态
2025-10-05 19:45:12.197 | INFO     | core.dst.dialog_state_tracker:track:59 - 意图改变: None → query_packages
2025-10-05 19:45:12.197 | DEBUG    | core.dst.slot_manager:fill_slots:61 - 不同领域，仅保留用户信息: []
2025-10-05 19:45:12.197 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_003
2025-10-05 19:45:12.197 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=1, 需要澄清=False
2025-10-05 19:45:12.197 | INFO     | executor.db_executor:execute_function:29 - 执行Function: query_packages, 参数: {'price_max': 100, 'sort_by': 'price_asc'}
2025-10-05 19:45:12.255 | INFO     | executor.db_executor:execute_function:50 - Function执行成功: query_packages
2025-10-05 19:45:12.255 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_003
2025-10-05 19:45:12.256 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_003] 对话完成 | 意图: query_packages | 轮次: 2 | 耗时: 3647ms
2025-10-05 19:45:12.256 | INFO     | core.chatbot_dst:chat:46 - [integration_test_003] 收到用户输入: 查询我的流量使用情况
2025-10-05 19:45:12.256 | INFO     | core.nlu.nlu_engine:understand:83 - [integration_test_003] 开始NLU理解: 查询我的流量使用情况
2025-10-05 19:45:12.256 | DEBUG    | core.nlu.nlu_engine:understand:88 - [integration_test_003] 预处理后: 查询我的流量使用情况
2025-10-05 19:45:15.017 | INFO     | core.nlu.nlu_engine:understand:113 - [integration_test_003] NLU完成: intent=query_packages
2025-10-05 19:45:15.019 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_003
2025-10-05 19:45:15.019 | DEBUG    | core.dst.state_store:_load_from_memory:118 - 从内存加载状态: integration_test_003
2025-10-05 19:45:15.019 | DEBUG    | core.dst.slot_manager:fill_slots:43 - 意图不变，合并槽位: ['price_max', 'sort_by']
2025-10-05 19:45:15.020 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_003
2025-10-05 19:45:15.020 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=3, 需要澄清=False
2025-10-05 19:45:15.020 | INFO     | executor.db_executor:execute_function:29 - 执行Function: query_packages, 参数: {'price_max': 100, 'sort_by': 'price_asc'}
2025-10-05 19:45:15.026 | INFO     | executor.db_executor:execute_function:50 - Function执行成功: query_packages
2025-10-05 19:45:15.027 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_003
2025-10-05 19:45:15.027 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_003] 对话完成 | 意图: query_packages | 轮次: 4 | 耗时: 2771ms
2025-10-05 19:50:18.629 | INFO     | database.db_manager:_initialize:38 - 数据库连接初始化成功
2025-10-05 19:50:18.630 | ERROR    | database.redis_manager:_initialize:45 - Redis连接池初始化失败: 'Settings' object has no attribute 'get'
2025-10-05 19:50:18.728 | INFO     | core.nlu.nlu_engine:__init__:53 - ✓ NLU引擎初始化成功: DeepSeek (deepseek-chat)
2025-10-05 19:50:18.729 | ERROR    | core.dst.state_store:__init__:28 - Redis初始化失败: Redis连接池未初始化, 使用内存存储
2025-10-05 19:50:18.729 | INFO     | core.dst.dialog_state_tracker:__init__:27 - 对话状态跟踪器初始化完成
2025-10-05 19:50:18.729 | INFO     | executor.db_executor:__init__:16 - 数据库执行器初始化完成
2025-10-05 19:50:18.729 | INFO     | core.chatbot_dst:__init__:23 - 第二阶段对话系统初始化完成（含DST支持）
2025-10-05 19:50:18.730 | INFO     | core.chatbot_dst:chat:46 - [integration_test_003] 收到用户输入: 100元以内的套餐
2025-10-05 19:50:18.730 | INFO     | core.nlu.nlu_engine:understand:83 - [integration_test_003] 开始NLU理解: 100元以内的套餐
2025-10-05 19:50:18.730 | DEBUG    | core.nlu.nlu_engine:understand:88 - [integration_test_003] 预处理后: 100元以内的套餐
2025-10-05 19:50:22.308 | INFO     | core.nlu.nlu_engine:understand:113 - [integration_test_003] NLU完成: intent=query_packages
2025-10-05 19:50:22.308 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_003
2025-10-05 19:50:22.308 | DEBUG    | core.dst.state_store:_load_from_memory:121 - 内存中不存在会话: integration_test_003, 返回新状态
2025-10-05 19:50:22.308 | INFO     | core.dst.dialog_state_tracker:track:59 - 意图改变: None → query_packages
2025-10-05 19:50:22.308 | DEBUG    | core.dst.slot_manager:fill_slots:61 - 不同领域，仅保留用户信息: []
2025-10-05 19:50:22.309 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_003
2025-10-05 19:50:22.309 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=1, 需要澄清=False
2025-10-05 19:50:22.309 | INFO     | executor.db_executor:execute_function:29 - 执行Function: query_packages, 参数: {'price_max': 100, 'sort_by': 'price_asc'}
2025-10-05 19:50:22.373 | INFO     | executor.db_executor:execute_function:50 - Function执行成功: query_packages
2025-10-05 19:50:22.373 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_003
2025-10-05 19:50:22.373 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_003] 对话完成 | 意图: query_packages | 轮次: 2 | 耗时: 3644ms
2025-10-05 19:50:22.373 | INFO     | core.chatbot_dst:chat:46 - [integration_test_003] 收到用户输入: 查询我的流量使用情况
2025-10-05 19:50:22.374 | INFO     | core.nlu.nlu_engine:understand:83 - [integration_test_003] 开始NLU理解: 查询我的流量使用情况
2025-10-05 19:50:22.374 | DEBUG    | core.nlu.nlu_engine:understand:88 - [integration_test_003] 预处理后: 查询我的流量使用情况
2025-10-05 19:50:25.098 | INFO     | core.nlu.nlu_engine:understand:113 - [integration_test_003] NLU完成: intent=query_packages
2025-10-05 19:50:25.099 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_003
2025-10-05 19:50:25.099 | DEBUG    | core.dst.state_store:_load_from_memory:118 - 从内存加载状态: integration_test_003
2025-10-05 19:50:25.099 | DEBUG    | core.dst.slot_manager:fill_slots:43 - 意图不变，合并槽位: ['price_max', 'sort_by']
2025-10-05 19:50:25.099 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_003
2025-10-05 19:50:25.100 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=3, 需要澄清=False
2025-10-05 19:50:25.100 | INFO     | executor.db_executor:execute_function:29 - 执行Function: query_packages, 参数: {'price_max': 100, 'sort_by': 'price_asc'}
2025-10-05 19:50:25.106 | INFO     | executor.db_executor:execute_function:50 - Function执行成功: query_packages
2025-10-05 19:50:25.106 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_003
2025-10-05 19:50:25.107 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_003] 对话完成 | 意图: query_packages | 轮次: 4 | 耗时: 2733ms
2025-10-05 19:51:56.674 | INFO     | database.db_manager:_initialize:38 - 数据库连接初始化成功
2025-10-05 19:51:56.675 | ERROR    | database.redis_manager:_initialize:45 - Redis连接池初始化失败: 'Settings' object has no attribute 'get'
2025-10-05 19:51:56.774 | INFO     | core.nlu.nlu_engine:__init__:53 - ✓ NLU引擎初始化成功: DeepSeek (deepseek-chat)
2025-10-05 19:51:56.774 | ERROR    | core.dst.state_store:__init__:28 - Redis初始化失败: Redis连接池未初始化, 使用内存存储
2025-10-05 19:51:56.774 | INFO     | core.dst.dialog_state_tracker:__init__:27 - 对话状态跟踪器初始化完成
2025-10-05 19:51:56.774 | INFO     | executor.db_executor:__init__:16 - 数据库执行器初始化完成
2025-10-05 19:51:56.774 | INFO     | core.chatbot_dst:__init__:23 - 第二阶段对话系统初始化完成（含DST支持）
2025-10-05 19:52:03.649 | INFO     | core.chatbot_dst:chat:46 - [integration_test_004] 收到用户输入: 100元以内的套餐
2025-10-05 19:52:09.023 | INFO     | core.nlu.nlu_engine:understand:83 - [integration_test_004] 开始NLU理解: 100元以内的套餐
2025-10-05 19:52:09.024 | DEBUG    | core.nlu.nlu_engine:understand:88 - [integration_test_004] 预处理后: 100元以内的套餐
2025-10-05 19:53:00.064 | INFO     | core.nlu.nlu_engine:understand:113 - [integration_test_004] NLU完成: intent=query_packages
2025-10-05 19:53:02.576 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_004
2025-10-05 19:53:02.577 | DEBUG    | core.dst.state_store:_load_from_memory:121 - 内存中不存在会话: integration_test_004, 返回新状态
2025-10-05 19:53:02.578 | INFO     | core.dst.dialog_state_tracker:track:59 - 意图改变: None → query_packages
2025-10-05 19:53:02.579 | DEBUG    | core.dst.slot_manager:fill_slots:61 - 不同领域，仅保留用户信息: []
2025-10-05 19:53:02.579 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_004
2025-10-05 19:53:02.579 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=1, 需要澄清=False
2025-10-05 19:53:10.765 | INFO     | executor.db_executor:execute_function:29 - 执行Function: query_packages, 参数: {'price_max': 100, 'sort_by': 'price_asc'}
2025-10-05 19:53:11.954 | INFO     | executor.db_executor:execute_function:50 - Function执行成功: query_packages
2025-10-05 19:53:13.739 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_004
2025-10-05 19:53:13.740 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_004] 对话完成 | 意图: query_packages | 轮次: 2 | 耗时: 70091ms
2025-10-05 19:53:22.190 | INFO     | core.chatbot_dst:chat:46 - [integration_test_004] 收到用户输入: 查询我的流量使用情况
2025-10-05 19:53:24.075 | INFO     | core.nlu.nlu_engine:understand:83 - [integration_test_004] 开始NLU理解: 查询我的流量使用情况
2025-10-05 19:53:24.076 | DEBUG    | core.nlu.nlu_engine:understand:88 - [integration_test_004] 预处理后: 查询我的流量使用情况
2025-10-05 19:55:13.351 | INFO     | core.nlu.nlu_engine:understand:113 - [integration_test_004] NLU完成: intent=query_packages
2025-10-05 19:55:14.629 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_004
2025-10-05 19:55:14.630 | DEBUG    | core.dst.state_store:_load_from_memory:118 - 从内存加载状态: integration_test_004
2025-10-05 19:55:14.631 | DEBUG    | core.dst.slot_manager:fill_slots:43 - 意图不变，合并槽位: ['price_max', 'sort_by']
2025-10-05 19:55:14.632 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_004
2025-10-05 19:55:14.632 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=3, 需要澄清=False
2025-10-05 19:55:16.867 | INFO     | executor.db_executor:execute_function:29 - 执行Function: query_packages, 参数: {'price_max': 100, 'sort_by': 'price_asc'}
2025-10-05 19:55:17.720 | INFO     | executor.db_executor:execute_function:50 - Function执行成功: query_packages
2025-10-05 19:55:18.884 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_004
2025-10-05 19:55:18.886 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_004] 对话完成 | 意图: query_packages | 轮次: 4 | 耗时: 116696ms
2025-10-05 20:01:10.697 | INFO     | database.db_manager:_initialize:38 - 数据库连接初始化成功
2025-10-05 20:01:10.698 | ERROR    | database.redis_manager:_initialize:45 - Redis连接池初始化失败: 'Settings' object has no attribute 'get'
2025-10-05 20:01:10.793 | INFO     | core.nlu.nlu_engine:__init__:53 - ✓ NLU引擎初始化成功: DeepSeek (deepseek-chat)
2025-10-05 20:01:10.794 | ERROR    | core.dst.state_store:__init__:28 - Redis初始化失败: Redis连接池未初始化, 使用内存存储
2025-10-05 20:01:10.794 | INFO     | core.dst.dialog_state_tracker:__init__:27 - 对话状态跟踪器初始化完成
2025-10-05 20:01:10.794 | INFO     | executor.db_executor:__init__:16 - 数据库执行器初始化完成
2025-10-05 20:01:10.794 | INFO     | core.chatbot_dst:__init__:23 - 第二阶段对话系统初始化完成（含DST支持）
2025-10-05 20:01:14.768 | INFO     | core.chatbot_dst:chat:46 - [integration_test_004] 收到用户输入: 100元以内的套餐
2025-10-05 20:01:14.769 | INFO     | core.nlu.nlu_engine:understand:83 - [integration_test_004] 开始NLU理解: 100元以内的套餐
2025-10-05 20:01:14.769 | DEBUG    | core.nlu.nlu_engine:understand:88 - [integration_test_004] 预处理后: 100元以内的套餐
2025-10-05 20:01:18.973 | INFO     | core.nlu.nlu_engine:_parse_response:187 - [response ChatCompletion(id='fd39e706-0f20-440f-a0ee-58abdd0950d8', choices=[Choice(finish_reason='tool_calls', index=0, logprobs=None, message=ChatCompletionMessage(content='', refusal=None, role='assistant', annotations=None, audio=None, function_call=None, tool_calls=[ChatCompletionMessageFunctionToolCall(id='call_00_fHGDeU6gVa9M65X3rRY0H6uK', function=Function(arguments='{"price_max": 100, "sort_by": "price_asc"}', name='query_packages'), type='function', index=0)]))], created=1759665678, model='deepseek-chat', object='chat.completion', service_tier=None, system_fingerprint='fp_ffc7281d48_prod0820_fp8_kvcache', usage=CompletionUsage(completion_tokens=23, prompt_tokens=1436, total_tokens=1459, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetails(audio_tokens=None, cached_tokens=1408), prompt_cache_hit_tokens=1408, prompt_cache_miss_tokens=28))] context: {'history': [], 'current_intent': None, 'slot_values': {}, 'user_phone': None, 'created_at': datetime.datetime(2025, 10, 5, 20, 1, 14, 770069)}
2025-10-05 20:01:18.973 | INFO     | core.nlu.nlu_engine:understand:113 - [integration_test_004] NLU完成: intent=query_packages
2025-10-05 20:01:18.973 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_004
2025-10-05 20:01:18.973 | DEBUG    | core.dst.state_store:_load_from_memory:121 - 内存中不存在会话: integration_test_004, 返回新状态
2025-10-05 20:01:18.973 | INFO     | core.dst.dialog_state_tracker:track:59 - 意图改变: None → query_packages
2025-10-05 20:01:18.973 | DEBUG    | core.dst.slot_manager:fill_slots:61 - 不同领域，仅保留用户信息: []
2025-10-05 20:01:18.973 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_004
2025-10-05 20:01:18.974 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=1, 需要澄清=False
2025-10-05 20:01:18.974 | INFO     | executor.db_executor:execute_function:29 - 执行Function: query_packages, 参数: {'price_max': 100, 'sort_by': 'price_asc'}
2025-10-05 20:01:19.042 | INFO     | executor.db_executor:execute_function:50 - Function执行成功: query_packages
2025-10-05 20:01:19.042 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_004
2025-10-05 20:01:19.042 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_004] 对话完成 | 意图: query_packages | 轮次: 2 | 耗时: 4274ms
2025-10-05 20:01:19.043 | INFO     | core.chatbot_dst:chat:46 - [integration_test_004] 收到用户输入: 查询我的流量使用情况
2025-10-05 20:01:19.043 | INFO     | core.nlu.nlu_engine:understand:83 - [integration_test_004] 开始NLU理解: 查询我的流量使用情况
2025-10-05 20:01:19.043 | DEBUG    | core.nlu.nlu_engine:understand:88 - [integration_test_004] 预处理后: 查询我的流量使用情况
2025-10-05 20:01:21.786 | INFO     | core.nlu.nlu_engine:_parse_response:187 - [response ChatCompletion(id='b66d7b0f-93ef-4b61-9df1-b7597c07b5b6', choices=[Choice(finish_reason='tool_calls', index=0, logprobs=None, message=ChatCompletionMessage(content='', refusal=None, role='assistant', annotations=None, audio=None, function_call=None, tool_calls=[ChatCompletionMessageFunctionToolCall(id='call_00_eRLUt5fLLslRmWfMl7jJCGpA', function=Function(arguments='{"price_max": 100, "sort_by": "price_asc"}', name='query_packages'), type='function', index=0), ChatCompletionMessageFunctionToolCall(id='call_01_SIHTob5rvepKEDZz9Nz15RVZ', function=Function(arguments='{"query_type": "all"}', name='query_usage'), type='function', index=1)]))], created=1759665681, model='deepseek-chat', object='chat.completion', service_tier=None, system_fingerprint='fp_ffc7281d48_prod0820_fp8_kvcache', usage=CompletionUsage(completion_tokens=36, prompt_tokens=1442, total_tokens=1478, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetails(audio_tokens=None, cached_tokens=1408), prompt_cache_hit_tokens=1408, prompt_cache_miss_tokens=34))] context: {'history': [{'role': 'user', 'content': '100元以内的套餐'}], 'current_intent': 'query_packages', 'slot_values': {'price_max': 100, 'sort_by': 'price_asc'}, 'user_phone': None, 'created_at': datetime.datetime(2025, 10, 5, 20, 1, 14, 770069)}
2025-10-05 20:01:21.787 | INFO     | core.nlu.nlu_engine:understand:113 - [integration_test_004] NLU完成: intent=query_packages
2025-10-05 20:01:21.787 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_004
2025-10-05 20:01:21.787 | DEBUG    | core.dst.state_store:_load_from_memory:118 - 从内存加载状态: integration_test_004
2025-10-05 20:01:21.787 | DEBUG    | core.dst.slot_manager:fill_slots:43 - 意图不变，合并槽位: ['price_max', 'sort_by']
2025-10-05 20:01:21.787 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_004
2025-10-05 20:01:21.787 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=3, 需要澄清=False
2025-10-05 20:01:21.788 | INFO     | executor.db_executor:execute_function:29 - 执行Function: query_packages, 参数: {'price_max': 100, 'sort_by': 'price_asc'}
2025-10-05 20:01:21.794 | INFO     | executor.db_executor:execute_function:50 - Function执行成功: query_packages
2025-10-05 20:01:21.794 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_004
2025-10-05 20:01:21.794 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_004] 对话完成 | 意图: query_packages | 轮次: 4 | 耗时: 2752ms
2025-10-05 20:23:44.720 | INFO     | database.db_manager:_initialize:38 - 数据库连接初始化成功
2025-10-05 20:23:44.720 | ERROR    | database.redis_manager:_initialize:45 - Redis连接池初始化失败: 'Settings' object has no attribute 'get'
2025-10-05 20:23:44.777 | INFO     | core.nlu.nlu_engine:__init__:53 - ✓ NLU引擎初始化成功: DeepSeek (deepseek-chat)
2025-10-05 20:23:44.777 | ERROR    | core.dst.state_store:__init__:28 - Redis初始化失败: Redis连接池未初始化, 使用内存存储
2025-10-05 20:23:44.777 | INFO     | core.dst.dialog_state_tracker:__init__:27 - 对话状态跟踪器初始化完成
2025-10-05 20:23:44.778 | INFO     | executor.db_executor:__init__:16 - 数据库执行器初始化完成
2025-10-05 20:23:44.778 | INFO     | core.chatbot_dst:__init__:23 - 第二阶段对话系统初始化完成（含DST支持）
2025-10-05 20:23:44.778 | INFO     | core.chatbot_dst:chat:46 - [integration_test_0002] 收到用户输入: 查下我的套餐
2025-10-05 20:23:44.778 | INFO     | core.nlu.nlu_engine:understand:73 - [integration_test_0002] 开始NLU理解: 查下我的套餐
2025-10-05 20:23:44.778 | DEBUG    | core.nlu.nlu_engine:understand:78 - [integration_test_0002] 预处理后: 查下我的套餐
2025-10-05 20:23:48.038 | INFO     | core.nlu.nlu_engine:_parse_response:185 - 解析响应: tool_calls数量=0
2025-10-05 20:23:48.038 | INFO     | core.nlu.nlu_engine:_update_session:322 - [integration_test_0002] 意图切换: None -> chat
2025-10-05 20:23:48.038 | INFO     | core.nlu.nlu_engine:understand:105 - [integration_test_0002] NLU完成: intent=chat
2025-10-05 20:23:48.038 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_0002
2025-10-05 20:23:48.038 | DEBUG    | core.dst.state_store:_load_from_memory:121 - 内存中不存在会话: integration_test_0002, 返回新状态
2025-10-05 20:23:48.039 | INFO     | core.dst.dialog_state_tracker:track:59 - 意图改变: None → chat
2025-10-05 20:23:48.039 | DEBUG    | core.dst.slot_manager:fill_slots:61 - 不同领域，仅保留用户信息: []
2025-10-05 20:23:48.039 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_0002
2025-10-05 20:23:48.039 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=1, 需要澄清=False
2025-10-05 20:23:48.039 | INFO     | executor.db_executor:execute_function:29 - 执行Function: chat, 参数: {}
2025-10-05 20:23:48.039 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_0002
2025-10-05 20:23:48.039 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_0002] 对话完成 | 意图: chat | 轮次: 2 | 耗时: 3261ms
2025-10-05 20:24:17.206 | INFO     | database.db_manager:_initialize:38 - 数据库连接初始化成功
2025-10-05 20:24:17.206 | ERROR    | database.redis_manager:_initialize:45 - Redis连接池初始化失败: 'Settings' object has no attribute 'get'
2025-10-05 20:24:17.264 | INFO     | core.nlu.nlu_engine:__init__:53 - ✓ NLU引擎初始化成功: DeepSeek (deepseek-chat)
2025-10-05 20:24:17.264 | ERROR    | core.dst.state_store:__init__:28 - Redis初始化失败: Redis连接池未初始化, 使用内存存储
2025-10-05 20:24:17.264 | INFO     | core.dst.dialog_state_tracker:__init__:27 - 对话状态跟踪器初始化完成
2025-10-05 20:24:17.264 | INFO     | executor.db_executor:__init__:16 - 数据库执行器初始化完成
2025-10-05 20:24:17.264 | INFO     | core.chatbot_dst:__init__:23 - 第二阶段对话系统初始化完成（含DST支持）
2025-10-05 20:24:17.264 | INFO     | core.chatbot_dst:chat:46 - [integration_test_004] 收到用户输入: 100元以内的套餐
2025-10-05 20:24:17.265 | INFO     | core.nlu.nlu_engine:understand:73 - [integration_test_004] 开始NLU理解: 100元以内的套餐
2025-10-05 20:24:17.265 | DEBUG    | core.nlu.nlu_engine:understand:78 - [integration_test_004] 预处理后: 100元以内的套餐
2025-10-05 20:24:20.085 | INFO     | core.nlu.nlu_engine:_parse_response:185 - 解析响应: tool_calls数量=1
2025-10-05 20:24:20.085 | INFO     | core.nlu.nlu_engine:_update_session:322 - [integration_test_004] 意图切换: None -> query_packages
2025-10-05 20:24:20.085 | INFO     | core.nlu.nlu_engine:understand:105 - [integration_test_004] NLU完成: intent=query_packages
2025-10-05 20:24:20.085 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_004
2025-10-05 20:24:20.085 | DEBUG    | core.dst.state_store:_load_from_memory:121 - 内存中不存在会话: integration_test_004, 返回新状态
2025-10-05 20:24:20.085 | INFO     | core.dst.dialog_state_tracker:track:59 - 意图改变: None → query_packages
2025-10-05 20:24:20.085 | DEBUG    | core.dst.slot_manager:fill_slots:61 - 不同领域，仅保留用户信息: []
2025-10-05 20:24:20.085 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_004
2025-10-05 20:24:20.085 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=1, 需要澄清=False
2025-10-05 20:24:20.085 | INFO     | executor.db_executor:execute_function:29 - 执行Function: query_packages, 参数: {'price_max': 100}
2025-10-05 20:24:20.139 | INFO     | executor.db_executor:execute_function:50 - Function执行成功: query_packages
2025-10-05 20:24:20.139 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_004
2025-10-05 20:24:20.139 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_004] 对话完成 | 意图: query_packages | 轮次: 2 | 耗时: 2875ms
2025-10-05 20:24:20.139 | INFO     | core.chatbot_dst:chat:46 - [integration_test_004] 收到用户输入: 查询我的流量使用情况
2025-10-05 20:24:20.139 | INFO     | core.nlu.nlu_engine:understand:73 - [integration_test_004] 开始NLU理解: 查询我的流量使用情况
2025-10-05 20:24:20.139 | DEBUG    | core.nlu.nlu_engine:understand:78 - [integration_test_004] 预处理后: 查询我的流量使用情况
2025-10-05 20:24:24.074 | INFO     | core.nlu.nlu_engine:_parse_response:185 - 解析响应: tool_calls数量=1
2025-10-05 20:24:24.074 | INFO     | core.nlu.nlu_engine:understand:105 - [integration_test_004] NLU完成: intent=query_packages
2025-10-05 20:24:24.074 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_004
2025-10-05 20:24:24.075 | DEBUG    | core.dst.state_store:_load_from_memory:118 - 从内存加载状态: integration_test_004
2025-10-05 20:24:24.075 | DEBUG    | core.dst.slot_manager:fill_slots:43 - 意图不变，合并槽位: ['price_max', 'sort_by']
2025-10-05 20:24:24.075 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_004
2025-10-05 20:24:24.075 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=3, 需要澄清=False
2025-10-05 20:24:24.075 | INFO     | executor.db_executor:execute_function:29 - 执行Function: query_packages, 参数: {'price_max': 100, 'sort_by': 'price_asc'}
2025-10-05 20:24:24.080 | INFO     | executor.db_executor:execute_function:50 - Function执行成功: query_packages
2025-10-05 20:24:24.080 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_004
2025-10-05 20:24:24.081 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_004] 对话完成 | 意图: query_packages | 轮次: 4 | 耗时: 3941ms
2025-10-05 20:28:58.122 | INFO     | database.db_manager:_initialize:38 - 数据库连接初始化成功
2025-10-05 20:28:58.122 | ERROR    | database.redis_manager:_initialize:45 - Redis连接池初始化失败: 'Settings' object has no attribute 'get'
2025-10-05 20:28:58.181 | INFO     | core.nlu.nlu_engine:__init__:53 - ✓ NLU引擎初始化成功: DeepSeek (deepseek-chat)
2025-10-05 20:28:58.181 | ERROR    | core.dst.state_store:__init__:28 - Redis初始化失败: Redis连接池未初始化, 使用内存存储
2025-10-05 20:28:58.181 | INFO     | core.dst.dialog_state_tracker:__init__:27 - 对话状态跟踪器初始化完成
2025-10-05 20:28:58.181 | INFO     | executor.db_executor:__init__:16 - 数据库执行器初始化完成
2025-10-05 20:28:58.181 | INFO     | core.chatbot_dst:__init__:23 - 第二阶段对话系统初始化完成（含DST支持）
2025-10-05 20:28:58.182 | INFO     | core.chatbot_dst:chat:46 - [integration_test_004] 收到用户输入: 100元以内的套餐
2025-10-05 20:28:58.182 | INFO     | core.nlu.nlu_engine:understand:73 - [integration_test_004] 开始NLU理解: 100元以内的套餐
2025-10-05 20:28:58.182 | DEBUG    | core.nlu.nlu_engine:understand:78 - [integration_test_004] 预处理后: 100元以内的套餐
2025-10-05 20:28:58.182 | INFO     | core.nlu.nlu_engine:understand:87 - 请求模型message=[{'role': 'system', 'content': '你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业务。\n\n【你的职责】\n1. 理解用户的自然语言需求\n2. **必须**识别用户意图并调用相应的函数，不要进行闲聊\n3. 当信息不完整时,友好地向用户确认缺失的信息\n4. 用专业但亲切的语气与用户交流\n\n【⭐ 重要原则】\n- **每次只处理用户的当前问题**，不要同时调用多个无关函数\n- **仔细识别用户的最新意图**，忽略之前已经处理过的问题\n- 如果用户问题明显改变了话题，只响应新的意图\n- 绝对不要同时调用query_packages和query_usage等不同类型的函数\n\n【当前可用套餐】\n- 经济套餐: 10G/月, 50元/月, 无限制人群\n- 畅游套餐: 100G/月, 180元/月, 无限制人群\n- 无限套餐: 1000G/月, 300元/月, 无限制人群\n- 校园套餐: 200G/月, 150元/月, 在校生专享\n\n【意图识别规则】\n1. 套餐查询类（query_packages）:\n   - "有什么套餐"、"推荐套餐"、"便宜的套餐"、"100元以内的套餐"\n   - 关键词：套餐、推荐、查询、有什么、价格、便宜\n\n2. 当前套餐查询（query_current_package）:\n   - "我的套餐"、"当前套餐"、"我用的什么套餐"\n   - 关键词：我的、当前、现在的\n\n3. 使用情况查询（query_usage）:  \n   - "用了多少流量"、"剩余流量"、"话费余额"、"查询余量"\n   - 关键词：用了、剩余、余额、余量、流量使用\n\n4. 套餐办理（change_package）:\n   - "办理XX套餐"、"换成XX套餐"、"我要办理"\n   - 关键词：办理、更换、变更\n\n【函数调用决策】\n当用户输入时，按以下步骤判断：\n1. 识别用户的**当前问题**关键词\n2. 匹配最相关的**单一函数**\n3. 只调用该函数，不要调用其他函数\n4. 如果不确定，优先选择与最新输入最相关的函数\n\n【理解规则】\n- 价格表达要准确理解: "100块以内"→price_max=100, "50元以上"→price_min=50\n- "便宜点的"、"经济实惠"等模糊表达→sort_by="price_asc"\n- "学生套餐"、"校园"→target_user="在校生"\n- 如果用户没有提供手机号,需要礼貌询问\n\n【重要】\n- **一次只调用一个函数**\n- **根据用户最新输入判断意图**，不要被历史对话影响\n- 不要假设用户信息,缺失时一定要询问\n- 回答要简洁明了\n'}, {'role': 'user', 'content': '100元以内的套餐'}]
2025-10-05 20:29:01.096 | INFO     | core.nlu.nlu_engine:_parse_response:185 - 解析响应=ChatCompletion(id='9063cd23-fcc0-40b5-96e2-1307dedbfd33', choices=[Choice(finish_reason='tool_calls', index=0, logprobs=None, message=ChatCompletionMessage(content='我来为您查询100元以内的套餐。', refusal=None, role='assistant', annotations=None, audio=None, function_call=None, tool_calls=[ChatCompletionMessageFunctionToolCall(id='call_00_h1G8fxrWVhOe5kKA1CDHc3DH', function=Function(arguments='{"price_max": 100}', name='query_packages'), type='function', index=0)]))], created=1759667340, model='deepseek-chat', object='chat.completion', service_tier=None, system_fingerprint='fp_ffc7281d48_prod0820_fp8_kvcache', usage=CompletionUsage(completion_tokens=23, prompt_tokens=1545, total_tokens=1568, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetails(audio_tokens=None, cached_tokens=1536), prompt_cache_hit_tokens=1536, prompt_cache_miss_tokens=9))
2025-10-05 20:29:01.096 | INFO     | core.nlu.nlu_engine:_parse_response:186 - 解析响应: tool_calls数量=1
2025-10-05 20:29:01.096 | INFO     | core.nlu.nlu_engine:_update_session:323 - [integration_test_004] 意图切换: None -> query_packages
2025-10-05 20:29:01.096 | INFO     | core.nlu.nlu_engine:understand:105 - [integration_test_004] NLU完成: intent=query_packages
2025-10-05 20:29:01.097 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_004
2025-10-05 20:29:01.097 | DEBUG    | core.dst.state_store:_load_from_memory:121 - 内存中不存在会话: integration_test_004, 返回新状态
2025-10-05 20:29:01.097 | INFO     | core.dst.dialog_state_tracker:track:59 - 意图改变: None → query_packages
2025-10-05 20:29:01.097 | DEBUG    | core.dst.slot_manager:fill_slots:61 - 不同领域，仅保留用户信息: []
2025-10-05 20:29:01.097 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_004
2025-10-05 20:29:01.097 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=1, 需要澄清=False
2025-10-05 20:29:01.097 | INFO     | executor.db_executor:execute_function:29 - 执行Function: query_packages, 参数: {'price_max': 100}
2025-10-05 20:29:01.204 | INFO     | executor.db_executor:execute_function:50 - Function执行成功: query_packages
2025-10-05 20:29:01.204 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_004
2025-10-05 20:29:01.204 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_004] 对话完成 | 意图: query_packages | 轮次: 2 | 耗时: 3023ms
2025-10-05 20:29:01.204 | INFO     | core.chatbot_dst:chat:46 - [integration_test_004] 收到用户输入: 查询我的流量使用情况
2025-10-05 20:29:01.204 | INFO     | core.nlu.nlu_engine:understand:73 - [integration_test_004] 开始NLU理解: 查询我的流量使用情况
2025-10-05 20:29:01.204 | DEBUG    | core.nlu.nlu_engine:understand:78 - [integration_test_004] 预处理后: 查询我的流量使用情况
2025-10-05 20:29:01.205 | INFO     | core.nlu.nlu_engine:understand:87 - 请求模型message=[{'role': 'system', 'content': '你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业务。\n\n【你的职责】\n1. 理解用户的自然语言需求\n2. **必须**识别用户意图并调用相应的函数，不要进行闲聊\n3. 当信息不完整时,友好地向用户确认缺失的信息\n4. 用专业但亲切的语气与用户交流\n\n【⭐ 重要原则】\n- **每次只处理用户的当前问题**，不要同时调用多个无关函数\n- **仔细识别用户的最新意图**，忽略之前已经处理过的问题\n- 如果用户问题明显改变了话题，只响应新的意图\n- 绝对不要同时调用query_packages和query_usage等不同类型的函数\n\n【当前可用套餐】\n- 经济套餐: 10G/月, 50元/月, 无限制人群\n- 畅游套餐: 100G/月, 180元/月, 无限制人群\n- 无限套餐: 1000G/月, 300元/月, 无限制人群\n- 校园套餐: 200G/月, 150元/月, 在校生专享\n\n【意图识别规则】\n1. 套餐查询类（query_packages）:\n   - "有什么套餐"、"推荐套餐"、"便宜的套餐"、"100元以内的套餐"\n   - 关键词：套餐、推荐、查询、有什么、价格、便宜\n\n2. 当前套餐查询（query_current_package）:\n   - "我的套餐"、"当前套餐"、"我用的什么套餐"\n   - 关键词：我的、当前、现在的\n\n3. 使用情况查询（query_usage）:  \n   - "用了多少流量"、"剩余流量"、"话费余额"、"查询余量"\n   - 关键词：用了、剩余、余额、余量、流量使用\n\n4. 套餐办理（change_package）:\n   - "办理XX套餐"、"换成XX套餐"、"我要办理"\n   - 关键词：办理、更换、变更\n\n【函数调用决策】\n当用户输入时，按以下步骤判断：\n1. 识别用户的**当前问题**关键词\n2. 匹配最相关的**单一函数**\n3. 只调用该函数，不要调用其他函数\n4. 如果不确定，优先选择与最新输入最相关的函数\n\n【理解规则】\n- 价格表达要准确理解: "100块以内"→price_max=100, "50元以上"→price_min=50\n- "便宜点的"、"经济实惠"等模糊表达→sort_by="price_asc"\n- "学生套餐"、"校园"→target_user="在校生"\n- 如果用户没有提供手机号,需要礼貌询问\n\n【重要】\n- **一次只调用一个函数**\n- **根据用户最新输入判断意图**，不要被历史对话影响\n- 不要假设用户信息,缺失时一定要询问\n- 回答要简洁明了\n'}, {'role': 'user', 'content': '100元以内的套餐'}, {'role': 'user', 'content': '查询我的流量使用情况'}]
2025-10-05 20:29:05.672 | INFO     | core.nlu.nlu_engine:_parse_response:185 - 解析响应=ChatCompletion(id='3b3725a7-50d8-456d-8257-39457311815b', choices=[Choice(finish_reason='tool_calls', index=0, logprobs=None, message=ChatCompletionMessage(content='我注意到您有两个不同的需求：查询100元以内的套餐和查询流量使用情况。\n\n根据我的服务规则，我需要一次只处理一个问题。让我先为您查询100元以内的套餐信息：', refusal=None, role='assistant', annotations=None, audio=None, function_call=None, tool_calls=[ChatCompletionMessageFunctionToolCall(id='call_00_KvjbX87ZI3Y6xMYr3iBqio1n', function=Function(arguments='{"price_max": 100, "sort_by": "price_asc"}', name='query_packages'), type='function', index=0)]))], created=1759667343, model='deepseek-chat', object='chat.completion', service_tier=None, system_fingerprint='fp_ffc7281d48_prod0820_fp8_kvcache', usage=CompletionUsage(completion_tokens=63, prompt_tokens=1551, total_tokens=1614, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetails(audio_tokens=None, cached_tokens=1536), prompt_cache_hit_tokens=1536, prompt_cache_miss_tokens=15))
2025-10-05 20:29:05.672 | INFO     | core.nlu.nlu_engine:_parse_response:186 - 解析响应: tool_calls数量=1
2025-10-05 20:29:05.672 | INFO     | core.nlu.nlu_engine:understand:105 - [integration_test_004] NLU完成: intent=query_packages
2025-10-05 20:29:05.673 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_004
2025-10-05 20:29:05.673 | DEBUG    | core.dst.state_store:_load_from_memory:118 - 从内存加载状态: integration_test_004
2025-10-05 20:29:05.673 | DEBUG    | core.dst.slot_manager:fill_slots:43 - 意图不变，合并槽位: ['price_max', 'sort_by']
2025-10-05 20:29:05.673 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_004
2025-10-05 20:29:05.673 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=3, 需要澄清=False
2025-10-05 20:29:05.673 | INFO     | executor.db_executor:execute_function:29 - 执行Function: query_packages, 参数: {'price_max': 100, 'sort_by': 'price_asc'}
2025-10-05 20:29:05.678 | INFO     | executor.db_executor:execute_function:50 - Function执行成功: query_packages
2025-10-05 20:29:05.678 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_004
2025-10-05 20:29:05.678 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_004] 对话完成 | 意图: query_packages | 轮次: 4 | 耗时: 4474ms
2025-10-05 20:29:51.232 | INFO     | database.db_manager:_initialize:38 - 数据库连接初始化成功
2025-10-05 20:29:51.233 | ERROR    | database.redis_manager:_initialize:45 - Redis连接池初始化失败: 'Settings' object has no attribute 'get'
2025-10-05 20:29:51.290 | INFO     | core.nlu.nlu_engine:__init__:53 - ✓ NLU引擎初始化成功: DeepSeek (deepseek-chat)
2025-10-05 20:29:51.290 | ERROR    | core.dst.state_store:__init__:28 - Redis初始化失败: Redis连接池未初始化, 使用内存存储
2025-10-05 20:29:51.290 | INFO     | core.dst.dialog_state_tracker:__init__:27 - 对话状态跟踪器初始化完成
2025-10-05 20:29:51.290 | INFO     | executor.db_executor:__init__:16 - 数据库执行器初始化完成
2025-10-05 20:29:51.290 | INFO     | core.chatbot_dst:__init__:23 - 第二阶段对话系统初始化完成（含DST支持）
2025-10-05 20:29:51.290 | INFO     | core.chatbot_dst:chat:46 - [integration_test_004] 收到用户输入: 100元以内的套餐
2025-10-05 20:29:51.290 | INFO     | core.nlu.nlu_engine:understand:73 - [integration_test_004] 开始NLU理解: 100元以内的套餐
2025-10-05 20:29:51.290 | DEBUG    | core.nlu.nlu_engine:understand:78 - [integration_test_004] 预处理后: 100元以内的套餐
2025-10-05 20:29:51.291 | INFO     | core.nlu.nlu_engine:understand:87 - 请求模型message=[{'role': 'system', 'content': '你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业务。\n\n【你的职责】\n1. 理解用户的自然语言需求\n2. **必须**识别用户意图并调用相应的函数，不要进行闲聊\n3. 当信息不完整时,友好地向用户确认缺失的信息\n4. 用专业但亲切的语气与用户交流\n\n【⭐ 重要原则】\n- **每次只处理用户的当前问题**，不要同时调用多个无关函数\n- **仔细识别用户的最新意图**，忽略之前已经处理过的问题\n- 如果用户问题明显改变了话题，只响应新的意图\n- 绝对不要同时调用query_packages和query_usage等不同类型的函数\n\n【当前可用套餐】\n- 经济套餐: 10G/月, 50元/月, 无限制人群\n- 畅游套餐: 100G/月, 180元/月, 无限制人群\n- 无限套餐: 1000G/月, 300元/月, 无限制人群\n- 校园套餐: 200G/月, 150元/月, 在校生专享\n\n【意图识别规则】\n1. 套餐查询类（query_packages）:\n   - "有什么套餐"、"推荐套餐"、"便宜的套餐"、"100元以内的套餐"\n   - 关键词：套餐、推荐、查询、有什么、价格、便宜\n\n2. 当前套餐查询（query_current_package）:\n   - "我的套餐"、"当前套餐"、"我用的什么套餐"\n   - 关键词：我的、当前、现在的\n\n3. 使用情况查询（query_usage）:  \n   - "用了多少流量"、"剩余流量"、"话费余额"、"查询余量"\n   - 关键词：用了、剩余、余额、余量、流量使用\n\n4. 套餐办理（change_package）:\n   - "办理XX套餐"、"换成XX套餐"、"我要办理"\n   - 关键词：办理、更换、变更\n\n【函数调用决策】\n当用户输入时，按以下步骤判断：\n1. 识别用户的**当前问题**关键词\n2. 匹配最相关的**单一函数**\n3. 只调用该函数，不要调用其他函数\n4. 如果不确定，优先选择与最新输入最相关的函数\n\n【理解规则】\n- 价格表达要准确理解: "100块以内"→price_max=100, "50元以上"→price_min=50\n- "便宜点的"、"经济实惠"等模糊表达→sort_by="price_asc"\n- "学生套餐"、"校园"→target_user="在校生"\n- 如果用户没有提供手机号,需要礼貌询问\n\n【重要】\n- **一次只调用一个函数**\n- **根据用户最新输入判断意图**，不要被历史对话影响\n- 不要假设用户信息,缺失时一定要询问\n- 回答要简洁明了\n'}, {'role': 'user', 'content': '100元以内的套餐'}]
2025-10-05 20:29:54.135 | INFO     | core.nlu.nlu_engine:_parse_response:185 - 解析响应=ChatCompletion(id='624b9f23-f61e-4089-b3ff-d2d631296e29', choices=[Choice(finish_reason='tool_calls', index=0, logprobs=None, message=ChatCompletionMessage(content='我来为您查询100元以内的套餐。', refusal=None, role='assistant', annotations=None, audio=None, function_call=None, tool_calls=[ChatCompletionMessageFunctionToolCall(id='call_00_cm8RUOHPlTJflcTgbvdG6fN1', function=Function(arguments='{"price_max": 100}', name='query_packages'), type='function', index=0)]))], created=1759667393, model='deepseek-chat', object='chat.completion', service_tier=None, system_fingerprint='fp_ffc7281d48_prod0820_fp8_kvcache', usage=CompletionUsage(completion_tokens=23, prompt_tokens=1545, total_tokens=1568, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetails(audio_tokens=None, cached_tokens=1536), prompt_cache_hit_tokens=1536, prompt_cache_miss_tokens=9))
2025-10-05 20:29:54.135 | INFO     | core.nlu.nlu_engine:_parse_response:186 - 解析响应: tool_calls数量=1
2025-10-05 20:29:54.135 | INFO     | core.nlu.nlu_engine:_update_session:323 - [integration_test_004] 意图切换: None -> query_packages
2025-10-05 20:29:54.135 | INFO     | core.nlu.nlu_engine:understand:105 - [integration_test_004] NLU完成: intent=query_packages
2025-10-05 20:29:54.135 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_004
2025-10-05 20:29:54.135 | DEBUG    | core.dst.state_store:_load_from_memory:121 - 内存中不存在会话: integration_test_004, 返回新状态
2025-10-05 20:29:54.136 | INFO     | core.dst.dialog_state_tracker:track:59 - 意图改变: None → query_packages
2025-10-05 20:29:54.136 | DEBUG    | core.dst.slot_manager:fill_slots:61 - 不同领域，仅保留用户信息: []
2025-10-05 20:29:54.136 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_004
2025-10-05 20:29:54.136 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=1, 需要澄清=False
2025-10-05 20:29:54.136 | INFO     | executor.db_executor:execute_function:29 - 执行Function: query_packages, 参数: {'price_max': 100}
2025-10-05 20:29:54.202 | INFO     | executor.db_executor:execute_function:50 - Function执行成功: query_packages
2025-10-05 20:29:54.203 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_004
2025-10-05 20:29:54.203 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_004] 对话完成 | 意图: query_packages | 轮次: 2 | 耗时: 2913ms
2025-10-05 20:29:54.203 | INFO     | core.chatbot_dst:chat:46 - [integration_test_004] 收到用户输入: 查询我的流量使用情况
2025-10-05 20:29:54.203 | INFO     | core.nlu.nlu_engine:understand:73 - [integration_test_004] 开始NLU理解: 查询我的流量使用情况
2025-10-05 20:29:54.203 | DEBUG    | core.nlu.nlu_engine:understand:78 - [integration_test_004] 预处理后: 查询我的流量使用情况
2025-10-05 20:29:54.203 | INFO     | core.nlu.nlu_engine:understand:87 - 请求模型message=[{'role': 'system', 'content': '你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业务。\n\n【你的职责】\n1. 理解用户的自然语言需求\n2. **必须**识别用户意图并调用相应的函数，不要进行闲聊\n3. 当信息不完整时,友好地向用户确认缺失的信息\n4. 用专业但亲切的语气与用户交流\n\n【⭐ 重要原则】\n- **每次只处理用户的当前问题**，不要同时调用多个无关函数\n- **仔细识别用户的最新意图**，忽略之前已经处理过的问题\n- 如果用户问题明显改变了话题，只响应新的意图\n- 绝对不要同时调用query_packages和query_usage等不同类型的函数\n\n【当前可用套餐】\n- 经济套餐: 10G/月, 50元/月, 无限制人群\n- 畅游套餐: 100G/月, 180元/月, 无限制人群\n- 无限套餐: 1000G/月, 300元/月, 无限制人群\n- 校园套餐: 200G/月, 150元/月, 在校生专享\n\n【意图识别规则】\n1. 套餐查询类（query_packages）:\n   - "有什么套餐"、"推荐套餐"、"便宜的套餐"、"100元以内的套餐"\n   - 关键词：套餐、推荐、查询、有什么、价格、便宜\n\n2. 当前套餐查询（query_current_package）:\n   - "我的套餐"、"当前套餐"、"我用的什么套餐"\n   - 关键词：我的、当前、现在的\n\n3. 使用情况查询（query_usage）:  \n   - "用了多少流量"、"剩余流量"、"话费余额"、"查询余量"\n   - 关键词：用了、剩余、余额、余量、流量使用\n\n4. 套餐办理（change_package）:\n   - "办理XX套餐"、"换成XX套餐"、"我要办理"\n   - 关键词：办理、更换、变更\n\n【函数调用决策】\n当用户输入时，按以下步骤判断：\n1. 识别用户的**当前问题**关键词\n2. 匹配最相关的**单一函数**\n3. 只调用该函数，不要调用其他函数\n4. 如果不确定，优先选择与最新输入最相关的函数\n\n【理解规则】\n- 价格表达要准确理解: "100块以内"→price_max=100, "50元以上"→price_min=50\n- "便宜点的"、"经济实惠"等模糊表达→sort_by="price_asc"\n- "学生套餐"、"校园"→target_user="在校生"\n- 如果用户没有提供手机号,需要礼貌询问\n\n【重要】\n- **一次只调用一个函数**\n- **根据用户最新输入判断意图**，不要被历史对话影响\n- 不要假设用户信息,缺失时一定要询问\n- 回答要简洁明了\n'}, {'role': 'user', 'content': '100元以内的套餐'}, {'role': 'user', 'content': '查询我的流量使用情况'}]
2025-10-05 20:29:58.062 | INFO     | core.nlu.nlu_engine:_parse_response:185 - 解析响应=ChatCompletion(id='00832844-54ff-431e-abfb-313fcc8c6aa4', choices=[Choice(finish_reason='tool_calls', index=0, logprobs=None, message=ChatCompletionMessage(content='我注意到您有两个不同的需求：查询100元以内的套餐和查询流量使用情况。\n\n根据我们的服务原则，我需要先处理您的第一个问题。让我为您查询100元以内的套餐：', refusal=None, role='assistant', annotations=None, audio=None, function_call=None, tool_calls=[ChatCompletionMessageFunctionToolCall(id='call_00_w6vhQOsFFpQkGuqtgIOyfhik', function=Function(arguments='{"price_max": 100, "sort_by": "price_asc"}', name='query_packages'), type='function', index=0)]))], created=1759667396, model='deepseek-chat', object='chat.completion', service_tier=None, system_fingerprint='fp_ffc7281d48_prod0820_fp8_kvcache', usage=CompletionUsage(completion_tokens=62, prompt_tokens=1551, total_tokens=1613, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetails(audio_tokens=None, cached_tokens=1536), prompt_cache_hit_tokens=1536, prompt_cache_miss_tokens=15))
2025-10-05 20:29:58.063 | INFO     | core.nlu.nlu_engine:_parse_response:186 - 解析响应: tool_calls数量=1
2025-10-05 20:29:58.063 | INFO     | core.nlu.nlu_engine:understand:105 - [integration_test_004] NLU完成: intent=query_packages
2025-10-05 20:29:58.063 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_004
2025-10-05 20:29:58.063 | DEBUG    | core.dst.state_store:_load_from_memory:118 - 从内存加载状态: integration_test_004
2025-10-05 20:29:58.063 | DEBUG    | core.dst.slot_manager:fill_slots:43 - 意图不变，合并槽位: ['price_max', 'sort_by']
2025-10-05 20:29:58.064 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_004
2025-10-05 20:29:58.064 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=3, 需要澄清=False
2025-10-05 20:29:58.064 | INFO     | executor.db_executor:execute_function:29 - 执行Function: query_packages, 参数: {'price_max': 100, 'sort_by': 'price_asc'}
2025-10-05 20:29:58.071 | INFO     | executor.db_executor:execute_function:50 - Function执行成功: query_packages
2025-10-05 20:29:58.072 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_004
2025-10-05 20:29:58.072 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_004] 对话完成 | 意图: query_packages | 轮次: 4 | 耗时: 3869ms
2025-10-05 20:34:06.333 | INFO     | database.db_manager:_initialize:38 - 数据库连接初始化成功
2025-10-05 20:34:06.333 | ERROR    | database.redis_manager:_initialize:45 - Redis连接池初始化失败: 'Settings' object has no attribute 'get'
2025-10-05 20:34:06.390 | INFO     | core.nlu.nlu_engine:__init__:53 - ✓ NLU引擎初始化成功: DeepSeek (deepseek-chat)
2025-10-05 20:34:06.390 | ERROR    | core.dst.state_store:__init__:28 - Redis初始化失败: Redis连接池未初始化, 使用内存存储
2025-10-05 20:34:06.390 | INFO     | core.dst.dialog_state_tracker:__init__:27 - 对话状态跟踪器初始化完成
2025-10-05 20:34:06.391 | INFO     | executor.db_executor:__init__:16 - 数据库执行器初始化完成
2025-10-05 20:34:06.391 | INFO     | core.chatbot_dst:__init__:23 - 第二阶段对话系统初始化完成（含DST支持）
2025-10-05 20:34:06.391 | INFO     | core.chatbot_dst:chat:46 - [integration_test_004] 收到用户输入: 100元以内的套餐
2025-10-05 20:34:06.391 | INFO     | core.nlu.nlu_engine:understand:73 - [integration_test_004] 开始NLU理解: 100元以内的套餐
2025-10-05 20:34:06.391 | DEBUG    | core.nlu.nlu_engine:understand:78 - [integration_test_004] 预处理后: 100元以内的套餐
2025-10-05 20:34:06.391 | INFO     | core.nlu.nlu_engine:understand:87 - 请求模型message=[{'role': 'system', 'content': '你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业务。\n\n【⭐⭐⭐ 最重要原则】\n- **只处理用户的最后一条消息**，忽略之前的所有用户消息\n- 如果看到多个用户消息，只响应最后一个\n- 每次只调用一个与最后一条用户消息相关的函数\n\n【你的职责】\n1. 理解用户的自然语言需求\n2. **必须**识别用户意图并调用相应的函数，不要进行闲聊\n3. 当信息不完整时,友好地向用户确认缺失的信息\n4. 用专业但亲切的语气与用户交流\n\n【当前可用套餐】\n- 经济套餐: 10G/月, 50元/月, 无限制人群\n- 畅游套餐: 100G/月, 180元/月, 无限制人群\n- 无限套餐: 1000G/月, 300元/月, 无限制人群\n- 校园套餐: 200G/月, 150元/月, 在校生专享\n\n【意图识别规则】\n1. 套餐查询类（query_packages）:\n   - "有什么套餐"、"推荐套餐"、"便宜的套餐"、"100元以内的套餐"\n   - 关键词：套餐、推荐、查询、有什么、价格、便宜\n\n2. 当前套餐查询（query_current_package）:\n   - "我的套餐"、"当前套餐"、"我用的什么套餐"\n   - 关键词：我的、当前、现在的\n\n3. 使用情况查询（query_usage）:  \n   - "用了多少流量"、"剩余流量"、"话费余额"、"查询余量"、"流量使用情况"\n   - 关键词：用了、剩余、余额、余量、流量使用、使用情况\n\n4. 套餐办理（change_package）:\n   - "办理XX套餐"、"换成XX套餐"、"我要办理"\n   - 关键词：办理、更换、变更\n\n【函数调用决策】\n重要：如果对话历史中有多个用户消息，只根据最后一条用户消息来判断意图！\n1. 识别**最后一条用户消息**的关键词\n2. 匹配最相关的单一函数\n3. 只调用该函数\n4. 忽略之前的用户消息\n\n【理解规则】\n- 价格表达要准确理解: "100块以内"→price_max=100, "50元以上"→price_min=50\n- "便宜点的"、"经济实惠"等模糊表达→sort_by="price_asc"\n- "学生套餐"、"校园"→target_user="在校生"\n- 如果用户没有提供手机号,需要礼貌询问\n\n【重要】\n- **只响应最后一条用户消息**\n- **一次只调用一个函数**\n- 不要试图同时处理多个问题\n- 回答要简洁明了\n'}, {'role': 'user', 'content': '100元以内的套餐'}]
2025-10-05 20:34:09.810 | INFO     | core.nlu.nlu_engine:_parse_response:185 - 解析响应=ChatCompletion(id='6de7b4d6-6999-4415-8a10-e111c8480eb5', choices=[Choice(finish_reason='tool_calls', index=0, logprobs=None, message=ChatCompletionMessage(content='我来为您查询100元以内的流量套餐。', refusal=None, role='assistant', annotations=None, audio=None, function_call=None, tool_calls=[ChatCompletionMessageFunctionToolCall(id='call_00_rc7BoNxzMlgcXDMSGKVmwCVB', function=Function(arguments='{"price_max": 100}', name='query_packages'), type='function', index=0)]))], created=1759667648, model='deepseek-chat', object='chat.completion', service_tier=None, system_fingerprint='fp_ffc7281d48_prod0820_fp8_kvcache', usage=CompletionUsage(completion_tokens=24, prompt_tokens=1520, total_tokens=1544, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetails(audio_tokens=None, cached_tokens=0), prompt_cache_hit_tokens=0, prompt_cache_miss_tokens=1520))
2025-10-05 20:34:09.810 | INFO     | core.nlu.nlu_engine:_parse_response:186 - 解析响应: tool_calls数量=1
2025-10-05 20:34:09.810 | INFO     | core.nlu.nlu_engine:_update_session:323 - [integration_test_004] 意图切换: None -> query_packages
2025-10-05 20:34:09.811 | INFO     | core.nlu.nlu_engine:understand:105 - [integration_test_004] NLU完成: intent=query_packages
2025-10-05 20:34:09.811 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_004
2025-10-05 20:34:09.811 | DEBUG    | core.dst.state_store:_load_from_memory:121 - 内存中不存在会话: integration_test_004, 返回新状态
2025-10-05 20:34:09.811 | INFO     | core.dst.dialog_state_tracker:track:59 - 意图改变: None → query_packages
2025-10-05 20:34:09.811 | DEBUG    | core.dst.slot_manager:fill_slots:61 - 不同领域，仅保留用户信息: []
2025-10-05 20:34:09.811 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_004
2025-10-05 20:34:09.811 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=1, 需要澄清=False
2025-10-05 20:34:09.811 | INFO     | executor.db_executor:execute_function:29 - 执行Function: query_packages, 参数: {'price_max': 100}
2025-10-05 20:34:09.884 | INFO     | executor.db_executor:execute_function:50 - Function执行成功: query_packages
2025-10-05 20:34:09.884 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_004
2025-10-05 20:34:09.885 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_004] 对话完成 | 意图: query_packages | 轮次: 2 | 耗时: 3494ms
2025-10-05 20:34:09.885 | INFO     | core.chatbot_dst:chat:46 - [integration_test_004] 收到用户输入: 查询我的流量使用情况
2025-10-05 20:34:09.885 | INFO     | core.nlu.nlu_engine:understand:73 - [integration_test_004] 开始NLU理解: 查询我的流量使用情况
2025-10-05 20:34:09.885 | DEBUG    | core.nlu.nlu_engine:understand:78 - [integration_test_004] 预处理后: 查询我的流量使用情况
2025-10-05 20:34:09.885 | INFO     | core.nlu.nlu_engine:understand:87 - 请求模型message=[{'role': 'system', 'content': '你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业务。\n\n【⭐⭐⭐ 最重要原则】\n- **只处理用户的最后一条消息**，忽略之前的所有用户消息\n- 如果看到多个用户消息，只响应最后一个\n- 每次只调用一个与最后一条用户消息相关的函数\n\n【你的职责】\n1. 理解用户的自然语言需求\n2. **必须**识别用户意图并调用相应的函数，不要进行闲聊\n3. 当信息不完整时,友好地向用户确认缺失的信息\n4. 用专业但亲切的语气与用户交流\n\n【当前可用套餐】\n- 经济套餐: 10G/月, 50元/月, 无限制人群\n- 畅游套餐: 100G/月, 180元/月, 无限制人群\n- 无限套餐: 1000G/月, 300元/月, 无限制人群\n- 校园套餐: 200G/月, 150元/月, 在校生专享\n\n【意图识别规则】\n1. 套餐查询类（query_packages）:\n   - "有什么套餐"、"推荐套餐"、"便宜的套餐"、"100元以内的套餐"\n   - 关键词：套餐、推荐、查询、有什么、价格、便宜\n\n2. 当前套餐查询（query_current_package）:\n   - "我的套餐"、"当前套餐"、"我用的什么套餐"\n   - 关键词：我的、当前、现在的\n\n3. 使用情况查询（query_usage）:  \n   - "用了多少流量"、"剩余流量"、"话费余额"、"查询余量"、"流量使用情况"\n   - 关键词：用了、剩余、余额、余量、流量使用、使用情况\n\n4. 套餐办理（change_package）:\n   - "办理XX套餐"、"换成XX套餐"、"我要办理"\n   - 关键词：办理、更换、变更\n\n【函数调用决策】\n重要：如果对话历史中有多个用户消息，只根据最后一条用户消息来判断意图！\n1. 识别**最后一条用户消息**的关键词\n2. 匹配最相关的单一函数\n3. 只调用该函数\n4. 忽略之前的用户消息\n\n【理解规则】\n- 价格表达要准确理解: "100块以内"→price_max=100, "50元以上"→price_min=50\n- "便宜点的"、"经济实惠"等模糊表达→sort_by="price_asc"\n- "学生套餐"、"校园"→target_user="在校生"\n- 如果用户没有提供手机号,需要礼貌询问\n\n【重要】\n- **只响应最后一条用户消息**\n- **一次只调用一个函数**\n- 不要试图同时处理多个问题\n- 回答要简洁明了\n'}, {'role': 'user', 'content': '100元以内的套餐'}, {'role': 'user', 'content': '查询我的流量使用情况'}]
2025-10-05 20:34:13.696 | INFO     | core.nlu.nlu_engine:_parse_response:185 - 解析响应=ChatCompletion(id='5614c803-5abb-40b7-9106-7c658a62740f', choices=[Choice(finish_reason='tool_calls', index=0, logprobs=None, message=ChatCompletionMessage(content='我注意到您有两个需求：查询100元以内的套餐和查询流量使用情况。根据系统规则，我需要分别处理您的请求。\n\n首先为您查询100元以内的套餐：', refusal=None, role='assistant', annotations=None, audio=None, function_call=None, tool_calls=[ChatCompletionMessageFunctionToolCall(id='call_00_1ld3D9VEhseTJpA4LbITFJnw', function=Function(arguments='{"price_max": 100, "sort_by": "price_asc"}', name='query_packages'), type='function', index=0)]))], created=1759667652, model='deepseek-chat', object='chat.completion', service_tier=None, system_fingerprint='fp_ffc7281d48_prod0820_fp8_kvcache', usage=CompletionUsage(completion_tokens=59, prompt_tokens=1526, total_tokens=1585, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetails(audio_tokens=None, cached_tokens=1472), prompt_cache_hit_tokens=1472, prompt_cache_miss_tokens=54))
2025-10-05 20:34:13.697 | INFO     | core.nlu.nlu_engine:_parse_response:186 - 解析响应: tool_calls数量=1
2025-10-05 20:34:13.697 | INFO     | core.nlu.nlu_engine:understand:105 - [integration_test_004] NLU完成: intent=query_packages
2025-10-05 20:34:13.697 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_004
2025-10-05 20:34:13.698 | DEBUG    | core.dst.state_store:_load_from_memory:118 - 从内存加载状态: integration_test_004
2025-10-05 20:34:13.698 | DEBUG    | core.dst.slot_manager:fill_slots:43 - 意图不变，合并槽位: ['price_max', 'sort_by']
2025-10-05 20:34:13.698 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_004
2025-10-05 20:34:13.698 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=3, 需要澄清=False
2025-10-05 20:34:13.698 | INFO     | executor.db_executor:execute_function:29 - 执行Function: query_packages, 参数: {'price_max': 100, 'sort_by': 'price_asc'}
2025-10-05 20:34:13.703 | INFO     | executor.db_executor:execute_function:50 - Function执行成功: query_packages
2025-10-05 20:34:13.703 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_004
2025-10-05 20:34:13.703 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_004] 对话完成 | 意图: query_packages | 轮次: 4 | 耗时: 3818ms
2025-10-05 20:38:36.986 | INFO     | database.db_manager:_initialize:38 - 数据库连接初始化成功
2025-10-05 20:38:36.987 | ERROR    | database.redis_manager:_initialize:45 - Redis连接池初始化失败: 'Settings' object has no attribute 'get'
2025-10-05 20:38:37.080 | INFO     | core.nlu.nlu_engine:__init__:53 - ✓ NLU引擎初始化成功: DeepSeek (deepseek-chat)
2025-10-05 20:38:37.081 | ERROR    | core.dst.state_store:__init__:28 - Redis初始化失败: Redis连接池未初始化, 使用内存存储
2025-10-05 20:38:37.081 | INFO     | core.dst.dialog_state_tracker:__init__:27 - 对话状态跟踪器初始化完成
2025-10-05 20:38:37.081 | INFO     | executor.db_executor:__init__:16 - 数据库执行器初始化完成
2025-10-05 20:38:37.081 | INFO     | core.chatbot_dst:__init__:23 - 第二阶段对话系统初始化完成（含DST支持）
2025-10-05 20:38:37.082 | INFO     | core.chatbot_dst:chat:46 - [integration_test_004] 收到用户输入: 100元以内的套餐
2025-10-05 20:38:37.082 | INFO     | core.nlu.nlu_engine:understand:73 - [integration_test_004] 开始NLU理解: 100元以内的套餐
2025-10-05 20:38:37.082 | DEBUG    | core.nlu.nlu_engine:understand:78 - [integration_test_004] 预处理后: 100元以内的套餐
2025-10-05 20:38:37.082 | DEBUG    | core.nlu.nlu_engine:_build_messages:162 - 构建的消息: ['system: 你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业...', 'user: 100元以内的套餐...']
2025-10-05 20:38:37.082 | INFO     | core.nlu.nlu_engine:understand:87 - 请求模型message=[{'role': 'system', 'content': '你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业务。\n\n【⭐⭐⭐ 最重要原则】\n- **只处理用户的最后一条消息**，忽略之前的所有用户消息\n- 如果看到多个用户消息，只响应最后一个\n- 每次只调用一个与最后一条用户消息相关的函数\n\n【你的职责】\n1. 理解用户的自然语言需求\n2. **必须**识别用户意图并调用相应的函数，不要进行闲聊\n3. 当信息不完整时,友好地向用户确认缺失的信息\n4. 用专业但亲切的语气与用户交流\n\n【当前可用套餐】\n- 经济套餐: 10G/月, 50元/月, 无限制人群\n- 畅游套餐: 100G/月, 180元/月, 无限制人群\n- 无限套餐: 1000G/月, 300元/月, 无限制人群\n- 校园套餐: 200G/月, 150元/月, 在校生专享\n\n【意图识别规则】\n1. 套餐查询类（query_packages）:\n   - "有什么套餐"、"推荐套餐"、"便宜的套餐"、"100元以内的套餐"\n   - 关键词：套餐、推荐、查询、有什么、价格、便宜\n\n2. 当前套餐查询（query_current_package）:\n   - "我的套餐"、"当前套餐"、"我用的什么套餐"\n   - 关键词：我的、当前、现在的\n\n3. 使用情况查询（query_usage）:  \n   - "用了多少流量"、"剩余流量"、"话费余额"、"查询余量"、"流量使用情况"\n   - 关键词：用了、剩余、余额、余量、流量使用、使用情况\n\n4. 套餐办理（change_package）:\n   - "办理XX套餐"、"换成XX套餐"、"我要办理"\n   - 关键词：办理、更换、变更\n\n【函数调用决策】\n重要：如果对话历史中有多个用户消息，只根据最后一条用户消息来判断意图！\n1. 识别**最后一条用户消息**的关键词\n2. 匹配最相关的单一函数\n3. 只调用该函数\n4. 忽略之前的用户消息\n\n【理解规则】\n- 价格表达要准确理解: "100块以内"→price_max=100, "50元以上"→price_min=50\n- "便宜点的"、"经济实惠"等模糊表达→sort_by="price_asc"\n- "学生套餐"、"校园"→target_user="在校生"\n- 如果用户没有提供手机号,需要礼貌询问\n\n【重要】\n- **只响应最后一条用户消息**\n- **一次只调用一个函数**\n- 不要试图同时处理多个问题\n- 回答要简洁明了\n'}, {'role': 'user', 'content': '100元以内的套餐'}]
2025-10-05 20:38:41.948 | INFO     | core.nlu.nlu_engine:_parse_response:189 - 解析响应=ChatCompletion(id='83174bc4-8164-4e14-ab97-267b4849acd9', choices=[Choice(finish_reason='tool_calls', index=0, logprobs=None, message=ChatCompletionMessage(content='我来为您查询100元以内的套餐。', refusal=None, role='assistant', annotations=None, audio=None, function_call=None, tool_calls=[ChatCompletionMessageFunctionToolCall(id='call_00_djCaY6elfpaWX4qQ9BBebRci', function=Function(arguments='{"price_max": 100}', name='query_packages'), type='function', index=0)]))], created=1759667920, model='deepseek-chat', object='chat.completion', service_tier=None, system_fingerprint='fp_ffc7281d48_prod0820_fp8_kvcache', usage=CompletionUsage(completion_tokens=23, prompt_tokens=1520, total_tokens=1543, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetails(audio_tokens=None, cached_tokens=1472), prompt_cache_hit_tokens=1472, prompt_cache_miss_tokens=48))
2025-10-05 20:38:41.949 | INFO     | core.nlu.nlu_engine:_parse_response:190 - 解析响应: tool_calls数量=1
2025-10-05 20:38:41.949 | INFO     | core.nlu.nlu_engine:_update_session:351 - [integration_test_004] 意图切换: None -> query_packages
2025-10-05 20:38:41.949 | INFO     | core.nlu.nlu_engine:understand:105 - [integration_test_004] NLU完成: intent=query_packages
2025-10-05 20:38:41.949 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_004
2025-10-05 20:38:41.949 | DEBUG    | core.dst.state_store:_load_from_memory:121 - 内存中不存在会话: integration_test_004, 返回新状态
2025-10-05 20:38:41.949 | INFO     | core.dst.dialog_state_tracker:track:59 - 意图改变: None → query_packages
2025-10-05 20:38:41.949 | DEBUG    | core.dst.slot_manager:fill_slots:61 - 不同领域，仅保留用户信息: []
2025-10-05 20:38:41.949 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_004
2025-10-05 20:38:41.949 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=1, 需要澄清=False
2025-10-05 20:38:41.949 | INFO     | executor.db_executor:execute_function:29 - 执行Function: query_packages, 参数: {'price_max': 100}
2025-10-05 20:38:41.995 | INFO     | executor.db_executor:execute_function:50 - Function执行成功: query_packages
2025-10-05 20:38:41.995 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_004
2025-10-05 20:38:41.996 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_004] 对话完成 | 意图: query_packages | 轮次: 2 | 耗时: 4914ms
2025-10-05 20:38:41.996 | INFO     | core.chatbot_dst:chat:46 - [integration_test_004] 收到用户输入: 查询我的流量使用情况
2025-10-05 20:38:41.996 | INFO     | core.nlu.nlu_engine:understand:73 - [integration_test_004] 开始NLU理解: 查询我的流量使用情况
2025-10-05 20:38:41.996 | DEBUG    | core.nlu.nlu_engine:understand:78 - [integration_test_004] 预处理后: 查询我的流量使用情况
2025-10-05 20:38:41.996 | DEBUG    | core.nlu.nlu_engine:_build_messages:162 - 构建的消息: ['system: 你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业...', 'assistant: 正在查询套餐信息...', 'user: 查询我的流量使用情况...']
2025-10-05 20:38:41.996 | INFO     | core.nlu.nlu_engine:understand:87 - 请求模型message=[{'role': 'system', 'content': '你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业务。\n\n【⭐⭐⭐ 最重要原则】\n- **只处理用户的最后一条消息**，忽略之前的所有用户消息\n- 如果看到多个用户消息，只响应最后一个\n- 每次只调用一个与最后一条用户消息相关的函数\n\n【你的职责】\n1. 理解用户的自然语言需求\n2. **必须**识别用户意图并调用相应的函数，不要进行闲聊\n3. 当信息不完整时,友好地向用户确认缺失的信息\n4. 用专业但亲切的语气与用户交流\n\n【当前可用套餐】\n- 经济套餐: 10G/月, 50元/月, 无限制人群\n- 畅游套餐: 100G/月, 180元/月, 无限制人群\n- 无限套餐: 1000G/月, 300元/月, 无限制人群\n- 校园套餐: 200G/月, 150元/月, 在校生专享\n\n【意图识别规则】\n1. 套餐查询类（query_packages）:\n   - "有什么套餐"、"推荐套餐"、"便宜的套餐"、"100元以内的套餐"\n   - 关键词：套餐、推荐、查询、有什么、价格、便宜\n\n2. 当前套餐查询（query_current_package）:\n   - "我的套餐"、"当前套餐"、"我用的什么套餐"\n   - 关键词：我的、当前、现在的\n\n3. 使用情况查询（query_usage）:  \n   - "用了多少流量"、"剩余流量"、"话费余额"、"查询余量"、"流量使用情况"\n   - 关键词：用了、剩余、余额、余量、流量使用、使用情况\n\n4. 套餐办理（change_package）:\n   - "办理XX套餐"、"换成XX套餐"、"我要办理"\n   - 关键词：办理、更换、变更\n\n【函数调用决策】\n重要：如果对话历史中有多个用户消息，只根据最后一条用户消息来判断意图！\n1. 识别**最后一条用户消息**的关键词\n2. 匹配最相关的单一函数\n3. 只调用该函数\n4. 忽略之前的用户消息\n\n【理解规则】\n- 价格表达要准确理解: "100块以内"→price_max=100, "50元以上"→price_min=50\n- "便宜点的"、"经济实惠"等模糊表达→sort_by="price_asc"\n- "学生套餐"、"校园"→target_user="在校生"\n- 如果用户没有提供手机号,需要礼貌询问\n\n【重要】\n- **只响应最后一条用户消息**\n- **一次只调用一个函数**\n- 不要试图同时处理多个问题\n- 回答要简洁明了\n'}, {'role': 'assistant', 'content': '正在查询套餐信息'}, {'role': 'user', 'content': '查询我的流量使用情况'}]
2025-10-05 20:38:44.539 | INFO     | core.nlu.nlu_engine:_parse_response:189 - 解析响应=ChatCompletion(id='03b83659-8790-40fb-a6c6-bb696524b9a8', choices=[Choice(finish_reason='stop', index=0, logprobs=None, message=ChatCompletionMessage(content='您好！查询流量使用情况需要您的手机号码。请问您方便提供一下手机号码吗？', refusal=None, role='assistant', annotations=None, audio=None, function_call=None, tool_calls=None))], created=1759667924, model='deepseek-chat', object='chat.completion', service_tier=None, system_fingerprint='fp_ffc7281d48_prod0820_fp8_kvcache', usage=CompletionUsage(completion_tokens=20, prompt_tokens=1526, total_tokens=1546, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetails(audio_tokens=None, cached_tokens=1472), prompt_cache_hit_tokens=1472, prompt_cache_miss_tokens=54))
2025-10-05 20:38:44.540 | INFO     | core.nlu.nlu_engine:_parse_response:190 - 解析响应: tool_calls数量=0
2025-10-05 20:38:44.541 | INFO     | core.nlu.nlu_engine:_update_session:351 - [integration_test_004] 意图切换: query_packages -> chat
2025-10-05 20:38:44.541 | INFO     | core.nlu.nlu_engine:understand:105 - [integration_test_004] NLU完成: intent=chat
2025-10-05 20:38:44.541 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_004
2025-10-05 20:38:44.542 | DEBUG    | core.dst.state_store:_load_from_memory:118 - 从内存加载状态: integration_test_004
2025-10-05 20:38:44.542 | INFO     | core.dst.dialog_state_tracker:track:59 - 意图改变: query_packages → chat
2025-10-05 20:38:44.542 | DEBUG    | core.dst.slot_manager:fill_slots:61 - 不同领域，仅保留用户信息: []
2025-10-05 20:38:44.542 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_004
2025-10-05 20:38:44.542 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=3, 需要澄清=False
2025-10-05 20:38:44.542 | INFO     | executor.db_executor:execute_function:29 - 执行Function: chat, 参数: {}
2025-10-05 20:38:44.542 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_004
2025-10-05 20:38:44.543 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_004] 对话完成 | 意图: chat | 轮次: 4 | 耗时: 2547ms
2025-10-05 20:53:18.529 | INFO     | database.db_manager:_initialize:38 - 数据库连接初始化成功
2025-10-05 20:53:18.530 | ERROR    | database.redis_manager:_initialize:45 - Redis连接池初始化失败: 'Settings' object has no attribute 'get'
2025-10-05 20:53:18.627 | INFO     | core.nlu.nlu_engine:__init__:53 - ✓ NLU引擎初始化成功: DeepSeek (deepseek-chat)
2025-10-05 20:53:18.627 | ERROR    | core.dst.state_store:__init__:28 - Redis初始化失败: Redis连接池未初始化, 使用内存存储
2025-10-05 20:53:18.627 | INFO     | core.dst.dialog_state_tracker:__init__:27 - 对话状态跟踪器初始化完成
2025-10-05 20:53:18.627 | INFO     | executor.db_executor:__init__:16 - 数据库执行器初始化完成
2025-10-05 20:53:18.627 | INFO     | core.chatbot_dst:__init__:23 - 第二阶段对话系统初始化完成（含DST支持）
2025-10-05 20:53:23.465 | INFO     | core.chatbot_dst:chat:46 - [integration_test_004] 收到用户输入: 100元以内的套餐
2025-10-05 20:53:25.516 | INFO     | core.nlu.nlu_engine:understand:73 - [integration_test_004] 开始NLU理解: 100元以内的套餐
2025-10-05 20:53:25.517 | DEBUG    | core.nlu.nlu_engine:understand:78 - [integration_test_004] 预处理后: 100元以内的套餐
2025-10-05 20:53:25.517 | DEBUG    | core.nlu.nlu_engine:_build_messages:162 - 构建的消息: ['system: 你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业...', 'user: 100元以内的套餐...']
2025-10-05 20:53:25.517 | INFO     | core.nlu.nlu_engine:understand:87 - 请求模型message=[{'role': 'system', 'content': '你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业务。\n\n【⭐⭐⭐ 最重要原则】\n- **只处理用户的最后一条消息**，忽略之前的所有用户消息\n- 如果看到多个用户消息，只响应最后一个\n- 每次只调用一个与最后一条用户消息相关的函数\n\n【你的职责】\n1. 理解用户的自然语言需求\n2. **必须**识别用户意图并调用相应的函数，不要进行闲聊\n3. 当信息不完整时,友好地向用户确认缺失的信息\n4. 用专业但亲切的语气与用户交流\n\n【当前可用套餐】\n- 经济套餐: 10G/月, 50元/月, 无限制人群\n- 畅游套餐: 100G/月, 180元/月, 无限制人群\n- 无限套餐: 1000G/月, 300元/月, 无限制人群\n- 校园套餐: 200G/月, 150元/月, 在校生专享\n\n【意图识别规则】\n1. 套餐查询类（query_packages）:\n   - "有什么套餐"、"推荐套餐"、"便宜的套餐"、"100元以内的套餐"\n   - 关键词：套餐、推荐、查询、有什么、价格、便宜\n\n2. 当前套餐查询（query_current_package）:\n   - "我的套餐"、"当前套餐"、"我用的什么套餐"\n   - 关键词：我的、当前、现在的\n\n3. 使用情况查询（query_usage）:  \n   - "用了多少流量"、"剩余流量"、"话费余额"、"查询余量"、"流量使用情况"\n   - 关键词：用了、剩余、余额、余量、流量使用、使用情况\n\n4. 套餐办理（change_package）:\n   - "办理XX套餐"、"换成XX套餐"、"我要办理"\n   - 关键词：办理、更换、变更\n\n【函数调用决策】\n重要：如果对话历史中有多个用户消息，只根据最后一条用户消息来判断意图！\n1. 识别**最后一条用户消息**的关键词\n2. 匹配最相关的单一函数\n3. 只调用该函数\n4. 忽略之前的用户消息\n\n【理解规则】\n- 价格表达要准确理解: "100块以内"→price_max=100, "50元以上"→price_min=50\n- "便宜点的"、"经济实惠"等模糊表达→sort_by="price_asc"\n- "学生套餐"、"校园"→target_user="在校生"\n- 如果用户没有提供手机号,需要礼貌询问\n\n【重要】\n- **只响应最后一条用户消息**\n- **一次只调用一个函数**\n- 不要试图同时处理多个问题\n- 回答要简洁明了\n'}, {'role': 'user', 'content': '100元以内的套餐'}]
2025-10-05 20:53:30.112 | INFO     | core.nlu.nlu_engine:_parse_response:189 - 解析响应=ChatCompletion(id='ba155a67-8f84-4c00-8ddd-596654b0381a', choices=[Choice(finish_reason='tool_calls', index=0, logprobs=None, message=ChatCompletionMessage(content='我来为您查询100元以内的套餐选项。', refusal=None, role='assistant', annotations=None, audio=None, function_call=None, tool_calls=[ChatCompletionMessageFunctionToolCall(id='call_00_bB9VYLYcwK4TysCeGwOTYPF4', function=Function(arguments='{"price_max": 100}', name='query_packages'), type='function', index=0)]))], created=1759668809, model='deepseek-chat', object='chat.completion', service_tier=None, system_fingerprint='fp_ffc7281d48_prod0820_fp8_kvcache', usage=CompletionUsage(completion_tokens=24, prompt_tokens=1520, total_tokens=1544, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetails(audio_tokens=None, cached_tokens=1472), prompt_cache_hit_tokens=1472, prompt_cache_miss_tokens=48))
2025-10-05 20:53:30.112 | INFO     | core.nlu.nlu_engine:_parse_response:190 - 解析响应: tool_calls数量=1
2025-10-05 20:53:30.113 | INFO     | core.nlu.nlu_engine:_update_session:351 - [integration_test_004] 意图切换: None -> query_packages
2025-10-05 20:53:30.113 | INFO     | core.nlu.nlu_engine:understand:105 - [integration_test_004] NLU完成: intent=query_packages
2025-10-05 20:53:40.201 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_004
2025-10-05 20:53:40.203 | DEBUG    | core.dst.state_store:_load_from_memory:121 - 内存中不存在会话: integration_test_004, 返回新状态
2025-10-05 20:53:40.204 | INFO     | core.dst.dialog_state_tracker:track:59 - 意图改变: None → query_packages
2025-10-05 20:53:40.205 | DEBUG    | core.dst.slot_manager:fill_slots:61 - 不同领域，仅保留用户信息: []
2025-10-05 20:53:40.206 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_004
2025-10-05 20:53:40.206 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=1, 需要澄清=False
2025-10-05 20:53:42.797 | INFO     | executor.db_executor:execute_function:29 - 执行Function: query_packages, 参数: {'price_max': 100}
2025-10-05 20:53:52.178 | INFO     | executor.db_executor:execute_function:50 - Function执行成功: query_packages
2025-10-05 20:53:54.188 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_004
2025-10-05 20:53:54.189 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_004] 对话完成 | 意图: query_packages | 轮次: 2 | 耗时: 30724ms
2025-10-05 20:53:58.727 | INFO     | core.chatbot_dst:chat:46 - [integration_test_004] 收到用户输入: 查询我的流量使用情况
2025-10-05 20:54:02.282 | INFO     | core.nlu.nlu_engine:understand:73 - [integration_test_004] 开始NLU理解: 查询我的流量使用情况
2025-10-05 20:54:02.284 | DEBUG    | core.nlu.nlu_engine:understand:78 - [integration_test_004] 预处理后: 查询我的流量使用情况
2025-10-05 20:54:02.284 | DEBUG    | core.nlu.nlu_engine:_build_messages:162 - 构建的消息: ['system: 你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业...', 'assistant: 正在查询套餐信息...', 'user: 查询我的流量使用情况...']
2025-10-05 20:54:02.285 | INFO     | core.nlu.nlu_engine:understand:87 - 请求模型message=[{'role': 'system', 'content': '你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业务。\n\n【⭐⭐⭐ 最重要原则】\n- **只处理用户的最后一条消息**，忽略之前的所有用户消息\n- 如果看到多个用户消息，只响应最后一个\n- 每次只调用一个与最后一条用户消息相关的函数\n\n【你的职责】\n1. 理解用户的自然语言需求\n2. **必须**识别用户意图并调用相应的函数，不要进行闲聊\n3. 当信息不完整时,友好地向用户确认缺失的信息\n4. 用专业但亲切的语气与用户交流\n\n【当前可用套餐】\n- 经济套餐: 10G/月, 50元/月, 无限制人群\n- 畅游套餐: 100G/月, 180元/月, 无限制人群\n- 无限套餐: 1000G/月, 300元/月, 无限制人群\n- 校园套餐: 200G/月, 150元/月, 在校生专享\n\n【意图识别规则】\n1. 套餐查询类（query_packages）:\n   - "有什么套餐"、"推荐套餐"、"便宜的套餐"、"100元以内的套餐"\n   - 关键词：套餐、推荐、查询、有什么、价格、便宜\n\n2. 当前套餐查询（query_current_package）:\n   - "我的套餐"、"当前套餐"、"我用的什么套餐"\n   - 关键词：我的、当前、现在的\n\n3. 使用情况查询（query_usage）:  \n   - "用了多少流量"、"剩余流量"、"话费余额"、"查询余量"、"流量使用情况"\n   - 关键词：用了、剩余、余额、余量、流量使用、使用情况\n\n4. 套餐办理（change_package）:\n   - "办理XX套餐"、"换成XX套餐"、"我要办理"\n   - 关键词：办理、更换、变更\n\n【函数调用决策】\n重要：如果对话历史中有多个用户消息，只根据最后一条用户消息来判断意图！\n1. 识别**最后一条用户消息**的关键词\n2. 匹配最相关的单一函数\n3. 只调用该函数\n4. 忽略之前的用户消息\n\n【理解规则】\n- 价格表达要准确理解: "100块以内"→price_max=100, "50元以上"→price_min=50\n- "便宜点的"、"经济实惠"等模糊表达→sort_by="price_asc"\n- "学生套餐"、"校园"→target_user="在校生"\n- 如果用户没有提供手机号,需要礼貌询问\n\n【重要】\n- **只响应最后一条用户消息**\n- **一次只调用一个函数**\n- 不要试图同时处理多个问题\n- 回答要简洁明了\n'}, {'role': 'assistant', 'content': '正在查询套餐信息'}, {'role': 'user', 'content': '查询我的流量使用情况'}]
2025-10-05 20:54:04.916 | INFO     | core.nlu.nlu_engine:_parse_response:189 - 解析响应=ChatCompletion(id='7421a87a-62c1-4b73-8d9d-bbf056b3f3cc', choices=[Choice(finish_reason='stop', index=0, logprobs=None, message=ChatCompletionMessage(content='您好！查询流量使用情况需要您的手机号码。请问您要查询哪个手机号的流量使用情况呢？', refusal=None, role='assistant', annotations=None, audio=None, function_call=None, tool_calls=None))], created=1759668844, model='deepseek-chat', object='chat.completion', service_tier=None, system_fingerprint='fp_ffc7281d48_prod0820_fp8_kvcache', usage=CompletionUsage(completion_tokens=23, prompt_tokens=1526, total_tokens=1549, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetails(audio_tokens=None, cached_tokens=1472), prompt_cache_hit_tokens=1472, prompt_cache_miss_tokens=54))
2025-10-05 20:54:04.917 | INFO     | core.nlu.nlu_engine:_parse_response:190 - 解析响应: tool_calls数量=0
2025-10-05 20:54:04.918 | INFO     | core.nlu.nlu_engine:_update_session:351 - [integration_test_004] 意图切换: query_packages -> chat
2025-10-05 20:54:04.918 | INFO     | core.nlu.nlu_engine:understand:105 - [integration_test_004] NLU完成: intent=chat
2025-10-05 20:54:45.026 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_004
2025-10-05 20:54:48.236 | DEBUG    | core.dst.state_store:_load_from_memory:118 - 从内存加载状态: integration_test_004
2025-10-05 20:56:21.004 | INFO     | database.db_manager:_initialize:38 - 数据库连接初始化成功
2025-10-05 20:56:21.004 | ERROR    | database.redis_manager:_initialize:45 - Redis连接池初始化失败: 'Settings' object has no attribute 'get'
2025-10-05 20:56:21.099 | INFO     | core.nlu.nlu_engine:__init__:53 - ✓ NLU引擎初始化成功: DeepSeek (deepseek-chat)
2025-10-05 20:56:21.099 | ERROR    | core.dst.state_store:__init__:28 - Redis初始化失败: Redis连接池未初始化, 使用内存存储
2025-10-05 20:56:21.099 | INFO     | core.dst.dialog_state_tracker:__init__:27 - 对话状态跟踪器初始化完成
2025-10-05 20:56:21.099 | INFO     | executor.db_executor:__init__:16 - 数据库执行器初始化完成
2025-10-05 20:56:21.099 | INFO     | core.chatbot_dst:__init__:23 - 第二阶段对话系统初始化完成（含DST支持）
2025-10-05 20:56:26.449 | INFO     | core.chatbot_dst:chat:46 - [integration_test_004] 收到用户输入: 100元以内的套餐
2025-10-05 20:56:37.274 | INFO     | core.nlu.nlu_engine:understand:73 - [integration_test_004] 开始NLU理解: 100元以内的套餐
2025-10-05 20:56:37.275 | DEBUG    | core.nlu.nlu_engine:understand:78 - [integration_test_004] 预处理后: 100元以内的套餐
2025-10-05 20:56:37.276 | DEBUG    | core.nlu.nlu_engine:_build_messages:162 - 构建的消息: ['system: 你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业...', 'user: 100元以内的套餐...']
2025-10-05 20:56:37.276 | INFO     | core.nlu.nlu_engine:understand:87 - 请求模型message=[{'role': 'system', 'content': '你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业务。\n\n【⭐⭐⭐ 最重要原则】\n- **只处理用户的最后一条消息**，忽略之前的所有用户消息\n- 如果看到多个用户消息，只响应最后一个\n- 每次只调用一个与最后一条用户消息相关的函数\n\n【你的职责】\n1. 理解用户的自然语言需求\n2. **必须**识别用户意图并调用相应的函数，不要进行闲聊\n3. 当信息不完整时,友好地向用户确认缺失的信息\n4. 用专业但亲切的语气与用户交流\n\n【当前可用套餐】\n- 经济套餐: 10G/月, 50元/月, 无限制人群\n- 畅游套餐: 100G/月, 180元/月, 无限制人群\n- 无限套餐: 1000G/月, 300元/月, 无限制人群\n- 校园套餐: 200G/月, 150元/月, 在校生专享\n\n【意图识别规则】\n1. 套餐查询类（query_packages）:\n   - "有什么套餐"、"推荐套餐"、"便宜的套餐"、"100元以内的套餐"\n   - 关键词：套餐、推荐、查询、有什么、价格、便宜\n\n2. 当前套餐查询（query_current_package）:\n   - "我的套餐"、"当前套餐"、"我用的什么套餐"\n   - 关键词：我的、当前、现在的\n\n3. 使用情况查询（query_usage）:  \n   - "用了多少流量"、"剩余流量"、"话费余额"、"查询余量"、"流量使用情况"\n   - 关键词：用了、剩余、余额、余量、流量使用、使用情况\n\n4. 套餐办理（change_package）:\n   - "办理XX套餐"、"换成XX套餐"、"我要办理"\n   - 关键词：办理、更换、变更\n\n【函数调用决策】\n重要：如果对话历史中有多个用户消息，只根据最后一条用户消息来判断意图！\n1. 识别**最后一条用户消息**的关键词\n2. 匹配最相关的单一函数\n3. 只调用该函数\n4. 忽略之前的用户消息\n\n【理解规则】\n- 价格表达要准确理解: "100块以内"→price_max=100, "50元以上"→price_min=50\n- "便宜点的"、"经济实惠"等模糊表达→sort_by="price_asc"\n- "学生套餐"、"校园"→target_user="在校生"\n- 如果用户没有提供手机号,需要礼貌询问\n\n【重要】\n- **只响应最后一条用户消息**\n- **一次只调用一个函数**\n- 不要试图同时处理多个问题\n- 回答要简洁明了\n'}, {'role': 'user', 'content': '100元以内的套餐'}]
2025-10-05 20:56:41.158 | INFO     | core.nlu.nlu_engine:_parse_response:189 - 解析响应=ChatCompletion(id='dab76581-decd-4f2f-8d67-b49b29b449e1', choices=[Choice(finish_reason='tool_calls', index=0, logprobs=None, message=ChatCompletionMessage(content='', refusal=None, role='assistant', annotations=None, audio=None, function_call=None, tool_calls=[ChatCompletionMessageFunctionToolCall(id='call_00_h10v1obLD7iITHSitBObEpkK', function=Function(arguments='{"price_max": 100, "sort_by": "price_asc"}', name='query_packages'), type='function', index=0)]))], created=1759669000, model='deepseek-chat', object='chat.completion', service_tier=None, system_fingerprint='fp_ffc7281d48_prod0820_fp8_kvcache', usage=CompletionUsage(completion_tokens=23, prompt_tokens=1521, total_tokens=1544, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetails(audio_tokens=None, cached_tokens=1472), prompt_cache_hit_tokens=1472, prompt_cache_miss_tokens=49))
2025-10-05 20:56:41.158 | INFO     | core.nlu.nlu_engine:_parse_response:190 - 解析响应: tool_calls数量=1
2025-10-05 20:56:41.158 | INFO     | core.nlu.nlu_engine:_update_session:351 - [integration_test_004] 意图切换: None -> query_packages
2025-10-05 20:56:41.158 | INFO     | core.nlu.nlu_engine:understand:105 - [integration_test_004] NLU完成: intent=query_packages
2025-10-05 20:56:46.207 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_004
2025-10-05 20:56:47.109 | DEBUG    | core.dst.state_store:_load_from_memory:121 - 内存中不存在会话: integration_test_004, 返回新状态
2025-10-05 20:56:47.110 | INFO     | core.dst.dialog_state_tracker:track:59 - 意图改变: None → query_packages
2025-10-05 20:56:47.110 | DEBUG    | core.dst.slot_manager:fill_slots:61 - 不同领域，仅保留用户信息: []
2025-10-05 20:56:47.111 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_004
2025-10-05 20:56:47.111 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=1, 需要澄清=False
2025-10-05 20:56:52.131 | INFO     | executor.db_executor:execute_function:29 - 执行Function: query_packages, 参数: {'price_max': 100, 'sort_by': 'price_asc'}
2025-10-05 20:56:53.068 | INFO     | executor.db_executor:execute_function:50 - Function执行成功: query_packages
2025-10-05 20:56:56.450 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_004
2025-10-05 20:56:56.450 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_004] 对话完成 | 意图: query_packages | 轮次: 2 | 耗时: 30001ms
2025-10-05 20:56:58.720 | INFO     | core.chatbot_dst:chat:46 - [integration_test_004] 收到用户输入: 查询我的流量使用情况
2025-10-05 20:56:58.720 | INFO     | core.nlu.nlu_engine:understand:73 - [integration_test_004] 开始NLU理解: 查询我的流量使用情况
2025-10-05 20:56:58.721 | DEBUG    | core.nlu.nlu_engine:understand:78 - [integration_test_004] 预处理后: 查询我的流量使用情况
2025-10-05 20:56:58.721 | DEBUG    | core.nlu.nlu_engine:_build_messages:162 - 构建的消息: ['system: 你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业...', 'assistant: 正在查询套餐信息...', 'user: 查询我的流量使用情况...']
2025-10-05 20:56:58.721 | INFO     | core.nlu.nlu_engine:understand:87 - 请求模型message=[{'role': 'system', 'content': '你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业务。\n\n【⭐⭐⭐ 最重要原则】\n- **只处理用户的最后一条消息**，忽略之前的所有用户消息\n- 如果看到多个用户消息，只响应最后一个\n- 每次只调用一个与最后一条用户消息相关的函数\n\n【你的职责】\n1. 理解用户的自然语言需求\n2. **必须**识别用户意图并调用相应的函数，不要进行闲聊\n3. 当信息不完整时,友好地向用户确认缺失的信息\n4. 用专业但亲切的语气与用户交流\n\n【当前可用套餐】\n- 经济套餐: 10G/月, 50元/月, 无限制人群\n- 畅游套餐: 100G/月, 180元/月, 无限制人群\n- 无限套餐: 1000G/月, 300元/月, 无限制人群\n- 校园套餐: 200G/月, 150元/月, 在校生专享\n\n【意图识别规则】\n1. 套餐查询类（query_packages）:\n   - "有什么套餐"、"推荐套餐"、"便宜的套餐"、"100元以内的套餐"\n   - 关键词：套餐、推荐、查询、有什么、价格、便宜\n\n2. 当前套餐查询（query_current_package）:\n   - "我的套餐"、"当前套餐"、"我用的什么套餐"\n   - 关键词：我的、当前、现在的\n\n3. 使用情况查询（query_usage）:  \n   - "用了多少流量"、"剩余流量"、"话费余额"、"查询余量"、"流量使用情况"\n   - 关键词：用了、剩余、余额、余量、流量使用、使用情况\n\n4. 套餐办理（change_package）:\n   - "办理XX套餐"、"换成XX套餐"、"我要办理"\n   - 关键词：办理、更换、变更\n\n【函数调用决策】\n重要：如果对话历史中有多个用户消息，只根据最后一条用户消息来判断意图！\n1. 识别**最后一条用户消息**的关键词\n2. 匹配最相关的单一函数\n3. 只调用该函数\n4. 忽略之前的用户消息\n\n【理解规则】\n- 价格表达要准确理解: "100块以内"→price_max=100, "50元以上"→price_min=50\n- "便宜点的"、"经济实惠"等模糊表达→sort_by="price_asc"\n- "学生套餐"、"校园"→target_user="在校生"\n- 如果用户没有提供手机号,需要礼貌询问\n\n【重要】\n- **只响应最后一条用户消息**\n- **一次只调用一个函数**\n- 不要试图同时处理多个问题\n- 回答要简洁明了\n'}, {'role': 'assistant', 'content': '正在查询套餐信息'}, {'role': 'user', 'content': '查询我的流量使用情况'}]
2025-10-05 20:57:01.462 | INFO     | core.nlu.nlu_engine:_parse_response:189 - 解析响应=ChatCompletion(id='5721a3fa-265d-482f-8896-af3d85be82d7', choices=[Choice(finish_reason='tool_calls', index=0, logprobs=None, message=ChatCompletionMessage(content='', refusal=None, role='assistant', annotations=None, audio=None, function_call=None, tool_calls=[ChatCompletionMessageFunctionToolCall(id='call_00_O4bXujAJd5G7vzq0QVrI3nyM', function=Function(arguments='{"phone": "", "query_type": "all"}', name='query_usage'), type='function', index=0)]))], created=1759669021, model='deepseek-chat', object='chat.completion', service_tier=None, system_fingerprint='fp_ffc7281d48_prod0820_fp8_kvcache', usage=CompletionUsage(completion_tokens=18, prompt_tokens=1527, total_tokens=1545, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetails(audio_tokens=None, cached_tokens=1472), prompt_cache_hit_tokens=1472, prompt_cache_miss_tokens=55))
2025-10-05 20:57:01.463 | INFO     | core.nlu.nlu_engine:_parse_response:190 - 解析响应: tool_calls数量=1
2025-10-05 20:57:01.464 | INFO     | core.nlu.nlu_engine:_update_session:351 - [integration_test_004] 意图切换: query_packages -> query_usage
2025-10-05 20:57:01.464 | INFO     | core.nlu.nlu_engine:understand:105 - [integration_test_004] NLU完成: intent=query_usage
2025-10-05 20:57:01.464 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_004
2025-10-05 20:57:01.464 | DEBUG    | core.dst.state_store:_load_from_memory:118 - 从内存加载状态: integration_test_004
2025-10-05 20:57:01.464 | INFO     | core.dst.dialog_state_tracker:track:59 - 意图改变: query_packages → query_usage
2025-10-05 20:57:01.465 | DEBUG    | core.dst.slot_manager:fill_slots:61 - 不同领域，仅保留用户信息: []
2025-10-05 20:57:01.465 | INFO     | core.dst.slot_manager:validate_slots:103 - 缺失槽位: ['phone']
2025-10-05 20:57:01.465 | INFO     | core.dst.dialog_state_tracker:_validate_slots:134 - 缺失必填槽位: ['phone']
2025-10-05 20:57:01.465 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_004
2025-10-05 20:57:01.465 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=3, 需要澄清=True
2025-10-05 20:57:01.465 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_004] 对话完成 | 意图: query_usage | 轮次: 3 | 耗时: 2745ms
2025-10-05 20:57:03.221 | INFO     | core.chatbot_dst:chat:46 - [integration_test_004] 收到用户输入: 查询我的流量使用情况
2025-10-05 20:57:07.073 | INFO     | core.nlu.nlu_engine:understand:73 - [integration_test_004] 开始NLU理解: 查询我的流量使用情况
2025-10-05 20:57:07.074 | DEBUG    | core.nlu.nlu_engine:understand:78 - [integration_test_004] 预处理后: 查询我的流量使用情况
2025-10-05 20:57:07.074 | DEBUG    | core.nlu.nlu_engine:_build_messages:162 - 构建的消息: ['system: 你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业...', 'assistant: 请问您的手机号码是多少呢？...', 'user: 查询我的流量使用情况...']
2025-10-05 20:57:07.074 | INFO     | core.nlu.nlu_engine:understand:87 - 请求模型message=[{'role': 'system', 'content': '你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业务。\n\n【⭐⭐⭐ 最重要原则】\n- **只处理用户的最后一条消息**，忽略之前的所有用户消息\n- 如果看到多个用户消息，只响应最后一个\n- 每次只调用一个与最后一条用户消息相关的函数\n\n【你的职责】\n1. 理解用户的自然语言需求\n2. **必须**识别用户意图并调用相应的函数，不要进行闲聊\n3. 当信息不完整时,友好地向用户确认缺失的信息\n4. 用专业但亲切的语气与用户交流\n\n【当前可用套餐】\n- 经济套餐: 10G/月, 50元/月, 无限制人群\n- 畅游套餐: 100G/月, 180元/月, 无限制人群\n- 无限套餐: 1000G/月, 300元/月, 无限制人群\n- 校园套餐: 200G/月, 150元/月, 在校生专享\n\n【意图识别规则】\n1. 套餐查询类（query_packages）:\n   - "有什么套餐"、"推荐套餐"、"便宜的套餐"、"100元以内的套餐"\n   - 关键词：套餐、推荐、查询、有什么、价格、便宜\n\n2. 当前套餐查询（query_current_package）:\n   - "我的套餐"、"当前套餐"、"我用的什么套餐"\n   - 关键词：我的、当前、现在的\n\n3. 使用情况查询（query_usage）:  \n   - "用了多少流量"、"剩余流量"、"话费余额"、"查询余量"、"流量使用情况"\n   - 关键词：用了、剩余、余额、余量、流量使用、使用情况\n\n4. 套餐办理（change_package）:\n   - "办理XX套餐"、"换成XX套餐"、"我要办理"\n   - 关键词：办理、更换、变更\n\n【函数调用决策】\n重要：如果对话历史中有多个用户消息，只根据最后一条用户消息来判断意图！\n1. 识别**最后一条用户消息**的关键词\n2. 匹配最相关的单一函数\n3. 只调用该函数\n4. 忽略之前的用户消息\n\n【理解规则】\n- 价格表达要准确理解: "100块以内"→price_max=100, "50元以上"→price_min=50\n- "便宜点的"、"经济实惠"等模糊表达→sort_by="price_asc"\n- "学生套餐"、"校园"→target_user="在校生"\n- 如果用户没有提供手机号,需要礼貌询问\n\n【重要】\n- **只响应最后一条用户消息**\n- **一次只调用一个函数**\n- 不要试图同时处理多个问题\n- 回答要简洁明了\n'}, {'role': 'assistant', 'content': '请问您的手机号码是多少呢？'}, {'role': 'user', 'content': '查询我的流量使用情况'}]
2025-10-05 20:57:09.432 | INFO     | core.nlu.nlu_engine:_parse_response:189 - 解析响应=ChatCompletion(id='ded03560-a471-4dea-9f4f-6b1c73485989', choices=[Choice(finish_reason='tool_calls', index=0, logprobs=None, message=ChatCompletionMessage(content='', refusal=None, role='assistant', annotations=None, audio=None, function_call=None, tool_calls=[ChatCompletionMessageFunctionToolCall(id='call_00_UxeFWyWcs6GUl2ptlJ31oxqw', function=Function(arguments='{"phone": "", "query_type": "all"}', name='query_usage'), type='function', index=0)]))], created=1759669029, model='deepseek-chat', object='chat.completion', service_tier=None, system_fingerprint='fp_ffc7281d48_prod0820_fp8_kvcache', usage=CompletionUsage(completion_tokens=18, prompt_tokens=1530, total_tokens=1548, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetails(audio_tokens=None, cached_tokens=1472), prompt_cache_hit_tokens=1472, prompt_cache_miss_tokens=58))
2025-10-05 20:57:09.433 | INFO     | core.nlu.nlu_engine:_parse_response:190 - 解析响应: tool_calls数量=1
2025-10-05 20:57:09.433 | INFO     | core.nlu.nlu_engine:understand:105 - [integration_test_004] NLU完成: intent=query_usage
2025-10-05 20:57:15.253 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_004
2025-10-05 20:57:15.836 | DEBUG    | core.dst.state_store:_load_from_memory:118 - 从内存加载状态: integration_test_004
2025-10-05 20:57:26.608 | DEBUG    | core.dst.slot_manager:fill_slots:43 - 意图不变，合并槽位: ['phone', 'query_type']
2025-10-05 20:57:26.609 | INFO     | core.dst.slot_manager:validate_slots:103 - 缺失槽位: ['phone']
2025-10-05 20:57:26.610 | INFO     | core.dst.dialog_state_tracker:_validate_slots:134 - 缺失必填槽位: ['phone']
2025-10-05 20:57:26.611 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_004
2025-10-05 20:57:26.612 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=4, 需要澄清=True
2025-10-05 20:57:26.613 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_004] 对话完成 | 意图: query_usage | 轮次: 4 | 耗时: 23392ms
2025-10-05 21:05:18.579 | INFO     | database.db_manager:_initialize:38 - 数据库连接初始化成功
2025-10-05 21:05:18.579 | ERROR    | database.redis_manager:_initialize:45 - Redis连接池初始化失败: 'Settings' object has no attribute 'get'
2025-10-05 21:05:18.673 | INFO     | core.nlu.nlu_engine:__init__:53 - ✓ NLU引擎初始化成功: DeepSeek (deepseek-chat)
2025-10-05 21:05:18.673 | ERROR    | core.dst.state_store:__init__:28 - Redis初始化失败: Redis连接池未初始化, 使用内存存储
2025-10-05 21:05:18.674 | INFO     | core.dst.dialog_state_tracker:__init__:27 - 对话状态跟踪器初始化完成
2025-10-05 21:05:18.674 | INFO     | executor.db_executor:__init__:16 - 数据库执行器初始化完成
2025-10-05 21:05:18.674 | INFO     | core.chatbot_dst:__init__:23 - 第二阶段对话系统初始化完成（含DST支持）
2025-10-05 21:05:23.639 | INFO     | core.chatbot_dst:chat:46 - [integration_test_001] 收到用户输入: 有100元以内的套餐吗
2025-10-05 21:05:26.836 | INFO     | core.nlu.nlu_engine:understand:73 - [integration_test_001] 开始NLU理解: 有100元以内的套餐吗
2025-10-05 21:05:26.836 | DEBUG    | core.nlu.nlu_engine:understand:78 - [integration_test_001] 预处理后: 有100元以内的套餐吗
2025-10-05 21:05:26.837 | DEBUG    | core.nlu.nlu_engine:_build_messages:162 - 构建的消息: ['system: 你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业...', 'user: 有100元以内的套餐吗...']
2025-10-05 21:05:26.837 | INFO     | core.nlu.nlu_engine:understand:87 - 请求模型message=[{'role': 'system', 'content': '你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业务。\n\n【⭐⭐⭐ 最重要原则】\n- **只处理用户的最后一条消息**，忽略之前的所有用户消息\n- 如果看到多个用户消息，只响应最后一个\n- 每次只调用一个与最后一条用户消息相关的函数\n\n【你的职责】\n1. 理解用户的自然语言需求\n2. **必须**识别用户意图并调用相应的函数，不要进行闲聊\n3. 当信息不完整时,友好地向用户确认缺失的信息\n4. 用专业但亲切的语气与用户交流\n\n【当前可用套餐】\n- 经济套餐: 10G/月, 50元/月, 无限制人群\n- 畅游套餐: 100G/月, 180元/月, 无限制人群\n- 无限套餐: 1000G/月, 300元/月, 无限制人群\n- 校园套餐: 200G/月, 150元/月, 在校生专享\n\n【意图识别规则】\n1. 套餐查询类（query_packages）:\n   - "有什么套餐"、"推荐套餐"、"便宜的套餐"、"100元以内的套餐"\n   - 关键词：套餐、推荐、查询、有什么、价格、便宜\n\n2. 当前套餐查询（query_current_package）:\n   - "我的套餐"、"当前套餐"、"我用的什么套餐"\n   - 关键词：我的、当前、现在的\n\n3. 使用情况查询（query_usage）:  \n   - "用了多少流量"、"剩余流量"、"话费余额"、"查询余量"、"流量使用情况"\n   - 关键词：用了、剩余、余额、余量、流量使用、使用情况\n\n4. 套餐办理（change_package）:\n   - "办理XX套餐"、"换成XX套餐"、"我要办理"\n   - 关键词：办理、更换、变更\n\n【函数调用决策】\n重要：如果对话历史中有多个用户消息，只根据最后一条用户消息来判断意图！\n1. 识别**最后一条用户消息**的关键词\n2. 匹配最相关的单一函数\n3. 只调用该函数\n4. 忽略之前的用户消息\n\n【理解规则】\n- 价格表达要准确理解: "100块以内"→price_max=100, "50元以上"→price_min=50\n- "便宜点的"、"经济实惠"等模糊表达→sort_by="price_asc"\n- "学生套餐"、"校园"→target_user="在校生"\n- 如果用户没有提供手机号,需要礼貌询问\n\n【重要】\n- **只响应最后一条用户消息**\n- **一次只调用一个函数**\n- 不要试图同时处理多个问题\n- 回答要简洁明了\n'}, {'role': 'user', 'content': '有100元以内的套餐吗'}]
2025-10-05 21:05:30.471 | INFO     | core.nlu.nlu_engine:_parse_response:189 - 解析响应=ChatCompletion(id='7c6973a6-35ae-4e69-83f9-b07851de1d09', choices=[Choice(finish_reason='tool_calls', index=0, logprobs=None, message=ChatCompletionMessage(content='', refusal=None, role='assistant', annotations=None, audio=None, function_call=None, tool_calls=[ChatCompletionMessageFunctionToolCall(id='call_00_jOnCJNnmqPdBxVBN8mjjxI8i', function=Function(arguments='{"price_max": 100, "sort_by": "price_asc"}', name='query_packages'), type='function', index=0)]))], created=1759669530, model='deepseek-chat', object='chat.completion', service_tier=None, system_fingerprint='fp_ffc7281d48_prod0820_fp8_kvcache', usage=CompletionUsage(completion_tokens=23, prompt_tokens=1523, total_tokens=1546, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetails(audio_tokens=None, cached_tokens=1472), prompt_cache_hit_tokens=1472, prompt_cache_miss_tokens=51))
2025-10-05 21:05:30.471 | INFO     | core.nlu.nlu_engine:_parse_response:190 - 解析响应: tool_calls数量=1
2025-10-05 21:05:30.471 | INFO     | core.nlu.nlu_engine:_update_session:351 - [integration_test_001] 意图切换: None -> query_packages
2025-10-05 21:05:30.471 | INFO     | core.nlu.nlu_engine:understand:105 - [integration_test_001] NLU完成: intent=query_packages
2025-10-05 21:05:47.095 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_001
2025-10-05 21:05:47.645 | DEBUG    | core.dst.state_store:_load_from_memory:121 - 内存中不存在会话: integration_test_001, 返回新状态
2025-10-05 21:06:02.500 | INFO     | core.dst.dialog_state_tracker:track:59 - 意图改变: None → query_packages
2025-10-05 21:06:02.502 | DEBUG    | core.dst.slot_manager:fill_slots:61 - 不同领域，仅保留用户信息: []
2025-10-05 21:06:02.502 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_001
2025-10-05 21:06:02.502 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=1, 需要澄清=False
2025-10-05 21:06:07.865 | INFO     | executor.db_executor:execute_function:29 - 执行Function: query_packages, 参数: {'price_max': 100, 'sort_by': 'price_asc'}
2025-10-05 21:06:08.949 | INFO     | executor.db_executor:execute_function:50 - Function执行成功: query_packages
2025-10-05 21:06:08.951 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_001
2025-10-05 21:06:08.952 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_001] 对话完成 | 意图: query_packages | 轮次: 2 | 耗时: 45312ms
2025-10-05 21:06:08.953 | INFO     | tests.test_integration:test_multi_turn_conversation:74 - 第一轮返回结果: {'session_id': 'integration_test_001', 'response': '为您找到 1 个合适的套餐:\n\n【经济套餐】\n  💰 月费: 50.0元\n  📊 流量: 10GB/月\n  📞 通话: 100分钟/月\n  👥 适用: 无限制\n  📝 适合轻度上网用户,性价比高,包含10GB流量和100分钟通话\n\n如需办理或了解详情,请告诉我套餐名称和您的手机号码。', 'intent': 'query_packages', 'function': 'query_packages', 'parameters': {'price_max': 100, 'sort_by': 'price_asc'}, 'data': {'success': True, 'data': [{'id': 1, 'name': '经济套餐', 'data_gb': 10, 'voice_minutes': 100, 'price': 50.0, 'target_user': '无限制', 'description': '适合轻度上网用户,性价比高,包含10GB流量和100分钟通话'}], 'count': 1}, 'requires_input': False, 'state': {'session_id': 'integration_test_001', 'user_phone': None, 'user_name': None, 'current_intent': 'query_packages', 'previous_intent': None, 'slots': {'price_max': 100, 'sort_by': 'price_asc'}, 'history': [{'turn_id': 1, 'role': 'user', 'content': '有100元以内的套餐吗', 'intent': 'query_packages', 'entities': {}, 'timestamp': '2025-10-05T21:05:49.329371'}, {'turn_id': 2, 'role': 'assistant', 'content': '为您找到 1 个合适的套餐:\n\n【经济套餐】\n  💰 月费: 50.0元\n  📊 流量: 10GB/月\n  📞 通话: 100分钟/月\n  👥 适用: 无限制\n  📝 适合轻度上网用户,性价比高,包含10GB流量和100分钟通话\n\n如需办理或了解详情,请告诉我套餐名称和您的手机号码。', 'intent': None, 'entities': {}, 'timestamp': '2025-10-05T21:06:08.951357'}], 'context_stack': [{'intent': 'query_packages', 'parameters': {'price_max': 100, 'sort_by': 'price_asc'}, 'confidence': 0.9, 'timestamp': datetime.datetime(2025, 10, 5, 21, 6, 2, 502459), 'turn_id': 1}], 'turn_count': 2, 'created_at': '2025-10-05T21:05:47.645729', 'updated_at': '2025-10-05T21:06:08.951379', 'is_completed': False, 'needs_clarification': False, 'missing_slots': [], 'user_profile': {}}, 'timestamp': '2025-10-05T21:06:08.952283'}
2025-10-05 21:06:12.279 | INFO     | core.chatbot_dst:chat:46 - [integration_test_001] 收到用户输入: 流量要50G以上
2025-10-05 21:06:16.798 | INFO     | core.nlu.nlu_engine:understand:73 - [integration_test_001] 开始NLU理解: 流量要50G以上
2025-10-05 21:06:16.799 | DEBUG    | core.nlu.nlu_engine:understand:78 - [integration_test_001] 预处理后: 流量要50G以上
2025-10-05 21:06:16.799 | DEBUG    | core.nlu.nlu_engine:_build_messages:162 - 构建的消息: ['system: 你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业...', 'assistant: 正在查询套餐信息...', 'user: 流量要50G以上...']
2025-10-05 21:06:16.800 | INFO     | core.nlu.nlu_engine:understand:87 - 请求模型message=[{'role': 'system', 'content': '你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业务。\n\n【⭐⭐⭐ 最重要原则】\n- **只处理用户的最后一条消息**，忽略之前的所有用户消息\n- 如果看到多个用户消息，只响应最后一个\n- 每次只调用一个与最后一条用户消息相关的函数\n\n【你的职责】\n1. 理解用户的自然语言需求\n2. **必须**识别用户意图并调用相应的函数，不要进行闲聊\n3. 当信息不完整时,友好地向用户确认缺失的信息\n4. 用专业但亲切的语气与用户交流\n\n【当前可用套餐】\n- 经济套餐: 10G/月, 50元/月, 无限制人群\n- 畅游套餐: 100G/月, 180元/月, 无限制人群\n- 无限套餐: 1000G/月, 300元/月, 无限制人群\n- 校园套餐: 200G/月, 150元/月, 在校生专享\n\n【意图识别规则】\n1. 套餐查询类（query_packages）:\n   - "有什么套餐"、"推荐套餐"、"便宜的套餐"、"100元以内的套餐"\n   - 关键词：套餐、推荐、查询、有什么、价格、便宜\n\n2. 当前套餐查询（query_current_package）:\n   - "我的套餐"、"当前套餐"、"我用的什么套餐"\n   - 关键词：我的、当前、现在的\n\n3. 使用情况查询（query_usage）:  \n   - "用了多少流量"、"剩余流量"、"话费余额"、"查询余量"、"流量使用情况"\n   - 关键词：用了、剩余、余额、余量、流量使用、使用情况\n\n4. 套餐办理（change_package）:\n   - "办理XX套餐"、"换成XX套餐"、"我要办理"\n   - 关键词：办理、更换、变更\n\n【函数调用决策】\n重要：如果对话历史中有多个用户消息，只根据最后一条用户消息来判断意图！\n1. 识别**最后一条用户消息**的关键词\n2. 匹配最相关的单一函数\n3. 只调用该函数\n4. 忽略之前的用户消息\n\n【理解规则】\n- 价格表达要准确理解: "100块以内"→price_max=100, "50元以上"→price_min=50\n- "便宜点的"、"经济实惠"等模糊表达→sort_by="price_asc"\n- "学生套餐"、"校园"→target_user="在校生"\n- 如果用户没有提供手机号,需要礼貌询问\n\n【重要】\n- **只响应最后一条用户消息**\n- **一次只调用一个函数**\n- 不要试图同时处理多个问题\n- 回答要简洁明了\n'}, {'role': 'assistant', 'content': '正在查询套餐信息'}, {'role': 'user', 'content': '流量要50G以上'}]
2025-10-05 21:06:20.745 | INFO     | core.nlu.nlu_engine:_parse_response:189 - 解析响应=ChatCompletion(id='b1123f8a-326a-47a7-850d-7b2b0ea8eefd', choices=[Choice(finish_reason='tool_calls', index=0, logprobs=None, message=ChatCompletionMessage(content='', refusal=None, role='assistant', annotations=None, audio=None, function_call=None, tool_calls=[ChatCompletionMessageFunctionToolCall(id='call_00_MduFmUyVemrlHok4rLpOfqO7', function=Function(arguments='{"data_min": 50, "sort_by": "price_asc"}', name='query_packages'), type='function', index=0)]))], created=1759669579, model='deepseek-chat', object='chat.completion', service_tier=None, system_fingerprint='fp_ffc7281d48_prod0820_fp8_kvcache', usage=CompletionUsage(completion_tokens=23, prompt_tokens=1527, total_tokens=1550, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetails(audio_tokens=None, cached_tokens=1472), prompt_cache_hit_tokens=1472, prompt_cache_miss_tokens=55))
2025-10-05 21:06:20.745 | INFO     | core.nlu.nlu_engine:_parse_response:190 - 解析响应: tool_calls数量=1
2025-10-05 21:06:20.746 | INFO     | core.nlu.nlu_engine:understand:105 - [integration_test_001] NLU完成: intent=query_packages
2025-10-05 21:06:37.773 | INFO     | core.nlu.nlu_engine:understand:73 - [integration_test_001] 开始NLU理解: 流量要50G以上
2025-10-05 21:06:37.774 | DEBUG    | core.nlu.nlu_engine:understand:78 - [integration_test_001] 预处理后: 流量要50G以上
2025-10-05 21:07:13.530 | DEBUG    | core.nlu.nlu_engine:_build_messages:162 - 构建的消息: ['system: 你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业...', 'assistant: 正在查询套餐信息...', 'user: 流量要50G以上...']
2025-10-05 21:07:20.215 | INFO     | core.nlu.nlu_engine:understand:87 - 请求模型message=[{'role': 'system', 'content': '你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业务。\n\n【⭐⭐⭐ 最重要原则】\n- **只处理用户的最后一条消息**，忽略之前的所有用户消息\n- 如果看到多个用户消息，只响应最后一个\n- 每次只调用一个与最后一条用户消息相关的函数\n\n【你的职责】\n1. 理解用户的自然语言需求\n2. **必须**识别用户意图并调用相应的函数，不要进行闲聊\n3. 当信息不完整时,友好地向用户确认缺失的信息\n4. 用专业但亲切的语气与用户交流\n\n【当前可用套餐】\n- 经济套餐: 10G/月, 50元/月, 无限制人群\n- 畅游套餐: 100G/月, 180元/月, 无限制人群\n- 无限套餐: 1000G/月, 300元/月, 无限制人群\n- 校园套餐: 200G/月, 150元/月, 在校生专享\n\n【意图识别规则】\n1. 套餐查询类（query_packages）:\n   - "有什么套餐"、"推荐套餐"、"便宜的套餐"、"100元以内的套餐"\n   - 关键词：套餐、推荐、查询、有什么、价格、便宜\n\n2. 当前套餐查询（query_current_package）:\n   - "我的套餐"、"当前套餐"、"我用的什么套餐"\n   - 关键词：我的、当前、现在的\n\n3. 使用情况查询（query_usage）:  \n   - "用了多少流量"、"剩余流量"、"话费余额"、"查询余量"、"流量使用情况"\n   - 关键词：用了、剩余、余额、余量、流量使用、使用情况\n\n4. 套餐办理（change_package）:\n   - "办理XX套餐"、"换成XX套餐"、"我要办理"\n   - 关键词：办理、更换、变更\n\n【函数调用决策】\n重要：如果对话历史中有多个用户消息，只根据最后一条用户消息来判断意图！\n1. 识别**最后一条用户消息**的关键词\n2. 匹配最相关的单一函数\n3. 只调用该函数\n4. 忽略之前的用户消息\n\n【理解规则】\n- 价格表达要准确理解: "100块以内"→price_max=100, "50元以上"→price_min=50\n- "便宜点的"、"经济实惠"等模糊表达→sort_by="price_asc"\n- "学生套餐"、"校园"→target_user="在校生"\n- 如果用户没有提供手机号,需要礼貌询问\n\n【重要】\n- **只响应最后一条用户消息**\n- **一次只调用一个函数**\n- 不要试图同时处理多个问题\n- 回答要简洁明了\n'}, {'role': 'assistant', 'content': '正在查询套餐信息'}, {'role': 'user', 'content': '流量要50G以上'}]
2025-10-05 21:07:22.701 | INFO     | core.nlu.nlu_engine:_parse_response:189 - 解析响应=ChatCompletion(id='d6913749-f900-4516-afa9-be215b79f606', choices=[Choice(finish_reason='tool_calls', index=0, logprobs=None, message=ChatCompletionMessage(content='', refusal=None, role='assistant', annotations=None, audio=None, function_call=None, tool_calls=[ChatCompletionMessageFunctionToolCall(id='call_00_2V95XygDiNKAXSnXfnmrFoJ2', function=Function(arguments='{"data_min": 50, "sort_by": "price_asc"}', name='query_packages'), type='function', index=0)]))], created=1759669642, model='deepseek-chat', object='chat.completion', service_tier=None, system_fingerprint='fp_ffc7281d48_prod0820_fp8_kvcache', usage=CompletionUsage(completion_tokens=23, prompt_tokens=1527, total_tokens=1550, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetails(audio_tokens=None, cached_tokens=1472), prompt_cache_hit_tokens=1472, prompt_cache_miss_tokens=55))
2025-10-05 21:07:22.702 | INFO     | core.nlu.nlu_engine:_parse_response:190 - 解析响应: tool_calls数量=1
2025-10-05 21:07:22.703 | INFO     | core.nlu.nlu_engine:understand:105 - [integration_test_001] NLU完成: intent=query_packages
2025-10-05 21:07:27.580 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_001
2025-10-05 21:07:28.179 | DEBUG    | core.dst.state_store:_load_from_memory:118 - 从内存加载状态: integration_test_001
2025-10-05 21:07:43.089 | DEBUG    | core.dst.slot_manager:fill_slots:43 - 意图不变，合并槽位: ['data_min', 'sort_by']
2025-10-05 21:07:57.795 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_001
2025-10-05 21:07:57.796 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=3, 需要澄清=False
2025-10-05 21:07:59.914 | INFO     | executor.db_executor:execute_function:29 - 执行Function: query_packages, 参数: {'price_max': 100, 'sort_by': 'price_asc', 'data_min': 50}
2025-10-05 21:08:00.585 | INFO     | executor.db_executor:execute_function:50 - Function执行成功: query_packages
2025-10-05 21:08:00.586 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_001
2025-10-05 21:08:00.588 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_001] 对话完成 | 意图: query_packages | 轮次: 4 | 耗时: 108309ms
2025-10-05 21:08:00.589 | INFO     | tests.test_integration:test_multi_turn_conversation:86 - 第二轮返回结果: {'session_id': 'integration_test_001', 'user_phone': None, 'user_name': None, 'current_intent': 'query_packages', 'previous_intent': 'query_packages', 'slots': {'price_max': 100, 'sort_by': 'price_asc', 'data_min': 50}, 'history': [{'turn_id': 1, 'role': 'user', 'content': '有100元以内的套餐吗', 'intent': 'query_packages', 'entities': {}, 'timestamp': '2025-10-05T21:05:49.329371'}, {'turn_id': 2, 'role': 'assistant', 'content': '为您找到 1 个合适的套餐:\n\n【经济套餐】\n  💰 月费: 50.0元\n  📊 流量: 10GB/月\n  📞 通话: 100分钟/月\n  👥 适用: 无限制\n  📝 适合轻度上网用户,性价比高,包含10GB流量和100分钟通话\n\n如需办理或了解详情,请告诉我套餐名称和您的手机号码。', 'intent': None, 'entities': {}, 'timestamp': '2025-10-05T21:06:08.951357'}, {'turn_id': 3, 'role': 'user', 'content': '流量要50G以上', 'intent': 'query_packages', 'entities': {}, 'timestamp': '2025-10-05T21:07:30.664151'}, {'turn_id': 4, 'role': 'assistant', 'content': '抱歉,没有找到符合条件的套餐。要不要看看其他套餐?', 'intent': None, 'entities': {}, 'timestamp': '2025-10-05T21:08:00.586790'}], 'context_stack': [{'intent': 'query_packages', 'parameters': {'price_max': 100, 'sort_by': 'price_asc'}, 'confidence': 0.9, 'timestamp': datetime.datetime(2025, 10, 5, 21, 6, 2, 502459), 'turn_id': 1}, {'intent': 'query_packages', 'parameters': {'data_min': 50, 'sort_by': 'price_asc'}, 'confidence': 0.9, 'timestamp': datetime.datetime(2025, 10, 5, 21, 7, 57, 794779), 'turn_id': 2}], 'turn_count': 4, 'created_at': '2025-10-05T21:05:47.645729', 'updated_at': '2025-10-05T21:08:00.586813', 'is_completed': False, 'needs_clarification': False, 'missing_slots': [], 'user_profile': {}}
2025-10-05 21:12:11.816 | INFO     | database.db_manager:_initialize:38 - 数据库连接初始化成功
2025-10-05 21:12:11.816 | ERROR    | database.redis_manager:_initialize:45 - Redis连接池初始化失败: 'Settings' object has no attribute 'get'
2025-10-05 21:12:11.914 | INFO     | core.nlu.nlu_engine:__init__:53 - ✓ NLU引擎初始化成功: DeepSeek (deepseek-chat)
2025-10-05 21:12:11.914 | ERROR    | core.dst.state_store:__init__:28 - Redis初始化失败: Redis连接池未初始化, 使用内存存储
2025-10-05 21:12:11.914 | INFO     | core.dst.dialog_state_tracker:__init__:27 - 对话状态跟踪器初始化完成
2025-10-05 21:12:11.914 | INFO     | executor.db_executor:__init__:16 - 数据库执行器初始化完成
2025-10-05 21:12:11.915 | INFO     | core.chatbot_dst:__init__:23 - 第二阶段对话系统初始化完成（含DST支持）
2025-10-05 21:12:15.498 | INFO     | core.chatbot_dst:chat:46 - [integration_test_0002] 收到用户输入: 查下我的套餐
2025-10-05 21:12:17.192 | INFO     | core.nlu.nlu_engine:understand:73 - [integration_test_0002] 开始NLU理解: 查下我的套餐
2025-10-05 21:12:17.193 | DEBUG    | core.nlu.nlu_engine:understand:78 - [integration_test_0002] 预处理后: 查下我的套餐
2025-10-05 21:12:22.176 | DEBUG    | core.nlu.nlu_engine:_build_messages:162 - 构建的消息: ['system: 你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业...', 'user: 查下我的套餐...']
2025-10-05 21:12:22.177 | INFO     | core.nlu.nlu_engine:understand:87 - 请求模型message=[{'role': 'system', 'content': '你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业务。\n\n【⭐⭐⭐ 最重要原则】\n- **只处理用户的最后一条消息**，忽略之前的所有用户消息\n- 如果看到多个用户消息，只响应最后一个\n- 每次只调用一个与最后一条用户消息相关的函数\n\n【你的职责】\n1. 理解用户的自然语言需求\n2. **必须**识别用户意图并调用相应的函数，不要进行闲聊\n3. 当信息不完整时,友好地向用户确认缺失的信息\n4. 用专业但亲切的语气与用户交流\n\n【当前可用套餐】\n- 经济套餐: 10G/月, 50元/月, 无限制人群\n- 畅游套餐: 100G/月, 180元/月, 无限制人群\n- 无限套餐: 1000G/月, 300元/月, 无限制人群\n- 校园套餐: 200G/月, 150元/月, 在校生专享\n\n【意图识别规则】\n1. 套餐查询类（query_packages）:\n   - "有什么套餐"、"推荐套餐"、"便宜的套餐"、"100元以内的套餐"\n   - 关键词：套餐、推荐、查询、有什么、价格、便宜\n\n2. 当前套餐查询（query_current_package）:\n   - "我的套餐"、"当前套餐"、"我用的什么套餐"\n   - 关键词：我的、当前、现在的\n\n3. 使用情况查询（query_usage）:  \n   - "用了多少流量"、"剩余流量"、"话费余额"、"查询余量"、"流量使用情况"\n   - 关键词：用了、剩余、余额、余量、流量使用、使用情况\n\n4. 套餐办理（change_package）:\n   - "办理XX套餐"、"换成XX套餐"、"我要办理"\n   - 关键词：办理、更换、变更\n\n【函数调用决策】\n重要：如果对话历史中有多个用户消息，只根据最后一条用户消息来判断意图！\n1. 识别**最后一条用户消息**的关键词\n2. 匹配最相关的单一函数\n3. 只调用该函数\n4. 忽略之前的用户消息\n\n【理解规则】\n- 价格表达要准确理解: "100块以内"→price_max=100, "50元以上"→price_min=50\n- "便宜点的"、"经济实惠"等模糊表达→sort_by="price_asc"\n- "学生套餐"、"校园"→target_user="在校生"\n- 如果用户没有提供手机号,需要礼貌询问\n\n【重要】\n- **只响应最后一条用户消息**\n- **一次只调用一个函数**\n- 不要试图同时处理多个问题\n- 回答要简洁明了\n'}, {'role': 'user', 'content': '查下我的套餐'}]
2025-10-05 21:12:26.380 | INFO     | core.nlu.nlu_engine:_parse_response:189 - 解析响应=ChatCompletion(id='59892a64-18ae-44bc-896c-92869043ccf3', choices=[Choice(finish_reason='tool_calls', index=0, logprobs=None, message=ChatCompletionMessage(content='', refusal=None, role='assistant', annotations=None, audio=None, function_call=None, tool_calls=[ChatCompletionMessageFunctionToolCall(id='call_00_Cue1OHwdh7UAOfK5zZGiJuTI', function=Function(arguments='{"phone": "13800138000"}', name='query_current_package'), type='function', index=0)]))], created=1759669945, model='deepseek-chat', object='chat.completion', service_tier=None, system_fingerprint='fp_ffc7281d48_prod0820_fp8_kvcache', usage=CompletionUsage(completion_tokens=17, prompt_tokens=1521, total_tokens=1538, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetails(audio_tokens=None, cached_tokens=1472), prompt_cache_hit_tokens=1472, prompt_cache_miss_tokens=49))
2025-10-05 21:12:26.380 | INFO     | core.nlu.nlu_engine:_parse_response:190 - 解析响应: tool_calls数量=1
2025-10-05 21:12:26.381 | INFO     | core.nlu.nlu_engine:_update_session:351 - [integration_test_0002] 意图切换: None -> query_current_package
2025-10-05 21:12:26.381 | INFO     | core.nlu.nlu_engine:understand:105 - [integration_test_0002] NLU完成: intent=query_current_package
2025-10-05 21:12:57.275 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_0002
2025-10-05 21:12:58.009 | DEBUG    | core.dst.state_store:_load_from_memory:121 - 内存中不存在会话: integration_test_0002, 返回新状态
2025-10-05 21:12:58.010 | INFO     | core.dst.dialog_state_tracker:track:59 - 意图改变: None → query_current_package
2025-10-05 21:12:58.010 | DEBUG    | core.dst.slot_manager:fill_slots:61 - 不同领域，仅保留用户信息: []
2025-10-05 21:13:07.830 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_0002
2025-10-05 21:13:07.830 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=1, 需要澄清=False
2025-10-05 21:13:09.935 | INFO     | executor.db_executor:execute_function:29 - 执行Function: query_current_package, 参数: {'phone': '13800138000'}
2025-10-05 21:13:12.801 | INFO     | executor.db_executor:execute_function:50 - Function执行成功: query_current_package
2025-10-05 21:13:12.801 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_0002
2025-10-05 21:13:12.801 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_0002] 对话完成 | 意图: query_current_package | 轮次: 2 | 耗时: 57304ms
2025-10-05 21:13:49.519 | INFO     | database.db_manager:_initialize:38 - 数据库连接初始化成功
2025-10-05 21:13:49.520 | ERROR    | database.redis_manager:_initialize:45 - Redis连接池初始化失败: 'Settings' object has no attribute 'get'
2025-10-05 21:13:49.620 | INFO     | core.nlu.nlu_engine:__init__:53 - ✓ NLU引擎初始化成功: DeepSeek (deepseek-chat)
2025-10-05 21:13:49.620 | ERROR    | core.dst.state_store:__init__:28 - Redis初始化失败: Redis连接池未初始化, 使用内存存储
2025-10-05 21:13:49.620 | INFO     | core.dst.dialog_state_tracker:__init__:27 - 对话状态跟踪器初始化完成
2025-10-05 21:13:49.620 | INFO     | executor.db_executor:__init__:16 - 数据库执行器初始化完成
2025-10-05 21:13:49.620 | INFO     | core.chatbot_dst:__init__:23 - 第二阶段对话系统初始化完成（含DST支持）
2025-10-05 21:13:51.821 | INFO     | core.chatbot_dst:chat:46 - [integration_test_0004] 收到用户输入: 查下我的套餐
2025-10-05 21:13:52.527 | INFO     | core.nlu.nlu_engine:understand:73 - [integration_test_0004] 开始NLU理解: 查下我的套餐
2025-10-05 21:13:52.527 | DEBUG    | core.nlu.nlu_engine:understand:78 - [integration_test_0004] 预处理后: 查下我的套餐
2025-10-05 21:13:52.527 | DEBUG    | core.nlu.nlu_engine:_build_messages:162 - 构建的消息: ['system: 你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业...', 'user: 查下我的套餐...']
2025-10-05 21:13:52.527 | INFO     | core.nlu.nlu_engine:understand:87 - 请求模型message=[{'role': 'system', 'content': '你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业务。\n\n【⭐⭐⭐ 最重要原则】\n- **只处理用户的最后一条消息**，忽略之前的所有用户消息\n- 如果看到多个用户消息，只响应最后一个\n- 每次只调用一个与最后一条用户消息相关的函数\n\n【你的职责】\n1. 理解用户的自然语言需求\n2. **必须**识别用户意图并调用相应的函数，不要进行闲聊\n3. 当信息不完整时,友好地向用户确认缺失的信息\n4. 用专业但亲切的语气与用户交流\n\n【当前可用套餐】\n- 经济套餐: 10G/月, 50元/月, 无限制人群\n- 畅游套餐: 100G/月, 180元/月, 无限制人群\n- 无限套餐: 1000G/月, 300元/月, 无限制人群\n- 校园套餐: 200G/月, 150元/月, 在校生专享\n\n【意图识别规则】\n1. 套餐查询类（query_packages）:\n   - "有什么套餐"、"推荐套餐"、"便宜的套餐"、"100元以内的套餐"\n   - 关键词：套餐、推荐、查询、有什么、价格、便宜\n\n2. 当前套餐查询（query_current_package）:\n   - "我的套餐"、"当前套餐"、"我用的什么套餐"\n   - 关键词：我的、当前、现在的\n\n3. 使用情况查询（query_usage）:  \n   - "用了多少流量"、"剩余流量"、"话费余额"、"查询余量"、"流量使用情况"\n   - 关键词：用了、剩余、余额、余量、流量使用、使用情况\n\n4. 套餐办理（change_package）:\n   - "办理XX套餐"、"换成XX套餐"、"我要办理"\n   - 关键词：办理、更换、变更\n\n【函数调用决策】\n重要：如果对话历史中有多个用户消息，只根据最后一条用户消息来判断意图！\n1. 识别**最后一条用户消息**的关键词\n2. 匹配最相关的单一函数\n3. 只调用该函数\n4. 忽略之前的用户消息\n\n【理解规则】\n- 价格表达要准确理解: "100块以内"→price_max=100, "50元以上"→price_min=50\n- "便宜点的"、"经济实惠"等模糊表达→sort_by="price_asc"\n- "学生套餐"、"校园"→target_user="在校生"\n- 如果用户没有提供手机号,需要礼貌询问\n\n【重要】\n- **只响应最后一条用户消息**\n- **一次只调用一个函数**\n- 不要试图同时处理多个问题\n- 回答要简洁明了\n'}, {'role': 'user', 'content': '查下我的套餐'}]
2025-10-05 21:13:55.875 | INFO     | core.nlu.nlu_engine:_parse_response:189 - 解析响应=ChatCompletion(id='5a397960-4f46-4ac3-acf9-6fc64422fc32', choices=[Choice(finish_reason='tool_calls', index=0, logprobs=None, message=ChatCompletionMessage(content='', refusal=None, role='assistant', annotations=None, audio=None, function_call=None, tool_calls=[ChatCompletionMessageFunctionToolCall(id='call_00_XchMSqyxO9DNDD7AGsJ2W13t', function=Function(arguments='{"phone": "13800138000"}', name='query_current_package'), type='function', index=0)]))], created=1759670035, model='deepseek-chat', object='chat.completion', service_tier=None, system_fingerprint='fp_ffc7281d48_prod0820_fp8_kvcache', usage=CompletionUsage(completion_tokens=17, prompt_tokens=1521, total_tokens=1538, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetails(audio_tokens=None, cached_tokens=1472), prompt_cache_hit_tokens=1472, prompt_cache_miss_tokens=49))
2025-10-05 21:13:55.875 | INFO     | core.nlu.nlu_engine:_parse_response:190 - 解析响应: tool_calls数量=1
2025-10-05 21:13:55.875 | INFO     | core.nlu.nlu_engine:_update_session:351 - [integration_test_0004] 意图切换: None -> query_current_package
2025-10-05 21:13:55.875 | INFO     | core.nlu.nlu_engine:understand:105 - [integration_test_0004] NLU完成: intent=query_current_package
2025-10-05 21:14:33.906 | INFO     | database.db_manager:_initialize:38 - 数据库连接初始化成功
2025-10-05 21:14:33.907 | ERROR    | database.redis_manager:_initialize:45 - Redis连接池初始化失败: 'Settings' object has no attribute 'get'
2025-10-05 21:14:33.963 | INFO     | core.nlu.nlu_engine:__init__:53 - ✓ NLU引擎初始化成功: DeepSeek (deepseek-chat)
2025-10-05 21:14:33.963 | ERROR    | core.dst.state_store:__init__:28 - Redis初始化失败: Redis连接池未初始化, 使用内存存储
2025-10-05 21:14:33.963 | INFO     | core.dst.dialog_state_tracker:__init__:27 - 对话状态跟踪器初始化完成
2025-10-05 21:14:33.963 | INFO     | executor.db_executor:__init__:16 - 数据库执行器初始化完成
2025-10-05 21:14:33.963 | INFO     | core.chatbot_dst:__init__:23 - 第二阶段对话系统初始化完成（含DST支持）
2025-10-05 21:14:33.963 | INFO     | core.chatbot_dst:chat:46 - [integration_test_0004] 收到用户输入: 查下我的套餐
2025-10-05 21:14:33.963 | INFO     | core.nlu.nlu_engine:understand:73 - [integration_test_0004] 开始NLU理解: 查下我的套餐
2025-10-05 21:14:33.963 | DEBUG    | core.nlu.nlu_engine:understand:78 - [integration_test_0004] 预处理后: 查下我的套餐
2025-10-05 21:14:33.963 | DEBUG    | core.nlu.nlu_engine:_build_messages:162 - 构建的消息: ['system: 你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业...', 'user: 查下我的套餐...']
2025-10-05 21:14:33.963 | INFO     | core.nlu.nlu_engine:understand:87 - 请求模型message=[{'role': 'system', 'content': '你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业务。\n\n【⭐⭐⭐ 最重要原则】\n- **只处理用户的最后一条消息**，忽略之前的所有用户消息\n- 如果看到多个用户消息，只响应最后一个\n- 每次只调用一个与最后一条用户消息相关的函数\n\n【你的职责】\n1. 理解用户的自然语言需求\n2. **必须**识别用户意图并调用相应的函数，不要进行闲聊\n3. 当信息不完整时,友好地向用户确认缺失的信息\n4. 用专业但亲切的语气与用户交流\n\n【当前可用套餐】\n- 经济套餐: 10G/月, 50元/月, 无限制人群\n- 畅游套餐: 100G/月, 180元/月, 无限制人群\n- 无限套餐: 1000G/月, 300元/月, 无限制人群\n- 校园套餐: 200G/月, 150元/月, 在校生专享\n\n【意图识别规则】\n1. 套餐查询类（query_packages）:\n   - "有什么套餐"、"推荐套餐"、"便宜的套餐"、"100元以内的套餐"\n   - 关键词：套餐、推荐、查询、有什么、价格、便宜\n\n2. 当前套餐查询（query_current_package）:\n   - "我的套餐"、"当前套餐"、"我用的什么套餐"\n   - 关键词：我的、当前、现在的\n\n3. 使用情况查询（query_usage）:  \n   - "用了多少流量"、"剩余流量"、"话费余额"、"查询余量"、"流量使用情况"\n   - 关键词：用了、剩余、余额、余量、流量使用、使用情况\n\n4. 套餐办理（change_package）:\n   - "办理XX套餐"、"换成XX套餐"、"我要办理"\n   - 关键词：办理、更换、变更\n\n【函数调用决策】\n重要：如果对话历史中有多个用户消息，只根据最后一条用户消息来判断意图！\n1. 识别**最后一条用户消息**的关键词\n2. 匹配最相关的单一函数\n3. 只调用该函数\n4. 忽略之前的用户消息\n\n【理解规则】\n- 价格表达要准确理解: "100块以内"→price_max=100, "50元以上"→price_min=50\n- "便宜点的"、"经济实惠"等模糊表达→sort_by="price_asc"\n- "学生套餐"、"校园"→target_user="在校生"\n- 如果用户没有提供手机号,需要礼貌询问\n\n【重要】\n- **只响应最后一条用户消息**\n- **一次只调用一个函数**\n- 不要试图同时处理多个问题\n- 回答要简洁明了\n'}, {'role': 'user', 'content': '查下我的套餐'}]
2025-10-05 21:14:37.905 | INFO     | core.nlu.nlu_engine:_parse_response:189 - 解析响应=ChatCompletion(id='5c55d434-1658-4333-95f9-2d8dd0096f82', choices=[Choice(finish_reason='tool_calls', index=0, logprobs=None, message=ChatCompletionMessage(content='', refusal=None, role='assistant', annotations=None, audio=None, function_call=None, tool_calls=[ChatCompletionMessageFunctionToolCall(id='call_00_CQPapXTDuAxXNnbquGK94DL8', function=Function(arguments='{"phone": ""}', name='query_current_package'), type='function', index=0)]))], created=1759670076, model='deepseek-chat', object='chat.completion', service_tier=None, system_fingerprint='fp_ffc7281d48_prod0820_fp8_kvcache', usage=CompletionUsage(completion_tokens=13, prompt_tokens=1521, total_tokens=1534, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetails(audio_tokens=None, cached_tokens=1472), prompt_cache_hit_tokens=1472, prompt_cache_miss_tokens=49))
2025-10-05 21:14:37.906 | INFO     | core.nlu.nlu_engine:_parse_response:190 - 解析响应: tool_calls数量=1
2025-10-05 21:14:37.906 | INFO     | core.nlu.nlu_engine:_update_session:351 - [integration_test_0004] 意图切换: None -> query_current_package
2025-10-05 21:14:37.906 | INFO     | core.nlu.nlu_engine:understand:105 - [integration_test_0004] NLU完成: intent=query_current_package
2025-10-05 21:14:37.906 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_0004
2025-10-05 21:14:37.906 | DEBUG    | core.dst.state_store:_load_from_memory:121 - 内存中不存在会话: integration_test_0004, 返回新状态
2025-10-05 21:14:37.907 | INFO     | core.dst.dialog_state_tracker:track:59 - 意图改变: None → query_current_package
2025-10-05 21:14:37.907 | DEBUG    | core.dst.slot_manager:fill_slots:61 - 不同领域，仅保留用户信息: []
2025-10-05 21:14:37.907 | INFO     | core.dst.slot_manager:validate_slots:103 - 缺失槽位: ['phone']
2025-10-05 21:14:37.907 | INFO     | core.dst.dialog_state_tracker:_validate_slots:134 - 缺失必填槽位: ['phone']
2025-10-05 21:14:37.907 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_0004
2025-10-05 21:14:37.907 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=1, 需要澄清=True
2025-10-05 21:14:37.907 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_0004] 对话完成 | 意图: query_current_package | 轮次: 1 | 耗时: 3944ms
2025-10-05 21:14:37.907 | INFO     | core.chatbot_dst:chat:46 - [integration_test_0004] 收到用户输入: 13800138000
2025-10-05 21:14:37.907 | INFO     | core.nlu.nlu_engine:understand:73 - [integration_test_0004] 开始NLU理解: 13800138000
2025-10-05 21:14:37.907 | DEBUG    | core.nlu.nlu_engine:understand:78 - [integration_test_0004] 预处理后: 13800138000
2025-10-05 21:14:37.907 | DEBUG    | core.nlu.nlu_engine:_build_messages:162 - 构建的消息: ['system: 你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业...', 'assistant: 请问您的手机号码是多少呢？...', 'user: 13800138000...']
2025-10-05 21:14:37.907 | INFO     | core.nlu.nlu_engine:understand:87 - 请求模型message=[{'role': 'system', 'content': '你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业务。\n\n【⭐⭐⭐ 最重要原则】\n- **只处理用户的最后一条消息**，忽略之前的所有用户消息\n- 如果看到多个用户消息，只响应最后一个\n- 每次只调用一个与最后一条用户消息相关的函数\n\n【你的职责】\n1. 理解用户的自然语言需求\n2. **必须**识别用户意图并调用相应的函数，不要进行闲聊\n3. 当信息不完整时,友好地向用户确认缺失的信息\n4. 用专业但亲切的语气与用户交流\n\n【当前可用套餐】\n- 经济套餐: 10G/月, 50元/月, 无限制人群\n- 畅游套餐: 100G/月, 180元/月, 无限制人群\n- 无限套餐: 1000G/月, 300元/月, 无限制人群\n- 校园套餐: 200G/月, 150元/月, 在校生专享\n\n【意图识别规则】\n1. 套餐查询类（query_packages）:\n   - "有什么套餐"、"推荐套餐"、"便宜的套餐"、"100元以内的套餐"\n   - 关键词：套餐、推荐、查询、有什么、价格、便宜\n\n2. 当前套餐查询（query_current_package）:\n   - "我的套餐"、"当前套餐"、"我用的什么套餐"\n   - 关键词：我的、当前、现在的\n\n3. 使用情况查询（query_usage）:  \n   - "用了多少流量"、"剩余流量"、"话费余额"、"查询余量"、"流量使用情况"\n   - 关键词：用了、剩余、余额、余量、流量使用、使用情况\n\n4. 套餐办理（change_package）:\n   - "办理XX套餐"、"换成XX套餐"、"我要办理"\n   - 关键词：办理、更换、变更\n\n【函数调用决策】\n重要：如果对话历史中有多个用户消息，只根据最后一条用户消息来判断意图！\n1. 识别**最后一条用户消息**的关键词\n2. 匹配最相关的单一函数\n3. 只调用该函数\n4. 忽略之前的用户消息\n\n【理解规则】\n- 价格表达要准确理解: "100块以内"→price_max=100, "50元以上"→price_min=50\n- "便宜点的"、"经济实惠"等模糊表达→sort_by="price_asc"\n- "学生套餐"、"校园"→target_user="在校生"\n- 如果用户没有提供手机号,需要礼貌询问\n\n【重要】\n- **只响应最后一条用户消息**\n- **一次只调用一个函数**\n- 不要试图同时处理多个问题\n- 回答要简洁明了\n'}, {'role': 'assistant', 'content': '请问您的手机号码是多少呢？'}, {'role': 'user', 'content': '13800138000'}]
2025-10-05 21:14:40.761 | INFO     | core.nlu.nlu_engine:_parse_response:189 - 解析响应=ChatCompletion(id='3f0f614f-4c60-4efb-a67e-5db1b109e695', choices=[Choice(finish_reason='tool_calls', index=0, logprobs=None, message=ChatCompletionMessage(content='', refusal=None, role='assistant', annotations=None, audio=None, function_call=None, tool_calls=[ChatCompletionMessageFunctionToolCall(id='call_00_pGvTFWZ4mI7HpGAEHaqP4FvW', function=Function(arguments='{"phone": "13800138000"}', name='query_current_package'), type='function', index=0)]))], created=1759670080, model='deepseek-chat', object='chat.completion', service_tier=None, system_fingerprint='fp_ffc7281d48_prod0820_fp8_kvcache', usage=CompletionUsage(completion_tokens=17, prompt_tokens=1529, total_tokens=1546, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetails(audio_tokens=None, cached_tokens=1472), prompt_cache_hit_tokens=1472, prompt_cache_miss_tokens=57))
2025-10-05 21:14:40.763 | INFO     | core.nlu.nlu_engine:_parse_response:190 - 解析响应: tool_calls数量=1
2025-10-05 21:14:40.763 | INFO     | core.nlu.nlu_engine:understand:105 - [integration_test_0004] NLU完成: intent=query_current_package
2025-10-05 21:14:40.763 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_0004
2025-10-05 21:14:40.763 | DEBUG    | core.dst.state_store:_load_from_memory:118 - 从内存加载状态: integration_test_0004
2025-10-05 21:14:40.763 | DEBUG    | core.dst.slot_manager:fill_slots:43 - 意图不变，合并槽位: ['phone']
2025-10-05 21:14:40.763 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_0004
2025-10-05 21:14:40.763 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=2, 需要澄清=False
2025-10-05 21:14:40.764 | INFO     | executor.db_executor:execute_function:29 - 执行Function: query_current_package, 参数: {'phone': '13800138000'}
2025-10-05 21:14:40.830 | INFO     | executor.db_executor:execute_function:50 - Function执行成功: query_current_package
2025-10-05 21:14:40.831 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_0004
2025-10-05 21:14:40.831 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_0004] 对话完成 | 意图: query_current_package | 轮次: 3 | 耗时: 2924ms
2025-10-05 21:14:40.831 | INFO     | core.chatbot_dst:chat:46 - [integration_test_0004] 收到用户输入: 我用了多少流量
2025-10-05 21:14:40.831 | INFO     | core.nlu.nlu_engine:understand:73 - [integration_test_0004] 开始NLU理解: 我用了多少流量
2025-10-05 21:14:40.831 | DEBUG    | core.nlu.nlu_engine:understand:78 - [integration_test_0004] 预处理后: 我用了多少流量
2025-10-05 21:14:40.831 | DEBUG    | core.nlu.nlu_engine:_build_messages:162 - 构建的消息: ['system: 你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业...', 'assistant: 正在查询您的当前套餐...', 'user: 我用了多少流量...']
2025-10-05 21:14:40.831 | INFO     | core.nlu.nlu_engine:understand:87 - 请求模型message=[{'role': 'system', 'content': '你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业务。\n\n【⭐⭐⭐ 最重要原则】\n- **只处理用户的最后一条消息**，忽略之前的所有用户消息\n- 如果看到多个用户消息，只响应最后一个\n- 每次只调用一个与最后一条用户消息相关的函数\n\n【你的职责】\n1. 理解用户的自然语言需求\n2. **必须**识别用户意图并调用相应的函数，不要进行闲聊\n3. 当信息不完整时,友好地向用户确认缺失的信息\n4. 用专业但亲切的语气与用户交流\n\n【当前可用套餐】\n- 经济套餐: 10G/月, 50元/月, 无限制人群\n- 畅游套餐: 100G/月, 180元/月, 无限制人群\n- 无限套餐: 1000G/月, 300元/月, 无限制人群\n- 校园套餐: 200G/月, 150元/月, 在校生专享\n\n【意图识别规则】\n1. 套餐查询类（query_packages）:\n   - "有什么套餐"、"推荐套餐"、"便宜的套餐"、"100元以内的套餐"\n   - 关键词：套餐、推荐、查询、有什么、价格、便宜\n\n2. 当前套餐查询（query_current_package）:\n   - "我的套餐"、"当前套餐"、"我用的什么套餐"\n   - 关键词：我的、当前、现在的\n\n3. 使用情况查询（query_usage）:  \n   - "用了多少流量"、"剩余流量"、"话费余额"、"查询余量"、"流量使用情况"\n   - 关键词：用了、剩余、余额、余量、流量使用、使用情况\n\n4. 套餐办理（change_package）:\n   - "办理XX套餐"、"换成XX套餐"、"我要办理"\n   - 关键词：办理、更换、变更\n\n【函数调用决策】\n重要：如果对话历史中有多个用户消息，只根据最后一条用户消息来判断意图！\n1. 识别**最后一条用户消息**的关键词\n2. 匹配最相关的单一函数\n3. 只调用该函数\n4. 忽略之前的用户消息\n\n【理解规则】\n- 价格表达要准确理解: "100块以内"→price_max=100, "50元以上"→price_min=50\n- "便宜点的"、"经济实惠"等模糊表达→sort_by="price_asc"\n- "学生套餐"、"校园"→target_user="在校生"\n- 如果用户没有提供手机号,需要礼貌询问\n\n【重要】\n- **只响应最后一条用户消息**\n- **一次只调用一个函数**\n- 不要试图同时处理多个问题\n- 回答要简洁明了\n'}, {'role': 'assistant', 'content': '正在查询您的当前套餐'}, {'role': 'user', 'content': '我用了多少流量'}]
2025-10-05 21:14:43.320 | INFO     | core.nlu.nlu_engine:_parse_response:189 - 解析响应=ChatCompletion(id='fd405760-62cc-4ba9-aff1-3c9a62250d59', choices=[Choice(finish_reason='tool_calls', index=0, logprobs=None, message=ChatCompletionMessage(content='', refusal=None, role='assistant', annotations=None, audio=None, function_call=None, tool_calls=[ChatCompletionMessageFunctionToolCall(id='call_00_7hnOfEyeiNsEDhyebFYCn7iz', function=Function(arguments='{"phone": "", "query_type": "data"}', name='query_usage'), type='function', index=0)]))], created=1759670083, model='deepseek-chat', object='chat.completion', service_tier=None, system_fingerprint='fp_ffc7281d48_prod0820_fp8_kvcache', usage=CompletionUsage(completion_tokens=18, prompt_tokens=1527, total_tokens=1545, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetails(audio_tokens=None, cached_tokens=1472), prompt_cache_hit_tokens=1472, prompt_cache_miss_tokens=55))
2025-10-05 21:14:43.320 | INFO     | core.nlu.nlu_engine:_parse_response:190 - 解析响应: tool_calls数量=1
2025-10-05 21:14:43.320 | INFO     | core.nlu.nlu_engine:_update_session:351 - [integration_test_0004] 意图切换: query_current_package -> query_usage
2025-10-05 21:14:43.320 | INFO     | core.nlu.nlu_engine:understand:105 - [integration_test_0004] NLU完成: intent=query_usage
2025-10-05 21:14:43.320 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_0004
2025-10-05 21:14:43.320 | DEBUG    | core.dst.state_store:_load_from_memory:118 - 从内存加载状态: integration_test_0004
2025-10-05 21:14:43.320 | INFO     | core.dst.dialog_state_tracker:track:59 - 意图改变: query_current_package → query_usage
2025-10-05 21:14:43.320 | DEBUG    | core.dst.slot_manager:fill_slots:52 - 相同领域，保留槽位: ['phone']
2025-10-05 21:14:43.320 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_0004
2025-10-05 21:14:43.320 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=4, 需要澄清=False
2025-10-05 21:14:43.320 | INFO     | executor.db_executor:execute_function:29 - 执行Function: query_usage, 参数: {'phone': '13800138000', 'query_type': 'data'}
2025-10-05 21:14:43.323 | INFO     | executor.db_executor:execute_function:50 - Function执行成功: query_usage
2025-10-05 21:14:43.323 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_0004
2025-10-05 21:14:43.323 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_0004] 对话完成 | 意图: query_usage | 轮次: 5 | 耗时: 2493ms
2025-10-05 21:15:14.298 | INFO     | database.db_manager:_initialize:38 - 数据库连接初始化成功
2025-10-05 21:15:14.299 | ERROR    | database.redis_manager:_initialize:45 - Redis连接池初始化失败: 'Settings' object has no attribute 'get'
2025-10-05 21:15:14.356 | INFO     | core.nlu.nlu_engine:__init__:53 - ✓ NLU引擎初始化成功: DeepSeek (deepseek-chat)
2025-10-05 21:15:14.357 | ERROR    | core.dst.state_store:__init__:28 - Redis初始化失败: Redis连接池未初始化, 使用内存存储
2025-10-05 21:15:14.357 | INFO     | core.dst.dialog_state_tracker:__init__:27 - 对话状态跟踪器初始化完成
2025-10-05 21:15:14.357 | INFO     | executor.db_executor:__init__:16 - 数据库执行器初始化完成
2025-10-05 21:15:14.357 | INFO     | core.chatbot_dst:__init__:23 - 第二阶段对话系统初始化完成（含DST支持）
2025-10-05 21:15:14.357 | INFO     | core.chatbot_dst:chat:46 - [integration_test_0004] 收到用户输入: 查下我的套餐
2025-10-05 21:15:14.357 | INFO     | core.nlu.nlu_engine:understand:73 - [integration_test_0004] 开始NLU理解: 查下我的套餐
2025-10-05 21:15:14.357 | DEBUG    | core.nlu.nlu_engine:understand:78 - [integration_test_0004] 预处理后: 查下我的套餐
2025-10-05 21:15:14.357 | DEBUG    | core.nlu.nlu_engine:_build_messages:162 - 构建的消息: ['system: 你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业...', 'user: 查下我的套餐...']
2025-10-05 21:15:14.357 | INFO     | core.nlu.nlu_engine:understand:87 - 请求模型message=[{'role': 'system', 'content': '你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业务。\n\n【⭐⭐⭐ 最重要原则】\n- **只处理用户的最后一条消息**，忽略之前的所有用户消息\n- 如果看到多个用户消息，只响应最后一个\n- 每次只调用一个与最后一条用户消息相关的函数\n\n【你的职责】\n1. 理解用户的自然语言需求\n2. **必须**识别用户意图并调用相应的函数，不要进行闲聊\n3. 当信息不完整时,友好地向用户确认缺失的信息\n4. 用专业但亲切的语气与用户交流\n\n【当前可用套餐】\n- 经济套餐: 10G/月, 50元/月, 无限制人群\n- 畅游套餐: 100G/月, 180元/月, 无限制人群\n- 无限套餐: 1000G/月, 300元/月, 无限制人群\n- 校园套餐: 200G/月, 150元/月, 在校生专享\n\n【意图识别规则】\n1. 套餐查询类（query_packages）:\n   - "有什么套餐"、"推荐套餐"、"便宜的套餐"、"100元以内的套餐"\n   - 关键词：套餐、推荐、查询、有什么、价格、便宜\n\n2. 当前套餐查询（query_current_package）:\n   - "我的套餐"、"当前套餐"、"我用的什么套餐"\n   - 关键词：我的、当前、现在的\n\n3. 使用情况查询（query_usage）:  \n   - "用了多少流量"、"剩余流量"、"话费余额"、"查询余量"、"流量使用情况"\n   - 关键词：用了、剩余、余额、余量、流量使用、使用情况\n\n4. 套餐办理（change_package）:\n   - "办理XX套餐"、"换成XX套餐"、"我要办理"\n   - 关键词：办理、更换、变更\n\n【函数调用决策】\n重要：如果对话历史中有多个用户消息，只根据最后一条用户消息来判断意图！\n1. 识别**最后一条用户消息**的关键词\n2. 匹配最相关的单一函数\n3. 只调用该函数\n4. 忽略之前的用户消息\n\n【理解规则】\n- 价格表达要准确理解: "100块以内"→price_max=100, "50元以上"→price_min=50\n- "便宜点的"、"经济实惠"等模糊表达→sort_by="price_asc"\n- "学生套餐"、"校园"→target_user="在校生"\n- 如果用户没有提供手机号,需要礼貌询问\n\n【重要】\n- **只响应最后一条用户消息**\n- **一次只调用一个函数**\n- 不要试图同时处理多个问题\n- 回答要简洁明了\n'}, {'role': 'user', 'content': '查下我的套餐'}]
2025-10-05 21:15:17.349 | INFO     | core.nlu.nlu_engine:_parse_response:189 - 解析响应=ChatCompletion(id='c7d63d60-9365-4c1a-9ade-7159531cc085', choices=[Choice(finish_reason='tool_calls', index=0, logprobs=None, message=ChatCompletionMessage(content='', refusal=None, role='assistant', annotations=None, audio=None, function_call=None, tool_calls=[ChatCompletionMessageFunctionToolCall(id='call_00_eR67Aa7aZV5DB4l8RxFuZCle', function=Function(arguments='{"phone": "13800138000"}', name='query_current_package'), type='function', index=0)]))], created=1759670116, model='deepseek-chat', object='chat.completion', service_tier=None, system_fingerprint='fp_ffc7281d48_prod0820_fp8_kvcache', usage=CompletionUsage(completion_tokens=17, prompt_tokens=1521, total_tokens=1538, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetails(audio_tokens=None, cached_tokens=1472), prompt_cache_hit_tokens=1472, prompt_cache_miss_tokens=49))
2025-10-05 21:15:17.349 | INFO     | core.nlu.nlu_engine:_parse_response:190 - 解析响应: tool_calls数量=1
2025-10-05 21:15:17.349 | INFO     | core.nlu.nlu_engine:_update_session:351 - [integration_test_0004] 意图切换: None -> query_current_package
2025-10-05 21:15:17.350 | INFO     | core.nlu.nlu_engine:understand:105 - [integration_test_0004] NLU完成: intent=query_current_package
2025-10-05 21:15:17.350 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_0004
2025-10-05 21:15:17.350 | DEBUG    | core.dst.state_store:_load_from_memory:121 - 内存中不存在会话: integration_test_0004, 返回新状态
2025-10-05 21:15:17.350 | INFO     | core.dst.dialog_state_tracker:track:59 - 意图改变: None → query_current_package
2025-10-05 21:15:17.350 | DEBUG    | core.dst.slot_manager:fill_slots:61 - 不同领域，仅保留用户信息: []
2025-10-05 21:15:17.350 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_0004
2025-10-05 21:15:17.350 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=1, 需要澄清=False
2025-10-05 21:15:17.350 | INFO     | executor.db_executor:execute_function:29 - 执行Function: query_current_package, 参数: {'phone': '13800138000'}
2025-10-05 21:15:17.390 | INFO     | executor.db_executor:execute_function:50 - Function执行成功: query_current_package
2025-10-05 21:15:17.390 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_0004
2025-10-05 21:15:17.391 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_0004] 对话完成 | 意图: query_current_package | 轮次: 2 | 耗时: 3034ms
2025-10-05 21:17:20.412 | INFO     | database.db_manager:_initialize:38 - 数据库连接初始化成功
2025-10-05 21:17:20.412 | ERROR    | database.redis_manager:_initialize:45 - Redis连接池初始化失败: 'Settings' object has no attribute 'get'
2025-10-05 21:17:20.470 | INFO     | core.nlu.nlu_engine:__init__:53 - ✓ NLU引擎初始化成功: DeepSeek (deepseek-chat)
2025-10-05 21:17:20.470 | ERROR    | core.dst.state_store:__init__:28 - Redis初始化失败: Redis连接池未初始化, 使用内存存储
2025-10-05 21:17:20.470 | INFO     | core.dst.dialog_state_tracker:__init__:27 - 对话状态跟踪器初始化完成
2025-10-05 21:17:20.470 | INFO     | executor.db_executor:__init__:16 - 数据库执行器初始化完成
2025-10-05 21:17:20.470 | INFO     | core.chatbot_dst:__init__:23 - 第二阶段对话系统初始化完成（含DST支持）
2025-10-05 21:17:20.470 | INFO     | core.chatbot_dst:chat:46 - [integration_test_0004] 收到用户输入: 查下我的套餐
2025-10-05 21:17:20.470 | INFO     | core.nlu.nlu_engine:understand:73 - [integration_test_0004] 开始NLU理解: 查下我的套餐
2025-10-05 21:17:20.470 | DEBUG    | core.nlu.nlu_engine:understand:78 - [integration_test_0004] 预处理后: 查下我的套餐
2025-10-05 21:17:20.470 | DEBUG    | core.nlu.nlu_engine:_build_messages:162 - 构建的消息: ['system: 你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业...', 'user: 查下我的套餐...']
2025-10-05 21:17:20.470 | INFO     | core.nlu.nlu_engine:understand:87 - 请求模型message=[{'role': 'system', 'content': '你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业务。\n\n【⭐⭐⭐ 最重要原则】\n- **只处理用户的最后一条消息**，忽略之前的所有用户消息\n- 如果看到多个用户消息，只响应最后一个\n- 每次只调用一个与最后一条用户消息相关的函数\n\n【你的职责】\n1. 理解用户的自然语言需求\n2. **必须**识别用户意图并调用相应的函数，不要进行闲聊\n3. 当信息不完整时,友好地向用户确认缺失的信息\n4. 用专业但亲切的语气与用户交流\n\n【当前可用套餐】\n- 经济套餐: 10G/月, 50元/月, 无限制人群\n- 畅游套餐: 100G/月, 180元/月, 无限制人群\n- 无限套餐: 1000G/月, 300元/月, 无限制人群\n- 校园套餐: 200G/月, 150元/月, 在校生专享\n\n【意图识别规则】\n1. 套餐查询类（query_packages）:\n   - "有什么套餐"、"推荐套餐"、"便宜的套餐"、"100元以内的套餐"\n   - 关键词：套餐、推荐、查询、有什么、价格、便宜\n\n2. 当前套餐查询（query_current_package）:\n   - "我的套餐"、"当前套餐"、"我用的什么套餐"\n   - 关键词：我的、当前、现在的\n\n3. 使用情况查询（query_usage）:  \n   - "用了多少流量"、"剩余流量"、"话费余额"、"查询余量"、"流量使用情况"\n   - 关键词：用了、剩余、余额、余量、流量使用、使用情况\n\n4. 套餐办理（change_package）:\n   - "办理XX套餐"、"换成XX套餐"、"我要办理"\n   - 关键词：办理、更换、变更\n\n【函数调用决策】\n重要：如果对话历史中有多个用户消息，只根据最后一条用户消息来判断意图！\n1. 识别**最后一条用户消息**的关键词\n2. 匹配最相关的单一函数\n3. 只调用该函数\n4. 忽略之前的用户消息\n\n【理解规则】\n- 价格表达要准确理解: "100块以内"→price_max=100, "50元以上"→price_min=50\n- "便宜点的"、"经济实惠"等模糊表达→sort_by="price_asc"\n- "学生套餐"、"校园"→target_user="在校生"\n- 如果用户没有提供手机号,需要礼貌询问\n\n【重要】\n- **只响应最后一条用户消息**\n- **一次只调用一个函数**\n- 不要试图同时处理多个问题\n- 回答要简洁明了\n'}, {'role': 'user', 'content': '查下我的套餐'}]
2025-10-05 21:17:22.766 | INFO     | core.nlu.nlu_engine:_parse_response:189 - 解析响应=ChatCompletion(id='2dc8dfb5-f67f-45e4-93c6-4f78c608f690', choices=[Choice(finish_reason='tool_calls', index=0, logprobs=None, message=ChatCompletionMessage(content='', refusal=None, role='assistant', annotations=None, audio=None, function_call=None, tool_calls=[ChatCompletionMessageFunctionToolCall(id='call_00_RnWztybt4qKJ40TjEJECbr04', function=Function(arguments='{"phone": ""}', name='query_current_package'), type='function', index=0)]))], created=1759670243, model='deepseek-chat', object='chat.completion', service_tier=None, system_fingerprint='fp_ffc7281d48_prod0820_fp8_kvcache', usage=CompletionUsage(completion_tokens=13, prompt_tokens=1521, total_tokens=1534, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetails(audio_tokens=None, cached_tokens=1472), prompt_cache_hit_tokens=1472, prompt_cache_miss_tokens=49))
2025-10-05 21:17:22.766 | INFO     | core.nlu.nlu_engine:_parse_response:190 - 解析响应: tool_calls数量=1
2025-10-05 21:17:22.767 | INFO     | core.nlu.nlu_engine:_update_session:351 - [integration_test_0004] 意图切换: None -> query_current_package
2025-10-05 21:17:22.767 | INFO     | core.nlu.nlu_engine:understand:105 - [integration_test_0004] NLU完成: intent=query_current_package
2025-10-05 21:17:22.767 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_0004
2025-10-05 21:17:22.767 | DEBUG    | core.dst.state_store:_load_from_memory:121 - 内存中不存在会话: integration_test_0004, 返回新状态
2025-10-05 21:17:22.768 | INFO     | core.dst.dialog_state_tracker:track:59 - 意图改变: None → query_current_package
2025-10-05 21:17:22.768 | DEBUG    | core.dst.slot_manager:fill_slots:61 - 不同领域，仅保留用户信息: []
2025-10-05 21:17:22.768 | INFO     | core.dst.slot_manager:validate_slots:103 - 缺失槽位: ['phone']
2025-10-05 21:17:22.768 | INFO     | core.dst.dialog_state_tracker:_validate_slots:134 - 缺失必填槽位: ['phone']
2025-10-05 21:17:22.768 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_0004
2025-10-05 21:17:22.769 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=1, 需要澄清=True
2025-10-05 21:17:22.769 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_0004] 对话完成 | 意图: query_current_package | 轮次: 1 | 耗时: 2298ms
2025-10-05 21:17:22.769 | INFO     | core.chatbot_dst:chat:46 - [integration_test_0004] 收到用户输入: 13800138000
2025-10-05 21:17:22.769 | INFO     | core.nlu.nlu_engine:understand:73 - [integration_test_0004] 开始NLU理解: 13800138000
2025-10-05 21:17:22.769 | DEBUG    | core.nlu.nlu_engine:understand:78 - [integration_test_0004] 预处理后: 13800138000
2025-10-05 21:17:22.769 | DEBUG    | core.nlu.nlu_engine:_build_messages:162 - 构建的消息: ['system: 你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业...', 'assistant: 请问您的手机号码是多少呢？...', 'user: 13800138000...']
2025-10-05 21:17:22.769 | INFO     | core.nlu.nlu_engine:understand:87 - 请求模型message=[{'role': 'system', 'content': '你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业务。\n\n【⭐⭐⭐ 最重要原则】\n- **只处理用户的最后一条消息**，忽略之前的所有用户消息\n- 如果看到多个用户消息，只响应最后一个\n- 每次只调用一个与最后一条用户消息相关的函数\n\n【你的职责】\n1. 理解用户的自然语言需求\n2. **必须**识别用户意图并调用相应的函数，不要进行闲聊\n3. 当信息不完整时,友好地向用户确认缺失的信息\n4. 用专业但亲切的语气与用户交流\n\n【当前可用套餐】\n- 经济套餐: 10G/月, 50元/月, 无限制人群\n- 畅游套餐: 100G/月, 180元/月, 无限制人群\n- 无限套餐: 1000G/月, 300元/月, 无限制人群\n- 校园套餐: 200G/月, 150元/月, 在校生专享\n\n【意图识别规则】\n1. 套餐查询类（query_packages）:\n   - "有什么套餐"、"推荐套餐"、"便宜的套餐"、"100元以内的套餐"\n   - 关键词：套餐、推荐、查询、有什么、价格、便宜\n\n2. 当前套餐查询（query_current_package）:\n   - "我的套餐"、"当前套餐"、"我用的什么套餐"\n   - 关键词：我的、当前、现在的\n\n3. 使用情况查询（query_usage）:  \n   - "用了多少流量"、"剩余流量"、"话费余额"、"查询余量"、"流量使用情况"\n   - 关键词：用了、剩余、余额、余量、流量使用、使用情况\n\n4. 套餐办理（change_package）:\n   - "办理XX套餐"、"换成XX套餐"、"我要办理"\n   - 关键词：办理、更换、变更\n\n【函数调用决策】\n重要：如果对话历史中有多个用户消息，只根据最后一条用户消息来判断意图！\n1. 识别**最后一条用户消息**的关键词\n2. 匹配最相关的单一函数\n3. 只调用该函数\n4. 忽略之前的用户消息\n\n【理解规则】\n- 价格表达要准确理解: "100块以内"→price_max=100, "50元以上"→price_min=50\n- "便宜点的"、"经济实惠"等模糊表达→sort_by="price_asc"\n- "学生套餐"、"校园"→target_user="在校生"\n- 如果用户没有提供手机号,需要礼貌询问\n\n【重要】\n- **只响应最后一条用户消息**\n- **一次只调用一个函数**\n- 不要试图同时处理多个问题\n- 回答要简洁明了\n'}, {'role': 'assistant', 'content': '请问您的手机号码是多少呢？'}, {'role': 'user', 'content': '13800138000'}]
2025-10-05 21:17:25.096 | INFO     | core.nlu.nlu_engine:_parse_response:189 - 解析响应=ChatCompletion(id='e2db9c07-133f-429d-acc0-6b036076d45b', choices=[Choice(finish_reason='tool_calls', index=0, logprobs=None, message=ChatCompletionMessage(content='', refusal=None, role='assistant', annotations=None, audio=None, function_call=None, tool_calls=[ChatCompletionMessageFunctionToolCall(id='call_00_OLPiKo2zq0FPRWerDeI1SJ6x', function=Function(arguments='{"phone": "13800138000"}', name='query_current_package'), type='function', index=0)]))], created=1759670245, model='deepseek-chat', object='chat.completion', service_tier=None, system_fingerprint='fp_ffc7281d48_prod0820_fp8_kvcache', usage=CompletionUsage(completion_tokens=17, prompt_tokens=1529, total_tokens=1546, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetails(audio_tokens=None, cached_tokens=1472), prompt_cache_hit_tokens=1472, prompt_cache_miss_tokens=57))
2025-10-05 21:17:25.097 | INFO     | core.nlu.nlu_engine:_parse_response:190 - 解析响应: tool_calls数量=1
2025-10-05 21:17:25.097 | INFO     | core.nlu.nlu_engine:understand:105 - [integration_test_0004] NLU完成: intent=query_current_package
2025-10-05 21:17:25.097 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_0004
2025-10-05 21:17:25.097 | DEBUG    | core.dst.state_store:_load_from_memory:118 - 从内存加载状态: integration_test_0004
2025-10-05 21:17:25.097 | DEBUG    | core.dst.slot_manager:fill_slots:43 - 意图不变，合并槽位: ['phone']
2025-10-05 21:17:25.098 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_0004
2025-10-05 21:17:25.098 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=2, 需要澄清=False
2025-10-05 21:17:25.098 | INFO     | executor.db_executor:execute_function:29 - 执行Function: query_current_package, 参数: {'phone': '13800138000'}
2025-10-05 21:17:25.168 | INFO     | executor.db_executor:execute_function:50 - Function执行成功: query_current_package
2025-10-05 21:17:25.169 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_0004
2025-10-05 21:17:25.169 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_0004] 对话完成 | 意图: query_current_package | 轮次: 3 | 耗时: 2400ms
2025-10-05 21:17:25.169 | INFO     | core.chatbot_dst:chat:46 - [integration_test_0004] 收到用户输入: 我用了多少流量
2025-10-05 21:17:25.169 | INFO     | core.nlu.nlu_engine:understand:73 - [integration_test_0004] 开始NLU理解: 我用了多少流量
2025-10-05 21:17:25.169 | DEBUG    | core.nlu.nlu_engine:understand:78 - [integration_test_0004] 预处理后: 我用了多少流量
2025-10-05 21:17:25.170 | DEBUG    | core.nlu.nlu_engine:_build_messages:162 - 构建的消息: ['system: 你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业...', 'assistant: 正在查询您的当前套餐...', 'user: 我用了多少流量...']
2025-10-05 21:17:25.170 | INFO     | core.nlu.nlu_engine:understand:87 - 请求模型message=[{'role': 'system', 'content': '你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业务。\n\n【⭐⭐⭐ 最重要原则】\n- **只处理用户的最后一条消息**，忽略之前的所有用户消息\n- 如果看到多个用户消息，只响应最后一个\n- 每次只调用一个与最后一条用户消息相关的函数\n\n【你的职责】\n1. 理解用户的自然语言需求\n2. **必须**识别用户意图并调用相应的函数，不要进行闲聊\n3. 当信息不完整时,友好地向用户确认缺失的信息\n4. 用专业但亲切的语气与用户交流\n\n【当前可用套餐】\n- 经济套餐: 10G/月, 50元/月, 无限制人群\n- 畅游套餐: 100G/月, 180元/月, 无限制人群\n- 无限套餐: 1000G/月, 300元/月, 无限制人群\n- 校园套餐: 200G/月, 150元/月, 在校生专享\n\n【意图识别规则】\n1. 套餐查询类（query_packages）:\n   - "有什么套餐"、"推荐套餐"、"便宜的套餐"、"100元以内的套餐"\n   - 关键词：套餐、推荐、查询、有什么、价格、便宜\n\n2. 当前套餐查询（query_current_package）:\n   - "我的套餐"、"当前套餐"、"我用的什么套餐"\n   - 关键词：我的、当前、现在的\n\n3. 使用情况查询（query_usage）:  \n   - "用了多少流量"、"剩余流量"、"话费余额"、"查询余量"、"流量使用情况"\n   - 关键词：用了、剩余、余额、余量、流量使用、使用情况\n\n4. 套餐办理（change_package）:\n   - "办理XX套餐"、"换成XX套餐"、"我要办理"\n   - 关键词：办理、更换、变更\n\n【函数调用决策】\n重要：如果对话历史中有多个用户消息，只根据最后一条用户消息来判断意图！\n1. 识别**最后一条用户消息**的关键词\n2. 匹配最相关的单一函数\n3. 只调用该函数\n4. 忽略之前的用户消息\n\n【理解规则】\n- 价格表达要准确理解: "100块以内"→price_max=100, "50元以上"→price_min=50\n- "便宜点的"、"经济实惠"等模糊表达→sort_by="price_asc"\n- "学生套餐"、"校园"→target_user="在校生"\n- 如果用户没有提供手机号,需要礼貌询问\n\n【重要】\n- **只响应最后一条用户消息**\n- **一次只调用一个函数**\n- 不要试图同时处理多个问题\n- 回答要简洁明了\n'}, {'role': 'assistant', 'content': '正在查询您的当前套餐'}, {'role': 'user', 'content': '我用了多少流量'}]
2025-10-05 21:17:27.876 | INFO     | core.nlu.nlu_engine:_parse_response:189 - 解析响应=ChatCompletion(id='0fc2e571-e4fe-4052-afdf-1cf48e0ba070', choices=[Choice(finish_reason='tool_calls', index=0, logprobs=None, message=ChatCompletionMessage(content='', refusal=None, role='assistant', annotations=None, audio=None, function_call=None, tool_calls=[ChatCompletionMessageFunctionToolCall(id='call_00_N7FhmvH5DlWFyBkomx4g0lh3', function=Function(arguments='{"phone": "", "query_type": "data"}', name='query_usage'), type='function', index=0)]))], created=1759670247, model='deepseek-chat', object='chat.completion', service_tier=None, system_fingerprint='fp_ffc7281d48_prod0820_fp8_kvcache', usage=CompletionUsage(completion_tokens=18, prompt_tokens=1527, total_tokens=1545, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetails(audio_tokens=None, cached_tokens=1472), prompt_cache_hit_tokens=1472, prompt_cache_miss_tokens=55))
2025-10-05 21:17:27.877 | INFO     | core.nlu.nlu_engine:_parse_response:190 - 解析响应: tool_calls数量=1
2025-10-05 21:17:27.877 | INFO     | core.nlu.nlu_engine:_update_session:351 - [integration_test_0004] 意图切换: query_current_package -> query_usage
2025-10-05 21:17:27.877 | INFO     | core.nlu.nlu_engine:understand:105 - [integration_test_0004] NLU完成: intent=query_usage
2025-10-05 21:17:27.877 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_0004
2025-10-05 21:17:27.877 | DEBUG    | core.dst.state_store:_load_from_memory:118 - 从内存加载状态: integration_test_0004
2025-10-05 21:17:27.877 | INFO     | core.dst.dialog_state_tracker:track:59 - 意图改变: query_current_package → query_usage
2025-10-05 21:17:27.877 | DEBUG    | core.dst.slot_manager:fill_slots:52 - 相同领域，保留槽位: ['phone']
2025-10-05 21:17:27.877 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_0004
2025-10-05 21:17:27.877 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=4, 需要澄清=False
2025-10-05 21:17:27.877 | INFO     | executor.db_executor:execute_function:29 - 执行Function: query_usage, 参数: {'phone': '13800138000', 'query_type': 'data'}
2025-10-05 21:17:27.881 | INFO     | executor.db_executor:execute_function:50 - Function执行成功: query_usage
2025-10-05 21:17:27.882 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_0004
2025-10-05 21:17:27.882 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_0004] 对话完成 | 意图: query_usage | 轮次: 5 | 耗时: 2713ms
2025-10-05 21:18:35.955 | INFO     | database.db_manager:_initialize:38 - 数据库连接初始化成功
2025-10-05 21:18:35.956 | ERROR    | database.redis_manager:_initialize:45 - Redis连接池初始化失败: 'Settings' object has no attribute 'get'
2025-10-05 21:18:36.055 | INFO     | core.nlu.nlu_engine:__init__:53 - ✓ NLU引擎初始化成功: DeepSeek (deepseek-chat)
2025-10-05 21:18:36.055 | ERROR    | core.dst.state_store:__init__:28 - Redis初始化失败: Redis连接池未初始化, 使用内存存储
2025-10-05 21:18:36.056 | INFO     | core.dst.dialog_state_tracker:__init__:27 - 对话状态跟踪器初始化完成
2025-10-05 21:18:36.056 | INFO     | executor.db_executor:__init__:16 - 数据库执行器初始化完成
2025-10-05 21:18:36.056 | INFO     | core.chatbot_dst:__init__:23 - 第二阶段对话系统初始化完成（含DST支持）
2025-10-05 21:18:40.359 | INFO     | core.chatbot_dst:chat:46 - [integration_test_0005] 收到用户输入: 查下我的套餐
2025-10-05 21:18:43.081 | INFO     | core.nlu.nlu_engine:understand:73 - [integration_test_0005] 开始NLU理解: 查下我的套餐
2025-10-05 21:18:43.082 | DEBUG    | core.nlu.nlu_engine:understand:78 - [integration_test_0005] 预处理后: 查下我的套餐
2025-10-05 21:19:06.651 | DEBUG    | core.nlu.nlu_engine:_build_messages:162 - 构建的消息: ['system: 你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业...', 'user: 查下我的套餐...']
2025-10-05 21:19:07.351 | INFO     | core.nlu.nlu_engine:understand:87 - 请求模型message=[{'role': 'system', 'content': '你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业务。\n\n【⭐⭐⭐ 最重要原则】\n- **只处理用户的最后一条消息**，忽略之前的所有用户消息\n- 如果看到多个用户消息，只响应最后一个\n- 每次只调用一个与最后一条用户消息相关的函数\n\n【你的职责】\n1. 理解用户的自然语言需求\n2. **必须**识别用户意图并调用相应的函数，不要进行闲聊\n3. 当信息不完整时,友好地向用户确认缺失的信息\n4. 用专业但亲切的语气与用户交流\n\n【当前可用套餐】\n- 经济套餐: 10G/月, 50元/月, 无限制人群\n- 畅游套餐: 100G/月, 180元/月, 无限制人群\n- 无限套餐: 1000G/月, 300元/月, 无限制人群\n- 校园套餐: 200G/月, 150元/月, 在校生专享\n\n【意图识别规则】\n1. 套餐查询类（query_packages）:\n   - "有什么套餐"、"推荐套餐"、"便宜的套餐"、"100元以内的套餐"\n   - 关键词：套餐、推荐、查询、有什么、价格、便宜\n\n2. 当前套餐查询（query_current_package）:\n   - "我的套餐"、"当前套餐"、"我用的什么套餐"\n   - 关键词：我的、当前、现在的\n\n3. 使用情况查询（query_usage）:  \n   - "用了多少流量"、"剩余流量"、"话费余额"、"查询余量"、"流量使用情况"\n   - 关键词：用了、剩余、余额、余量、流量使用、使用情况\n\n4. 套餐办理（change_package）:\n   - "办理XX套餐"、"换成XX套餐"、"我要办理"\n   - 关键词：办理、更换、变更\n\n【函数调用决策】\n重要：如果对话历史中有多个用户消息，只根据最后一条用户消息来判断意图！\n1. 识别**最后一条用户消息**的关键词\n2. 匹配最相关的单一函数\n3. 只调用该函数\n4. 忽略之前的用户消息\n\n【理解规则】\n- 价格表达要准确理解: "100块以内"→price_max=100, "50元以上"→price_min=50\n- "便宜点的"、"经济实惠"等模糊表达→sort_by="price_asc"\n- "学生套餐"、"校园"→target_user="在校生"\n- 如果用户没有提供手机号,需要礼貌询问\n\n【重要】\n- **只响应最后一条用户消息**\n- **一次只调用一个函数**\n- 不要试图同时处理多个问题\n- 回答要简洁明了\n'}, {'role': 'user', 'content': '查下我的套餐'}]
2025-10-05 21:19:49.683 | INFO     | core.nlu.nlu_engine:_parse_response:189 - 解析响应=ChatCompletion(id='6ee5b1f1-8682-43f3-a231-568c9652ee1e', choices=[Choice(finish_reason='tool_calls', index=0, logprobs=None, message=ChatCompletionMessage(content='', refusal=None, role='assistant', annotations=None, audio=None, function_call=None, tool_calls=[ChatCompletionMessageFunctionToolCall(id='call_00_67IXMrkLUcYhmxaxPMQWoDOm', function=Function(arguments='{"phone": "13800138000"}', name='query_current_package'), type='function', index=0)]))], created=1759670357, model='deepseek-chat', object='chat.completion', service_tier=None, system_fingerprint='fp_ffc7281d48_prod0820_fp8_kvcache', usage=CompletionUsage(completion_tokens=17, prompt_tokens=1521, total_tokens=1538, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetails(audio_tokens=None, cached_tokens=1472), prompt_cache_hit_tokens=1472, prompt_cache_miss_tokens=49))
2025-10-05 21:19:49.685 | INFO     | core.nlu.nlu_engine:_parse_response:190 - 解析响应: tool_calls数量=1
2025-10-05 21:19:49.685 | INFO     | core.nlu.nlu_engine:_update_session:351 - [integration_test_0005] 意图切换: None -> query_current_package
2025-10-05 21:19:49.686 | INFO     | core.nlu.nlu_engine:understand:105 - [integration_test_0005] NLU完成: intent=query_current_package
2025-10-05 21:19:55.179 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_0005
2025-10-05 21:19:55.700 | DEBUG    | core.dst.state_store:_load_from_memory:121 - 内存中不存在会话: integration_test_0005, 返回新状态
2025-10-05 21:20:12.240 | INFO     | core.dst.dialog_state_tracker:track:59 - 意图改变: None → query_current_package
2025-10-05 21:20:15.199 | DEBUG    | core.dst.slot_manager:fill_slots:61 - 不同领域，仅保留用户信息: []
2025-10-05 21:30:54.986 | INFO     | database.db_manager:_initialize:38 - 数据库连接初始化成功
2025-10-05 21:30:54.986 | ERROR    | database.redis_manager:_initialize:45 - Redis连接池初始化失败: 'Settings' object has no attribute 'get'
2025-10-05 21:30:55.026 | INFO     | core.nlu.nlu_engine:__init__:53 - ✓ NLU引擎初始化成功: DeepSeek (deepseek-chat)
2025-10-05 21:30:55.026 | ERROR    | core.dst.state_store:__init__:28 - Redis初始化失败: Redis连接池未初始化, 使用内存存储
2025-10-05 21:30:55.026 | INFO     | core.dst.dialog_state_tracker:__init__:27 - 对话状态跟踪器初始化完成
2025-10-05 21:30:55.026 | INFO     | executor.db_executor:__init__:16 - 数据库执行器初始化完成
2025-10-05 21:30:55.026 | INFO     | core.chatbot_dst:__init__:23 - 第二阶段对话系统初始化完成（含DST支持）
2025-10-05 21:30:55.027 | INFO     | core.chatbot_dst:chat:46 - [integration_test_0006] 收到用户输入: 查下我的套餐
2025-10-05 21:30:55.027 | INFO     | core.nlu.nlu_engine:understand:73 - [integration_test_0006] 开始NLU理解: 查下我的套餐
2025-10-05 21:30:55.027 | DEBUG    | core.nlu.nlu_engine:understand:78 - [integration_test_0006] 预处理后: 查下我的套餐
2025-10-05 21:30:55.027 | DEBUG    | core.nlu.nlu_engine:_build_messages:162 - 构建的消息: ['system: 你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业...', 'user: 查下我的套餐...']
2025-10-05 21:30:55.027 | INFO     | core.nlu.nlu_engine:understand:87 - 请求模型message=[{'role': 'system', 'content': '你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业务。\n\n【⭐⭐⭐ 最重要原则】\n- **只处理用户的最后一条消息**，忽略之前的所有用户消息\n- 如果看到多个用户消息，只响应最后一个\n- 每次只调用一个与最后一条用户消息相关的函数\n\n【你的职责】\n1. 理解用户的自然语言需求\n2. **必须**识别用户意图并调用相应的函数，不要进行闲聊\n3. 当信息不完整时,友好地向用户确认缺失的信息\n4. 用专业但亲切的语气与用户交流\n\n【当前可用套餐】\n- 经济套餐: 10G/月, 50元/月, 无限制人群\n- 畅游套餐: 100G/月, 180元/月, 无限制人群\n- 无限套餐: 1000G/月, 300元/月, 无限制人群\n- 校园套餐: 200G/月, 150元/月, 在校生专享\n\n【意图识别规则】\n1. 套餐查询类（query_packages）:\n   - "有什么套餐"、"推荐套餐"、"便宜的套餐"、"100元以内的套餐"\n   - 关键词：套餐、推荐、查询、有什么、价格、便宜\n\n2. 当前套餐查询（query_current_package）:\n   - "我的套餐"、"当前套餐"、"我用的什么套餐"\n   - 关键词：我的、当前、现在的\n\n3. 使用情况查询（query_usage）:  \n   - "用了多少流量"、"剩余流量"、"话费余额"、"查询余量"、"流量使用情况"\n   - 关键词：用了、剩余、余额、余量、流量使用、使用情况\n\n4. 套餐办理（change_package）:\n   - "办理XX套餐"、"换成XX套餐"、"我要办理"\n   - 关键词：办理、更换、变更\n\n【函数调用决策】\n重要：如果对话历史中有多个用户消息，只根据最后一条用户消息来判断意图！\n1. 识别**最后一条用户消息**的关键词\n2. 匹配最相关的单一函数\n3. 只调用该函数\n4. 忽略之前的用户消息\n\n【理解规则】\n- 价格表达要准确理解: "100块以内"→price_max=100, "50元以上"→price_min=50\n- "便宜点的"、"经济实惠"等模糊表达→sort_by="price_asc"\n- "学生套餐"、"校园"→target_user="在校生"\n- 如果用户没有提供手机号,需要礼貌询问\n\n【重要】\n- **只响应最后一条用户消息**\n- **一次只调用一个函数**\n- 不要试图同时处理多个问题\n- 回答要简洁明了\n'}, {'role': 'user', 'content': '查下我的套餐'}]
2025-10-05 21:30:58.625 | INFO     | core.nlu.nlu_engine:_parse_response:189 - 解析响应=ChatCompletion(id='66afdae3-b88a-479c-9f7c-cb150b6839f8', choices=[Choice(finish_reason='tool_calls', index=0, logprobs=None, message=ChatCompletionMessage(content='', refusal=None, role='assistant', annotations=None, audio=None, function_call=None, tool_calls=[ChatCompletionMessageFunctionToolCall(id='call_00_6E5lN9kRzBXWeWNDRBJyATlp', function=Function(arguments='{"phone": "13800138000"}', name='query_current_package'), type='function', index=0)]))], created=1759671058, model='deepseek-chat', object='chat.completion', service_tier=None, system_fingerprint='fp_ffc7281d48_prod0820_fp8_kvcache', usage=CompletionUsage(completion_tokens=17, prompt_tokens=1521, total_tokens=1538, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetails(audio_tokens=None, cached_tokens=1472), prompt_cache_hit_tokens=1472, prompt_cache_miss_tokens=49))
2025-10-05 21:30:58.625 | INFO     | core.nlu.nlu_engine:_parse_response:190 - 解析响应: tool_calls数量=1
2025-10-05 21:30:58.625 | INFO     | core.nlu.nlu_engine:_update_session:351 - [integration_test_0006] 意图切换: None -> query_current_package
2025-10-05 21:30:58.625 | INFO     | core.nlu.nlu_engine:understand:105 - [integration_test_0006] NLU完成: intent=query_current_package
2025-10-05 21:30:58.626 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_0006
2025-10-05 21:30:58.626 | DEBUG    | core.dst.state_store:_load_from_memory:121 - 内存中不存在会话: integration_test_0006, 返回新状态
2025-10-05 21:30:58.626 | INFO     | core.dst.dialog_state_tracker:track:59 - 意图改变: None → query_current_package
2025-10-05 21:30:58.626 | DEBUG    | core.dst.slot_manager:fill_slots:61 - 不同领域，仅保留用户信息: []
2025-10-05 21:30:58.626 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_0006
2025-10-05 21:30:58.626 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=1, 需要澄清=False
2025-10-05 21:30:58.626 | INFO     | executor.db_executor:execute_function:29 - 执行Function: query_current_package, 参数: {'phone': '13800138000'}
2025-10-05 21:30:58.721 | INFO     | executor.db_executor:execute_function:50 - Function执行成功: query_current_package
2025-10-05 21:30:58.722 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_0006
2025-10-05 21:30:58.722 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_0006] 对话完成 | 意图: query_current_package | 轮次: 2 | 耗时: 3695ms
2025-10-05 21:35:44.144 | INFO     | database.db_manager:_initialize:38 - 数据库连接初始化成功
2025-10-05 21:35:44.144 | ERROR    | database.redis_manager:_initialize:45 - Redis连接池初始化失败: 'Settings' object has no attribute 'get'
2025-10-05 21:35:44.204 | INFO     | core.nlu.nlu_engine:__init__:53 - ✓ NLU引擎初始化成功: DeepSeek (deepseek-chat)
2025-10-05 21:35:44.204 | ERROR    | core.dst.state_store:__init__:28 - Redis初始化失败: Redis连接池未初始化, 使用内存存储
2025-10-05 21:35:44.204 | INFO     | core.dst.dialog_state_tracker:__init__:27 - 对话状态跟踪器初始化完成
2025-10-05 21:35:44.204 | INFO     | executor.db_executor:__init__:16 - 数据库执行器初始化完成
2025-10-05 21:35:44.204 | INFO     | core.chatbot_dst:__init__:23 - 第二阶段对话系统初始化完成（含DST支持）
2025-10-05 21:35:44.205 | INFO     | core.chatbot_dst:chat:46 - [integration_test_0007] 收到用户输入: 查下我的套餐
2025-10-05 21:35:44.205 | INFO     | core.nlu.nlu_engine:understand:73 - [integration_test_0007] 开始NLU理解: 查下我的套餐
2025-10-05 21:35:44.205 | DEBUG    | core.nlu.nlu_engine:understand:78 - [integration_test_0007] 预处理后: 查下我的套餐
2025-10-05 21:35:44.205 | DEBUG    | core.nlu.nlu_engine:_build_messages:162 - 构建的消息: ['system: 你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业...', 'user: 查下我的套餐...']
2025-10-05 21:35:44.205 | INFO     | core.nlu.nlu_engine:understand:87 - 请求模型message=[{'role': 'system', 'content': '你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业务。\n\n【⭐⭐⭐ 最重要原则】\n- **只处理用户的最后一条消息**，忽略之前的所有用户消息\n- 如果看到多个用户消息，只响应最后一个\n- 每次只调用一个与最后一条用户消息相关的函数\n\n【你的职责】\n1. 理解用户的自然语言需求\n2. **必须**识别用户意图并调用相应的函数，不要进行闲聊\n3. 当信息不完整时,友好地向用户确认缺失的信息\n4. 用专业但亲切的语气与用户交流\n\n【当前可用套餐】\n- 经济套餐: 10G/月, 50元/月, 无限制人群\n- 畅游套餐: 100G/月, 180元/月, 无限制人群\n- 无限套餐: 1000G/月, 300元/月, 无限制人群\n- 校园套餐: 200G/月, 150元/月, 在校生专享\n\n【意图识别规则】\n1. 套餐查询类（query_packages）:\n   - "有什么套餐"、"推荐套餐"、"便宜的套餐"、"100元以内的套餐"\n   - 关键词：套餐、推荐、查询、有什么、价格、便宜\n\n2. 当前套餐查询（query_current_package）:\n   - "我的套餐"、"当前套餐"、"我用的什么套餐"\n   - 关键词：我的、当前、现在的\n\n3. 使用情况查询（query_usage）:  \n   - "用了多少流量"、"剩余流量"、"话费余额"、"查询余量"、"流量使用情况"\n   - 关键词：用了、剩余、余额、余量、流量使用、使用情况\n\n4. 套餐办理（change_package）:\n   - "办理XX套餐"、"换成XX套餐"、"我要办理"\n   - 关键词：办理、更换、变更\n\n【函数调用决策】\n重要：如果对话历史中有多个用户消息，只根据最后一条用户消息来判断意图！\n1. 识别**最后一条用户消息**的关键词\n2. 匹配最相关的单一函数\n3. 只调用该函数\n4. 忽略之前的用户消息\n\n【理解规则】\n- 价格表达要准确理解: "100块以内"→price_max=100, "50元以上"→price_min=50\n- "便宜点的"、"经济实惠"等模糊表达→sort_by="price_asc"\n- "学生套餐"、"校园"→target_user="在校生"\n- 如果用户没有提供手机号,需要礼貌询问，不要从function definitions的description中提取信息当作用户输入的。比如手机号\n\n【重要】\n- **只响应最后一条用户消息**\n- **一次只调用一个函数**\n- 不要试图同时处理多个问题\n- 回答要简洁明了\n'}, {'role': 'user', 'content': '查下我的套餐'}]
2025-10-05 21:35:47.210 | INFO     | core.nlu.nlu_engine:_parse_response:189 - 解析响应=ChatCompletion(id='46b758b5-0b03-4bb0-b0a6-c6090baba595', choices=[Choice(finish_reason='tool_calls', index=0, logprobs=None, message=ChatCompletionMessage(content='', refusal=None, role='assistant', annotations=None, audio=None, function_call=None, tool_calls=[ChatCompletionMessageFunctionToolCall(id='call_00_e4cnJhYy07WhcpvvCWvbSlwW', function=Function(arguments='{"phone": ""}', name='query_current_package'), type='function', index=0)]))], created=1759671346, model='deepseek-chat', object='chat.completion', service_tier=None, system_fingerprint='fp_ffc7281d48_prod0820_fp8_kvcache', usage=CompletionUsage(completion_tokens=13, prompt_tokens=1539, total_tokens=1552, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetails(audio_tokens=None, cached_tokens=512), prompt_cache_hit_tokens=512, prompt_cache_miss_tokens=1027))
2025-10-05 21:35:47.210 | INFO     | core.nlu.nlu_engine:_parse_response:190 - 解析响应: tool_calls数量=1
2025-10-05 21:35:47.211 | INFO     | core.nlu.nlu_engine:_update_session:351 - [integration_test_0007] 意图切换: None -> query_current_package
2025-10-05 21:35:47.211 | INFO     | core.nlu.nlu_engine:understand:105 - [integration_test_0007] NLU完成: intent=query_current_package
2025-10-05 21:35:47.211 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_0007
2025-10-05 21:35:47.211 | DEBUG    | core.dst.state_store:_load_from_memory:121 - 内存中不存在会话: integration_test_0007, 返回新状态
2025-10-05 21:35:47.211 | INFO     | core.dst.dialog_state_tracker:track:59 - 意图改变: None → query_current_package
2025-10-05 21:35:47.211 | DEBUG    | core.dst.slot_manager:fill_slots:61 - 不同领域，仅保留用户信息: []
2025-10-05 21:35:47.211 | INFO     | core.dst.slot_manager:validate_slots:103 - 缺失槽位: ['phone']
2025-10-05 21:35:47.211 | INFO     | core.dst.dialog_state_tracker:_validate_slots:134 - 缺失必填槽位: ['phone']
2025-10-05 21:35:47.211 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_0007
2025-10-05 21:35:47.211 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=1, 需要澄清=True
2025-10-05 21:35:47.211 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_0007] 对话完成 | 意图: query_current_package | 轮次: 1 | 耗时: 3007ms
2025-10-05 21:35:47.212 | INFO     | core.chatbot_dst:chat:46 - [integration_test_0007] 收到用户输入: 13800138000
2025-10-05 21:35:47.212 | INFO     | core.nlu.nlu_engine:understand:73 - [integration_test_0007] 开始NLU理解: 13800138000
2025-10-05 21:35:47.212 | DEBUG    | core.nlu.nlu_engine:understand:78 - [integration_test_0007] 预处理后: 13800138000
2025-10-05 21:35:47.212 | DEBUG    | core.nlu.nlu_engine:_build_messages:162 - 构建的消息: ['system: 你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业...', 'assistant: 请问您的手机号码是多少呢？...', 'user: 13800138000...']
2025-10-05 21:35:47.212 | INFO     | core.nlu.nlu_engine:understand:87 - 请求模型message=[{'role': 'system', 'content': '你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业务。\n\n【⭐⭐⭐ 最重要原则】\n- **只处理用户的最后一条消息**，忽略之前的所有用户消息\n- 如果看到多个用户消息，只响应最后一个\n- 每次只调用一个与最后一条用户消息相关的函数\n\n【你的职责】\n1. 理解用户的自然语言需求\n2. **必须**识别用户意图并调用相应的函数，不要进行闲聊\n3. 当信息不完整时,友好地向用户确认缺失的信息\n4. 用专业但亲切的语气与用户交流\n\n【当前可用套餐】\n- 经济套餐: 10G/月, 50元/月, 无限制人群\n- 畅游套餐: 100G/月, 180元/月, 无限制人群\n- 无限套餐: 1000G/月, 300元/月, 无限制人群\n- 校园套餐: 200G/月, 150元/月, 在校生专享\n\n【意图识别规则】\n1. 套餐查询类（query_packages）:\n   - "有什么套餐"、"推荐套餐"、"便宜的套餐"、"100元以内的套餐"\n   - 关键词：套餐、推荐、查询、有什么、价格、便宜\n\n2. 当前套餐查询（query_current_package）:\n   - "我的套餐"、"当前套餐"、"我用的什么套餐"\n   - 关键词：我的、当前、现在的\n\n3. 使用情况查询（query_usage）:  \n   - "用了多少流量"、"剩余流量"、"话费余额"、"查询余量"、"流量使用情况"\n   - 关键词：用了、剩余、余额、余量、流量使用、使用情况\n\n4. 套餐办理（change_package）:\n   - "办理XX套餐"、"换成XX套餐"、"我要办理"\n   - 关键词：办理、更换、变更\n\n【函数调用决策】\n重要：如果对话历史中有多个用户消息，只根据最后一条用户消息来判断意图！\n1. 识别**最后一条用户消息**的关键词\n2. 匹配最相关的单一函数\n3. 只调用该函数\n4. 忽略之前的用户消息\n\n【理解规则】\n- 价格表达要准确理解: "100块以内"→price_max=100, "50元以上"→price_min=50\n- "便宜点的"、"经济实惠"等模糊表达→sort_by="price_asc"\n- "学生套餐"、"校园"→target_user="在校生"\n- 如果用户没有提供手机号,需要礼貌询问，不要从function definitions的description中提取信息当作用户输入的。比如手机号\n\n【重要】\n- **只响应最后一条用户消息**\n- **一次只调用一个函数**\n- 不要试图同时处理多个问题\n- 回答要简洁明了\n'}, {'role': 'assistant', 'content': '请问您的手机号码是多少呢？'}, {'role': 'user', 'content': '13800138000'}]
2025-10-05 21:35:49.694 | INFO     | core.nlu.nlu_engine:_parse_response:189 - 解析响应=ChatCompletion(id='fb262159-45e2-409c-b560-e4795e56bb3b', choices=[Choice(finish_reason='tool_calls', index=0, logprobs=None, message=ChatCompletionMessage(content='', refusal=None, role='assistant', annotations=None, audio=None, function_call=None, tool_calls=[ChatCompletionMessageFunctionToolCall(id='call_00_wNYEdHZtGVX0KPQ5uuUUNZKl', function=Function(arguments='{"phone": "13800138000"}', name='query_current_package'), type='function', index=0)]))], created=1759671349, model='deepseek-chat', object='chat.completion', service_tier=None, system_fingerprint='fp_ffc7281d48_prod0820_fp8_kvcache', usage=CompletionUsage(completion_tokens=17, prompt_tokens=1547, total_tokens=1564, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetails(audio_tokens=None, cached_tokens=1472), prompt_cache_hit_tokens=1472, prompt_cache_miss_tokens=75))
2025-10-05 21:35:49.694 | INFO     | core.nlu.nlu_engine:_parse_response:190 - 解析响应: tool_calls数量=1
2025-10-05 21:35:49.695 | INFO     | core.nlu.nlu_engine:understand:105 - [integration_test_0007] NLU完成: intent=query_current_package
2025-10-05 21:35:49.695 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_0007
2025-10-05 21:35:49.695 | DEBUG    | core.dst.state_store:_load_from_memory:118 - 从内存加载状态: integration_test_0007
2025-10-05 21:35:49.695 | DEBUG    | core.dst.slot_manager:fill_slots:43 - 意图不变，合并槽位: ['phone']
2025-10-05 21:35:49.695 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_0007
2025-10-05 21:35:49.695 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=2, 需要澄清=False
2025-10-05 21:35:49.696 | INFO     | executor.db_executor:execute_function:29 - 执行Function: query_current_package, 参数: {'phone': '13800138000'}
2025-10-05 21:35:49.752 | INFO     | executor.db_executor:execute_function:50 - Function执行成功: query_current_package
2025-10-05 21:35:49.752 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_0007
2025-10-05 21:35:49.753 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_0007] 对话完成 | 意图: query_current_package | 轮次: 3 | 耗时: 2541ms
2025-10-05 21:35:49.753 | INFO     | core.chatbot_dst:chat:46 - [integration_test_0007] 收到用户输入: 我用了多少流量
2025-10-05 21:35:49.753 | INFO     | core.nlu.nlu_engine:understand:73 - [integration_test_0007] 开始NLU理解: 我用了多少流量
2025-10-05 21:35:49.753 | DEBUG    | core.nlu.nlu_engine:understand:78 - [integration_test_0007] 预处理后: 我用了多少流量
2025-10-05 21:35:49.753 | DEBUG    | core.nlu.nlu_engine:_build_messages:162 - 构建的消息: ['system: 你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业...', 'assistant: 正在查询您的当前套餐...', 'user: 我用了多少流量...']
2025-10-05 21:35:49.753 | INFO     | core.nlu.nlu_engine:understand:87 - 请求模型message=[{'role': 'system', 'content': '你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业务。\n\n【⭐⭐⭐ 最重要原则】\n- **只处理用户的最后一条消息**，忽略之前的所有用户消息\n- 如果看到多个用户消息，只响应最后一个\n- 每次只调用一个与最后一条用户消息相关的函数\n\n【你的职责】\n1. 理解用户的自然语言需求\n2. **必须**识别用户意图并调用相应的函数，不要进行闲聊\n3. 当信息不完整时,友好地向用户确认缺失的信息\n4. 用专业但亲切的语气与用户交流\n\n【当前可用套餐】\n- 经济套餐: 10G/月, 50元/月, 无限制人群\n- 畅游套餐: 100G/月, 180元/月, 无限制人群\n- 无限套餐: 1000G/月, 300元/月, 无限制人群\n- 校园套餐: 200G/月, 150元/月, 在校生专享\n\n【意图识别规则】\n1. 套餐查询类（query_packages）:\n   - "有什么套餐"、"推荐套餐"、"便宜的套餐"、"100元以内的套餐"\n   - 关键词：套餐、推荐、查询、有什么、价格、便宜\n\n2. 当前套餐查询（query_current_package）:\n   - "我的套餐"、"当前套餐"、"我用的什么套餐"\n   - 关键词：我的、当前、现在的\n\n3. 使用情况查询（query_usage）:  \n   - "用了多少流量"、"剩余流量"、"话费余额"、"查询余量"、"流量使用情况"\n   - 关键词：用了、剩余、余额、余量、流量使用、使用情况\n\n4. 套餐办理（change_package）:\n   - "办理XX套餐"、"换成XX套餐"、"我要办理"\n   - 关键词：办理、更换、变更\n\n【函数调用决策】\n重要：如果对话历史中有多个用户消息，只根据最后一条用户消息来判断意图！\n1. 识别**最后一条用户消息**的关键词\n2. 匹配最相关的单一函数\n3. 只调用该函数\n4. 忽略之前的用户消息\n\n【理解规则】\n- 价格表达要准确理解: "100块以内"→price_max=100, "50元以上"→price_min=50\n- "便宜点的"、"经济实惠"等模糊表达→sort_by="price_asc"\n- "学生套餐"、"校园"→target_user="在校生"\n- 如果用户没有提供手机号,需要礼貌询问，不要从function definitions的description中提取信息当作用户输入的。比如手机号\n\n【重要】\n- **只响应最后一条用户消息**\n- **一次只调用一个函数**\n- 不要试图同时处理多个问题\n- 回答要简洁明了\n'}, {'role': 'assistant', 'content': '正在查询您的当前套餐'}, {'role': 'user', 'content': '我用了多少流量'}]
2025-10-05 21:35:52.155 | INFO     | core.nlu.nlu_engine:_parse_response:189 - 解析响应=ChatCompletion(id='7777196c-c11c-4cf3-a991-72bfc9153833', choices=[Choice(finish_reason='tool_calls', index=0, logprobs=None, message=ChatCompletionMessage(content='', refusal=None, role='assistant', annotations=None, audio=None, function_call=None, tool_calls=[ChatCompletionMessageFunctionToolCall(id='call_00_z86fIhjb78SIopscflz7VKPe', function=Function(arguments='{"phone": "", "query_type": "data"}', name='query_usage'), type='function', index=0)]))], created=1759671352, model='deepseek-chat', object='chat.completion', service_tier=None, system_fingerprint='fp_ffc7281d48_prod0820_fp8_kvcache', usage=CompletionUsage(completion_tokens=18, prompt_tokens=1545, total_tokens=1563, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetails(audio_tokens=None, cached_tokens=1472), prompt_cache_hit_tokens=1472, prompt_cache_miss_tokens=73))
2025-10-05 21:35:52.155 | INFO     | core.nlu.nlu_engine:_parse_response:190 - 解析响应: tool_calls数量=1
2025-10-05 21:35:52.155 | INFO     | core.nlu.nlu_engine:_update_session:351 - [integration_test_0007] 意图切换: query_current_package -> query_usage
2025-10-05 21:35:52.155 | INFO     | core.nlu.nlu_engine:understand:105 - [integration_test_0007] NLU完成: intent=query_usage
2025-10-05 21:35:52.155 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_0007
2025-10-05 21:35:52.155 | DEBUG    | core.dst.state_store:_load_from_memory:118 - 从内存加载状态: integration_test_0007
2025-10-05 21:35:52.156 | INFO     | core.dst.dialog_state_tracker:track:59 - 意图改变: query_current_package → query_usage
2025-10-05 21:35:52.156 | DEBUG    | core.dst.slot_manager:fill_slots:52 - 相同领域，保留槽位: ['phone']
2025-10-05 21:35:52.156 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_0007
2025-10-05 21:35:52.156 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=4, 需要澄清=False
2025-10-05 21:35:52.156 | INFO     | executor.db_executor:execute_function:29 - 执行Function: query_usage, 参数: {'phone': '13800138000', 'query_type': 'data'}
2025-10-05 21:35:52.160 | INFO     | executor.db_executor:execute_function:50 - Function执行成功: query_usage
2025-10-05 21:35:52.160 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_0007
2025-10-05 21:35:52.161 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_0007] 对话完成 | 意图: query_usage | 轮次: 5 | 耗时: 2408ms
2025-10-05 21:37:44.649 | INFO     | database.db_manager:_initialize:38 - 数据库连接初始化成功
2025-10-05 21:37:44.649 | ERROR    | database.redis_manager:_initialize:45 - Redis连接池初始化失败: 'Settings' object has no attribute 'get'
2025-10-05 21:37:44.707 | INFO     | core.nlu.nlu_engine:__init__:53 - ✓ NLU引擎初始化成功: DeepSeek (deepseek-chat)
2025-10-05 21:37:44.707 | ERROR    | core.dst.state_store:__init__:28 - Redis初始化失败: Redis连接池未初始化, 使用内存存储
2025-10-05 21:37:44.707 | INFO     | core.dst.dialog_state_tracker:__init__:27 - 对话状态跟踪器初始化完成
2025-10-05 21:37:44.707 | INFO     | executor.db_executor:__init__:16 - 数据库执行器初始化完成
2025-10-05 21:37:44.707 | INFO     | core.chatbot_dst:__init__:23 - 第二阶段对话系统初始化完成（含DST支持）
2025-10-05 21:37:44.708 | INFO     | core.chatbot_dst:chat:46 - [integration_test_005] 收到用户输入: 100元以内的套餐
2025-10-05 21:37:44.708 | INFO     | core.nlu.nlu_engine:understand:73 - [integration_test_005] 开始NLU理解: 100元以内的套餐
2025-10-05 21:37:44.708 | DEBUG    | core.nlu.nlu_engine:understand:78 - [integration_test_005] 预处理后: 100元以内的套餐
2025-10-05 21:37:44.708 | DEBUG    | core.nlu.nlu_engine:_build_messages:162 - 构建的消息: ['system: 你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业...', 'user: 100元以内的套餐...']
2025-10-05 21:37:44.708 | INFO     | core.nlu.nlu_engine:understand:87 - 请求模型message=[{'role': 'system', 'content': '你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业务。\n\n【⭐⭐⭐ 最重要原则】\n- **只处理用户的最后一条消息**，忽略之前的所有用户消息\n- 如果看到多个用户消息，只响应最后一个\n- 每次只调用一个与最后一条用户消息相关的函数\n\n【你的职责】\n1. 理解用户的自然语言需求\n2. **必须**识别用户意图并调用相应的函数，不要进行闲聊\n3. 当信息不完整时,友好地向用户确认缺失的信息\n4. 用专业但亲切的语气与用户交流\n\n【当前可用套餐】\n- 经济套餐: 10G/月, 50元/月, 无限制人群\n- 畅游套餐: 100G/月, 180元/月, 无限制人群\n- 无限套餐: 1000G/月, 300元/月, 无限制人群\n- 校园套餐: 200G/月, 150元/月, 在校生专享\n\n【意图识别规则】\n1. 套餐查询类（query_packages）:\n   - "有什么套餐"、"推荐套餐"、"便宜的套餐"、"100元以内的套餐"\n   - 关键词：套餐、推荐、查询、有什么、价格、便宜\n\n2. 当前套餐查询（query_current_package）:\n   - "我的套餐"、"当前套餐"、"我用的什么套餐"\n   - 关键词：我的、当前、现在的\n\n3. 使用情况查询（query_usage）:  \n   - "用了多少流量"、"剩余流量"、"话费余额"、"查询余量"、"流量使用情况"\n   - 关键词：用了、剩余、余额、余量、流量使用、使用情况\n\n4. 套餐办理（change_package）:\n   - "办理XX套餐"、"换成XX套餐"、"我要办理"\n   - 关键词：办理、更换、变更\n\n【函数调用决策】\n重要：如果对话历史中有多个用户消息，只根据最后一条用户消息来判断意图！\n1. 识别**最后一条用户消息**的关键词\n2. 匹配最相关的单一函数\n3. 只调用该函数\n4. 忽略之前的用户消息\n\n【理解规则】\n- 价格表达要准确理解: "100块以内"→price_max=100, "50元以上"→price_min=50\n- "便宜点的"、"经济实惠"等模糊表达→sort_by="price_asc"\n- "学生套餐"、"校园"→target_user="在校生"\n- 如果用户没有提供手机号,需要礼貌询问，不要从function definitions的description中提取信息当作用户输入的。比如手机号\n\n【重要】\n- **只响应最后一条用户消息**\n- **一次只调用一个函数**\n- 不要试图同时处理多个问题\n- 回答要简洁明了\n'}, {'role': 'user', 'content': '100元以内的套餐'}]
2025-10-05 21:37:47.981 | INFO     | core.nlu.nlu_engine:_parse_response:189 - 解析响应=ChatCompletion(id='05a2afa2-d7f5-446f-a8a5-a0a2ed767a5e', choices=[Choice(finish_reason='tool_calls', index=0, logprobs=None, message=ChatCompletionMessage(content='', refusal=None, role='assistant', annotations=None, audio=None, function_call=None, tool_calls=[ChatCompletionMessageFunctionToolCall(id='call_00_snCJWml2Vy1nJKacUwjHKVXr', function=Function(arguments='{"price_max": 100, "sort_by": "price_asc"}', name='query_packages'), type='function', index=0)]))], created=1759671467, model='deepseek-chat', object='chat.completion', service_tier=None, system_fingerprint='fp_ffc7281d48_prod0820_fp8_kvcache', usage=CompletionUsage(completion_tokens=23, prompt_tokens=1539, total_tokens=1562, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetails(audio_tokens=None, cached_tokens=1472), prompt_cache_hit_tokens=1472, prompt_cache_miss_tokens=67))
2025-10-05 21:37:47.981 | INFO     | core.nlu.nlu_engine:_parse_response:190 - 解析响应: tool_calls数量=1
2025-10-05 21:37:47.982 | INFO     | core.nlu.nlu_engine:_update_session:351 - [integration_test_005] 意图切换: None -> query_packages
2025-10-05 21:37:47.982 | INFO     | core.nlu.nlu_engine:understand:105 - [integration_test_005] NLU完成: intent=query_packages
2025-10-05 21:37:47.982 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_005
2025-10-05 21:37:47.982 | DEBUG    | core.dst.state_store:_load_from_memory:121 - 内存中不存在会话: integration_test_005, 返回新状态
2025-10-05 21:37:47.982 | INFO     | core.dst.dialog_state_tracker:track:59 - 意图改变: None → query_packages
2025-10-05 21:37:47.982 | DEBUG    | core.dst.slot_manager:fill_slots:61 - 不同领域，仅保留用户信息: []
2025-10-05 21:37:47.982 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_005
2025-10-05 21:37:47.982 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=1, 需要澄清=False
2025-10-05 21:37:47.982 | INFO     | executor.db_executor:execute_function:29 - 执行Function: query_packages, 参数: {'price_max': 100, 'sort_by': 'price_asc'}
2025-10-05 21:37:48.037 | INFO     | executor.db_executor:execute_function:50 - Function执行成功: query_packages
2025-10-05 21:37:48.037 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_005
2025-10-05 21:37:48.038 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_005] 对话完成 | 意图: query_packages | 轮次: 2 | 耗时: 3330ms
2025-10-05 21:37:48.038 | INFO     | core.chatbot_dst:chat:46 - [integration_test_005] 收到用户输入: 查询我的流量使用情况
2025-10-05 21:37:48.038 | INFO     | core.nlu.nlu_engine:understand:73 - [integration_test_005] 开始NLU理解: 查询我的流量使用情况
2025-10-05 21:37:48.038 | DEBUG    | core.nlu.nlu_engine:understand:78 - [integration_test_005] 预处理后: 查询我的流量使用情况
2025-10-05 21:37:48.038 | DEBUG    | core.nlu.nlu_engine:_build_messages:162 - 构建的消息: ['system: 你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业...', 'assistant: 正在查询套餐信息...', 'user: 查询我的流量使用情况...']
2025-10-05 21:37:48.038 | INFO     | core.nlu.nlu_engine:understand:87 - 请求模型message=[{'role': 'system', 'content': '你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业务。\n\n【⭐⭐⭐ 最重要原则】\n- **只处理用户的最后一条消息**，忽略之前的所有用户消息\n- 如果看到多个用户消息，只响应最后一个\n- 每次只调用一个与最后一条用户消息相关的函数\n\n【你的职责】\n1. 理解用户的自然语言需求\n2. **必须**识别用户意图并调用相应的函数，不要进行闲聊\n3. 当信息不完整时,友好地向用户确认缺失的信息\n4. 用专业但亲切的语气与用户交流\n\n【当前可用套餐】\n- 经济套餐: 10G/月, 50元/月, 无限制人群\n- 畅游套餐: 100G/月, 180元/月, 无限制人群\n- 无限套餐: 1000G/月, 300元/月, 无限制人群\n- 校园套餐: 200G/月, 150元/月, 在校生专享\n\n【意图识别规则】\n1. 套餐查询类（query_packages）:\n   - "有什么套餐"、"推荐套餐"、"便宜的套餐"、"100元以内的套餐"\n   - 关键词：套餐、推荐、查询、有什么、价格、便宜\n\n2. 当前套餐查询（query_current_package）:\n   - "我的套餐"、"当前套餐"、"我用的什么套餐"\n   - 关键词：我的、当前、现在的\n\n3. 使用情况查询（query_usage）:  \n   - "用了多少流量"、"剩余流量"、"话费余额"、"查询余量"、"流量使用情况"\n   - 关键词：用了、剩余、余额、余量、流量使用、使用情况\n\n4. 套餐办理（change_package）:\n   - "办理XX套餐"、"换成XX套餐"、"我要办理"\n   - 关键词：办理、更换、变更\n\n【函数调用决策】\n重要：如果对话历史中有多个用户消息，只根据最后一条用户消息来判断意图！\n1. 识别**最后一条用户消息**的关键词\n2. 匹配最相关的单一函数\n3. 只调用该函数\n4. 忽略之前的用户消息\n\n【理解规则】\n- 价格表达要准确理解: "100块以内"→price_max=100, "50元以上"→price_min=50\n- "便宜点的"、"经济实惠"等模糊表达→sort_by="price_asc"\n- "学生套餐"、"校园"→target_user="在校生"\n- 如果用户没有提供手机号,需要礼貌询问，不要从function definitions的description中提取信息当作用户输入的。比如手机号\n\n【重要】\n- **只响应最后一条用户消息**\n- **一次只调用一个函数**\n- 不要试图同时处理多个问题\n- 回答要简洁明了\n'}, {'role': 'assistant', 'content': '正在查询套餐信息'}, {'role': 'user', 'content': '查询我的流量使用情况'}]
2025-10-05 21:37:50.351 | INFO     | core.nlu.nlu_engine:_parse_response:189 - 解析响应=ChatCompletion(id='50597dff-7674-4821-a7fc-3995b5b36ee0', choices=[Choice(finish_reason='tool_calls', index=0, logprobs=None, message=ChatCompletionMessage(content='', refusal=None, role='assistant', annotations=None, audio=None, function_call=None, tool_calls=[ChatCompletionMessageFunctionToolCall(id='call_00_AEhxOaBkeLWRr2ilXKCb3EOx', function=Function(arguments='{"phone": "", "query_type": "all"}', name='query_usage'), type='function', index=0)]))], created=1759671470, model='deepseek-chat', object='chat.completion', service_tier=None, system_fingerprint='fp_ffc7281d48_prod0820_fp8_kvcache', usage=CompletionUsage(completion_tokens=18, prompt_tokens=1545, total_tokens=1563, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetails(audio_tokens=None, cached_tokens=1472), prompt_cache_hit_tokens=1472, prompt_cache_miss_tokens=73))
2025-10-05 21:37:50.352 | INFO     | core.nlu.nlu_engine:_parse_response:190 - 解析响应: tool_calls数量=1
2025-10-05 21:37:50.352 | INFO     | core.nlu.nlu_engine:_update_session:351 - [integration_test_005] 意图切换: query_packages -> query_usage
2025-10-05 21:37:50.352 | INFO     | core.nlu.nlu_engine:understand:105 - [integration_test_005] NLU完成: intent=query_usage
2025-10-05 21:37:50.353 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_005
2025-10-05 21:37:50.353 | DEBUG    | core.dst.state_store:_load_from_memory:118 - 从内存加载状态: integration_test_005
2025-10-05 21:37:50.353 | INFO     | core.dst.dialog_state_tracker:track:59 - 意图改变: query_packages → query_usage
2025-10-05 21:37:50.353 | DEBUG    | core.dst.slot_manager:fill_slots:61 - 不同领域，仅保留用户信息: []
2025-10-05 21:37:50.353 | INFO     | core.dst.slot_manager:validate_slots:103 - 缺失槽位: ['phone']
2025-10-05 21:37:50.353 | INFO     | core.dst.dialog_state_tracker:_validate_slots:134 - 缺失必填槽位: ['phone']
2025-10-05 21:37:50.353 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_005
2025-10-05 21:37:50.353 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=3, 需要澄清=True
2025-10-05 21:37:50.354 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_005] 对话完成 | 意图: query_usage | 轮次: 3 | 耗时: 2316ms
2025-10-05 21:40:29.457 | INFO     | database.db_manager:_initialize:38 - 数据库连接初始化成功
2025-10-05 21:40:29.457 | ERROR    | database.redis_manager:_initialize:45 - Redis连接池初始化失败: 'Settings' object has no attribute 'get'
2025-10-05 21:40:29.516 | INFO     | core.nlu.nlu_engine:__init__:53 - ✓ NLU引擎初始化成功: DeepSeek (deepseek-chat)
2025-10-05 21:40:29.516 | ERROR    | core.dst.state_store:__init__:28 - Redis初始化失败: Redis连接池未初始化, 使用内存存储
2025-10-05 21:40:29.516 | INFO     | core.dst.dialog_state_tracker:__init__:27 - 对话状态跟踪器初始化完成
2025-10-05 21:40:29.516 | INFO     | executor.db_executor:__init__:16 - 数据库执行器初始化完成
2025-10-05 21:40:29.516 | INFO     | core.chatbot_dst:__init__:23 - 第二阶段对话系统初始化完成（含DST支持）
2025-10-05 21:40:29.516 | INFO     | core.chatbot_dst:chat:46 - [integration_test_005] 收到用户输入: 100元以内的套餐
2025-10-05 21:40:29.516 | INFO     | core.nlu.nlu_engine:understand:73 - [integration_test_005] 开始NLU理解: 100元以内的套餐
2025-10-05 21:40:29.516 | DEBUG    | core.nlu.nlu_engine:understand:78 - [integration_test_005] 预处理后: 100元以内的套餐
2025-10-05 21:40:29.516 | DEBUG    | core.nlu.nlu_engine:_build_messages:162 - 构建的消息: ['system: 你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业...', 'user: 100元以内的套餐...']
2025-10-05 21:40:29.516 | INFO     | core.nlu.nlu_engine:understand:87 - 请求模型message=[{'role': 'system', 'content': '你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业务。\n\n【⭐⭐⭐ 最重要原则】\n- **只处理用户的最后一条消息**，忽略之前的所有用户消息\n- 如果看到多个用户消息，只响应最后一个\n- 每次只调用一个与最后一条用户消息相关的函数\n\n【你的职责】\n1. 理解用户的自然语言需求\n2. **必须**识别用户意图并调用相应的函数，不要进行闲聊\n3. 当信息不完整时,友好地向用户确认缺失的信息\n4. 用专业但亲切的语气与用户交流\n\n【当前可用套餐】\n- 经济套餐: 10G/月, 50元/月, 无限制人群\n- 畅游套餐: 100G/月, 180元/月, 无限制人群\n- 无限套餐: 1000G/月, 300元/月, 无限制人群\n- 校园套餐: 200G/月, 150元/月, 在校生专享\n\n【意图识别规则】\n1. 套餐查询类（query_packages）:\n   - "有什么套餐"、"推荐套餐"、"便宜的套餐"、"100元以内的套餐"\n   - 关键词：套餐、推荐、查询、有什么、价格、便宜\n\n2. 当前套餐查询（query_current_package）:\n   - "我的套餐"、"当前套餐"、"我用的什么套餐"\n   - 关键词：我的、当前、现在的\n\n3. 使用情况查询（query_usage）:  \n   - "用了多少流量"、"剩余流量"、"话费余额"、"查询余量"、"流量使用情况"\n   - 关键词：用了、剩余、余额、余量、流量使用、使用情况\n\n4. 套餐办理（change_package）:\n   - "办理XX套餐"、"换成XX套餐"、"我要办理"\n   - 关键词：办理、更换、变更\n\n【函数调用决策】\n重要：如果对话历史中有多个用户消息，只根据最后一条用户消息来判断意图！\n1. 识别**最后一条用户消息**的关键词\n2. 匹配最相关的单一函数\n3. 只调用该函数\n4. 忽略之前的用户消息\n\n【理解规则】\n- 价格表达要准确理解: "100块以内"→price_max=100, "50元以上"→price_min=50\n- "便宜点的"、"经济实惠"等模糊表达→sort_by="price_asc"\n- "学生套餐"、"校园"→target_user="在校生"\n- 如果用户没有提供手机号,需要礼貌询问，不要从function definitions的description中提取信息当作用户输入的。比如手机号\n\n【重要】\n- **只响应最后一条用户消息**\n- **一次只调用一个函数**\n- 不要试图同时处理多个问题\n- 回答要简洁明了\n'}, {'role': 'user', 'content': '100元以内的套餐'}]
2025-10-05 21:40:32.103 | INFO     | core.nlu.nlu_engine:_parse_response:189 - 解析响应=ChatCompletion(id='78c94364-e874-44ac-a4ea-f460041ec9db', choices=[Choice(finish_reason='tool_calls', index=0, logprobs=None, message=ChatCompletionMessage(content='', refusal=None, role='assistant', annotations=None, audio=None, function_call=None, tool_calls=[ChatCompletionMessageFunctionToolCall(id='call_00_0gl6ROlTltYK3NXDISUOtBrH', function=Function(arguments='{"price_max": 100}', name='query_packages'), type='function', index=0)]))], created=1759671632, model='deepseek-chat', object='chat.completion', service_tier=None, system_fingerprint='fp_ffc7281d48_prod0820_fp8_kvcache', usage=CompletionUsage(completion_tokens=14, prompt_tokens=1539, total_tokens=1553, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetails(audio_tokens=None, cached_tokens=1536), prompt_cache_hit_tokens=1536, prompt_cache_miss_tokens=3))
2025-10-05 21:40:32.104 | INFO     | core.nlu.nlu_engine:_parse_response:190 - 解析响应: tool_calls数量=1
2025-10-05 21:40:32.104 | INFO     | core.nlu.nlu_engine:_update_session:351 - [integration_test_005] 意图切换: None -> query_packages
2025-10-05 21:40:32.104 | INFO     | core.nlu.nlu_engine:understand:105 - [integration_test_005] NLU完成: intent=query_packages
2025-10-05 21:40:32.104 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_005
2025-10-05 21:40:32.104 | DEBUG    | core.dst.state_store:_load_from_memory:121 - 内存中不存在会话: integration_test_005, 返回新状态
2025-10-05 21:40:32.104 | INFO     | core.dst.dialog_state_tracker:track:59 - 意图改变: None → query_packages
2025-10-05 21:40:32.104 | DEBUG    | core.dst.slot_manager:fill_slots:61 - 不同领域，仅保留用户信息: []
2025-10-05 21:40:32.104 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_005
2025-10-05 21:40:32.104 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=1, 需要澄清=False
2025-10-05 21:40:32.104 | INFO     | executor.db_executor:execute_function:29 - 执行Function: query_packages, 参数: {'price_max': 100}
2025-10-05 21:40:32.158 | INFO     | executor.db_executor:execute_function:50 - Function执行成功: query_packages
2025-10-05 21:40:32.159 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_005
2025-10-05 21:40:32.159 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_005] 对话完成 | 意图: query_packages | 轮次: 2 | 耗时: 2643ms
2025-10-05 21:40:32.159 | INFO     | core.chatbot_dst:chat:46 - [integration_test_005] 收到用户输入: 查询我的流量使用情况
2025-10-05 21:40:32.159 | INFO     | core.nlu.nlu_engine:understand:73 - [integration_test_005] 开始NLU理解: 查询我的流量使用情况
2025-10-05 21:40:32.159 | DEBUG    | core.nlu.nlu_engine:understand:78 - [integration_test_005] 预处理后: 查询我的流量使用情况
2025-10-05 21:40:32.159 | DEBUG    | core.nlu.nlu_engine:_build_messages:162 - 构建的消息: ['system: 你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业...', 'assistant: 正在查询套餐信息...', 'user: 查询我的流量使用情况...']
2025-10-05 21:40:32.159 | INFO     | core.nlu.nlu_engine:understand:87 - 请求模型message=[{'role': 'system', 'content': '你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业务。\n\n【⭐⭐⭐ 最重要原则】\n- **只处理用户的最后一条消息**，忽略之前的所有用户消息\n- 如果看到多个用户消息，只响应最后一个\n- 每次只调用一个与最后一条用户消息相关的函数\n\n【你的职责】\n1. 理解用户的自然语言需求\n2. **必须**识别用户意图并调用相应的函数，不要进行闲聊\n3. 当信息不完整时,友好地向用户确认缺失的信息\n4. 用专业但亲切的语气与用户交流\n\n【当前可用套餐】\n- 经济套餐: 10G/月, 50元/月, 无限制人群\n- 畅游套餐: 100G/月, 180元/月, 无限制人群\n- 无限套餐: 1000G/月, 300元/月, 无限制人群\n- 校园套餐: 200G/月, 150元/月, 在校生专享\n\n【意图识别规则】\n1. 套餐查询类（query_packages）:\n   - "有什么套餐"、"推荐套餐"、"便宜的套餐"、"100元以内的套餐"\n   - 关键词：套餐、推荐、查询、有什么、价格、便宜\n\n2. 当前套餐查询（query_current_package）:\n   - "我的套餐"、"当前套餐"、"我用的什么套餐"\n   - 关键词：我的、当前、现在的\n\n3. 使用情况查询（query_usage）:  \n   - "用了多少流量"、"剩余流量"、"话费余额"、"查询余量"、"流量使用情况"\n   - 关键词：用了、剩余、余额、余量、流量使用、使用情况\n\n4. 套餐办理（change_package）:\n   - "办理XX套餐"、"换成XX套餐"、"我要办理"\n   - 关键词：办理、更换、变更\n\n【函数调用决策】\n重要：如果对话历史中有多个用户消息，只根据最后一条用户消息来判断意图！\n1. 识别**最后一条用户消息**的关键词\n2. 匹配最相关的单一函数\n3. 只调用该函数\n4. 忽略之前的用户消息\n\n【理解规则】\n- 价格表达要准确理解: "100块以内"→price_max=100, "50元以上"→price_min=50\n- "便宜点的"、"经济实惠"等模糊表达→sort_by="price_asc"\n- "学生套餐"、"校园"→target_user="在校生"\n- 如果用户没有提供手机号,需要礼貌询问，不要从function definitions的description中提取信息当作用户输入的。比如手机号\n\n【重要】\n- **只响应最后一条用户消息**\n- **一次只调用一个函数**\n- 不要试图同时处理多个问题\n- 回答要简洁明了\n'}, {'role': 'assistant', 'content': '正在查询套餐信息'}, {'role': 'user', 'content': '查询我的流量使用情况'}]
2025-10-05 21:40:34.748 | INFO     | core.nlu.nlu_engine:_parse_response:189 - 解析响应=ChatCompletion(id='54bbfe3b-aca7-46d5-acd8-87a649e28107', choices=[Choice(finish_reason='tool_calls', index=0, logprobs=None, message=ChatCompletionMessage(content='', refusal=None, role='assistant', annotations=None, audio=None, function_call=None, tool_calls=[ChatCompletionMessageFunctionToolCall(id='call_00_a1GFPsRUZxdAhTZyj6C9yyfu', function=Function(arguments='{"phone": "", "query_type": "all"}', name='query_usage'), type='function', index=0)]))], created=1759671634, model='deepseek-chat', object='chat.completion', service_tier=None, system_fingerprint='fp_ffc7281d48_prod0820_fp8_kvcache', usage=CompletionUsage(completion_tokens=18, prompt_tokens=1545, total_tokens=1563, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetails(audio_tokens=None, cached_tokens=1536), prompt_cache_hit_tokens=1536, prompt_cache_miss_tokens=9))
2025-10-05 21:40:34.749 | INFO     | core.nlu.nlu_engine:_parse_response:190 - 解析响应: tool_calls数量=1
2025-10-05 21:40:34.749 | INFO     | core.nlu.nlu_engine:_update_session:351 - [integration_test_005] 意图切换: query_packages -> query_usage
2025-10-05 21:40:34.749 | INFO     | core.nlu.nlu_engine:understand:105 - [integration_test_005] NLU完成: intent=query_usage
2025-10-05 21:40:34.749 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_005
2025-10-05 21:40:34.749 | DEBUG    | core.dst.state_store:_load_from_memory:118 - 从内存加载状态: integration_test_005
2025-10-05 21:40:34.749 | INFO     | core.dst.dialog_state_tracker:track:59 - 意图改变: query_packages → query_usage
2025-10-05 21:40:34.750 | DEBUG    | core.dst.slot_manager:fill_slots:61 - 不同领域，仅保留用户信息: []
2025-10-05 21:40:34.750 | INFO     | core.dst.slot_manager:validate_slots:103 - 缺失槽位: ['phone']
2025-10-05 21:40:34.750 | INFO     | core.dst.dialog_state_tracker:_validate_slots:134 - 缺失必填槽位: ['phone']
2025-10-05 21:40:34.750 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_005
2025-10-05 21:40:34.750 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=3, 需要澄清=True
2025-10-05 21:40:34.750 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_005] 对话完成 | 意图: query_usage | 轮次: 3 | 耗时: 2591ms
2025-10-05 21:41:25.930 | INFO     | database.db_manager:_initialize:38 - 数据库连接初始化成功
2025-10-05 21:41:25.931 | ERROR    | database.redis_manager:_initialize:45 - Redis连接池初始化失败: 'Settings' object has no attribute 'get'
2025-10-05 21:41:26.030 | INFO     | core.nlu.nlu_engine:__init__:53 - ✓ NLU引擎初始化成功: DeepSeek (deepseek-chat)
2025-10-05 21:41:26.031 | ERROR    | core.dst.state_store:__init__:28 - Redis初始化失败: Redis连接池未初始化, 使用内存存储
2025-10-05 21:41:26.031 | INFO     | core.dst.dialog_state_tracker:__init__:27 - 对话状态跟踪器初始化完成
2025-10-05 21:41:26.031 | INFO     | executor.db_executor:__init__:16 - 数据库执行器初始化完成
2025-10-05 21:41:26.031 | INFO     | core.chatbot_dst:__init__:23 - 第二阶段对话系统初始化完成（含DST支持）
2025-10-05 21:41:44.503 | INFO     | core.chatbot_dst:chat:46 - [integration_test_005] 收到用户输入: 100元以内的套餐
2025-10-05 21:41:54.401 | INFO     | core.nlu.nlu_engine:understand:73 - [integration_test_005] 开始NLU理解: 100元以内的套餐
2025-10-05 21:41:54.402 | DEBUG    | core.nlu.nlu_engine:understand:78 - [integration_test_005] 预处理后: 100元以内的套餐
2025-10-05 21:42:02.407 | DEBUG    | core.nlu.nlu_engine:_build_messages:162 - 构建的消息: ['system: 你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业...', 'user: 100元以内的套餐...']
2025-10-05 21:42:02.409 | INFO     | core.nlu.nlu_engine:understand:87 - 请求模型message=[{'role': 'system', 'content': '你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业务。\n\n【⭐⭐⭐ 最重要原则】\n- **只处理用户的最后一条消息**，忽略之前的所有用户消息\n- 如果看到多个用户消息，只响应最后一个\n- 每次只调用一个与最后一条用户消息相关的函数\n\n【你的职责】\n1. 理解用户的自然语言需求\n2. **必须**识别用户意图并调用相应的函数，不要进行闲聊\n3. 当信息不完整时,友好地向用户确认缺失的信息\n4. 用专业但亲切的语气与用户交流\n\n【当前可用套餐】\n- 经济套餐: 10G/月, 50元/月, 无限制人群\n- 畅游套餐: 100G/月, 180元/月, 无限制人群\n- 无限套餐: 1000G/月, 300元/月, 无限制人群\n- 校园套餐: 200G/月, 150元/月, 在校生专享\n\n【意图识别规则】\n1. 套餐查询类（query_packages）:\n   - "有什么套餐"、"推荐套餐"、"便宜的套餐"、"100元以内的套餐"\n   - 关键词：套餐、推荐、查询、有什么、价格、便宜\n\n2. 当前套餐查询（query_current_package）:\n   - "我的套餐"、"当前套餐"、"我用的什么套餐"\n   - 关键词：我的、当前、现在的\n\n3. 使用情况查询（query_usage）:  \n   - "用了多少流量"、"剩余流量"、"话费余额"、"查询余量"、"流量使用情况"\n   - 关键词：用了、剩余、余额、余量、流量使用、使用情况\n\n4. 套餐办理（change_package）:\n   - "办理XX套餐"、"换成XX套餐"、"我要办理"\n   - 关键词：办理、更换、变更\n\n【函数调用决策】\n重要：如果对话历史中有多个用户消息，只根据最后一条用户消息来判断意图！\n1. 识别**最后一条用户消息**的关键词\n2. 匹配最相关的单一函数\n3. 只调用该函数\n4. 忽略之前的用户消息\n\n【理解规则】\n- 价格表达要准确理解: "100块以内"→price_max=100, "50元以上"→price_min=50\n- "便宜点的"、"经济实惠"等模糊表达→sort_by="price_asc"\n- "学生套餐"、"校园"→target_user="在校生"\n- 如果用户没有提供手机号,需要礼貌询问，不要从function definitions的description中提取信息当作用户输入的。比如手机号\n\n【重要】\n- **只响应最后一条用户消息**\n- **一次只调用一个函数**\n- 不要试图同时处理多个问题\n- 回答要简洁明了\n'}, {'role': 'user', 'content': '100元以内的套餐'}]
2025-10-05 21:42:06.496 | INFO     | core.nlu.nlu_engine:_parse_response:189 - 解析响应=ChatCompletion(id='7625f81b-50cd-4f32-b332-92ebe646b10e', choices=[Choice(finish_reason='tool_calls', index=0, logprobs=None, message=ChatCompletionMessage(content='', refusal=None, role='assistant', annotations=None, audio=None, function_call=None, tool_calls=[ChatCompletionMessageFunctionToolCall(id='call_00_0lTyU4eaUQNwwX7ZQZyxsjAU', function=Function(arguments='{"price_max": 100, "sort_by": "price_asc"}', name='query_packages'), type='function', index=0)]))], created=1759671726, model='deepseek-chat', object='chat.completion', service_tier=None, system_fingerprint='fp_ffc7281d48_prod0820_fp8_kvcache', usage=CompletionUsage(completion_tokens=23, prompt_tokens=1539, total_tokens=1562, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetails(audio_tokens=None, cached_tokens=1536), prompt_cache_hit_tokens=1536, prompt_cache_miss_tokens=3))
2025-10-05 21:42:06.497 | INFO     | core.nlu.nlu_engine:_parse_response:190 - 解析响应: tool_calls数量=1
2025-10-05 21:42:06.497 | INFO     | core.nlu.nlu_engine:_update_session:351 - [integration_test_005] 意图切换: None -> query_packages
2025-10-05 21:42:06.497 | INFO     | core.nlu.nlu_engine:understand:105 - [integration_test_005] NLU完成: intent=query_packages
2025-10-05 21:42:18.492 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_005
2025-10-05 21:42:22.561 | DEBUG    | core.dst.state_store:_load_from_memory:121 - 内存中不存在会话: integration_test_005, 返回新状态
2025-10-05 21:42:22.562 | INFO     | core.dst.dialog_state_tracker:track:59 - 意图改变: None → query_packages
2025-10-05 21:42:22.562 | DEBUG    | core.dst.slot_manager:fill_slots:61 - 不同领域，仅保留用户信息: []
2025-10-05 21:42:32.050 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_005
2025-10-05 21:42:32.051 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=1, 需要澄清=False
2025-10-05 21:42:34.583 | INFO     | executor.db_executor:execute_function:29 - 执行Function: query_packages, 参数: {'price_max': 100, 'sort_by': 'price_asc'}
2025-10-05 21:42:35.717 | INFO     | executor.db_executor:execute_function:50 - Function执行成功: query_packages
2025-10-05 21:42:35.718 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_005
2025-10-05 21:42:35.718 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_005] 对话完成 | 意图: query_packages | 轮次: 2 | 耗时: 51216ms
2025-10-05 21:42:47.630 | INFO     | core.chatbot_dst:chat:46 - [integration_test_005] 收到用户输入: 查询我的流量使用情况
2025-10-05 21:42:56.193 | INFO     | core.nlu.nlu_engine:understand:73 - [integration_test_005] 开始NLU理解: 查询我的流量使用情况
2025-10-05 21:42:56.195 | DEBUG    | core.nlu.nlu_engine:understand:78 - [integration_test_005] 预处理后: 查询我的流量使用情况
2025-10-05 21:42:56.195 | DEBUG    | core.nlu.nlu_engine:_build_messages:162 - 构建的消息: ['system: 你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业...', 'assistant: 正在查询套餐信息...', 'user: 查询我的流量使用情况...']
2025-10-05 21:42:56.195 | INFO     | core.nlu.nlu_engine:understand:87 - 请求模型message=[{'role': 'system', 'content': '你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业务。\n\n【⭐⭐⭐ 最重要原则】\n- **只处理用户的最后一条消息**，忽略之前的所有用户消息\n- 如果看到多个用户消息，只响应最后一个\n- 每次只调用一个与最后一条用户消息相关的函数\n\n【你的职责】\n1. 理解用户的自然语言需求\n2. **必须**识别用户意图并调用相应的函数，不要进行闲聊\n3. 当信息不完整时,友好地向用户确认缺失的信息\n4. 用专业但亲切的语气与用户交流\n\n【当前可用套餐】\n- 经济套餐: 10G/月, 50元/月, 无限制人群\n- 畅游套餐: 100G/月, 180元/月, 无限制人群\n- 无限套餐: 1000G/月, 300元/月, 无限制人群\n- 校园套餐: 200G/月, 150元/月, 在校生专享\n\n【意图识别规则】\n1. 套餐查询类（query_packages）:\n   - "有什么套餐"、"推荐套餐"、"便宜的套餐"、"100元以内的套餐"\n   - 关键词：套餐、推荐、查询、有什么、价格、便宜\n\n2. 当前套餐查询（query_current_package）:\n   - "我的套餐"、"当前套餐"、"我用的什么套餐"\n   - 关键词：我的、当前、现在的\n\n3. 使用情况查询（query_usage）:  \n   - "用了多少流量"、"剩余流量"、"话费余额"、"查询余量"、"流量使用情况"\n   - 关键词：用了、剩余、余额、余量、流量使用、使用情况\n\n4. 套餐办理（change_package）:\n   - "办理XX套餐"、"换成XX套餐"、"我要办理"\n   - 关键词：办理、更换、变更\n\n【函数调用决策】\n重要：如果对话历史中有多个用户消息，只根据最后一条用户消息来判断意图！\n1. 识别**最后一条用户消息**的关键词\n2. 匹配最相关的单一函数\n3. 只调用该函数\n4. 忽略之前的用户消息\n\n【理解规则】\n- 价格表达要准确理解: "100块以内"→price_max=100, "50元以上"→price_min=50\n- "便宜点的"、"经济实惠"等模糊表达→sort_by="price_asc"\n- "学生套餐"、"校园"→target_user="在校生"\n- 如果用户没有提供手机号,需要礼貌询问，不要从function definitions的description中提取信息当作用户输入的。比如手机号\n\n【重要】\n- **只响应最后一条用户消息**\n- **一次只调用一个函数**\n- 不要试图同时处理多个问题\n- 回答要简洁明了\n'}, {'role': 'assistant', 'content': '正在查询套餐信息'}, {'role': 'user', 'content': '查询我的流量使用情况'}]
2025-10-05 21:42:59.478 | INFO     | core.nlu.nlu_engine:_parse_response:189 - 解析响应=ChatCompletion(id='41c5a784-bda0-4f77-ae49-e5a1926e67da', choices=[Choice(finish_reason='tool_calls', index=0, logprobs=None, message=ChatCompletionMessage(content='', refusal=None, role='assistant', annotations=None, audio=None, function_call=None, tool_calls=[ChatCompletionMessageFunctionToolCall(id='call_00_BxXkYLnanQPD7PFNlcZ9A9Hs', function=Function(arguments='{"phone": "", "query_type": "all"}', name='query_usage'), type='function', index=0)]))], created=1759671778, model='deepseek-chat', object='chat.completion', service_tier=None, system_fingerprint='fp_ffc7281d48_prod0820_fp8_kvcache', usage=CompletionUsage(completion_tokens=18, prompt_tokens=1545, total_tokens=1563, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetails(audio_tokens=None, cached_tokens=1536), prompt_cache_hit_tokens=1536, prompt_cache_miss_tokens=9))
2025-10-05 21:42:59.478 | INFO     | core.nlu.nlu_engine:_parse_response:190 - 解析响应: tool_calls数量=1
2025-10-05 21:42:59.479 | INFO     | core.nlu.nlu_engine:_update_session:351 - [integration_test_005] 意图切换: query_packages -> query_usage
2025-10-05 21:42:59.480 | INFO     | core.nlu.nlu_engine:understand:105 - [integration_test_005] NLU完成: intent=query_usage
2025-10-05 21:43:20.015 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_005
2025-10-05 21:43:20.017 | DEBUG    | core.dst.state_store:_load_from_memory:118 - 从内存加载状态: integration_test_005
2025-10-05 21:43:20.017 | INFO     | core.dst.dialog_state_tracker:track:59 - 意图改变: query_packages → query_usage
2025-10-05 21:43:20.018 | DEBUG    | core.dst.slot_manager:fill_slots:61 - 不同领域，仅保留用户信息: []
2025-10-05 21:43:58.848 | INFO     | core.dst.slot_manager:validate_slots:103 - 缺失槽位: ['phone']
2025-10-05 21:44:03.743 | INFO     | core.dst.dialog_state_tracker:_validate_slots:134 - 缺失必填槽位: ['phone']
2025-10-05 21:44:07.286 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_005
2025-10-05 21:44:11.773 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=3, 需要澄清=True
2025-10-05 21:44:37.830 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_005] 对话完成 | 意图: query_usage | 轮次: 3 | 耗时: 110199ms
2025-10-05 21:46:34.447 | INFO     | database.db_manager:_initialize:38 - 数据库连接初始化成功
2025-10-05 21:46:34.447 | ERROR    | database.redis_manager:_initialize:45 - Redis连接池初始化失败: 'Settings' object has no attribute 'get'
2025-10-05 21:46:34.507 | INFO     | core.nlu.nlu_engine:__init__:53 - ✓ NLU引擎初始化成功: DeepSeek (deepseek-chat)
2025-10-05 21:46:34.507 | ERROR    | core.dst.state_store:__init__:28 - Redis初始化失败: Redis连接池未初始化, 使用内存存储
2025-10-05 21:46:34.507 | INFO     | core.dst.dialog_state_tracker:__init__:27 - 对话状态跟踪器初始化完成
2025-10-05 21:46:34.507 | INFO     | executor.db_executor:__init__:16 - 数据库执行器初始化完成
2025-10-05 21:46:34.507 | INFO     | core.chatbot_dst:__init__:23 - 第二阶段对话系统初始化完成（含DST支持）
2025-10-05 21:46:34.508 | INFO     | core.chatbot_dst:chat:46 - [integration_test_005] 收到用户输入: 100元以内的套餐
2025-10-05 21:46:34.509 | INFO     | core.nlu.nlu_engine:understand:73 - [integration_test_005] 开始NLU理解: 100元以内的套餐
2025-10-05 21:46:34.509 | DEBUG    | core.nlu.nlu_engine:understand:78 - [integration_test_005] 预处理后: 100元以内的套餐
2025-10-05 21:46:34.510 | DEBUG    | core.nlu.nlu_engine:_build_messages:162 - 构建的消息: ['system: 你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业...', 'user: 100元以内的套餐...']
2025-10-05 21:46:34.510 | INFO     | core.nlu.nlu_engine:understand:87 - 请求模型message=[{'role': 'system', 'content': '你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业务。\n\n【⭐⭐⭐ 最重要原则】\n- **只处理用户的最后一条消息**，忽略之前的所有用户消息\n- 如果看到多个用户消息，只响应最后一个\n- 每次只调用一个与最后一条用户消息相关的函数\n\n【你的职责】\n1. 理解用户的自然语言需求\n2. **必须**识别用户意图并调用相应的函数，不要进行闲聊\n3. 当信息不完整时,友好地向用户确认缺失的信息\n4. 用专业但亲切的语气与用户交流\n\n【当前可用套餐】\n- 经济套餐: 10G/月, 50元/月, 无限制人群\n- 畅游套餐: 100G/月, 180元/月, 无限制人群\n- 无限套餐: 1000G/月, 300元/月, 无限制人群\n- 校园套餐: 200G/月, 150元/月, 在校生专享\n\n【意图识别规则】\n1. 套餐查询类（query_packages）:\n   - "有什么套餐"、"推荐套餐"、"便宜的套餐"、"100元以内的套餐"\n   - 关键词：套餐、推荐、查询、有什么、价格、便宜\n\n2. 当前套餐查询（query_current_package）:\n   - "我的套餐"、"当前套餐"、"我用的什么套餐"\n   - 关键词：我的、当前、现在的\n\n3. 使用情况查询（query_usage）:  \n   - "用了多少流量"、"剩余流量"、"话费余额"、"查询余量"、"流量使用情况"\n   - 关键词：用了、剩余、余额、余量、流量使用、使用情况\n\n4. 套餐办理（change_package）:\n   - "办理XX套餐"、"换成XX套餐"、"我要办理"\n   - 关键词：办理、更换、变更\n\n【函数调用决策】\n重要：如果对话历史中有多个用户消息，只根据最后一条用户消息来判断意图！\n1. 识别**最后一条用户消息**的关键词\n2. 匹配最相关的单一函数\n3. 只调用该函数\n4. 忽略之前的用户消息\n\n【理解规则】\n- 价格表达要准确理解: "100块以内"→price_max=100, "50元以上"→price_min=50\n- "便宜点的"、"经济实惠"等模糊表达→sort_by="price_asc"\n- "学生套餐"、"校园"→target_user="在校生"\n- 如果用户没有提供手机号,需要礼貌询问，不要从function definitions的description中提取信息当作用户输入的。比如手机号\n\n【重要】\n- **只响应最后一条用户消息**\n- **一次只调用一个函数**\n- 不要试图同时处理多个问题\n- 回答要简洁明了\n'}, {'role': 'user', 'content': '100元以内的套餐'}]
2025-10-05 21:46:37.079 | INFO     | core.nlu.nlu_engine:_parse_response:189 - 解析响应=ChatCompletion(id='8779caa1-2d97-461b-aeac-bcce17845593', choices=[Choice(finish_reason='tool_calls', index=0, logprobs=None, message=ChatCompletionMessage(content='', refusal=None, role='assistant', annotations=None, audio=None, function_call=None, tool_calls=[ChatCompletionMessageFunctionToolCall(id='call_00_zK9J9jUFL95atNIdOuBzgSZd', function=Function(arguments='{"price_max": 100}', name='query_packages'), type='function', index=0)]))], created=1759671997, model='deepseek-chat', object='chat.completion', service_tier=None, system_fingerprint='fp_ffc7281d48_prod0820_fp8_kvcache', usage=CompletionUsage(completion_tokens=14, prompt_tokens=1539, total_tokens=1553, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetails(audio_tokens=None, cached_tokens=1536), prompt_cache_hit_tokens=1536, prompt_cache_miss_tokens=3))
2025-10-05 21:46:37.079 | INFO     | core.nlu.nlu_engine:_parse_response:190 - 解析响应: tool_calls数量=1
2025-10-05 21:46:37.079 | INFO     | core.nlu.nlu_engine:_update_session:351 - [integration_test_005] 意图切换: None -> query_packages
2025-10-05 21:46:37.079 | INFO     | core.nlu.nlu_engine:understand:105 - [integration_test_005] NLU完成: intent=query_packages
2025-10-05 21:46:37.079 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_005
2025-10-05 21:46:37.080 | DEBUG    | core.dst.state_store:_load_from_memory:121 - 内存中不存在会话: integration_test_005, 返回新状态
2025-10-05 21:46:37.080 | INFO     | core.dst.dialog_state_tracker:track:59 - 意图改变: None → query_packages
2025-10-05 21:46:37.080 | DEBUG    | core.dst.slot_manager:fill_slots:61 - 不同领域，仅保留用户信息: []
2025-10-05 21:46:37.080 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_005
2025-10-05 21:46:37.080 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=1, 需要澄清=False
2025-10-05 21:46:37.080 | INFO     | executor.db_executor:execute_function:29 - 执行Function: query_packages, 参数: {'price_max': 100}
2025-10-05 21:46:37.135 | INFO     | executor.db_executor:execute_function:50 - Function执行成功: query_packages
2025-10-05 21:46:37.135 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_005
2025-10-05 21:46:37.136 | INFO     | core.chatbot_dst:_log_conversation:235 - [integration_test_005] 对话完成 | 意图: query_packages | 轮次: 2 | 耗时: 2628ms
2025-10-05 21:46:37.136 | INFO     | core.chatbot_dst:chat:46 - [integration_test_005] 收到用户输入: 查询我的流量使用情况
2025-10-05 21:46:37.136 | INFO     | core.nlu.nlu_engine:understand:73 - [integration_test_005] 开始NLU理解: 查询我的流量使用情况
2025-10-05 21:46:37.136 | DEBUG    | core.nlu.nlu_engine:understand:78 - [integration_test_005] 预处理后: 查询我的流量使用情况
2025-10-05 21:46:37.136 | DEBUG    | core.nlu.nlu_engine:_build_messages:162 - 构建的消息: ['system: 你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业...', 'assistant: 正在查询套餐信息...', 'user: 查询我的流量使用情况...']
2025-10-05 21:46:37.136 | INFO     | core.nlu.nlu_engine:understand:87 - 请求模型message=[{'role': 'system', 'content': '你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业务。\n\n【⭐⭐⭐ 最重要原则】\n- **只处理用户的最后一条消息**，忽略之前的所有用户消息\n- 如果看到多个用户消息，只响应最后一个\n- 每次只调用一个与最后一条用户消息相关的函数\n\n【你的职责】\n1. 理解用户的自然语言需求\n2. **必须**识别用户意图并调用相应的函数，不要进行闲聊\n3. 当信息不完整时,友好地向用户确认缺失的信息\n4. 用专业但亲切的语气与用户交流\n\n【当前可用套餐】\n- 经济套餐: 10G/月, 50元/月, 无限制人群\n- 畅游套餐: 100G/月, 180元/月, 无限制人群\n- 无限套餐: 1000G/月, 300元/月, 无限制人群\n- 校园套餐: 200G/月, 150元/月, 在校生专享\n\n【意图识别规则】\n1. 套餐查询类（query_packages）:\n   - "有什么套餐"、"推荐套餐"、"便宜的套餐"、"100元以内的套餐"\n   - 关键词：套餐、推荐、查询、有什么、价格、便宜\n\n2. 当前套餐查询（query_current_package）:\n   - "我的套餐"、"当前套餐"、"我用的什么套餐"\n   - 关键词：我的、当前、现在的\n\n3. 使用情况查询（query_usage）:  \n   - "用了多少流量"、"剩余流量"、"话费余额"、"查询余量"、"流量使用情况"\n   - 关键词：用了、剩余、余额、余量、流量使用、使用情况\n\n4. 套餐办理（change_package）:\n   - "办理XX套餐"、"换成XX套餐"、"我要办理"\n   - 关键词：办理、更换、变更\n\n【函数调用决策】\n重要：如果对话历史中有多个用户消息，只根据最后一条用户消息来判断意图！\n1. 识别**最后一条用户消息**的关键词\n2. 匹配最相关的单一函数\n3. 只调用该函数\n4. 忽略之前的用户消息\n\n【理解规则】\n- 价格表达要准确理解: "100块以内"→price_max=100, "50元以上"→price_min=50\n- "便宜点的"、"经济实惠"等模糊表达→sort_by="price_asc"\n- "学生套餐"、"校园"→target_user="在校生"\n- 如果用户没有提供手机号,需要礼貌询问，不要从function definitions的description中提取信息当作用户输入的。比如手机号\n\n【重要】\n- **只响应最后一条用户消息**\n- **一次只调用一个函数**\n- 不要试图同时处理多个问题\n- 回答要简洁明了\n'}, {'role': 'assistant', 'content': '正在查询套餐信息'}, {'role': 'user', 'content': '查询我的流量使用情况'}]
2025-10-05 21:46:40.548 | INFO     | core.nlu.nlu_engine:_parse_response:189 - 解析响应=ChatCompletion(id='1d31eb01-190d-41f5-8012-22238daa385f', choices=[Choice(finish_reason='tool_calls', index=0, logprobs=None, message=ChatCompletionMessage(content='', refusal=None, role='assistant', annotations=None, audio=None, function_call=None, tool_calls=[ChatCompletionMessageFunctionToolCall(id='call_00_6cTvvyPceyxX9brFnC9Oscej', function=Function(arguments='{"phone": "", "query_type": "all"}', name='query_usage'), type='function', index=0)]))], created=1759671999, model='deepseek-chat', object='chat.completion', service_tier=None, system_fingerprint='fp_ffc7281d48_prod0820_fp8_kvcache', usage=CompletionUsage(completion_tokens=18, prompt_tokens=1545, total_tokens=1563, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetails(audio_tokens=None, cached_tokens=1536), prompt_cache_hit_tokens=1536, prompt_cache_miss_tokens=9))
2025-10-05 21:46:40.548 | INFO     | core.nlu.nlu_engine:_parse_response:190 - 解析响应: tool_calls数量=1
2025-10-05 21:46:40.549 | INFO     | core.nlu.nlu_engine:_update_session:351 - [integration_test_005] 意图切换: query_packages -> query_usage
2025-10-05 21:46:40.549 | INFO     | core.nlu.nlu_engine:understand:105 - [integration_test_005] NLU完成: intent=query_usage
2025-10-05 21:46:40.549 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_005
2025-10-05 21:46:40.549 | DEBUG    | core.dst.state_store:_load_from_memory:118 - 从内存加载状态: integration_test_005
2025-10-05 21:46:40.549 | INFO     | core.dst.dialog_state_tracker:track:59 - 意图改变: query_packages → query_usage
2025-10-05 21:46:40.549 | DEBUG    | core.dst.slot_manager:fill_slots:61 - 不同领域，仅保留用户信息: []
2025-10-05 21:46:40.549 | INFO     | core.dst.slot_manager:validate_slots:103 - 缺失槽位: ['phone']
2025-10-05 21:46:40.550 | INFO     | core.dst.dialog_state_tracker:_validate_slots:134 - 缺失必填槽位: ['phone']
2025-10-05 21:46:40.550 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_005
2025-10-05 21:46:40.550 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=3, 需要澄清=True
2025-10-05 21:46:40.550 | INFO     | core.chatbot_dst:_log_conversation:235 - [integration_test_005] 对话完成 | 意图: query_usage | 轮次: 3 | 耗时: 3414ms
2025-10-05 21:48:07.017 | INFO     | database.db_manager:_initialize:38 - 数据库连接初始化成功
2025-10-05 21:48:07.018 | ERROR    | database.redis_manager:_initialize:45 - Redis连接池初始化失败: 'Settings' object has no attribute 'get'
2025-10-05 21:48:07.077 | INFO     | core.nlu.nlu_engine:__init__:53 - ✓ NLU引擎初始化成功: DeepSeek (deepseek-chat)
2025-10-05 21:48:07.077 | ERROR    | core.dst.state_store:__init__:28 - Redis初始化失败: Redis连接池未初始化, 使用内存存储
2025-10-05 21:48:07.077 | INFO     | core.dst.dialog_state_tracker:__init__:27 - 对话状态跟踪器初始化完成
2025-10-05 21:48:07.077 | INFO     | executor.db_executor:__init__:16 - 数据库执行器初始化完成
2025-10-05 21:48:07.077 | INFO     | core.chatbot_dst:__init__:23 - 第二阶段对话系统初始化完成（含DST支持）
2025-10-05 21:48:07.077 | INFO     | core.chatbot_dst:chat:46 - [integration_test_005] 收到用户输入: 100元以内的套餐
2025-10-05 21:48:07.077 | INFO     | core.nlu.nlu_engine:understand:73 - [integration_test_005] 开始NLU理解: 100元以内的套餐
2025-10-05 21:48:07.077 | DEBUG    | core.nlu.nlu_engine:understand:78 - [integration_test_005] 预处理后: 100元以内的套餐
2025-10-05 21:48:07.077 | DEBUG    | core.nlu.nlu_engine:_build_messages:162 - 构建的消息: ['system: 你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业...', 'user: 100元以内的套餐...']
2025-10-05 21:48:07.077 | INFO     | core.nlu.nlu_engine:understand:87 - 请求模型message=[{'role': 'system', 'content': '你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业务。\n\n【⭐⭐⭐ 最重要原则】\n- **只处理用户的最后一条消息**，忽略之前的所有用户消息\n- 如果看到多个用户消息，只响应最后一个\n- 每次只调用一个与最后一条用户消息相关的函数\n\n【你的职责】\n1. 理解用户的自然语言需求\n2. **必须**识别用户意图并调用相应的函数，不要进行闲聊\n3. 当信息不完整时,友好地向用户确认缺失的信息\n4. 用专业但亲切的语气与用户交流\n\n【当前可用套餐】\n- 经济套餐: 10G/月, 50元/月, 无限制人群\n- 畅游套餐: 100G/月, 180元/月, 无限制人群\n- 无限套餐: 1000G/月, 300元/月, 无限制人群\n- 校园套餐: 200G/月, 150元/月, 在校生专享\n\n【意图识别规则】\n1. 套餐查询类（query_packages）:\n   - "有什么套餐"、"推荐套餐"、"便宜的套餐"、"100元以内的套餐"\n   - 关键词：套餐、推荐、查询、有什么、价格、便宜\n\n2. 当前套餐查询（query_current_package）:\n   - "我的套餐"、"当前套餐"、"我用的什么套餐"\n   - 关键词：我的、当前、现在的\n\n3. 使用情况查询（query_usage）:  \n   - "用了多少流量"、"剩余流量"、"话费余额"、"查询余量"、"流量使用情况"\n   - 关键词：用了、剩余、余额、余量、流量使用、使用情况\n\n4. 套餐办理（change_package）:\n   - "办理XX套餐"、"换成XX套餐"、"我要办理"\n   - 关键词：办理、更换、变更\n\n【函数调用决策】\n重要：如果对话历史中有多个用户消息，只根据最后一条用户消息来判断意图！\n1. 识别**最后一条用户消息**的关键词\n2. 匹配最相关的单一函数\n3. 只调用该函数\n4. 忽略之前的用户消息\n\n【理解规则】\n- 价格表达要准确理解: "100块以内"→price_max=100, "50元以上"→price_min=50\n- "便宜点的"、"经济实惠"等模糊表达→sort_by="price_asc"\n- "学生套餐"、"校园"→target_user="在校生"\n- 如果用户没有提供手机号,需要礼貌询问，不要从function definitions的description中提取信息当作用户输入的。比如手机号\n\n【重要】\n- **只响应最后一条用户消息**\n- **一次只调用一个函数**\n- 不要试图同时处理多个问题\n- 回答要简洁明了\n'}, {'role': 'user', 'content': '100元以内的套餐'}]
2025-10-05 21:48:09.897 | INFO     | core.nlu.nlu_engine:_parse_response:189 - 解析响应=ChatCompletion(id='24a1b093-1abf-401e-acb9-772a1cd7f02a', choices=[Choice(finish_reason='tool_calls', index=0, logprobs=None, message=ChatCompletionMessage(content='', refusal=None, role='assistant', annotations=None, audio=None, function_call=None, tool_calls=[ChatCompletionMessageFunctionToolCall(id='call_00_XV4DgEhGi3BAxYSsx2fGjFT2', function=Function(arguments='{"price_max": 100, "sort_by": "price_asc"}', name='query_packages'), type='function', index=0)]))], created=1759672089, model='deepseek-chat', object='chat.completion', service_tier=None, system_fingerprint='fp_ffc7281d48_prod0820_fp8_kvcache', usage=CompletionUsage(completion_tokens=23, prompt_tokens=1539, total_tokens=1562, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetails(audio_tokens=None, cached_tokens=1536), prompt_cache_hit_tokens=1536, prompt_cache_miss_tokens=3))
2025-10-05 21:48:09.897 | INFO     | core.nlu.nlu_engine:_parse_response:190 - 解析响应: tool_calls数量=1
2025-10-05 21:48:09.898 | INFO     | core.nlu.nlu_engine:_update_session:351 - [integration_test_005] 意图切换: None -> query_packages
2025-10-05 21:48:09.898 | INFO     | core.nlu.nlu_engine:understand:105 - [integration_test_005] NLU完成: intent=query_packages
2025-10-05 21:48:09.898 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_005
2025-10-05 21:48:09.898 | DEBUG    | core.dst.state_store:_load_from_memory:121 - 内存中不存在会话: integration_test_005, 返回新状态
2025-10-05 21:48:09.898 | INFO     | core.dst.dialog_state_tracker:track:59 - 意图改变: None → query_packages
2025-10-05 21:48:09.898 | DEBUG    | core.dst.slot_manager:fill_slots:61 - 不同领域，仅保留用户信息: []
2025-10-05 21:48:09.898 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_005
2025-10-05 21:48:09.898 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=1, 需要澄清=False
2025-10-05 21:48:09.898 | INFO     | executor.db_executor:execute_function:29 - 执行Function: query_packages, 参数: {'price_max': 100, 'sort_by': 'price_asc'}
2025-10-05 21:48:09.945 | INFO     | executor.db_executor:execute_function:50 - Function执行成功: query_packages
2025-10-05 21:48:09.946 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_005
2025-10-05 21:48:09.946 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_005] 对话完成 | 意图: query_packages | 轮次: 2 | 耗时: 2869ms
2025-10-05 21:48:09.946 | INFO     | core.chatbot_dst:chat:46 - [integration_test_005] 收到用户输入: 查询我的流量使用情况
2025-10-05 21:48:09.946 | INFO     | core.nlu.nlu_engine:understand:73 - [integration_test_005] 开始NLU理解: 查询我的流量使用情况
2025-10-05 21:48:09.946 | DEBUG    | core.nlu.nlu_engine:understand:78 - [integration_test_005] 预处理后: 查询我的流量使用情况
2025-10-05 21:48:09.946 | DEBUG    | core.nlu.nlu_engine:_build_messages:162 - 构建的消息: ['system: 你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业...', 'assistant: 正在查询套餐信息...', 'user: 查询我的流量使用情况...']
2025-10-05 21:48:09.946 | INFO     | core.nlu.nlu_engine:understand:87 - 请求模型message=[{'role': 'system', 'content': '你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业务。\n\n【⭐⭐⭐ 最重要原则】\n- **只处理用户的最后一条消息**，忽略之前的所有用户消息\n- 如果看到多个用户消息，只响应最后一个\n- 每次只调用一个与最后一条用户消息相关的函数\n\n【你的职责】\n1. 理解用户的自然语言需求\n2. **必须**识别用户意图并调用相应的函数，不要进行闲聊\n3. 当信息不完整时,友好地向用户确认缺失的信息\n4. 用专业但亲切的语气与用户交流\n\n【当前可用套餐】\n- 经济套餐: 10G/月, 50元/月, 无限制人群\n- 畅游套餐: 100G/月, 180元/月, 无限制人群\n- 无限套餐: 1000G/月, 300元/月, 无限制人群\n- 校园套餐: 200G/月, 150元/月, 在校生专享\n\n【意图识别规则】\n1. 套餐查询类（query_packages）:\n   - "有什么套餐"、"推荐套餐"、"便宜的套餐"、"100元以内的套餐"\n   - 关键词：套餐、推荐、查询、有什么、价格、便宜\n\n2. 当前套餐查询（query_current_package）:\n   - "我的套餐"、"当前套餐"、"我用的什么套餐"\n   - 关键词：我的、当前、现在的\n\n3. 使用情况查询（query_usage）:  \n   - "用了多少流量"、"剩余流量"、"话费余额"、"查询余量"、"流量使用情况"\n   - 关键词：用了、剩余、余额、余量、流量使用、使用情况\n\n4. 套餐办理（change_package）:\n   - "办理XX套餐"、"换成XX套餐"、"我要办理"\n   - 关键词：办理、更换、变更\n\n【函数调用决策】\n重要：如果对话历史中有多个用户消息，只根据最后一条用户消息来判断意图！\n1. 识别**最后一条用户消息**的关键词\n2. 匹配最相关的单一函数\n3. 只调用该函数\n4. 忽略之前的用户消息\n\n【理解规则】\n- 价格表达要准确理解: "100块以内"→price_max=100, "50元以上"→price_min=50\n- "便宜点的"、"经济实惠"等模糊表达→sort_by="price_asc"\n- "学生套餐"、"校园"→target_user="在校生"\n- 如果用户没有提供手机号,需要礼貌询问，不要从function definitions的description中提取信息当作用户输入的。比如手机号\n\n【重要】\n- **只响应最后一条用户消息**\n- **一次只调用一个函数**\n- 不要试图同时处理多个问题\n- 回答要简洁明了\n'}, {'role': 'assistant', 'content': '正在查询套餐信息'}, {'role': 'user', 'content': '查询我的流量使用情况'}]
2025-10-05 21:48:12.619 | INFO     | core.nlu.nlu_engine:_parse_response:189 - 解析响应=ChatCompletion(id='3fe8d804-4c3c-4014-9c90-56b127d84105', choices=[Choice(finish_reason='tool_calls', index=0, logprobs=None, message=ChatCompletionMessage(content='', refusal=None, role='assistant', annotations=None, audio=None, function_call=None, tool_calls=[ChatCompletionMessageFunctionToolCall(id='call_00_3LQSo945Zqku2HdGDVokolQZ', function=Function(arguments='{"phone": "", "query_type": "all"}', name='query_usage'), type='function', index=0)]))], created=1759672092, model='deepseek-chat', object='chat.completion', service_tier=None, system_fingerprint='fp_ffc7281d48_prod0820_fp8_kvcache', usage=CompletionUsage(completion_tokens=18, prompt_tokens=1545, total_tokens=1563, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetails(audio_tokens=None, cached_tokens=1536), prompt_cache_hit_tokens=1536, prompt_cache_miss_tokens=9))
2025-10-05 21:48:12.619 | INFO     | core.nlu.nlu_engine:_parse_response:190 - 解析响应: tool_calls数量=1
2025-10-05 21:48:12.620 | INFO     | core.nlu.nlu_engine:_update_session:351 - [integration_test_005] 意图切换: query_packages -> query_usage
2025-10-05 21:48:12.620 | INFO     | core.nlu.nlu_engine:understand:105 - [integration_test_005] NLU完成: intent=query_usage
2025-10-05 21:48:12.620 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_005
2025-10-05 21:48:12.620 | DEBUG    | core.dst.state_store:_load_from_memory:118 - 从内存加载状态: integration_test_005
2025-10-05 21:48:12.620 | INFO     | core.dst.dialog_state_tracker:track:59 - 意图改变: query_packages → query_usage
2025-10-05 21:48:12.620 | DEBUG    | core.dst.slot_manager:fill_slots:61 - 不同领域，仅保留用户信息: []
2025-10-05 21:48:12.620 | INFO     | core.dst.slot_manager:validate_slots:103 - 缺失槽位: ['phone']
2025-10-05 21:48:12.621 | INFO     | core.dst.dialog_state_tracker:_validate_slots:134 - 缺失必填槽位: ['phone']
2025-10-05 21:48:12.621 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_005
2025-10-05 21:48:12.621 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=3, 需要澄清=True
2025-10-05 21:48:12.621 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_005] 对话完成 | 意图: query_usage | 轮次: 3 | 耗时: 2675ms
2025-10-05 21:48:30.023 | INFO     | database.db_manager:_initialize:38 - 数据库连接初始化成功
2025-10-05 21:48:30.024 | ERROR    | database.redis_manager:_initialize:45 - Redis连接池初始化失败: 'Settings' object has no attribute 'get'
2025-10-05 21:48:30.118 | INFO     | core.nlu.nlu_engine:__init__:53 - ✓ NLU引擎初始化成功: DeepSeek (deepseek-chat)
2025-10-05 21:48:30.119 | ERROR    | core.dst.state_store:__init__:28 - Redis初始化失败: Redis连接池未初始化, 使用内存存储
2025-10-05 21:48:30.119 | INFO     | core.dst.dialog_state_tracker:__init__:27 - 对话状态跟踪器初始化完成
2025-10-05 21:48:30.119 | INFO     | executor.db_executor:__init__:16 - 数据库执行器初始化完成
2025-10-05 21:48:30.119 | INFO     | core.chatbot_dst:__init__:23 - 第二阶段对话系统初始化完成（含DST支持）
2025-10-05 21:48:37.335 | INFO     | core.chatbot_dst:chat:46 - [integration_test_005] 收到用户输入: 100元以内的套餐
2025-10-05 21:48:45.344 | INFO     | core.nlu.nlu_engine:understand:73 - [integration_test_005] 开始NLU理解: 100元以内的套餐
2025-10-05 21:48:45.346 | DEBUG    | core.nlu.nlu_engine:understand:78 - [integration_test_005] 预处理后: 100元以内的套餐
2025-10-05 21:48:45.346 | DEBUG    | core.nlu.nlu_engine:_build_messages:162 - 构建的消息: ['system: 你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业...', 'user: 100元以内的套餐...']
2025-10-05 21:48:45.346 | INFO     | core.nlu.nlu_engine:understand:87 - 请求模型message=[{'role': 'system', 'content': '你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业务。\n\n【⭐⭐⭐ 最重要原则】\n- **只处理用户的最后一条消息**，忽略之前的所有用户消息\n- 如果看到多个用户消息，只响应最后一个\n- 每次只调用一个与最后一条用户消息相关的函数\n\n【你的职责】\n1. 理解用户的自然语言需求\n2. **必须**识别用户意图并调用相应的函数，不要进行闲聊\n3. 当信息不完整时,友好地向用户确认缺失的信息\n4. 用专业但亲切的语气与用户交流\n\n【当前可用套餐】\n- 经济套餐: 10G/月, 50元/月, 无限制人群\n- 畅游套餐: 100G/月, 180元/月, 无限制人群\n- 无限套餐: 1000G/月, 300元/月, 无限制人群\n- 校园套餐: 200G/月, 150元/月, 在校生专享\n\n【意图识别规则】\n1. 套餐查询类（query_packages）:\n   - "有什么套餐"、"推荐套餐"、"便宜的套餐"、"100元以内的套餐"\n   - 关键词：套餐、推荐、查询、有什么、价格、便宜\n\n2. 当前套餐查询（query_current_package）:\n   - "我的套餐"、"当前套餐"、"我用的什么套餐"\n   - 关键词：我的、当前、现在的\n\n3. 使用情况查询（query_usage）:  \n   - "用了多少流量"、"剩余流量"、"话费余额"、"查询余量"、"流量使用情况"\n   - 关键词：用了、剩余、余额、余量、流量使用、使用情况\n\n4. 套餐办理（change_package）:\n   - "办理XX套餐"、"换成XX套餐"、"我要办理"\n   - 关键词：办理、更换、变更\n\n【函数调用决策】\n重要：如果对话历史中有多个用户消息，只根据最后一条用户消息来判断意图！\n1. 识别**最后一条用户消息**的关键词\n2. 匹配最相关的单一函数\n3. 只调用该函数\n4. 忽略之前的用户消息\n\n【理解规则】\n- 价格表达要准确理解: "100块以内"→price_max=100, "50元以上"→price_min=50\n- "便宜点的"、"经济实惠"等模糊表达→sort_by="price_asc"\n- "学生套餐"、"校园"→target_user="在校生"\n- 如果用户没有提供手机号,需要礼貌询问，不要从function definitions的description中提取信息当作用户输入的。比如手机号\n\n【重要】\n- **只响应最后一条用户消息**\n- **一次只调用一个函数**\n- 不要试图同时处理多个问题\n- 回答要简洁明了\n'}, {'role': 'user', 'content': '100元以内的套餐'}]
2025-10-05 21:48:48.529 | INFO     | core.nlu.nlu_engine:_parse_response:189 - 解析响应=ChatCompletion(id='35bea15a-eb8f-483b-829d-128b6cbb678f', choices=[Choice(finish_reason='tool_calls', index=0, logprobs=None, message=ChatCompletionMessage(content='', refusal=None, role='assistant', annotations=None, audio=None, function_call=None, tool_calls=[ChatCompletionMessageFunctionToolCall(id='call_00_biXIGpDLH8Asj9gr954qtfXb', function=Function(arguments='{"price_max": 100}', name='query_packages'), type='function', index=0)]))], created=1759672128, model='deepseek-chat', object='chat.completion', service_tier=None, system_fingerprint='fp_ffc7281d48_prod0820_fp8_kvcache', usage=CompletionUsage(completion_tokens=14, prompt_tokens=1539, total_tokens=1553, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetails(audio_tokens=None, cached_tokens=1536), prompt_cache_hit_tokens=1536, prompt_cache_miss_tokens=3))
2025-10-05 21:48:48.530 | INFO     | core.nlu.nlu_engine:_parse_response:190 - 解析响应: tool_calls数量=1
2025-10-05 21:48:48.530 | INFO     | core.nlu.nlu_engine:_update_session:351 - [integration_test_005] 意图切换: None -> query_packages
2025-10-05 21:48:48.530 | INFO     | core.nlu.nlu_engine:understand:105 - [integration_test_005] NLU完成: intent=query_packages
2025-10-05 21:48:54.938 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_005
2025-10-05 21:48:54.940 | DEBUG    | core.dst.state_store:_load_from_memory:121 - 内存中不存在会话: integration_test_005, 返回新状态
2025-10-05 21:48:54.940 | INFO     | core.dst.dialog_state_tracker:track:59 - 意图改变: None → query_packages
2025-10-05 21:48:54.940 | DEBUG    | core.dst.slot_manager:fill_slots:61 - 不同领域，仅保留用户信息: []
2025-10-05 21:48:56.302 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_005
2025-10-05 21:48:56.302 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=1, 需要澄清=False
2025-10-05 21:48:58.520 | INFO     | executor.db_executor:execute_function:29 - 执行Function: query_packages, 参数: {'price_max': 100}
2025-10-05 21:48:59.571 | INFO     | executor.db_executor:execute_function:50 - Function执行成功: query_packages
2025-10-05 21:48:59.571 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_005
2025-10-05 21:48:59.572 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_005] 对话完成 | 意图: query_packages | 轮次: 2 | 耗时: 22237ms
2025-10-05 21:49:01.975 | INFO     | core.chatbot_dst:chat:46 - [integration_test_005] 收到用户输入: 查询我的流量使用情况
2025-10-05 21:49:01.976 | INFO     | core.nlu.nlu_engine:understand:73 - [integration_test_005] 开始NLU理解: 查询我的流量使用情况
2025-10-05 21:49:01.976 | DEBUG    | core.nlu.nlu_engine:understand:78 - [integration_test_005] 预处理后: 查询我的流量使用情况
2025-10-05 21:49:01.977 | DEBUG    | core.nlu.nlu_engine:_build_messages:162 - 构建的消息: ['system: 你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业...', 'assistant: 正在查询套餐信息...', 'user: 查询我的流量使用情况...']
2025-10-05 21:49:01.977 | INFO     | core.nlu.nlu_engine:understand:87 - 请求模型message=[{'role': 'system', 'content': '你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业务。\n\n【⭐⭐⭐ 最重要原则】\n- **只处理用户的最后一条消息**，忽略之前的所有用户消息\n- 如果看到多个用户消息，只响应最后一个\n- 每次只调用一个与最后一条用户消息相关的函数\n\n【你的职责】\n1. 理解用户的自然语言需求\n2. **必须**识别用户意图并调用相应的函数，不要进行闲聊\n3. 当信息不完整时,友好地向用户确认缺失的信息\n4. 用专业但亲切的语气与用户交流\n\n【当前可用套餐】\n- 经济套餐: 10G/月, 50元/月, 无限制人群\n- 畅游套餐: 100G/月, 180元/月, 无限制人群\n- 无限套餐: 1000G/月, 300元/月, 无限制人群\n- 校园套餐: 200G/月, 150元/月, 在校生专享\n\n【意图识别规则】\n1. 套餐查询类（query_packages）:\n   - "有什么套餐"、"推荐套餐"、"便宜的套餐"、"100元以内的套餐"\n   - 关键词：套餐、推荐、查询、有什么、价格、便宜\n\n2. 当前套餐查询（query_current_package）:\n   - "我的套餐"、"当前套餐"、"我用的什么套餐"\n   - 关键词：我的、当前、现在的\n\n3. 使用情况查询（query_usage）:  \n   - "用了多少流量"、"剩余流量"、"话费余额"、"查询余量"、"流量使用情况"\n   - 关键词：用了、剩余、余额、余量、流量使用、使用情况\n\n4. 套餐办理（change_package）:\n   - "办理XX套餐"、"换成XX套餐"、"我要办理"\n   - 关键词：办理、更换、变更\n\n【函数调用决策】\n重要：如果对话历史中有多个用户消息，只根据最后一条用户消息来判断意图！\n1. 识别**最后一条用户消息**的关键词\n2. 匹配最相关的单一函数\n3. 只调用该函数\n4. 忽略之前的用户消息\n\n【理解规则】\n- 价格表达要准确理解: "100块以内"→price_max=100, "50元以上"→price_min=50\n- "便宜点的"、"经济实惠"等模糊表达→sort_by="price_asc"\n- "学生套餐"、"校园"→target_user="在校生"\n- 如果用户没有提供手机号,需要礼貌询问，不要从function definitions的description中提取信息当作用户输入的。比如手机号\n\n【重要】\n- **只响应最后一条用户消息**\n- **一次只调用一个函数**\n- 不要试图同时处理多个问题\n- 回答要简洁明了\n'}, {'role': 'assistant', 'content': '正在查询套餐信息'}, {'role': 'user', 'content': '查询我的流量使用情况'}]
2025-10-05 21:49:04.320 | INFO     | core.nlu.nlu_engine:_parse_response:189 - 解析响应=ChatCompletion(id='3f871f9c-1ea8-44f2-98f6-923a9640f599', choices=[Choice(finish_reason='tool_calls', index=0, logprobs=None, message=ChatCompletionMessage(content='', refusal=None, role='assistant', annotations=None, audio=None, function_call=None, tool_calls=[ChatCompletionMessageFunctionToolCall(id='call_00_D9gjpSb51AbamBZWuKxsVTr6', function=Function(arguments='{"phone": "", "query_type": "all"}', name='query_usage'), type='function', index=0)]))], created=1759672144, model='deepseek-chat', object='chat.completion', service_tier=None, system_fingerprint='fp_ffc7281d48_prod0820_fp8_kvcache', usage=CompletionUsage(completion_tokens=18, prompt_tokens=1545, total_tokens=1563, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetails(audio_tokens=None, cached_tokens=1536), prompt_cache_hit_tokens=1536, prompt_cache_miss_tokens=9))
2025-10-05 21:49:04.320 | INFO     | core.nlu.nlu_engine:_parse_response:190 - 解析响应: tool_calls数量=1
2025-10-05 21:49:04.321 | INFO     | core.nlu.nlu_engine:_update_session:351 - [integration_test_005] 意图切换: query_packages -> query_usage
2025-10-05 21:49:04.321 | INFO     | core.nlu.nlu_engine:understand:105 - [integration_test_005] NLU完成: intent=query_usage
2025-10-05 21:49:04.321 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_005
2025-10-05 21:49:04.321 | DEBUG    | core.dst.state_store:_load_from_memory:118 - 从内存加载状态: integration_test_005
2025-10-05 21:49:04.322 | INFO     | core.dst.dialog_state_tracker:track:59 - 意图改变: query_packages → query_usage
2025-10-05 21:49:04.322 | DEBUG    | core.dst.slot_manager:fill_slots:61 - 不同领域，仅保留用户信息: []
2025-10-05 21:49:07.177 | INFO     | core.dst.slot_manager:validate_slots:103 - 缺失槽位: ['phone']
2025-10-05 21:49:07.179 | INFO     | core.dst.dialog_state_tracker:_validate_slots:134 - 缺失必填槽位: ['phone']
2025-10-05 21:49:07.180 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_005
2025-10-05 21:49:07.180 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=3, 需要澄清=True
2025-10-05 21:49:07.181 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_005] 对话完成 | 意图: query_usage | 轮次: 3 | 耗时: 5206ms
2025-10-05 21:49:15.788 | INFO     | database.db_manager:_initialize:38 - 数据库连接初始化成功
2025-10-05 21:49:15.788 | ERROR    | database.redis_manager:_initialize:45 - Redis连接池初始化失败: 'Settings' object has no attribute 'get'
2025-10-05 21:49:15.883 | INFO     | core.nlu.nlu_engine:__init__:53 - ✓ NLU引擎初始化成功: DeepSeek (deepseek-chat)
2025-10-05 21:49:15.883 | ERROR    | core.dst.state_store:__init__:28 - Redis初始化失败: Redis连接池未初始化, 使用内存存储
2025-10-05 21:49:15.883 | INFO     | core.dst.dialog_state_tracker:__init__:27 - 对话状态跟踪器初始化完成
2025-10-05 21:49:15.884 | INFO     | executor.db_executor:__init__:16 - 数据库执行器初始化完成
2025-10-05 21:49:15.884 | INFO     | core.chatbot_dst:__init__:23 - 第二阶段对话系统初始化完成（含DST支持）
2025-10-05 21:49:17.990 | INFO     | core.chatbot_dst:chat:46 - [integration_test_005] 收到用户输入: 100元以内的套餐
2025-10-05 21:49:17.991 | INFO     | core.nlu.nlu_engine:understand:73 - [integration_test_005] 开始NLU理解: 100元以内的套餐
2025-10-05 21:49:17.991 | DEBUG    | core.nlu.nlu_engine:understand:78 - [integration_test_005] 预处理后: 100元以内的套餐
2025-10-05 21:49:17.992 | DEBUG    | core.nlu.nlu_engine:_build_messages:162 - 构建的消息: ['system: 你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业...', 'user: 100元以内的套餐...']
2025-10-05 21:49:17.992 | INFO     | core.nlu.nlu_engine:understand:87 - 请求模型message=[{'role': 'system', 'content': '你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业务。\n\n【⭐⭐⭐ 最重要原则】\n- **只处理用户的最后一条消息**，忽略之前的所有用户消息\n- 如果看到多个用户消息，只响应最后一个\n- 每次只调用一个与最后一条用户消息相关的函数\n\n【你的职责】\n1. 理解用户的自然语言需求\n2. **必须**识别用户意图并调用相应的函数，不要进行闲聊\n3. 当信息不完整时,友好地向用户确认缺失的信息\n4. 用专业但亲切的语气与用户交流\n\n【当前可用套餐】\n- 经济套餐: 10G/月, 50元/月, 无限制人群\n- 畅游套餐: 100G/月, 180元/月, 无限制人群\n- 无限套餐: 1000G/月, 300元/月, 无限制人群\n- 校园套餐: 200G/月, 150元/月, 在校生专享\n\n【意图识别规则】\n1. 套餐查询类（query_packages）:\n   - "有什么套餐"、"推荐套餐"、"便宜的套餐"、"100元以内的套餐"\n   - 关键词：套餐、推荐、查询、有什么、价格、便宜\n\n2. 当前套餐查询（query_current_package）:\n   - "我的套餐"、"当前套餐"、"我用的什么套餐"\n   - 关键词：我的、当前、现在的\n\n3. 使用情况查询（query_usage）:  \n   - "用了多少流量"、"剩余流量"、"话费余额"、"查询余量"、"流量使用情况"\n   - 关键词：用了、剩余、余额、余量、流量使用、使用情况\n\n4. 套餐办理（change_package）:\n   - "办理XX套餐"、"换成XX套餐"、"我要办理"\n   - 关键词：办理、更换、变更\n\n【函数调用决策】\n重要：如果对话历史中有多个用户消息，只根据最后一条用户消息来判断意图！\n1. 识别**最后一条用户消息**的关键词\n2. 匹配最相关的单一函数\n3. 只调用该函数\n4. 忽略之前的用户消息\n\n【理解规则】\n- 价格表达要准确理解: "100块以内"→price_max=100, "50元以上"→price_min=50\n- "便宜点的"、"经济实惠"等模糊表达→sort_by="price_asc"\n- "学生套餐"、"校园"→target_user="在校生"\n- 如果用户没有提供手机号,需要礼貌询问，不要从function definitions的description中提取信息当作用户输入的。比如手机号\n\n【重要】\n- **只响应最后一条用户消息**\n- **一次只调用一个函数**\n- 不要试图同时处理多个问题\n- 回答要简洁明了\n'}, {'role': 'user', 'content': '100元以内的套餐'}]
2025-10-05 21:49:22.921 | INFO     | core.nlu.nlu_engine:_parse_response:189 - 解析响应=ChatCompletion(id='2e440e1e-5319-4f89-86d5-4ce36d7ac109', choices=[Choice(finish_reason='tool_calls', index=0, logprobs=None, message=ChatCompletionMessage(content='', refusal=None, role='assistant', annotations=None, audio=None, function_call=None, tool_calls=[ChatCompletionMessageFunctionToolCall(id='call_00_AgFc3adtSB7cXUKBf6dvfV8V', function=Function(arguments='{"price_max": 100, "sort_by": "price_asc"}', name='query_packages'), type='function', index=0)]))], created=1759672161, model='deepseek-chat', object='chat.completion', service_tier=None, system_fingerprint='fp_ffc7281d48_prod0820_fp8_kvcache', usage=CompletionUsage(completion_tokens=23, prompt_tokens=1539, total_tokens=1562, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetails(audio_tokens=None, cached_tokens=1536), prompt_cache_hit_tokens=1536, prompt_cache_miss_tokens=3))
2025-10-05 21:49:22.922 | INFO     | core.nlu.nlu_engine:_parse_response:190 - 解析响应: tool_calls数量=1
2025-10-05 21:49:22.922 | INFO     | core.nlu.nlu_engine:_update_session:351 - [integration_test_005] 意图切换: None -> query_packages
2025-10-05 21:49:22.922 | INFO     | core.nlu.nlu_engine:understand:105 - [integration_test_005] NLU完成: intent=query_packages
2025-10-05 21:49:22.922 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_005
2025-10-05 21:49:22.922 | DEBUG    | core.dst.state_store:_load_from_memory:121 - 内存中不存在会话: integration_test_005, 返回新状态
2025-10-05 21:49:22.922 | INFO     | core.dst.dialog_state_tracker:track:59 - 意图改变: None → query_packages
2025-10-05 21:49:22.922 | DEBUG    | core.dst.slot_manager:fill_slots:61 - 不同领域，仅保留用户信息: []
2025-10-05 21:49:25.299 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_005
2025-10-05 21:49:25.300 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=1, 需要澄清=False
2025-10-05 21:49:27.457 | INFO     | executor.db_executor:execute_function:29 - 执行Function: query_packages, 参数: {'price_max': 100, 'sort_by': 'price_asc'}
2025-10-05 21:49:30.761 | INFO     | executor.db_executor:execute_function:50 - Function执行成功: query_packages
2025-10-05 21:49:30.762 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_005
2025-10-05 21:49:30.762 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_005] 对话完成 | 意图: query_packages | 轮次: 2 | 耗时: 12772ms
2025-10-05 21:49:32.504 | INFO     | core.chatbot_dst:chat:46 - [integration_test_005] 收到用户输入: 查询我的流量使用情况
2025-10-05 21:49:32.505 | INFO     | core.nlu.nlu_engine:understand:73 - [integration_test_005] 开始NLU理解: 查询我的流量使用情况
2025-10-05 21:49:32.506 | DEBUG    | core.nlu.nlu_engine:understand:78 - [integration_test_005] 预处理后: 查询我的流量使用情况
2025-10-05 21:49:32.506 | DEBUG    | core.nlu.nlu_engine:_build_messages:162 - 构建的消息: ['system: 你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业...', 'assistant: 正在查询套餐信息...', 'user: 查询我的流量使用情况...']
2025-10-05 21:49:32.506 | INFO     | core.nlu.nlu_engine:understand:87 - 请求模型message=[{'role': 'system', 'content': '你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业务。\n\n【⭐⭐⭐ 最重要原则】\n- **只处理用户的最后一条消息**，忽略之前的所有用户消息\n- 如果看到多个用户消息，只响应最后一个\n- 每次只调用一个与最后一条用户消息相关的函数\n\n【你的职责】\n1. 理解用户的自然语言需求\n2. **必须**识别用户意图并调用相应的函数，不要进行闲聊\n3. 当信息不完整时,友好地向用户确认缺失的信息\n4. 用专业但亲切的语气与用户交流\n\n【当前可用套餐】\n- 经济套餐: 10G/月, 50元/月, 无限制人群\n- 畅游套餐: 100G/月, 180元/月, 无限制人群\n- 无限套餐: 1000G/月, 300元/月, 无限制人群\n- 校园套餐: 200G/月, 150元/月, 在校生专享\n\n【意图识别规则】\n1. 套餐查询类（query_packages）:\n   - "有什么套餐"、"推荐套餐"、"便宜的套餐"、"100元以内的套餐"\n   - 关键词：套餐、推荐、查询、有什么、价格、便宜\n\n2. 当前套餐查询（query_current_package）:\n   - "我的套餐"、"当前套餐"、"我用的什么套餐"\n   - 关键词：我的、当前、现在的\n\n3. 使用情况查询（query_usage）:  \n   - "用了多少流量"、"剩余流量"、"话费余额"、"查询余量"、"流量使用情况"\n   - 关键词：用了、剩余、余额、余量、流量使用、使用情况\n\n4. 套餐办理（change_package）:\n   - "办理XX套餐"、"换成XX套餐"、"我要办理"\n   - 关键词：办理、更换、变更\n\n【函数调用决策】\n重要：如果对话历史中有多个用户消息，只根据最后一条用户消息来判断意图！\n1. 识别**最后一条用户消息**的关键词\n2. 匹配最相关的单一函数\n3. 只调用该函数\n4. 忽略之前的用户消息\n\n【理解规则】\n- 价格表达要准确理解: "100块以内"→price_max=100, "50元以上"→price_min=50\n- "便宜点的"、"经济实惠"等模糊表达→sort_by="price_asc"\n- "学生套餐"、"校园"→target_user="在校生"\n- 如果用户没有提供手机号,需要礼貌询问，不要从function definitions的description中提取信息当作用户输入的。比如手机号\n\n【重要】\n- **只响应最后一条用户消息**\n- **一次只调用一个函数**\n- 不要试图同时处理多个问题\n- 回答要简洁明了\n'}, {'role': 'assistant', 'content': '正在查询套餐信息'}, {'role': 'user', 'content': '查询我的流量使用情况'}]
2025-10-05 21:49:35.141 | INFO     | core.nlu.nlu_engine:_parse_response:189 - 解析响应=ChatCompletion(id='2e84ef18-62aa-4d16-b837-f203765ec08e', choices=[Choice(finish_reason='tool_calls', index=0, logprobs=None, message=ChatCompletionMessage(content='', refusal=None, role='assistant', annotations=None, audio=None, function_call=None, tool_calls=[ChatCompletionMessageFunctionToolCall(id='call_00_l9ZYIeJUlpUI9nShNI1sCrYQ', function=Function(arguments='{"phone": "", "query_type": "all"}', name='query_usage'), type='function', index=0)]))], created=1759672175, model='deepseek-chat', object='chat.completion', service_tier=None, system_fingerprint='fp_ffc7281d48_prod0820_fp8_kvcache', usage=CompletionUsage(completion_tokens=18, prompt_tokens=1545, total_tokens=1563, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetails(audio_tokens=None, cached_tokens=1536), prompt_cache_hit_tokens=1536, prompt_cache_miss_tokens=9))
2025-10-05 21:49:35.142 | INFO     | core.nlu.nlu_engine:_parse_response:190 - 解析响应: tool_calls数量=1
2025-10-05 21:49:35.142 | INFO     | core.nlu.nlu_engine:_update_session:351 - [integration_test_005] 意图切换: query_packages -> query_usage
2025-10-05 21:49:35.143 | INFO     | core.nlu.nlu_engine:understand:105 - [integration_test_005] NLU完成: intent=query_usage
2025-10-05 21:49:35.143 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_005
2025-10-05 21:49:35.143 | DEBUG    | core.dst.state_store:_load_from_memory:118 - 从内存加载状态: integration_test_005
2025-10-05 21:49:35.143 | INFO     | core.dst.dialog_state_tracker:track:59 - 意图改变: query_packages → query_usage
2025-10-05 21:49:35.144 | DEBUG    | core.dst.slot_manager:fill_slots:61 - 不同领域，仅保留用户信息: []
2025-10-05 21:49:41.422 | INFO     | core.dst.slot_manager:validate_slots:103 - 缺失槽位: ['phone']
2025-10-05 21:49:41.424 | INFO     | core.dst.dialog_state_tracker:_validate_slots:134 - 缺失必填槽位: ['phone']
2025-10-05 21:49:41.424 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_005
2025-10-05 21:49:41.425 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=3, 需要澄清=True
2025-10-05 21:49:41.425 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_005] 对话完成 | 意图: query_usage | 轮次: 3 | 耗时: 8921ms
2025-10-05 21:52:35.243 | INFO     | database.db_manager:_initialize:38 - 数据库连接初始化成功
2025-10-05 21:52:35.244 | ERROR    | database.redis_manager:_initialize:45 - Redis连接池初始化失败: 'Settings' object has no attribute 'get'
2025-10-05 21:52:35.340 | INFO     | core.nlu.nlu_engine:__init__:53 - ✓ NLU引擎初始化成功: DeepSeek (deepseek-chat)
2025-10-05 21:52:35.340 | ERROR    | core.dst.state_store:__init__:28 - Redis初始化失败: Redis连接池未初始化, 使用内存存储
2025-10-05 21:52:35.340 | INFO     | core.dst.dialog_state_tracker:__init__:27 - 对话状态跟踪器初始化完成
2025-10-05 21:52:35.340 | INFO     | executor.db_executor:__init__:16 - 数据库执行器初始化完成
2025-10-05 21:52:35.340 | INFO     | core.chatbot_dst:__init__:23 - 第二阶段对话系统初始化完成（含DST支持）
2025-10-05 21:52:38.126 | INFO     | core.chatbot_dst:chat:46 - [integration_test_005] 收到用户输入: 100元以内的套餐
2025-10-05 21:52:38.126 | INFO     | core.nlu.nlu_engine:understand:73 - [integration_test_005] 开始NLU理解: 100元以内的套餐
2025-10-05 21:52:38.126 | DEBUG    | core.nlu.nlu_engine:understand:78 - [integration_test_005] 预处理后: 100元以内的套餐
2025-10-05 21:52:38.126 | DEBUG    | core.nlu.nlu_engine:_build_messages:162 - 构建的消息: ['system: 你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业...', 'user: 100元以内的套餐...']
2025-10-05 21:52:38.127 | INFO     | core.nlu.nlu_engine:understand:87 - 请求模型message=[{'role': 'system', 'content': '你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业务。\n\n【⭐⭐⭐ 最重要原则】\n- **只处理用户的最后一条消息**，忽略之前的所有用户消息\n- 如果看到多个用户消息，只响应最后一个\n- 每次只调用一个与最后一条用户消息相关的函数\n\n【你的职责】\n1. 理解用户的自然语言需求\n2. **必须**识别用户意图并调用相应的函数，不要进行闲聊\n3. 当信息不完整时,友好地向用户确认缺失的信息\n4. 用专业但亲切的语气与用户交流\n\n【当前可用套餐】\n- 经济套餐: 10G/月, 50元/月, 无限制人群\n- 畅游套餐: 100G/月, 180元/月, 无限制人群\n- 无限套餐: 1000G/月, 300元/月, 无限制人群\n- 校园套餐: 200G/月, 150元/月, 在校生专享\n\n【意图识别规则】\n1. 套餐查询类（query_packages）:\n   - "有什么套餐"、"推荐套餐"、"便宜的套餐"、"100元以内的套餐"\n   - 关键词：套餐、推荐、查询、有什么、价格、便宜\n\n2. 当前套餐查询（query_current_package）:\n   - "我的套餐"、"当前套餐"、"我用的什么套餐"\n   - 关键词：我的、当前、现在的\n\n3. 使用情况查询（query_usage）:  \n   - "用了多少流量"、"剩余流量"、"话费余额"、"查询余量"、"流量使用情况"\n   - 关键词：用了、剩余、余额、余量、流量使用、使用情况\n\n4. 套餐办理（change_package）:\n   - "办理XX套餐"、"换成XX套餐"、"我要办理"\n   - 关键词：办理、更换、变更\n\n【函数调用决策】\n重要：如果对话历史中有多个用户消息，只根据最后一条用户消息来判断意图！\n1. 识别**最后一条用户消息**的关键词\n2. 匹配最相关的单一函数\n3. 只调用该函数\n4. 忽略之前的用户消息\n\n【理解规则】\n- 价格表达要准确理解: "100块以内"→price_max=100, "50元以上"→price_min=50\n- "便宜点的"、"经济实惠"等模糊表达→sort_by="price_asc"\n- "学生套餐"、"校园"→target_user="在校生"\n- 如果用户没有提供手机号,需要礼貌询问，不要从function definitions的description中提取信息当作用户输入的。比如手机号\n\n【重要】\n- **只响应最后一条用户消息**\n- **一次只调用一个函数**\n- 不要试图同时处理多个问题\n- 回答要简洁明了\n'}, {'role': 'user', 'content': '100元以内的套餐'}]
2025-10-05 21:52:41.465 | INFO     | core.nlu.nlu_engine:_parse_response:189 - 解析响应=ChatCompletion(id='6e71d9d6-bf0d-43e5-b96a-3ce97250944f', choices=[Choice(finish_reason='tool_calls', index=0, logprobs=None, message=ChatCompletionMessage(content='', refusal=None, role='assistant', annotations=None, audio=None, function_call=None, tool_calls=[ChatCompletionMessageFunctionToolCall(id='call_00_6pG0pJDtTlzV81fiUCMYiABo', function=Function(arguments='{"price_max": 100}', name='query_packages'), type='function', index=0)]))], created=1759672361, model='deepseek-chat', object='chat.completion', service_tier=None, system_fingerprint='fp_ffc7281d48_prod0820_fp8_kvcache', usage=CompletionUsage(completion_tokens=14, prompt_tokens=1539, total_tokens=1553, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetails(audio_tokens=None, cached_tokens=1536), prompt_cache_hit_tokens=1536, prompt_cache_miss_tokens=3))
2025-10-05 21:52:41.465 | INFO     | core.nlu.nlu_engine:_parse_response:190 - 解析响应: tool_calls数量=1
2025-10-05 21:52:41.465 | INFO     | core.nlu.nlu_engine:_update_session:351 - [integration_test_005] 意图切换: None -> query_packages
2025-10-05 21:52:41.465 | INFO     | core.nlu.nlu_engine:understand:105 - [integration_test_005] NLU完成: intent=query_packages
2025-10-05 21:52:41.466 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_005
2025-10-05 21:52:41.466 | DEBUG    | core.dst.state_store:_load_from_memory:121 - 内存中不存在会话: integration_test_005, 返回新状态
2025-10-05 21:52:41.466 | INFO     | core.dst.dialog_state_tracker:track:59 - 意图改变: None → query_packages
2025-10-05 21:53:01.591 | DEBUG    | core.dst.slot_manager:fill_slots:61 - 不同领域，仅保留用户信息: []
2025-10-05 21:53:18.951 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_005
2025-10-05 21:53:18.953 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=1, 需要澄清=False
2025-10-05 21:53:21.221 | INFO     | executor.db_executor:execute_function:29 - 执行Function: query_packages, 参数: {'price_max': 100}
2025-10-05 21:53:21.309 | INFO     | executor.db_executor:execute_function:50 - Function执行成功: query_packages
2025-10-05 21:53:21.310 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_005
2025-10-05 21:53:21.311 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_005] 对话完成 | 意图: query_packages | 轮次: 2 | 耗时: 43185ms
2025-10-05 21:53:23.400 | INFO     | core.chatbot_dst:chat:46 - [integration_test_005] 收到用户输入: 查询我的流量使用情况
2025-10-05 21:53:23.402 | INFO     | core.nlu.nlu_engine:understand:73 - [integration_test_005] 开始NLU理解: 查询我的流量使用情况
2025-10-05 21:53:23.402 | DEBUG    | core.nlu.nlu_engine:understand:78 - [integration_test_005] 预处理后: 查询我的流量使用情况
2025-10-05 21:53:23.403 | DEBUG    | core.nlu.nlu_engine:_build_messages:162 - 构建的消息: ['system: 你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业...', 'assistant: 正在查询套餐信息...', 'user: 查询我的流量使用情况...']
2025-10-05 21:53:23.403 | INFO     | core.nlu.nlu_engine:understand:87 - 请求模型message=[{'role': 'system', 'content': '你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业务。\n\n【⭐⭐⭐ 最重要原则】\n- **只处理用户的最后一条消息**，忽略之前的所有用户消息\n- 如果看到多个用户消息，只响应最后一个\n- 每次只调用一个与最后一条用户消息相关的函数\n\n【你的职责】\n1. 理解用户的自然语言需求\n2. **必须**识别用户意图并调用相应的函数，不要进行闲聊\n3. 当信息不完整时,友好地向用户确认缺失的信息\n4. 用专业但亲切的语气与用户交流\n\n【当前可用套餐】\n- 经济套餐: 10G/月, 50元/月, 无限制人群\n- 畅游套餐: 100G/月, 180元/月, 无限制人群\n- 无限套餐: 1000G/月, 300元/月, 无限制人群\n- 校园套餐: 200G/月, 150元/月, 在校生专享\n\n【意图识别规则】\n1. 套餐查询类（query_packages）:\n   - "有什么套餐"、"推荐套餐"、"便宜的套餐"、"100元以内的套餐"\n   - 关键词：套餐、推荐、查询、有什么、价格、便宜\n\n2. 当前套餐查询（query_current_package）:\n   - "我的套餐"、"当前套餐"、"我用的什么套餐"\n   - 关键词：我的、当前、现在的\n\n3. 使用情况查询（query_usage）:  \n   - "用了多少流量"、"剩余流量"、"话费余额"、"查询余量"、"流量使用情况"\n   - 关键词：用了、剩余、余额、余量、流量使用、使用情况\n\n4. 套餐办理（change_package）:\n   - "办理XX套餐"、"换成XX套餐"、"我要办理"\n   - 关键词：办理、更换、变更\n\n【函数调用决策】\n重要：如果对话历史中有多个用户消息，只根据最后一条用户消息来判断意图！\n1. 识别**最后一条用户消息**的关键词\n2. 匹配最相关的单一函数\n3. 只调用该函数\n4. 忽略之前的用户消息\n\n【理解规则】\n- 价格表达要准确理解: "100块以内"→price_max=100, "50元以上"→price_min=50\n- "便宜点的"、"经济实惠"等模糊表达→sort_by="price_asc"\n- "学生套餐"、"校园"→target_user="在校生"\n- 如果用户没有提供手机号,需要礼貌询问，不要从function definitions的description中提取信息当作用户输入的。比如手机号\n\n【重要】\n- **只响应最后一条用户消息**\n- **一次只调用一个函数**\n- 不要试图同时处理多个问题\n- 回答要简洁明了\n'}, {'role': 'assistant', 'content': '正在查询套餐信息'}, {'role': 'user', 'content': '查询我的流量使用情况'}]
2025-10-05 21:53:25.722 | INFO     | core.nlu.nlu_engine:_parse_response:189 - 解析响应=ChatCompletion(id='a5cff84f-5b88-41cc-b5fd-7b01e1ea9b9b', choices=[Choice(finish_reason='tool_calls', index=0, logprobs=None, message=ChatCompletionMessage(content='', refusal=None, role='assistant', annotations=None, audio=None, function_call=None, tool_calls=[ChatCompletionMessageFunctionToolCall(id='call_00_czJaOUNeDXKdMOJwJmh84EZR', function=Function(arguments='{"phone": "", "query_type": "all"}', name='query_usage'), type='function', index=0)]))], created=1759672405, model='deepseek-chat', object='chat.completion', service_tier=None, system_fingerprint='fp_ffc7281d48_prod0820_fp8_kvcache', usage=CompletionUsage(completion_tokens=18, prompt_tokens=1545, total_tokens=1563, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetails(audio_tokens=None, cached_tokens=1536), prompt_cache_hit_tokens=1536, prompt_cache_miss_tokens=9))
2025-10-05 21:53:25.724 | INFO     | core.nlu.nlu_engine:_parse_response:190 - 解析响应: tool_calls数量=1
2025-10-05 21:53:25.725 | INFO     | core.nlu.nlu_engine:_update_session:351 - [integration_test_005] 意图切换: query_packages -> query_usage
2025-10-05 21:53:25.725 | INFO     | core.nlu.nlu_engine:understand:105 - [integration_test_005] NLU完成: intent=query_usage
2025-10-05 21:53:25.726 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_005
2025-10-05 21:53:25.726 | DEBUG    | core.dst.state_store:_load_from_memory:118 - 从内存加载状态: integration_test_005
2025-10-05 21:53:25.727 | INFO     | core.dst.dialog_state_tracker:track:59 - 意图改变: query_packages → query_usage
2025-10-05 21:54:42.489 | DEBUG    | core.dst.slot_manager:fill_slots:61 - 不同领域，仅保留用户信息: []
2025-10-05 21:55:00.170 | INFO     | core.dst.slot_manager:validate_slots:103 - 缺失槽位: ['phone']
2025-10-05 21:55:02.329 | INFO     | core.dst.dialog_state_tracker:_validate_slots:134 - 缺失必填槽位: ['phone']
2025-10-05 21:55:03.836 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_005
2025-10-05 21:55:06.866 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=3, 需要澄清=True
2025-10-05 21:55:14.822 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_005] 对话完成 | 意图: query_usage | 轮次: 3 | 耗时: 111422ms
2025-10-05 21:56:19.170 | INFO     | database.db_manager:_initialize:38 - 数据库连接初始化成功
2025-10-05 21:56:19.170 | ERROR    | database.redis_manager:_initialize:45 - Redis连接池初始化失败: 'Settings' object has no attribute 'get'
2025-10-05 21:56:19.231 | INFO     | core.nlu.nlu_engine:__init__:53 - ✓ NLU引擎初始化成功: DeepSeek (deepseek-chat)
2025-10-05 21:56:19.231 | ERROR    | core.dst.state_store:__init__:28 - Redis初始化失败: Redis连接池未初始化, 使用内存存储
2025-10-05 21:56:19.231 | INFO     | core.dst.dialog_state_tracker:__init__:27 - 对话状态跟踪器初始化完成
2025-10-05 21:56:19.231 | INFO     | executor.db_executor:__init__:16 - 数据库执行器初始化完成
2025-10-05 21:56:19.231 | INFO     | core.chatbot_dst:__init__:23 - 第二阶段对话系统初始化完成（含DST支持）
2025-10-05 21:56:19.232 | INFO     | core.chatbot_dst:chat:46 - [integration_test_005] 收到用户输入: 100元以内的套餐
2025-10-05 21:56:19.232 | INFO     | core.nlu.nlu_engine:understand:73 - [integration_test_005] 开始NLU理解: 100元以内的套餐
2025-10-05 21:56:19.232 | DEBUG    | core.nlu.nlu_engine:understand:78 - [integration_test_005] 预处理后: 100元以内的套餐
2025-10-05 21:56:19.232 | DEBUG    | core.nlu.nlu_engine:_build_messages:162 - 构建的消息: ['system: 你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业...', 'user: 100元以内的套餐...']
2025-10-05 21:56:19.232 | INFO     | core.nlu.nlu_engine:understand:87 - 请求模型message=[{'role': 'system', 'content': '你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业务。\n\n【⭐⭐⭐ 最重要原则】\n- **只处理用户的最后一条消息**，忽略之前的所有用户消息\n- 如果看到多个用户消息，只响应最后一个\n- 每次只调用一个与最后一条用户消息相关的函数\n\n【你的职责】\n1. 理解用户的自然语言需求\n2. **必须**识别用户意图并调用相应的函数，不要进行闲聊\n3. 当信息不完整时,友好地向用户确认缺失的信息\n4. 用专业但亲切的语气与用户交流\n\n【当前可用套餐】\n- 经济套餐: 10G/月, 50元/月, 无限制人群\n- 畅游套餐: 100G/月, 180元/月, 无限制人群\n- 无限套餐: 1000G/月, 300元/月, 无限制人群\n- 校园套餐: 200G/月, 150元/月, 在校生专享\n\n【意图识别规则】\n1. 套餐查询类（query_packages）:\n   - "有什么套餐"、"推荐套餐"、"便宜的套餐"、"100元以内的套餐"\n   - 关键词：套餐、推荐、查询、有什么、价格、便宜\n\n2. 当前套餐查询（query_current_package）:\n   - "我的套餐"、"当前套餐"、"我用的什么套餐"\n   - 关键词：我的、当前、现在的\n\n3. 使用情况查询（query_usage）:  \n   - "用了多少流量"、"剩余流量"、"话费余额"、"查询余量"、"流量使用情况"\n   - 关键词：用了、剩余、余额、余量、流量使用、使用情况\n\n4. 套餐办理（change_package）:\n   - "办理XX套餐"、"换成XX套餐"、"我要办理"\n   - 关键词：办理、更换、变更\n\n【函数调用决策】\n重要：如果对话历史中有多个用户消息，只根据最后一条用户消息来判断意图！\n1. 识别**最后一条用户消息**的关键词\n2. 匹配最相关的单一函数\n3. 只调用该函数\n4. 忽略之前的用户消息\n\n【理解规则】\n- 价格表达要准确理解: "100块以内"→price_max=100, "50元以上"→price_min=50\n- "便宜点的"、"经济实惠"等模糊表达→sort_by="price_asc"\n- "学生套餐"、"校园"→target_user="在校生"\n- 如果用户没有提供手机号,需要礼貌询问，不要从function definitions的description中提取信息当作用户输入的。比如手机号\n\n【重要】\n- **只响应最后一条用户消息**\n- **一次只调用一个函数**\n- 不要试图同时处理多个问题\n- 回答要简洁明了\n'}, {'role': 'user', 'content': '100元以内的套餐'}]
2025-10-05 21:56:22.367 | INFO     | core.nlu.nlu_engine:_parse_response:189 - 解析响应=ChatCompletion(id='2b7808e1-73b1-468e-bf47-40afbb4908e1', choices=[Choice(finish_reason='tool_calls', index=0, logprobs=None, message=ChatCompletionMessage(content='', refusal=None, role='assistant', annotations=None, audio=None, function_call=None, tool_calls=[ChatCompletionMessageFunctionToolCall(id='call_00_BAO0KPxwtAzi6a2ttllUSZWr', function=Function(arguments='{"price_max": 100}', name='query_packages'), type='function', index=0)]))], created=1759672581, model='deepseek-chat', object='chat.completion', service_tier=None, system_fingerprint='fp_ffc7281d48_prod0820_fp8_kvcache', usage=CompletionUsage(completion_tokens=14, prompt_tokens=1539, total_tokens=1553, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetails(audio_tokens=None, cached_tokens=1536), prompt_cache_hit_tokens=1536, prompt_cache_miss_tokens=3))
2025-10-05 21:56:22.367 | INFO     | core.nlu.nlu_engine:_parse_response:190 - 解析响应: tool_calls数量=1
2025-10-05 21:56:22.368 | INFO     | core.nlu.nlu_engine:_update_session:351 - [integration_test_005] 意图切换: None -> query_packages
2025-10-05 21:56:22.368 | INFO     | core.nlu.nlu_engine:understand:105 - [integration_test_005] NLU完成: intent=query_packages
2025-10-05 21:56:22.368 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_005
2025-10-05 21:56:22.368 | DEBUG    | core.dst.state_store:_load_from_memory:121 - 内存中不存在会话: integration_test_005, 返回新状态
2025-10-05 21:56:22.368 | INFO     | core.dst.dialog_state_tracker:track:59 - 意图改变: None → query_packages
2025-10-05 21:56:22.368 | INFO     | core.dst.slot_manager:fill_slots:61 - 不同领域，仅保留用户信息: []
2025-10-05 21:56:22.368 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_005
2025-10-05 21:56:22.368 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=1, 需要澄清=False
2025-10-05 21:56:22.368 | INFO     | executor.db_executor:execute_function:29 - 执行Function: query_packages, 参数: {'price_max': 100}
2025-10-05 21:56:22.419 | INFO     | executor.db_executor:execute_function:50 - Function执行成功: query_packages
2025-10-05 21:56:22.419 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_005
2025-10-05 21:56:22.419 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_005] 对话完成 | 意图: query_packages | 轮次: 2 | 耗时: 3187ms
2025-10-05 21:56:22.420 | INFO     | core.chatbot_dst:chat:46 - [integration_test_005] 收到用户输入: 查询我的流量使用情况
2025-10-05 21:56:22.420 | INFO     | core.nlu.nlu_engine:understand:73 - [integration_test_005] 开始NLU理解: 查询我的流量使用情况
2025-10-05 21:56:22.420 | DEBUG    | core.nlu.nlu_engine:understand:78 - [integration_test_005] 预处理后: 查询我的流量使用情况
2025-10-05 21:56:22.420 | DEBUG    | core.nlu.nlu_engine:_build_messages:162 - 构建的消息: ['system: 你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业...', 'assistant: 正在查询套餐信息...', 'user: 查询我的流量使用情况...']
2025-10-05 21:56:22.420 | INFO     | core.nlu.nlu_engine:understand:87 - 请求模型message=[{'role': 'system', 'content': '你是一个专业的电信客服助手,负责帮助用户查询和办理流量套餐业务。\n\n【⭐⭐⭐ 最重要原则】\n- **只处理用户的最后一条消息**，忽略之前的所有用户消息\n- 如果看到多个用户消息，只响应最后一个\n- 每次只调用一个与最后一条用户消息相关的函数\n\n【你的职责】\n1. 理解用户的自然语言需求\n2. **必须**识别用户意图并调用相应的函数，不要进行闲聊\n3. 当信息不完整时,友好地向用户确认缺失的信息\n4. 用专业但亲切的语气与用户交流\n\n【当前可用套餐】\n- 经济套餐: 10G/月, 50元/月, 无限制人群\n- 畅游套餐: 100G/月, 180元/月, 无限制人群\n- 无限套餐: 1000G/月, 300元/月, 无限制人群\n- 校园套餐: 200G/月, 150元/月, 在校生专享\n\n【意图识别规则】\n1. 套餐查询类（query_packages）:\n   - "有什么套餐"、"推荐套餐"、"便宜的套餐"、"100元以内的套餐"\n   - 关键词：套餐、推荐、查询、有什么、价格、便宜\n\n2. 当前套餐查询（query_current_package）:\n   - "我的套餐"、"当前套餐"、"我用的什么套餐"\n   - 关键词：我的、当前、现在的\n\n3. 使用情况查询（query_usage）:  \n   - "用了多少流量"、"剩余流量"、"话费余额"、"查询余量"、"流量使用情况"\n   - 关键词：用了、剩余、余额、余量、流量使用、使用情况\n\n4. 套餐办理（change_package）:\n   - "办理XX套餐"、"换成XX套餐"、"我要办理"\n   - 关键词：办理、更换、变更\n\n【函数调用决策】\n重要：如果对话历史中有多个用户消息，只根据最后一条用户消息来判断意图！\n1. 识别**最后一条用户消息**的关键词\n2. 匹配最相关的单一函数\n3. 只调用该函数\n4. 忽略之前的用户消息\n\n【理解规则】\n- 价格表达要准确理解: "100块以内"→price_max=100, "50元以上"→price_min=50\n- "便宜点的"、"经济实惠"等模糊表达→sort_by="price_asc"\n- "学生套餐"、"校园"→target_user="在校生"\n- 如果用户没有提供手机号,需要礼貌询问，不要从function definitions的description中提取信息当作用户输入的。比如手机号\n\n【重要】\n- **只响应最后一条用户消息**\n- **一次只调用一个函数**\n- 不要试图同时处理多个问题\n- 回答要简洁明了\n'}, {'role': 'assistant', 'content': '正在查询套餐信息'}, {'role': 'user', 'content': '查询我的流量使用情况'}]
2025-10-05 21:56:24.741 | INFO     | core.nlu.nlu_engine:_parse_response:189 - 解析响应=ChatCompletion(id='c1c34fcd-601d-422a-b440-f5258754b41b', choices=[Choice(finish_reason='tool_calls', index=0, logprobs=None, message=ChatCompletionMessage(content='', refusal=None, role='assistant', annotations=None, audio=None, function_call=None, tool_calls=[ChatCompletionMessageFunctionToolCall(id='call_00_11heAcAJEC9Vk5QAjQswFZQl', function=Function(arguments='{"phone": "", "query_type": "all"}', name='query_usage'), type='function', index=0)]))], created=1759672584, model='deepseek-chat', object='chat.completion', service_tier=None, system_fingerprint='fp_ffc7281d48_prod0820_fp8_kvcache', usage=CompletionUsage(completion_tokens=18, prompt_tokens=1545, total_tokens=1563, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetails(audio_tokens=None, cached_tokens=1536), prompt_cache_hit_tokens=1536, prompt_cache_miss_tokens=9))
2025-10-05 21:56:24.742 | INFO     | core.nlu.nlu_engine:_parse_response:190 - 解析响应: tool_calls数量=1
2025-10-05 21:56:24.742 | INFO     | core.nlu.nlu_engine:_update_session:351 - [integration_test_005] 意图切换: query_packages -> query_usage
2025-10-05 21:56:24.742 | INFO     | core.nlu.nlu_engine:understand:105 - [integration_test_005] NLU完成: intent=query_usage
2025-10-05 21:56:24.742 | INFO     | core.dst.dialog_state_tracker:track:40 - [DST] 开始跟踪会话: integration_test_005
2025-10-05 21:56:24.742 | DEBUG    | core.dst.state_store:_load_from_memory:118 - 从内存加载状态: integration_test_005
2025-10-05 21:56:24.742 | INFO     | core.dst.dialog_state_tracker:track:59 - 意图改变: query_packages → query_usage
2025-10-05 21:56:24.742 | INFO     | core.dst.slot_manager:fill_slots:61 - 不同领域，仅保留用户信息: []
2025-10-05 21:56:24.742 | INFO     | core.dst.slot_manager:validate_slots:103 - 缺失槽位: ['phone']
2025-10-05 21:56:24.742 | INFO     | core.dst.dialog_state_tracker:_validate_slots:134 - 缺失必填槽位: ['phone']
2025-10-05 21:56:24.742 | DEBUG    | core.dst.state_store:_save_to_memory:78 - 状态已保存到内存: integration_test_005
2025-10-05 21:56:24.742 | INFO     | core.dst.dialog_state_tracker:track:112 - [DST] 状态跟踪完成: turn=3, 需要澄清=True
2025-10-05 21:56:24.742 | INFO     | core.chatbot_dst:_log_conversation:234 - [integration_test_005] 对话完成 | 意图: query_usage | 轮次: 3 | 耗时: 2323ms
